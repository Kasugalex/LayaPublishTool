!function(e,t,n){{var i=(n.un,n.uns,n.static),r=n.class,a=n.getset,o=n.__newvec,s=(laya.ani.AnimationContent,laya.ani.AnimationPlayer),l=(laya.ani.AnimationState,laya.ani.AnimationTemplet),u=laya.maths.Arith,c=laya.webgl.atlas.AtlasResourceManager,h=laya.webgl.shader.BaseShader,d=laya.utils.Browser,_=laya.webgl.utils.Buffer,f=laya.utils.Byte,m=(laya.ani.bone.canvasmesh.CacheAbleSkinMesh,laya.utils.ClassUtils),p=n.Config,E=(laya.events.Event,laya.events.EventDispatcher),v=laya.utils.Handler,g=laya.net.Loader,T=laya.net.LoaderManager,S=laya.maths.MathUtil,D=laya.display.Node,x=laya.renders.Render,M=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),R=laya.resource.Resource,A=laya.utils.RunDriver,I=(laya.webgl.shader.Shader,laya.webgl.utils.ShaderCompile),y=laya.display.Sprite,C=laya.utils.Stat,O=laya.utils.StringKey,V=(laya.display.css.Style,laya.resource.Texture,laya.net.URL),L=laya.utils.Utils,P=laya.webgl.WebGL,w=laya.webgl.WebGLContext;laya.webgl.canvas.WebGLContext2D}n.interface("laya.d3.core.IClone"),n.interface("laya.d3.graphics.IVertex"),n.interface("laya.d3.core.render.IUpdate"),n.interface("laya.d3.core.scene.ITreeNode"),n.interface("laya.d3.core.render.IRenderable");{var N=function(){function e(){}return r(e,"laya.d3.animation.AnimationClipParser01"),e.READ_DATA=function(){e._DATA.offset=e._reader.getUint32(),e._DATA.size=e._reader.getUint32()},e.READ_BLOCK=function(){for(var t=e._BLOCK.count=e._reader.getUint16(),n=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],r=0;t>r;r++)n.push(e._reader.getUint32()),i.push(e._reader.getUint32())},e.READ_STRINGS=function(){var t=e._reader.getUint32(),n=e._reader.getUint16(),i=e._reader.pos;e._reader.pos=t+e._DATA.offset;for(var r=0;n>r;r++)e._strings[r]=e._reader.readUTFString();e._reader.pos=i},e.parse=function(t,n){e._animationClip=t,e._reader=n;n.__getBuffer();e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var i=0,r=e._BLOCK.count;r>i;i++){var a=n.getUint16(),o=e._strings[a],s=e["READ_"+o];if(null==s)throw new Error("model file err,no this function:"+a+" "+o);s.call()}},e.READ_ANIMATIONS=function(){var t,n=0,i=0,r=e._reader,a=r.__getBuffer(),o=[],s=r.getUint8();for(o.length=s,n=0;s>n;n++)o[n]=r.getUint16();var l=[],u=r.getUint16();for(l.length=u,n=0;u>n;n++)l[n]=r.getFloat32();var c=e._animationClip;c.name=e._strings[r.getUint16()];var h=c._duration=r.getFloat32();c.islooping=!!r.getByte(),c._frameRate=r.getInt16();var d=r.getInt16(),_=c._nodes=new Array;_.length=d;var f=c._publicClipDatas=[];f.length=d;var m=c._nodesMap={},p=0,E=0;for(n=0;d>n;n++){t=_[n]=new H;var v=r.getUint16(),g=t.path=[];for(g.length=v,i=0;v>i;i++)g[i]=e._strings[r.getUint16()];var T=g.join("/"),S=m[T];S||(m[T]=S=[]),S.push(t);var D=r.getInt16();-1!==D&&(t.componentType=e._strings[D]);var x=B._propertyIndexDic[e._strings[r.getUint16()]];if(null==x)throw new Error("AnimationClipParser01:unknown property name.");var M=4>x,R=!M||M&&""===g[0];t._cacheProperty=R,R?p++:E++,t.propertyNameID=x;var A=o[r.getUint8()];t.keyFrameWidth=A/4;var I=t.keyFrames=[],y=I.length=r.getUint16(),C=null,O=0/0;for(i=0;y>i;i++){var V=I[i]=new U;O=V.startTime=l[r.getUint16()];var L=r.pos;V.inTangent=new Float32Array(a.slice(L,L+A)),r.pos+=A,L=r.pos,V.outTangent=new Float32Array(a.slice(L,L+A)),r.pos+=A,L=r.pos,V.data=new Float32Array(a.slice(L,L+A)),r.pos+=A,C&&(C.next=V,C.duration=O-C.startTime),C=V}V.next=null,V.duration=h-O}var P=c._nodeToCachePropertyMap=new Int32Array(d),w=c._cachePropertyMap=new Int32Array(p),N=c._unCachePropertyMap=new Int32Array(E);for(p=E=0,n=0;d>n;n++)t=_[n],t._cacheProperty?(P[n]=p,w[p++]=n):N[E++]=n},e._animationClip=null,e._reader=null,e._strings=[],i(e,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),e}(),F=function(){function e(){}return r(e,"laya.d3.animation.AnimationClipParser02"),e.READ_DATA=function(){e._DATA.offset=e._reader.getUint32(),e._DATA.size=e._reader.getUint32()},e.READ_BLOCK=function(){for(var t=e._BLOCK.count=e._reader.getUint16(),n=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],r=0;t>r;r++)n.push(e._reader.getUint32()),i.push(e._reader.getUint32())},e.READ_STRINGS=function(){var t=e._reader.getUint32(),n=e._reader.getUint16(),i=e._reader.pos;e._reader.pos=t+e._DATA.offset;for(var r=0;n>r;r++)e._strings[r]=e._reader.readUTFString();e._reader.pos=i},e.parse=function(t,n){e._animationClip=t,e._reader=n;n.__getBuffer();e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var i=0,r=e._BLOCK.count;r>i;i++){var a=n.getUint16(),o=e._strings[a],s=e["READ_"+o];if(null==s)throw new Error("model file err,no this function:"+a+" "+o);s.call()}},e.READ_ANIMATIONS=function(){var t,n=0,i=0,r=e._reader,a=r.__getBuffer(),o=[],s=r.getUint8();for(o.length=s,n=0;s>n;n++)o[n]=r.getUint16();var l=[],u=r.getUint16();for(l.length=u,n=0;u>n;n++)l[n]=r.getFloat32();var c=e._animationClip;c.name=e._strings[r.getUint16()];var h=c._duration=r.getFloat32();c.islooping=!!r.getByte(),c._frameRate=r.getInt16();var d=r.getInt16(),_=c._nodes=new Array;_.length=d;var f=c._publicClipDatas=[];f.length=d;var m=c._nodesMap={},p=0,E=0;for(n=0;d>n;n++){t=_[n]=new H;var v=r.getUint16(),g=t.path=[];for(g.length=v,i=0;v>i;i++)g[i]=e._strings[r.getUint16()];var T=g.join("/"),S=m[T];S||(m[T]=S=[]),S.push(t);var D=r.getInt16();-1!==D&&(t.componentType=e._strings[D]);var x=B._propertyIndexDic[e._strings[r.getUint16()]];if(null==x)throw new Error("AnimationClipParser02:unknown property name.");var M=4>x,R=!M||M&&""===g[0];t._cacheProperty=R,R?p++:E++,t.propertyNameID=x;var A=o[r.getUint8()];t.keyFrameWidth=A/4;var I=t.keyFrames=[],y=I.length=r.getUint16(),C=null,O=0/0;for(i=0;y>i;i++){var V=I[i]=new U;O=V.startTime=l[r.getUint16()];var L=r.pos;V.inTangent=new Float32Array(a.slice(L,L+A)),r.pos+=A,L=r.pos,V.outTangent=new Float32Array(a.slice(L,L+A)),r.pos+=A,L=r.pos,V.data=new Float32Array(a.slice(L,L+A)),r.pos+=A,C&&(C.next=V,C.duration=O-C.startTime),C=V}V.next=null,V.duration=h-O}var P=r.getUint16();for(n=0;P>n;n++){var w=new b;w.time=r.getFloat32(),w.eventName=e._strings[r.getUint16()];var N,F=r.getUint16();for(F>0&&(w.params=N=[]),i=0;F>i;i++){var G=r.getByte();switch(G){case 0:N.push(!!r.getByte());break;case 1:N.push(r.getInt32());break;case 2:N.push(r.getFloat32());break;case 3:N.push(e._strings[r.getUint16()]);break;default:throw new Error("unknown type.")}}c.addEvent(w)}var z=c._nodeToCachePropertyMap=new Int32Array(d),W=c._cachePropertyMap=new Int32Array(p),k=c._unCachePropertyMap=new Int32Array(E);for(p=E=0,n=0;d>n;n++)t=_[n],t._cacheProperty?(z[n]=p,W[p++]=n):k[E++]=n},e._animationClip=null,e._reader=null,e._strings=[],i(e,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),e}(),b=function(){function e(){this.time=0/0,this.eventName=null,this.params=null}return r(e,"laya.d3.animation.AnimationEvent"),e}(),B=function(){function e(){this._childs=[],this.transform=new Yn(this)}r(e,"laya.d3.animation.AnimationNode");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.addChild=function(e){e._parent=this,e.transform.setParent(this.transform),this._childs.push(e)},t.removeChild=function(e){var t=this._childs.indexOf(e);-1!==t&&this._childs.splice(t,1)},t.getChildByName=function(e){for(var t=0,n=this._childs.length;n>t;t++){var i=this._childs[t];if(i.name===e)return i}return null},t.getChildByIndex=function(e){return this._childs[e]},t.getChildCount=function(){return this._childs.length},t.cloneTo=function(e){var t=e;t.name=this.name;for(var n=0,i=this._childs.length;i>n;n++){var r=this._childs[n],a=r.clone();t.addChild(a);var o=r.transform,s=a.transform;s.setLocalPosition(o.getLocalPosition()),s.setLocalRotation(o.getLocalRotation()),s.setLocalScale(o.getLocalScale()),s._localRotationEuler=o._localRotationEuler,s._setWorldMatrixIgnoreUpdate(o.getWorldMatrix())}},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.__init__=function(){e.registerAnimationNodeProperty("localPosition",e._getLocalPosition,e._setLocalPosition),e.registerAnimationNodeProperty("localRotation",e._getLocalRotation,e._setLocalRotation),e.registerAnimationNodeProperty("localScale",e._getLocalScale,e._setLocalScale),e.registerAnimationNodeProperty("localRotationEuler",e._getLocalRotationEuler,e._setLocalRotationEuler),e.registerAnimationNodeProperty("particleRender.sharedMaterial.tintColor",e._getParticleRenderSharedMaterialTintColor,e._setParticleRenderSharedMaterialTintColor),e.registerAnimationNodeProperty("meshRender.sharedMaterial.tilingOffset",e._getMeshRenderSharedMaterialTilingOffset,e._setMeshRenderSharedMaterialTilingOffset),e.registerAnimationNodeProperty("meshRender.sharedMaterial.albedoColor",e._getMeshRenderSharedMaterialAlbedo,e._setMeshRenderSharedMaterialAlbedo),e.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.tilingOffset",e._getSkinnedMeshRenderSharedMaterialTilingOffset,e._setSkinnedMeshRenderSharedMaterialTilingOffset),e.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedoColor",e._getSkinnedMeshRenderSharedMaterialAlbedo,e._setSkinnedMeshRenderSharedMaterialAlbedo),e.registerAnimationNodeProperty("meshRender.sharedMaterial.albedo",e._getMeshRenderSharedMaterialAlbedo,e._setMeshRenderSharedMaterialAlbedo),e.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedo",e._getSkinnedMeshRenderSharedMaterialAlbedo,e._setSkinnedMeshRenderSharedMaterialAlbedo),e.registerAnimationNodeProperty("meshRender.sharedMaterial.intensity",e._getMeshRenderSharedMaterialIntensity,e._setMeshRenderSharedMaterialIntensity),e.registerAnimationNodeProperty("meshRender.sharedMaterial.alpha",e._getMeshRenderSharedMaterialAlpha,e._setMeshRenderSharedMaterialAlpha),e.registerAnimationNodeProperty("meshRender.sharedMaterial.alphaColor",e._getMeshRenderSharedMaterialAlphaColor,e._setMeshRenderSharedMaterialAlphaColor),e.registerAnimationNodeProperty("meshRender.sharedMaterial.baseColor",e._getMeshRenderSharedMaterialBaseColor,e._setMeshRenderSharedMaterialBaseColor),e.registerAnimationNodeProperty("meshRender.sharedMaterial.dissolve",e._getMeshRenderSharedMaterialDissolve,e._setMeshRenderSharedMaterialDissolve),e.registerAnimationNodeProperty("meshRender.sharedMaterial.dissolveSpeed",e._getMeshRenderSharedMaterialDissolveSpeed,e._setMeshRenderSharedMaterialDissolveSpeed),e.registerAnimationNodeProperty("meshRender.sharedMaterial.mMultiplier",e._getMeshRenderSharedMaterialMMultiplier,e._setMeshRenderSharedMaterialMMultiplier),e.registerAnimationNodeProperty("meshRender.sharedMaterial.baseScrollSpeedX",e._getMeshRenderSharedMaterialBaseScrollSpeedX,e._setMeshRenderSharedMaterialBaseScrollSpeedX),e.registerAnimationNodeProperty("meshRender.sharedMaterial.baseScrollSpeedY",e._getMeshRenderSharedMaterialBaseScrollSpeedY,e._setMeshRenderSharedMaterialBaseScrollSpeedY),e.registerAnimationNodeProperty("meshRender.sharedMaterial.secondScrollSpeedX",e._getMeshRenderSharedMaterialSecondScrollSpeedX,e._setMeshRenderSharedMaterialSecondScrollSpeedX),e.registerAnimationNodeProperty("meshRender.sharedMaterial.secondScrollSpeedY",e._getMeshRenderSharedMaterialSecondScrollSpeedY,e._setMeshRenderSharedMaterialSecondScrollSpeedY),e.registerAnimationNodeProperty("meshRender.sharedMaterial.detailTilingOffset",e._getMeshRenderSharedMaterialDetailTilingOffset,e._setMeshRenderSharedMaterialDetailTilingOffset),e.registerAnimationNodeProperty("meshRender.sharedMaterial.dissolveTilingOffset",e._getMeshRenderSharedMaterialDissolveTilingOffset,e._setMeshRenderSharedMaterialDissolveTilingOffset),e.registerAnimationNodeProperty("meshRender.sharedMaterial.maskTilingOffset",e._getMeshRenderSharedMaterialMaskTilingOffset,e._setMeshRenderSharedMaterialMaskTilingOffset)},e.registerAnimationNodeProperty=function(t,n,i){if(e._propertyIndexDic[t])throw new Error("AnimationNode: this propertyName has registered.");e._propertyIndexDic[t]=e._propertyIDCounter,e._propertyGetFuncs[e._propertyIDCounter]=n,e._propertySetFuncs[e._propertyIDCounter]=i,e._propertyIDCounter++},e._getLocalPosition=function(e,t){return e?e.transform.getLocalPosition():t._transform.localPosition.elements},e._setLocalPosition=function(e,t,n){if(e)e.transform.setLocalPosition(n);else{var i=t._transform,r=i.localPosition;r.elements=n,i.localPosition=r}},e._getLocalRotation=function(e,t){return e?e.transform.getLocalRotation():t._transform.localRotation.elements},e._setLocalRotation=function(e,t,n){if(e)e.transform.setLocalRotation(n);else{var i=t._transform,r=i.localRotation;r.elements=n,i.localRotation=r}},e._getLocalScale=function(e,t){return e?e.transform.getLocalScale():t._transform.localScale.elements},e._setLocalScale=function(e,t,n){if(e)e.transform.setLocalScale(n);else{var i=t._transform,r=i.localScale;r.elements=n,i.localScale=r}},e._getLocalRotationEuler=function(e,t){return e?e.transform.getLocalRotationEuler():t._transform.localRotationEuler.elements},e._setLocalRotationEuler=function(e,t,n){if(e)e.transform.setLocalRotationEuler(n);else{var i=t._transform,r=i.localRotationEuler;r.elements=n,i.localRotationEuler=r}},e._getMeshRenderSharedMaterialTilingOffset=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.tilingOffset.elements):null}return n=t.meshRender.sharedMaterial,n.tilingOffset.elements},e._setMeshRenderSharedMaterialTilingOffset=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.meshRender.material,r=i.tilingOffset,r.elements=n,i.tilingOffset=r)}else i=t.meshRender.material,r=i.tilingOffset,r.elements=n,i.tilingOffset=r},e._getMeshRenderSharedMaterialAlbedo=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.albedoColor.elements):null}return n=t.meshRender.sharedMaterial,n.albedoColor.elements},e._setMeshRenderSharedMaterialAlbedo=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.meshRender.material,r=i.albedoColor,r.elements=n,i.albedoColor=r)}else i=t.meshRender.material,r=i.albedoColor,r.elements=n,i.albedoColor=r},e._getSkinnedMeshRenderSharedMaterialTilingOffset=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.skinnedMeshRender.sharedMaterial,n.tilingOffset.elements):null}return n=t.skinnedMeshRender.sharedMaterial,n.tilingOffset.elements},e._setSkinnedMeshRenderSharedMaterialTilingOffset=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.skinnedMeshRender.material,r=i.tilingOffset,r.elements=n,i.tilingOffset=r)}else i=t.skinnedMeshRender.material,r=i.tilingOffset,r.elements=n,i.tilingOffset=r},e._getSkinnedMeshRenderSharedMaterialAlbedo=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.skinnedMeshRender.sharedMaterial,n.albedoColor.elements):null}return n=t.skinnedMeshRender.sharedMaterial,n.albedoColor.elements},e._setSkinnedMeshRenderSharedMaterialAlbedo=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.skinnedMeshRender.material,r=i.albedoColor,r.elements=n,i.albedoColor=r)}else i=t.skinnedMeshRender.material,r=i.albedoColor,r.elements=n,i.albedoColor=r},e._getParticleRenderSharedMaterialTintColor=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.particleRender.sharedMaterial,n.tintColor.elements):null}return n=t.particleRender.sharedMaterial,n.tintColor.elements},e._setParticleRenderSharedMaterialTintColor=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.particleRender.material,r=i.tintColor,r.elements=n,i.tintColor=r)}else i=t.particleRender.material,r=i.tintColor,r.elements=n,i.tintColor=r},e._getMeshRenderSharedMaterialAlphaColor=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.alphaColor.elements):null}return n=t.meshRender.sharedMaterial,n.alphaColor.elements},e._setMeshRenderSharedMaterialAlphaColor=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.meshRender.material,r=i.alphaColor,r.elements=n,i.alphaColor=r)}else i=t.meshRender.material,r=i.alphaColor,r.elements=n,i.alphaColor=r},e._getMeshRenderSharedMaterialBaseColor=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.baseColor.elements):null}return n=t.meshRender.sharedMaterial,n.baseColor.elements},e._setMeshRenderSharedMaterialBaseColor=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.meshRender.material,r=i.baseColor,r.elements=n,i.baseColor=r)}else i=t.meshRender.material,r=i.baseColor,r.elements=n,i.baseColor=r},e._getMeshRenderSharedMaterialDissolve=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.dissolve):0}return n=t.meshRender.sharedMaterial,n.dissolve},e._setMeshRenderSharedMaterialDissolve=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.dissolve=n[0])}else i=t.meshRender.material,i.dissolve=n[0]},e._getMeshRenderSharedMaterialDissolveSpeed=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.dissolveSpeed):0}return n=t.meshRender.sharedMaterial,n.dissolveSpeed},e._setMeshRenderSharedMaterialDissolveSpeed=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.dissolveSpeed=n[0])}else i=t.meshRender.material,i.dissolveSpeed=n[0]},e._getMeshRenderSharedMaterialMMultiplier=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.mMultiplier):0}return n=t.meshRender.sharedMaterial,n.mMultiplier},e._setMeshRenderSharedMaterialMMultiplier=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.mMultiplier=n[0])}else i=t.meshRender.material,i.mMultiplier=n[0]},e._getMeshRenderSharedMaterialBaseScrollSpeedX=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.baseScrollSpeedX):0}return n=t.meshRender.sharedMaterial,n.baseScrollSpeedX},e._setMeshRenderSharedMaterialBaseScrollSpeedX=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.baseScrollSpeedX=n[0])}else i=t.meshRender.material,i.baseScrollSpeedX=n[0]},e._getMeshRenderSharedMaterialBaseScrollSpeedY=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.baseScrollSpeedY):0}return n=t.meshRender.sharedMaterial,n.baseScrollSpeedY},e._setMeshRenderSharedMaterialBaseScrollSpeedY=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.baseScrollSpeedY=n[0])}else i=t.meshRender.material,i.baseScrollSpeedY=n[0]},e._getMeshRenderSharedMaterialSecondScrollSpeedX=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.secondScrollSpeedX):0}return n=t.meshRender.sharedMaterial,n.secondScrollSpeedX},e._setMeshRenderSharedMaterialSecondScrollSpeedX=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.secondScrollSpeedX=n[0])}else i=t.meshRender.material,i.secondScrollSpeedX=n[0]},e._getMeshRenderSharedMaterialSecondScrollSpeedY=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.secondScrollSpeedY):0}return n=t.meshRender.sharedMaterial,n.secondScrollSpeedY},e._setMeshRenderSharedMaterialSecondScrollSpeedY=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.secondScrollSpeedY=n[0])}else i=t.meshRender.material,i.secondScrollSpeedY=n[0]},e._getMeshRenderSharedMaterialAlpha=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.alpha):0}return n=t.meshRender.sharedMaterial,n.alpha},e._setMeshRenderSharedMaterialAlpha=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.alpha=n[0])}else i=t.meshRender.material,i.alpha=n[0]},e._getMeshRenderSharedMaterialIntensity=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.intensity):0}return n=t.meshRender.sharedMaterial,n.intensity},e._setMeshRenderSharedMaterialIntensity=function(e,t,n){var i;if(e){var r=e.transform._entity;r&&(i=r.owner.meshRender.material,i.intensity=n[0])}else i=t.meshRender.material,i.intensity=n[0]},e._getMeshRenderSharedMaterialDetailTilingOffset=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.detailTilingOffset.elements):null}return n=t.meshRender.sharedMaterial,n.detailTilingOffset.elements},e._setMeshRenderSharedMaterialDetailTilingOffset=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.meshRender.material,r=i.detailTilingOffset,r.elements=n,i.detailTilingOffset=r)}else i=t.meshRender.material,r=i.detailTilingOffset,r.elements=n,i.detailTilingOffset=r},e._getMeshRenderSharedMaterialDissolveTilingOffset=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.dissolveTilingOffset.elements):null}return n=t.meshRender.sharedMaterial,n.dissolveTilingOffset.elements},e._setMeshRenderSharedMaterialDissolveTilingOffset=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.meshRender.material,r=i.dissolveTilingOffset,r.elements=n,i.dissolveTilingOffset=r)}else i=t.meshRender.material,r=i.dissolveTilingOffset,r.elements=n,i.dissolveTilingOffset=r},e._getMeshRenderSharedMaterialMaskTilingOffset=function(e,t){var n;if(e){var i=e.transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.maskTilingOffset.elements):null}return n=t.meshRender.sharedMaterial,n.maskTilingOffset.elements},e._setMeshRenderSharedMaterialMaskTilingOffset=function(e,t,n){var i,r;if(e){var a=e.transform._entity;a&&(i=a.owner.meshRender.material,r=i.maskTilingOffset,r.elements=n,i.maskTilingOffset=r)}else i=t.meshRender.material,r=i.maskTilingOffset,r.elements=n,i.maskTilingOffset=r},e._propertyIDCounter=0,e._propertyIndexDic={},e._propertySetFuncs=[],e._propertyGetFuncs=[],e}(),U=function(){function e(){this.startTime=0/0,this.inTangent=null,this.outTangent=null,this.data=null,this.duration=0/0,this.next=null}return r(e,"laya.d3.animation.Keyframe"),e}(),H=function(){function e(){this._cacheProperty=!1,this.path=null,this.componentType=null,this.propertyNameID=0,this.keyFrameWidth=0,this.defaultData=null,this.keyFrames=null}return r(e,"laya.d3.animation.KeyframeNode"),e}(),G=function(){function e(){this._tempVector30=new On,this._tempVector31=new On,this._tempVector32=new On,this._a=new On,this._b=new On,this._c=new On,this._d=new On}r(e,"laya.d3.core.glitter.SplineCurvePositionVelocity");var t=e.prototype;return t.Init=function(e,t,n,i){e.cloneTo(this._d),t.cloneTo(this._c),On.scale(e,2,this._a),On.scale(n,2,this._tempVector30),On.subtract(this._a,this._tempVector30,this._a),On.add(this._a,t,this._a),On.add(this._a,i,this._a),On.scale(n,3,this._b),On.scale(e,3,this._tempVector30),On.subtract(this._b,this._tempVector30,this._b),On.subtract(this._b,i,this._b),On.scale(t,2,this._tempVector30),On.subtract(this._b,this._tempVector30,this._b)},t.Slerp=function(e,t){On.scale(this._a,e*e*e,this._tempVector30),On.scale(this._b,e*e,this._tempVector31),On.scale(this._c,e,this._tempVector32),On.add(this._tempVector30,this._tempVector31,t),On.add(t,this._tempVector32,t),On.add(t,this._d,t)},e}(),z=(function(){function e(){}r(e,"laya.d3.core.HeightMap");var t=e.prototype;return t._inBounds=function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w},t.getHeight=function(e,t){return this._inBounds(e,t)?this._datas[e][t]:0/0},a(0,t,"width",function(){return this._w}),a(0,t,"height",function(){return this._h}),a(0,t,"maxHeight",function(){return this._maxHeight}),a(0,t,"minHeight",function(){return this._minHeight}),e.creatFromMesh=function(){},e.createFromImage=function(){},e._getPosition=function(){},i(e,["_tempRay",function(){return this._tempRay=new yn(new On,new On)}]),e}(),function(){function e(){this._visible=!0,this._nonRigidbodyOffset=0,this._colliders=[]}r(e,"laya.d3.core.Layer");var t=e.prototype;return t._binarySearchIndex=function(){for(var t=0,n=e._collsionTestList.length-1,i=0;n>=t;){i=Math.floor((t+n)/2);var r=e._collsionTestList[i];if(r==this._number)return i;r>this._number?n=i-1:t=i+1}return t},t._addCollider=function(t){0===this._colliders.length&&e._collsionTestList.splice(this._binarySearchIndex(),0,this._number),t._isRigidbody?(this._colliders.unshift(t),this._nonRigidbodyOffset++):this._colliders.push(t)},t._removeCollider=function(t){var n=this._colliders.indexOf(t);n<this._nonRigidbodyOffset&&this._nonRigidbodyOffset--,this._colliders.splice(n,1),0===this._colliders.length&&e._collsionTestList.splice(e._collsionTestList.indexOf(this._number),1)},a(0,t,"number",function(){return this._number}),a(0,t,"visible",function(){return this._visible},function(t){this._visible=t,e._visibleLayers=t?e._visibleLayers|this.mask:e._visibleLayers&~this.mask}),a(0,t,"mask",function(){return this._mask}),a(1,e,"visibleLayers",function(){return e._visibleLayers},function(t){e._visibleLayers=t;for(var n=0,i=e._layerList.length;i>n;n++){var r=e._layerList[n];r._visible=0!==(r._mask&e._visibleLayers)}}),e.__init__=function(){e._layerList.length=31;for(var t=0;31>t;t++){var n=new e;e._layerList[t]=n,0===t?(n.name="Default Layer",n.visible=!0):(n.name="Layer-"+t,n.visible=!1),n._number=t,n._mask=Math.pow(2,t)}e.currentCreationLayer=e._layerList[0]},e.getLayerByNumber=function(t){if(0>t||t>30)throw new Error("无法返回指定Layer，该number超出范围！");return e._layerList[t]},e.getLayerByName=function(t){for(var n=0;31>n;n++)if(e._layerList[n].name===t)return e._layerList[n];throw new Error("无法返回指定Layer,该name不存在")},e.isVisible=function(t){return 0!=(t&e._currentCameraCullingMask&e._visibleLayers)},e._layerList=[],e._visibleLayers=2147483647,e._collsionTestList=[],e._currentCameraCullingMask=2147483647,e.maxCount=31,e.currentCreationLayer=null,e}()),W=function(){function e(e,t,n){this._time=0/0,this._minCount=0,this._maxCount=0,this._time=e,this._minCount=t,this._maxCount=n}r(e,"laya.d3.core.particleShuriKen.module.Burst");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"time",function(){return this._time}),a(0,t,"minCount",function(){return this._minCount}),a(0,t,"maxCount",function(){return this._maxCount}),e}(),k=function(){function e(e){this._color=null,this.enbale=!1,this._color=e}r(e,"laya.d3.core.particleShuriKen.module.ColorOverLifetime");var t=e.prototype;return t.cloneTo=function(e){var t=e;this._color.cloneTo(t._color),t.enbale=this.enbale},t.clone=function(){var e;switch(this._color.type){case 0:e=K.createByConstant(this._color.constant.clone());break;case 1:e=K.createByGradient(this._color.gradient.clone());break;case 2:e=K.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=K.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"color",function(){return this._color}),e}(),X=function(){function e(){this._destroyed=!1,this._emissionRate=0,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}r(e,"laya.d3.core.particleShuriKen.module.Emission");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0,"laya.resource.IDestroy":!0}),t._destroy=function(){this._bursts=null,this._destroyed=!0},t.getBurstsCount=function(){return this._bursts.length},t.getBurstByIndex=function(e){return this._bursts[e]},t.addBurst=function(e){var t=this._bursts.length;if(t>0)for(var n=0;t>n;n++)this._bursts[n].time>e.time&&this._bursts.splice(n,0,e);this._bursts.push(e)},t.removeBurst=function(e){var t=this._bursts.indexOf(e);-1!==t&&this._bursts.splice(t,1)},t.removeBurstByIndex=function(e){this._bursts.splice(e,1)},t.clearBurst=function(){this._bursts.length=0},t.cloneTo=function(e){var t=e,n=t._bursts;n.length=this._bursts.length;for(var i=0,r=this._bursts.length;r>i;i++){var a=n[i];a?this._bursts[i].cloneTo(a):n[i]=this._bursts[i].clone()}t._emissionRate=this._emissionRate,t.enbale=this.enbale},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"destroyed",function(){return this._destroyed}),a(0,t,"emissionRate",function(){return this._emissionRate},function(e){if(0>e)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e}),e}(),Y=function(){function e(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}r(e,"laya.d3.core.particleShuriKen.module.FrameOverTime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax.cloneTo(t._overTimeMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"frameOverTimeData",function(){return this._overTime}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"frameOverTimeDataMin",function(){return this._overTimeMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"frameOverTimeDataMax",function(){return this._overTimeMax}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByOverTime=function(t){var n=new e;return n._type=1,n._overTime=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoOverTime=function(t,n){var i=new e;return i._type=3,i._overTimeMin=t,i._overTimeMax=n,i},e}(),Z=function(){function e(){this._type=0,this._separateAxes=!1,this._constant=0/0,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=0/0,this._constantMax=0/0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"constant",function(){return this._constant}),a(0,t,"gradient",function(){return this._gradient}),a(0,t,"separateAxes",function(){return this._separateAxes}),a(0,t,"type",function(){return this._type}),a(0,t,"constantSeparate",function(){return this._constantSeparate}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY
}),a(0,t,"gradientW",function(){return this._gradientW}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"gradientWMin",function(){return this._gradientWMin}),a(0,t,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,t,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"gradientWMax",function(){return this._gradientWMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._separateAxes=!1,n._constant=t,n},e.createByConstantSeparate=function(t){var n=new e;return n._type=0,n._separateAxes=!0,n._constantSeparate=t,n},e.createByGradient=function(t){var n=new e;return n._type=1,n._separateAxes=!1,n._gradient=t,n},e.createByGradientSeparate=function(t,n,i,r){var a=new e;return a._type=1,a._separateAxes=!0,a._gradientX=t,a._gradientY=n,a._gradientZ=i,a._gradientW=r,a},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._separateAxes=!1,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoConstantSeparate=function(t,n){var i=new e;return i._type=2,i._separateAxes=!0,i._constantMinSeparate=t,i._constantMaxSeparate=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=3,i._separateAxes=!1,i._gradientMin=t,i._gradientMax=n,i},e.createByRandomTwoGradientSeparate=function(t,n,i,r,a,o,s,l){var u=new e;return u._type=3,u._separateAxes=!0,u._gradientXMin=t,u._gradientXMax=n,u._gradientYMin=i,u._gradientYMax=r,u._gradientZMin=a,u._gradientZMax=o,u._gradientWMin=s,u._gradientWMax=l,u},e}(),K=function(){function e(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientColor");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradient",function(){return this._gradient}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByGradient=function(t){var n=new e;return n._type=1,n._gradient=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=3,i._gradientMin=t,i._gradientMax=n,i},e}(),j=function(){function e(){this._alphaCurrentLength=0,this._rgbCurrentLength=0,this._alphaElements=null,this._rgbElements=null,this._alphaElements=new Float32Array(8),this._rgbElements=new Float32Array(16)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataColor");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.addAlpha=function(e,t){this._alphaCurrentLength<8?(6===this._alphaCurrentLength&&1!==e&&(e=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._alphaElements[this._alphaCurrentLength++]=e,this._alphaElements[this._alphaCurrentLength++]=t):console.log("GradientDataColor warning:data count must lessEqual than 4")},t.addRGB=function(e,t){this._rgbCurrentLength<16?(12===this._rgbCurrentLength&&1!==e&&(e=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._rgbElements[this._rgbCurrentLength++]=e,this._rgbElements[this._rgbCurrentLength++]=t.x,this._rgbElements[this._rgbCurrentLength++]=t.y,this._rgbElements[this._rgbCurrentLength++]=t.z):console.log("GradientDataColor warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e,n=0,i=0;t._alphaCurrentLength=this._alphaCurrentLength;var r=t._alphaElements;for(r.length=this._alphaElements.length,n=0,i=this._alphaElements.length;i>n;n++)r[n]=this._alphaElements[n];t._rgbCurrentLength=this._rgbCurrentLength;var a=t._rgbElements;for(a.length=this._rgbElements.length,n=0,i=this._rgbElements.length;i>n;n++)a[n]=this._rgbElements[n]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"alphaGradientCount",function(){return this._alphaCurrentLength/2}),a(0,t,"rgbGradientCount",function(){return this._rgbCurrentLength/4}),e}(),q=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataInt");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;r>i;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/2}),e}(),Q=function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataNumber");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")},t.getKeyByIndex=function(e){return this._elements[2*e]},t.getValueByIndex=function(e){return this._elements[2*e+1]},t.getAverageValue=function(){for(var e=0,t=0,n=this._currentLength-2;n>t;t+=2){var i=this._elements[t+1];i+=this._elements[t+3],i*=this._elements[t+2]-this._elements[t]}return e/2},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;r>i;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/2}),e}(),$=(function(){function e(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12)}r(e,"laya.d3.core.particleShuriKen.module.GradientDataVector2");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.add=function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")},t.cloneTo=function(e){var t=e;t._currentLength=this._currentLength;var n=t._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;r>i;i++)n[i]=this._elements[i]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientCount",function(){return this._currentLength/3}),e}(),function(){function e(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=0/0,this._constantMax=0/0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientSize");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.getMaxSizeInGradient=function(){var e=0,t=0,n=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;t>e;e++)n=Math.max(n,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;t>e;e++)n=Math.max(n,this._gradientY.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;t>e;e++)n=Math.max(n,this._gradient.getValueByIndex(e));break;case 1:this._separateAxes?(n=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),n=Math.max(n,this._constantMinSeparate.y),n=Math.max(n,this._constantMaxSeparate.y)):n=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;t>e;e++)n=Math.max(n,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;t>e;e++)n=Math.max(n,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;t>e;e++)n=Math.max(n,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;t>e;e++)n=Math.max(n,this._gradientZMax.getValueByIndex(e))}else{for(e=0,t=this._gradientMin.gradientCount;t>e;e++)n=Math.max(n,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;t>e;e++)n=Math.max(n,this._gradientMax.getValueByIndex(e))}}return n},t.cloneTo=function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"gradient",function(){return this._gradient}),a(0,t,"separateAxes",function(){return this._separateAxes}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientMin",function(){return this._gradientMin}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY}),a(0,t,"gradientMax",function(){return this._gradientMax}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,t,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByGradient=function(t){var n=new e;return n._type=0,n._separateAxes=!1,n._gradient=t,n},e.createByGradientSeparate=function(t,n,i){var r=new e;return r._type=0,r._separateAxes=!0,r._gradientX=t,r._gradientY=n,r._gradientZ=i,r},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=1,i._separateAxes=!1,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoConstantSeparate=function(t,n){var i=new e;return i._type=1,i._separateAxes=!0,i._constantMinSeparate=t,i._constantMaxSeparate=n,i},e.createByRandomTwoGradient=function(t,n){var i=new e;return i._type=2,i._separateAxes=!1,i._gradientMin=t,i._gradientMax=n,i},e.createByRandomTwoGradientSeparate=function(t,n,i,r,a,o){var s=new e;return s._type=2,s._separateAxes=!0,s._gradientXMin=t,s._gradientXMax=n,s._gradientYMin=i,s._gradientYMax=r,s._gradientZMin=a,s._gradientZMax=o,s},e}()),J=function(){function e(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(e,"laya.d3.core.particleShuriKen.module.GradientVelocity");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"gradientZ",function(){return this._gradientZ}),a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"gradientXMax",function(){return this._gradientXMax}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"gradientX",function(){return this._gradientX}),a(0,t,"gradientY",function(){return this._gradientY}),a(0,t,"gradientXMin",function(){return this._gradientXMin}),a(0,t,"constantMax",function(){return this._constantMax}),a(0,t,"gradientYMin",function(){return this._gradientYMin}),a(0,t,"gradientYMax",function(){return this._gradientYMax}),a(0,t,"gradientZMin",function(){return this._gradientZMin}),a(0,t,"gradientZMax",function(){return this._gradientZMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByGradient=function(t,n,i){var r=new e;return r._type=1,r._gradientX=t,r._gradientY=n,r._gradientZ=i,r},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=2,i._constantMin=t,i._constantMax=n,i},e.createByRandomTwoGradient=function(t,n,i,r,a,o){var s=new e;return s._type=3,s._gradientXMin=t,s._gradientXMax=n,s._gradientYMin=i,s._gradientYMax=r,s._gradientZMin=a,s._gradientZMax=o,s},e}(),et=function(){function e(e){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=e}r(e,"laya.d3.core.particleShuriKen.module.RotationOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enbale=this.enbale},t.clone=function(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?Z.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):Z.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?Z.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone(),this._angularVelocity.gradientW.clone()):Z.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?Z.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):Z.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?Z.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):Z.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"angularVelocity",function(){return this._angularVelocity}),e}(),tt=function(){function e(){this.enable=!1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.BaseShape");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t._getShapeBoundBox=function(){throw new Error("BaseShape: must override it.")},t._getSpeedBoundBox=function(){throw new Error("BaseShape: must override it.")},t.generatePositionAndDirection=function(){throw new Error("BaseShape: must override it.")},t._calculateProceduralBounds=function(e,t,n){this._getShapeBoundBox(e);var i=e.min,r=e.max;On.multiply(i,t,i),On.multiply(r,t,r);var a=new En(new On,new On);this.randomDirection?(a.min=new On(-1,-1,-1),a.max=new On(1,1,1)):this._getSpeedBoundBox(a);var o=new En(new On,new On),s=o.min,l=o.max;On.scale(a.min,n.y,s),On.scale(a.max,n.y,l),On.add(e.min,s,s),On.add(e.max,l,l),On.min(e.min,s,e.min),On.max(e.max,s,e.max);var u=new En(new On,new On),c=u.min,h=u.max;On.scale(a.min,n.x,c),On.scale(a.max,n.x,h),On.min(u.min,h,s),On.max(u.min,h,l),On.min(e.min,s,e.min),On.max(e.max,s,e.max)},t.cloneTo=function(e){var t=e;t.enable=this.enable},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e}(),nt=function(){function e(){}return r(e,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),e._randomPointUnitArcCircle=function(e,t,n){var i=t.elements,r=0/0;r=n?n.getFloat()*e:Math.random()*e,i[0]=Math.cos(r),i[1]=Math.sin(r)},e._randomPointInsideUnitArcCircle=function(t,n,i){var r=n.elements;e._randomPointUnitArcCircle(t,n,i);var a=0/0;a=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),r[0]=r[0]*a,r[1]=r[1]*a},e._randomPointUnitCircle=function(e,t){var n=e.elements,i=0/0;i=t?t.getFloat()*Math.PI*2:Math.random()*Math.PI*2,n[0]=Math.cos(i),n[1]=Math.sin(i)},e._randomPointInsideUnitCircle=function(t,n){var i=t.elements;e._randomPointUnitCircle(t);var r=0/0;r=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),i[0]=i[0]*r,i[1]=i[1]*r},e._randomPointUnitSphere=function(e,t){var n=e.elements,i=0/0,r=0/0;t?(i=n[2]=2*t.getFloat()-1,r=t.getFloat()*Math.PI*2):(i=n[2]=2*Math.random()-1,r=Math.random()*Math.PI*2);var a=Math.sqrt(1-i*i);n[0]=a*Math.cos(r),n[1]=a*Math.sin(r)},e._randomPointInsideUnitSphere=function(t,n){var i=t.elements;e._randomPointUnitSphere(t);var r=0/0;r=n?Math.pow(n.getFloat(),1/3):Math.pow(Math.random(),1/3),i[0]=i[0]*r,i[1]=i[1]*r,i[2]=i[2]*r},e._randomPointInsideHalfUnitBox=function(e,t){var n=e.elements;t?(n[0]=t.getFloat()-.5,n[1]=t.getFloat()-.5,n[2]=t.getFloat()-.5):(n[0]=Math.random()-.5,n[1]=Math.random()-.5,n[2]=Math.random()-.5)},e}(),it=function(){function e(e){this._size=null,this.enbale=!1,this._size=e}r(e,"laya.d3.core.particleShuriKen.module.SizeOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._size.cloneTo(t._size),t.enbale=this.enbale},t.clone=function(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?$.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):$.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?$.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):$.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?$.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):$.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t},a(0,t,"size",function(){return this._size}),e}(),rt=function(){function e(){this._type=0,this._constant=0/0,this._constantMin=0/0,this._constantMax=0/0}r(e,"laya.d3.core.particleShuriKen.module.StartFrame");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"constant",function(){return this._constant}),a(0,t,"type",function(){return this._type}),a(0,t,"constantMin",function(){return this._constantMin}),a(0,t,"constantMax",function(){return this._constantMax}),e.createByConstant=function(t){var n=new e;return n._type=0,n._constant=t,n},e.createByRandomTwoConstant=function(t,n){var i=new e;return i._type=1,i._constantMin=t,i._constantMax=n,i},e}(),at=function(){function e(e,t){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new Cn(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}r(e,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame),t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enable=this.enable},t.clone=function(){var e;switch(this._frame.type){case 0:e=Y.createByConstant(this._frame.constant);break;case 1:e=Y.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:e=Y.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=Y.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}var t;switch(this._startFrame.type){case 0:t=rt.createByConstant(this._startFrame.constant);break;case 1:t=rt.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var n=new this.constructor(e,t);return this.tiles.cloneTo(n.tiles),n.type=this.type,n.randomRow=this.randomRow,n.cycles=this.cycles,n.enableUVChannels=this.enableUVChannels,n.enable=this.enable,n},a(0,t,"frame",function(){return this._frame}),a(0,t,"startFrame",function(){return this._startFrame}),e}(),ot=function(){function e(e){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=e}r(e,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.cloneTo=function(e){var t=e;this._velocity.cloneTo(t._velocity),t.enbale=this.enbale,t.space=this.space},t.clone=function(){var e;switch(this._velocity.type){case 0:e=J.createByConstant(this._velocity.constant.clone());break;case 1:e=J.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=J.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=J.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var t=new this.constructor(e);return t.enbale=this.enbale,t.space=this.space,t},a(0,t,"velocity",function(){return this._velocity}),e}(),st=function(){function e(){}return r(e,"laya.d3.core.particleShuriKen.ShurikenParticleData"),e._getStartLifetimeFromGradient=function(e,t){for(var n=1,i=e.gradientCount;i>n;n++){var r=e.getKeyByIndex(n);if(r>=t){var a=e.getKeyByIndex(n-1),o=(t-a)/(r-a);return S.lerp(e.getValueByIndex(n-1),e.getValueByIndex(n),o)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},e._randomInvertRoationArray=function(e,t,n,i,r){var a=0/0;i?(i.seed=r[6],a=i.getFloat(),r[6]=i.seed):a=Math.random(),n>a?(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2]):(t[0]=e[0],t[1]=e[1],t[2]=e[2])},e._randomInvertRoation=function(e,t,n,i){var r=0/0;return n?(n.seed=i[6],r=n.getFloat(),i[6]=n.seed):r=Math.random(),t>r&&(e=-e),e},e.create=function(t,n,i){var r=t.autoRandomSeed,a=t._rand,o=t._randomSeeds;switch(t.startColorType){case 0:var s=t.startColorConstant.elements;e.startColor[0]=s[0],e.startColor[1]=s[1],e.startColor[2]=s[2],e.startColor[3]=s[3];break;case 2:r?S.lerpVector4(t.startColorConstantMin.elements,t.startColorConstantMax.elements,Math.random(),e.startColor):(a.seed=o[3],S.lerpVector4(t.startColorConstantMin.elements,t.startColorConstantMax.elements,a.getFloat(),e.startColor),o[3]=a.seed)}var l=t.colorOverLifetime;if(l&&l.enbale){var u=l.color;switch(u.type){case 0:e.startColor[0]=e.startColor[0]*u.constant.x,e.startColor[1]=e.startColor[1]*u.constant.y,e.startColor[2]=e.startColor[2]*u.constant.z,e.startColor[3]=e.startColor[3]*u.constant.w;break;case 2:var c=0/0;r?c=Math.random():(a.seed=o[10],c=a.getFloat(),o[10]=a.seed);var h=u.constantMin,d=u.constantMax;e.startColor[0]=e.startColor[0]*S.lerp(h.x,d.x,c),e.startColor[1]=e.startColor[1]*S.lerp(h.y,d.y,c),e.startColor[2]=e.startColor[2]*S.lerp(h.z,d.z,c),e.startColor[3]=e.startColor[3]*S.lerp(h.w,d.w,c)}}var _=e.startSize;switch(t.startSizeType){case 0:if(t.threeDStartSize){var f=t.startSizeConstantSeparate;_[0]=f.x,_[1]=f.y,_[2]=f.z}else _[0]=_[1]=_[2]=t.startSizeConstant;break;case 2:if(t.threeDStartSize){var m=t.startSizeConstantMinSeparate,p=t.startSizeConstantMaxSeparate;r?(_[0]=S.lerp(m.x,p.x,Math.random()),_[1]=S.lerp(m.y,p.y,Math.random()),_[2]=S.lerp(m.z,p.z,Math.random())):(a.seed=o[4],_[0]=S.lerp(m.x,p.x,a.getFloat()),_[1]=S.lerp(m.y,p.y,a.getFloat()),_[2]=S.lerp(m.z,p.z,a.getFloat()),o[4]=a.seed)}else r?_[0]=_[1]=_[2]=S.lerp(t.startSizeConstantMin,t.startSizeConstantMax,Math.random()):(a.seed=o[4],_[0]=_[1]=_[2]=S.lerp(t.startSizeConstantMin,t.startSizeConstantMax,a.getFloat()),o[4]=a.seed)}var E=t.sizeOverLifetime;if(E&&E.enbale&&1===E.size.type){var v=E.size;if(v.separateAxes)r?(_[0]=_[0]*S.lerp(v.constantMinSeparate.x,v.constantMaxSeparate.x,Math.random()),_[1]=_[1]*S.lerp(v.constantMinSeparate.y,v.constantMaxSeparate.y,Math.random()),_[2]=_[2]*S.lerp(v.constantMinSeparate.z,v.constantMaxSeparate.z,Math.random())):(a.seed=o[11],_[0]=_[0]*S.lerp(v.constantMinSeparate.x,v.constantMaxSeparate.x,a.getFloat()),_[1]=_[1]*S.lerp(v.constantMinSeparate.y,v.constantMaxSeparate.y,a.getFloat()),_[2]=_[2]*S.lerp(v.constantMinSeparate.z,v.constantMaxSeparate.z,a.getFloat()),o[11]=a.seed);else{var g=0/0;r?g=S.lerp(v.constantMin,v.constantMax,Math.random()):(a.seed=o[11],g=S.lerp(v.constantMin,v.constantMax,a.getFloat()),o[11]=a.seed),_[0]=_[0]*g,_[1]=_[1]*g,_[2]=_[2]*g}}var T=n.renderMode;if(1!==T)switch(t.startRotationType){case 0:if(t.threeDStartRotation){var D=t.startRotationConstantSeparate,x=e._tempVector30.elements;e._randomInvertRoationArray(D.elements,x,t.randomizeRotationDirection,r?null:a,o),e.startRotation[0]=x[0],e.startRotation[1]=x[1],e.startRotation[2]=4!==T?-x[2]:x[2]}else e.startRotation[0]=e._randomInvertRoation(t.startRotationConstant,t.randomizeRotationDirection,r?null:a,o);break;case 2:if(t.threeDStartRotation){var M=t.startRotationConstantMinSeparate,R=t.startRotationConstantMaxSeparate,A=e._tempVector30.elements;r?(A[0]=S.lerp(M.x,R.x,Math.random()),A[1]=S.lerp(M.y,R.y,Math.random()),A[2]=S.lerp(M.z,R.z,Math.random())):(a.seed=o[5],A[0]=S.lerp(M.x,R.x,a.getFloat()),A[1]=S.lerp(M.y,R.y,a.getFloat()),A[2]=S.lerp(M.z,R.z,a.getFloat()),o[5]=a.seed),e._randomInvertRoationArray(A,A,t.randomizeRotationDirection,r?null:a,o),e.startRotation[0]=A[0],e.startRotation[1]=A[1],e.startRotation[2]=4!==T?-A[2]:A[2]}else r?e.startRotation[0]=e._randomInvertRoation(S.lerp(t.startRotationConstantMin,t.startRotationConstantMax,Math.random()),t.randomizeRotationDirection,r?null:a,o):(a.seed=o[5],e.startRotation[0]=e._randomInvertRoation(S.lerp(t.startRotationConstantMin,t.startRotationConstantMax,a.getFloat()),t.randomizeRotationDirection,r?null:a,o),o[5]=a.seed)}switch(t.startLifetimeType){case 0:e.startLifeTime=t.startLifetimeConstant;break;case 1:e.startLifeTime=e._getStartLifetimeFromGradient(t.startLifeTimeGradient,t.emissionTime);break;case 2:r?e.startLifeTime=S.lerp(t.startLifetimeConstantMin,t.startLifetimeConstantMax,Math.random()):(a.seed=o[7],e.startLifeTime=S.lerp(t.startLifetimeConstantMin,t.startLifetimeConstantMax,a.getFloat()),o[7]=a.seed);break;case 3:var I=t.emissionTime;r?e.startLifeTime=S.lerp(e._getStartLifetimeFromGradient(t.startLifeTimeGradientMin,I),e._getStartLifetimeFromGradient(t.startLifeTimeGradientMax,I),Math.random()):(a.seed=o[7],e.startLifeTime=S.lerp(e._getStartLifetimeFromGradient(t.startLifeTimeGradientMin,I),e._getStartLifetimeFromGradient(t.startLifeTimeGradientMax,I),a.getFloat()),o[7]=a.seed)}switch(t.startSpeedType){case 0:e.startSpeed=t.startSpeedConstant;break;case 2:r?e.startSpeed=S.lerp(t.startSpeedConstantMin,t.startSpeedConstantMax,Math.random()):(a.seed=o[8],e.startSpeed=S.lerp(t.startSpeedConstantMin,t.startSpeedConstantMax,a.getFloat()),o[8]=a.seed)}var y=t.textureSheetAnimation,C=y&&y.enable;if(C){var O=y.tiles,V=O.x,L=O.y,P=1/V,w=1/L,N=0,F=y.startFrame;switch(F.type){case 0:N=F.constant;break;case 1:r?N=S.lerp(F.constantMin,F.constantMax,Math.random()):(a.seed=o[14],N=S.lerp(F.constantMin,F.constantMax,a.getFloat()),o[14]=a.seed)}var b=y.frame;switch(b.type){case 0:N+=b.constant;break;case 2:r?N+=S.lerp(b.constantMin,b.constantMax,Math.random()):(a.seed=o[15],N+=S.lerp(b.constantMin,b.constantMax,a.getFloat()),o[15]=a.seed)}var B=0;switch(y.type){case 0:B=Math.floor(N/V);break;case 1:y.randomRow?r?B=Math.floor(Math.random()*L):(a.seed=o[13],B=Math.floor(a.getFloat()*L),o[13]=a.seed):B=y.rowIndex}var U=Math.floor(N%V);e.startUVInfo=e.startUVInfo,e.startUVInfo[0]=P,e.startUVInfo[1]=w,e.startUVInfo[2]=U*P,e.startUVInfo[3]=B*w}else e.startUVInfo=e.startUVInfo,e.startUVInfo[0]=1,e.startUVInfo[1]=1,e.startUVInfo[2]=0,e.startUVInfo[3]=0;switch(t.simulationSpace){case 0:var H=i.position.elements;e.simulationWorldPostion[0]=H[0],e.simulationWorldPostion[1]=H[1],e.simulationWorldPostion[2]=H[2];var G=i.rotation.elements;e.simulationWorldRotation[0]=G[0],e.simulationWorldRotation[1]=G[1],e.simulationWorldRotation[2]=G[2],e.simulationWorldRotation[3]=G[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}},e.startLifeTime=0/0,e.startSpeed=0/0,i(e,["_tempVector30",function(){return this._tempVector30=new On},"_tempQuaternion",function(){return this._tempQuaternion=new An},"startColor",function(){return this.startColor=new Float32Array(4)},"startSize",function(){return this.startSize=new Float32Array(3)},"startRotation",function(){return this.startRotation=new Float32Array(3)},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4)},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3)},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4)}]),e}(),lt=function(){function e(){}r(e,"laya.d3.core.PhasorSpriter3D");var t=e.prototype;return t.line=function(){},t.circle=function(){},t.plane=function(){},t.box=function(){},t.cone=function(){},t.boundingBoxLine=function(){},t.addVertex=function(){},t.addVertexIndex=function(){},t.addIndexes=function(){},t.begin=function(){},t.end=function(){},t.flush=function(){},t.addVertexIndexException=function(){},t.beginException0=function(){},t.beginException1=function(){},t.endException=function(){},t.drawLinesException=function(){},t.drawTrianglesException=function(){},i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(28,[new Mt(0,"vector3",0),new Mt(12,"vector4",1)])
}]),e}(),ut=function(){function e(){this._id=0,this._type=0,this._mainSortID=0,this._render=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._tempBatchIndexStart=0,this._tempBatchIndexEnd=0,this._canDynamicBatch=!1,this._shaderValue=null,this._onPreRenderFunction=null,this._id=++e._uniqueIDCounter,this._canDynamicBatch=!0,this._shaderValue=new bn}r(e,"laya.d3.core.render.RenderElement");var t=e.prototype;return t.getDynamicBatchBakedVertexs=function(e){for(var t=4,n=this._renderObj._getVertexBuffer(e),i=n.getData().slice(),r=n.vertexDeclaration,a=r.getVertexElementByUsage(0).offset/t,o=r.getVertexElementByUsage(3).offset/t,s=this._sprite3D.transform,l=s.worldMatrix,u=s.rotation,c=r.vertexStride/t,h=0,d=i.length;d>h;h+=c){var _=h+a,f=h+o;kn.transformVector3ArrayToVector3ArrayCoordinate(i,_,l,i,_),kn.transformVector3ArrayByQuat(i,f,u,i,f)}return i},t.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},t._destroy=function(){this._staticBatch&&this._staticBatch._manager._garbageCollection(this)},a(0,t,"id",function(){return this._id}),a(0,t,"renderObj",function(){return this._renderObj},function(e){this._renderObj!==e&&(this._renderObj=e)}),e._uniqueIDCounter=0,e}(),ct=function(){function e(t){this._id=0,this._needSort=!1,this._renderElements=null,this._renderableRenderObjects=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++e._uniqueIDCounter,this._needSort=!1,this._scene=t,this._renderElements=[],this._renderableRenderObjects=[],this._dynamicBatchCombineRenderElements=[]}r(e,"laya.d3.core.render.RenderQueue");var t=e.prototype;return t._sortOpaqueFunc=function(e,t){if(e._render&&t._render){var n=e._material.renderQueue-t._material.renderQueue;return 0===n?e._render._distanceForSort-t._render._distanceForSort:n}return 0},t._sortAlphaFunc=function(e,t){if(e._render&&t._render){var n=e._material.renderQueue-t._material.renderQueue;return 0===n?t._render._distanceForSort-e._render._distanceForSort:n}return 0},t._begainRenderElement=function(e,t){return t._beforeRender(e)?!0:!1},t._sortAlpha=function(t){e._cameraPosition=t,this._finalElements.sort(this._sortAlphaFunc)},t._sortOpaque=function(t){e._cameraPosition=t,this._finalElements.sort(this._sortOpaqueFunc)},t._preRender=function(){this._finalElements=this._renderElements.concat(this._dynamicBatchCombineRenderElements)},t._render=function(e,t){for(var n,i,r,a,o,s,l=C.loopCount,u=this._scene,c=e.camera,h=(c.id,!1),d=0,_=this._finalElements.length;_>d;d++){var f,m,p,E=this._finalElements[d];if(null!=E._onPreRenderFunction&&E._onPreRenderFunction.call(E._sprite3D,e),0===E._type){if(e.owner=p=E._sprite3D,e.renderElement=E,p._preRenderUpdateComponents(e),f=E.renderObj,m=E._material,this._begainRenderElement(e,f,m)){if(n=f._getVertexBuffers(),i=f._getVertexBuffer(0),r=i.vertexDeclaration,a=e._shader=m._getShader(u._shaderDefineValue,r.shaderDefineValue,p._shaderDefineValue),h=a.bind()||l!==a._uploadLoopCount,n){if(a._uploadVertexBuffer!==n||h){for(var v=0;v<n.length;v++){var g=n[v];a.uploadAttributesX(g.vertexDeclaration.shaderValues.data,g)}a._uploadVertexBuffer=n}}else(a._uploadVertexBuffer!==i||h)&&(a.uploadAttributes(r.shaderValues.data,null),a._uploadVertexBuffer=i);(a._uploadScene!==u||h)&&(a.uploadSceneUniforms(u._shaderValues.data),a._uploadScene=u),(c!==a._uploadCamera||a._uploadSprite3D!==p||h)&&(a.uploadSpriteUniforms(p._shaderValues.data),a._uploadSprite3D=p),(c!==a._uploadCamera||h)&&(a.uploadCameraUniforms(c._shaderValues.data),a._uploadCamera=c),(a._uploadMaterial!==m||h)&&(m._upload(),a._uploadMaterial=m),o!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,p.transform),o=m,s=p):s!==p&&(m._setRenderStateFrontFace(t,p.transform),s=p),f._render(e),a._uploadLoopCount=l}p._postRenderUpdateComponents(e)}else if(2===E._type){{E.renderObj}e.owner=p=E._sprite3D,e.renderElement=E,e._batchIndexStart=E._tempBatchIndexStart,e._batchIndexEnd=E._tempBatchIndexEnd,f=E.renderObj,m=E._material,this._begainRenderElement(e,f,m)&&(i=f._getVertexBuffer(0),r=i.vertexDeclaration,a=e._shader=m._getShader(u._shaderDefineValue,r.shaderDefineValue,p._shaderDefineValue),h=a.bind()||l!==a._uploadLoopCount,(a._uploadVertexBuffer!==i||h)&&(a.uploadAttributes(r.shaderValues.data,null),a._uploadVertexBuffer=i),(a._uploadScene!==u||h)&&(a.uploadSceneUniforms(u._shaderValues.data),a._uploadScene=u),(c!==a._uploadCamera||a._uploadSprite3D!==p||h)&&(a.uploadSpriteUniforms(p._shaderValues.data),a._uploadSprite3D=p),(c!==a._uploadCamera||h)&&(a.uploadCameraUniforms(c._shaderValues.data),a._uploadCamera=c),(a._uploadMaterial!==m||h)&&(m._upload(),a._uploadMaterial=m),o!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(t,p.transform),o=m,s=p):s!==p&&(m._setRenderStateFrontFace(t,p.transform),s=p),f._render(e),a._uploadLoopCount=l)}}},t._renderShadow=function(e,t){for(var n,i,r,a,o,s=C.loopCount,l=this._scene,u=e.camera,c=!1,h=0,d=this._finalElements.length;d>h;h++){var _,f,m,p=this._finalElements[h];0===p._type&&(e.owner=m=p._sprite3D,t||m._projectionViewWorldUpdateCamera===u&&m._projectionViewWorldUpdateLoopCount===C.loopCount||(m._render._renderUpdate(e._projectionViewMatrix),m._projectionViewWorldUpdateLoopCount=C.loopCount,m._projectionViewWorldUpdateCamera=u),e.renderElement=p,m._preRenderUpdateComponents(e),_=p.renderObj,f=p._material,this._begainRenderElement(e,_,null)&&(n=_._getVertexBuffer(0),i=n.vertexDeclaration,r=e._shader=f._getShader(l._shaderDefineValue,i.shaderDefineValue,m._shaderDefineValue),c=r.bind()||s!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||c)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(u!==r._uploadCamera||r._uploadSprite3D!==m||c)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(u!==r._uploadCamera||c)&&(r.uploadCameraUniforms(u._shaderValues.data),r._uploadCamera=u),(r._uploadMaterial!==f||c)&&(f._upload(),r._uploadMaterial=f),r._uploadRenderElement!==p||c,a!==f?(f._setRenderStateFrontFace(!1,m.transform),a=f,o=m):o!==m&&(f._setRenderStateFrontFace(!1,m.transform),o=m),_._render(e),r._uploadLoopCount=s),m._postRenderUpdateComponents(e))}},t._clearRenderElements=function(){this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},t._addRenderElement=function(e){this._renderElements.push(e),this._needSort=!0},t._addDynamicBatchElement=function(e){this._dynamicBatchCombineRenderElements.push(e)},a(0,t,"id",function(){return this._id}),e._uniqueIDCounter=0,e._cameraPosition=null,e}(),ht=function(){function e(){this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this._viewMatrix=null,this._projectionMatrix=null,this._projectionViewMatrix=null,this._viewport=null,this._shader=null,this.elapsedTime=0/0,this.scene=null,this.owner=null,this.renderElement=null,this.camera=null}return r(e,"laya.d3.core.render.RenderState"),e.clientWidth=0,e.clientHeight=0,e}(),dt=function(){function e(e,t){this._exactBox=null,this._relaxBox=null,this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new gn(new On,0),this._corners=[new On,new On,new On,new On,new On,new On,new On,new On],this._boundingBoxCenter=new On,this._children=o(8),this._objects=[],this._tempBoundBoxCorners=[new On,new On,new On,new On,new On,new On,new On,new On],this._scene=e,this._currentDepth=t}r(e,"laya.d3.core.scene.OctreeNode");var t=e.prototype;return n.imps(t,{"laya.d3.core.scene.ITreeNode":!0}),t.init=function(e,t){var n=new On,i=new On;On.scale(t,-.5,n),On.scale(t,.5,i),On.add(n,e,n),On.add(i,e,i),this.exactBox=new En(n,i),this.relaxBox=new En(n,i)},t.addTreeNode=function(e){1===Tn.boxContainsBox(this._relaxBox,e.boundingBox)?this.addNodeDown(e,0):this.addObject(e)},t.addChild=function(t){var n=this._children[t];if(null==n){n=new e(this._scene,this._currentDepth+1),this._children[t]=n,n._parent=this,On.subtract(this._exactBox.max,this._exactBox.min,e.tempSize),On.multiply(e.tempSize,e._octreeSplit[t],e.tempCenter),On.add(this._exactBox.min,e.tempCenter,e.tempCenter),On.scale(e.tempSize,.25,e.tempSize);var i=new On,r=new On;On.subtract(e.tempCenter,e.tempSize,i),On.add(e.tempCenter,e.tempSize,r),n.exactBox=new En(i,r),On.scale(e.tempSize,e.relax,e.tempSize);var a=new On,o=new On;On.subtract(e.tempCenter,e.tempSize,a),On.add(e.tempCenter,e.tempSize,o),n.relaxBox=new En(a,o)}return n},t.addObject=function(e){e._treeNode=this,this._objects.push(e)},t.removeObject=function(e){if(e._treeNode!=this)return console.log("OctreeNode::removeObject error"),!1;var t=this._objects.indexOf(e);return-1!==t?(this._objects.splice(t,1),!0):!1},t.clearObject=function(){this._objects.length=0},t.addNodeUp=function(e,t){this._parent&&1!==Tn.boxContainsBox(this._exactBox,e.boundingBox)?this._parent.addNodeUp(e,t-1):this.addNodeDown(e,t)},t.addNodeDown=function(e,t){if(t<this._scene.treeLevel){var n=this.inChildIndex(e.boundingBoxCenter),i=this.addChild(n);1===Tn.boxContainsBox(i._relaxBox,e.boundingBox)?i.addNodeDown(e,++t):this.addObject(e)}else this.addObject(e)},t.inChildIndex=function(e){var t=e.z<this._boundingBoxCenter.z?0:1,n=e.y<this._boundingBoxCenter.y?0:1,i=e.x<this._boundingBoxCenter.x?0:1;return 4*t+2*n+i},t.updateObject=function(e){1===Tn.boxContainsBox(this._relaxBox,e.boundingBox)?(this.removeObject(e),e._treeNode=null,this.addNodeDown(e,this._currentDepth)):this._parent&&(this.removeObject(e),e._treeNode=null,this._parent.addNodeUp(e,this._currentDepth-1))},t.cullingObjects=function(e,t,n,i,r){var a=0,o=0,s=0,l=0,u=this._scene._dynamicBatchManager;for(a=0,s=this._objects.length;s>a;a++){var c=this._objects[a];if(z.isVisible(c._owner.layer.mask)&&c.enable){if(t&&(C.treeSpriteCollision+=1,0===e.containsBoundSphere(c.boundingSphere)))continue;c._renderUpdate(r),c._distanceForSort=On.distance(c.boundingSphere.center,i)+c.sortingFudge;var h=c._renderElements;for(o=0,l=h.length;l>o;o++){var d=h[o],_=d._staticBatch;if(_&&_._material===d._material)_._addBatchRenderElement(d);else{var f=d.renderObj;f.triangleCount<10&&1===f._vertexBufferCount&&f._getIndexBuffer()&&d._material.renderQueue<2&&d._canDynamicBatch&&!c._owner.isStatic?u._addPrepareRenderElement(d):this._scene.getRenderQueue(d._material.renderQueue)._addRenderElement(d)}}}}for(a=0;8>a;a++){var m=this._children[a];if(null!=m){var p=t;if(t){var E=e.containsBoundBox(m._relaxBox);if(C.treeNodeCollision+=1,0===E)continue;p=2===E}m.cullingObjects(e,p,n,i,r)}}},t.cullingShadowObjects=function(e,t,n,i,r){{var a=0,o=0,s=0,l=0;this._scene._dynamicBatchManager}for(a=0,s=this._objects.length;s>a;a++){var u=this._objects[a];if(u.castShadow&&z.isVisible(u._owner.layer.mask)&&u.enable){if(n&&0===e[0].containsBoundSphere(u.boundingSphere))continue;for(var c=1,h=e.length;h>c;c++){var d=t[c-1];if(0!==e[c].containsBoundSphere(u.boundingSphere)){var _=u._renderElements;for(o=0,l=_.length;l>o;o++)d._addRenderElement(_[o])}}}}for(a=0;8>a;a++){var f=this._children[a];if(null!=f){var m=n;if(n){var p=e[0].containsBoundBox(f._relaxBox);if(0===p)continue;m=2===p}f.cullingShadowObjects(e,t,m,i,r)}}},t.cullingShadowObjectsOnePSSM=function(e,t,n,i,r,a){var o=t[0],s=0,l=0,u=0,c=0;for(s=0,u=this._objects.length;u>s;s++){var h=this._objects[s];if(h.castShadow&&z.isVisible(h._owner.layer.mask)&&h.enable){if(i&&0===e.containsBoundSphere(h.boundingSphere))continue;h._renderUpdate(n);var d=h._renderElements;for(l=0,c=d.length;c>l;l++)o._addRenderElement(d[l])}}for(s=0;8>s;s++){var _=this._children[s];if(null!=_){var f=i;if(i){var m=e.containsBoundBox(_._relaxBox);if(0===m)continue;f=2===m}_.cullingShadowObjectsOnePSSM(e,t,n,f,r,a)}}},t.renderBoudingBox=function(e){this._renderBoudingBox(e);for(var t=0;8>t;++t){var n=this._children[t];n&&n.renderBoudingBox(e)}},t.buildAllChild=function(e){if(e<this._scene.treeLevel)for(var t=0;8>t;t++){var n=this.addChild(t);n.buildAllChild(e+1)}},t._renderBoudingBox=function(){},a(0,t,"exactBox",function(){return this._exactBox},function(e){this._exactBox=e,On.add(e.min,e.max,this._boundingBoxCenter),On.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),a(0,t,"relaxBox",function(){return this._relaxBox},function(e){this._relaxBox=e,e.getCorners(this._corners),gn.createfromPoints(this._corners,this._boundingSphere)}),e.debugMode=!1,e.relax=1.15,e.CHILDNUM=8,i(e,["tempVector0",function(){return this.tempVector0=new On},"tempSize",function(){return this.tempSize=new On},"tempCenter",function(){return this.tempCenter=new On},"_octreeSplit",function(){return this._octreeSplit=[new On(.25,.25,.25),new On(.75,.25,.25),new On(.25,.75,.25),new On(.75,.75,.25),new On(.25,.25,.75),new On(.75,.25,.75),new On(.25,.75,.75),new On(.75,.75,.75)]}]),e}(),_t=(function(){function e(){}return r(e,"laya.d3.core.scene.SceneManager"),e}(),function(){function e(e,t,n,i){this._r=0/0,this._g=0/0,this._b=0/0,this._a=0/0,void 0===e&&(e=1),void 0===t&&(t=1),void 0===n&&(n=1),void 0===i&&(i=1),this._r=e,this._g=t,this._b=n,this._a=i}r(e,"laya.d3.core.trail.module.Color",null,"Color$1");var t=e.prototype;return t.cloneTo=function(e){e._r=this._r,e._g=this._g,e._b=this._b,e._a=this._a},i(e,["RED",function(){return this.RED=new e(1,0,0,1)},"GREEN",function(){return this.GREEN=new e(0,1,0,1)},"BLUE",function(){return this.BLUE=new e(0,0,1,1)},"CYAN",function(){return this.CYAN=new e(0,1,1,1)},"YELLOW",function(){return this.YELLOW=new e(1,.92,.016,1)},"MAGENTA",function(){return this.MAGENTA=new e(1,0,1,1)},"GRAY",function(){return this.GRAY=new e(.5,.5,.5,1)},"WHITE",function(){return this.WHITE=new e(1,1,1,1)},"BLACK",function(){return this.BLACK=new e(0,0,0,1)}]),e}()),ft=function(){function e(){this._mode=0,this._colorKeys=null,this._alphaKeys=null,this.index=0,this._colorKeyData=new Float32Array(40),this._alphaKeyData=new Float32Array(20),this._colorKeys=[],this._alphaKeys=[]}r(e,"laya.d3.core.trail.module.Gradient");var t=e.prototype;return t.setKeys=function(e,t){this._colorKeys=e,this.index=0;for(var n,i=0;i<e.length;i++){n=e[i];var r=n.color;this._colorKeyData[this.index++]=r._r,this._colorKeyData[this.index++]=r._g,this._colorKeyData[this.index++]=r._b,this._colorKeyData[this.index++]=n.time}this._alphaKeys=t,this.index=0;for(var a,o=0;o<t.length;o++)a=t[o],this._alphaKeyData[this.index++]=a.alpha,this._alphaKeyData[this.index++]=a.time},t.cloneTo=function(e){var t=0,n=0,i=this.colorKeys,r=[];for(t=0,n=i.length;n>t;t++){var a=new pt;i[t].cloneTo(a),r.push(a)}var o=this.alphaKeys,s=[];for(t=0,n=o.length;n>t;t++){var l=new mt;o[t].cloneTo(l),s.push(l)}e.setKeys(r,s)},a(0,t,"mode",function(){return this._mode},function(e){this._mode=e}),a(0,t,"colorKeys",function(){return this._colorKeys},function(e){this._colorKeys=e,this.index=0;for(var t=0;t<e.length;t++){var n=e[t],i=n.color;this._colorKeyData[this.index++]=i._r,this._colorKeyData[this.index++]=i._g,this._colorKeyData[this.index++]=i._b,this._colorKeyData[this.index++]=n.time}}),a(0,t,"alphaKeys",function(){return this._alphaKeys},function(e){this._alphaKeys=e,this.index=0;for(var t=0;t<e.length;t++){var n=e[t];this._alphaKeyData[this.index++]=n.alpha,this._alphaKeyData[this.index++]=n.time}}),e}(),mt=function(){function e(e,t){this._alpha=0/0,this._time=0/0,void 0===e&&(e=0),void 0===t&&(t=0),this._alpha=e,this._time=t}r(e,"laya.d3.core.trail.module.GradientAlphaKey");var t=e.prototype;return t.cloneTo=function(e){e.alpha=this.alpha,e.time=this.time},a(0,t,"alpha",function(){return this._alpha},function(e){this._alpha=e}),a(0,t,"time",function(){return this._time},function(e){this._time=e}),e}(),pt=function(){function e(e,t){this._color=null,this._time=0/0,void 0===t&&(t=0),this._color=e||new _t,this._time=t}r(e,"laya.d3.core.trail.module.GradientColorKey");var t=e.prototype;return t.cloneTo=function(e){this.color.cloneTo(e.color),e.time=this.time},a(0,t,"color",function(){return this._color},function(e){this._color=e}),a(0,t,"time",function(){return this._time},function(e){this._time=e}),e}(),Et=(function(){function e(){}return r(e,"laya.d3.core.trail.module.GradientMode"),e.Blend=0,e.Fixed=1,e}(),function(){function e(){}return r(e,"laya.d3.core.trail.module.TextureMode"),e.Stretch=0,e.Tile=1,e}(),function(){function e(){this.time=0/0,this.inTangent=0/0,this.outTangent=0/0,this.value=0/0}r(e,"laya.d3.core.trail.module.TrailKeyFrame");var t=e.prototype;return t.cloneTo=function(e){e.time=this.time,e.inTangent=this.inTangent,e.outTangent=this.outTangent,e.value=this.value},e}()),vt=(function(){function e(){}r(e,"laya.d3.core.trail.TrailRenderElement");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0}),t._updateTrail=function(){},t._addTrailByFirstPosition=function(){},t._addTrailByNextPosition=function(){},t._updateVerticesByPosition=function(){},t._updateVertexBuffer2=function(){},t._onTrailRenderElementFinish=function(){},t._updateDisappear=function(){},t._beforeRender=function(){},t._render=function(){},t._getVertexBuffer=function(){},t._getVertexBuffers=function(){},t._getIndexBuffer=function(){},t.reActivate=function(){},t._destroy=function(){},a(0,t,"_vertexBufferCount",function(){}),a(0,t,"triangleCount",function(){return 0}),e.renderElementCount=0,e}(),function(){function e(){}r(e,"laya.d3.core.trail.VertexTrail");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration1}),a(1,e,"vertexDeclaration1",function(){return e._vertexDeclaration1}),a(1,e,"vertexDeclaration2",function(){return e._vertexDeclaration2}),i(e,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new xt(32,[new Mt(0,"vector3",0),new Mt(12,"vector3",41),new Mt(24,"single",33),new Mt(28,"single",40)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new xt(4,[new Mt(0,"single",38)])}]),e}(),function(){function e(){this.position=On.ZERO,this.rotation=An.DEFAULT,this.scale=new On(.3,.6,.1)}return r(e,"laya.d3.extension.domino.DominoKeyFrame"),e}(),function(){function e(){}r(e,"laya.d3.extension.domino.DominoRenderElement");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0}),t.addDomino=function(){},t.updateDomino=function(){},t.updateDominos=function(){},t.addDataForVertexBuffer1=function(){},t.addDataForVertexBuffer2=function(){},t.addDataForIndexBuffer=function(){},t.addDataForVertices1=function(){},t._beforeRender=function(){},t._render=function(){},t._getIndexBuffer=function(){},t._getVertexBuffer=function(){},t._getVertexBuffers=function(){},t._getIndexBuffer=function(){},a(0,t,"_vertexBufferCount",function(){}),a(0,t,"triangleCount",function(){}),e.renderElementCount=0,e}(),function(){function e(){}r(e,"laya.d3.extension.domino.DominoVertex");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration1}),a(1,e,"vertexDeclaration1",function(){return e._vertexDeclaration1}),a(1,e,"vertexDeclaration2",function(){return e._vertexDeclaration2}),i(e,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new xt(16,[new Mt(0,"vector4",1)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new xt(24,[new Mt(0,"vector3",0),new Mt(12,"vector3",3)])}]),e}(),function(){function e(){}r(e,"laya.d3.extension.lineRender.LineVertex");var t=e.prototype;return a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration1}),a(1,e,"vertexDeclaration1",function(){return e._vertexDeclaration1}),a(1,e,"vertexDeclaration2",function(){return e._vertexDeclaration2}),a(1,e,"vertexDeclaration3",function(){return e._vertexDeclaration3}),i(e,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new xt(16,[new Mt(0,"vector3",0),new Mt(12,"single",40)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new xt(12,[new Mt(0,"vector3",41)])},"_vertexDeclaration3",function(){return this._vertexDeclaration3=new xt(8,[new Mt(0,"single",38),new Mt(4,"single",39)])}]),e}(),function(){function e(e){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=e}r(e,"laya.d3.graphics.DynamicBatch");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._getCombineRenderElementFromPool=function(e,t,n){var i=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return i||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=i=new ut,i._sprite3D=new sr),i._sprite3D._render._renderUpdate(n),i},t._getRenderElement=function(t,n,i){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*e.maxVertexCount),this._indexDatas=new Uint16Array(e.maxIndexCount),this._vertexBuffer=Bi.create(this._vertexDeclaration,e.maxVertexCount,35048),this._indexBuffer=Fi.create("ushort",e.maxIndexCount,35048)),this._merageElements.length=0;for(var r=0,a=0,o=0,s=this._combineRenderElements.length;s>o;o++){var l=this._combineRenderElements[o],u=l.getDynamicBatchBakedVertexs(0),c=l.getBakedIndices(),h=l._sprite3D.transform._isFrontFaceInvert,d=r/(this._vertexDeclaration.vertexStride/4),_=a,f=_+c.length;l._tempBatchIndexStart=_,l._tempBatchIndexEnd=f,this._indexDatas.set(c,a);var m=0;if(h)for(m=_;f>m;m+=3){this._indexDatas[m]=d+this._indexDatas[m];var p=this._indexDatas[m+1],E=this._indexDatas[m+2];this._indexDatas[m+1]=d+E,this._indexDatas[m+2]=d+p}else for(m=_;f>m;m+=3)this._indexDatas[m]=d+this._indexDatas[m],this._indexDatas[m+1]=d+this._indexDatas[m+1],this._indexDatas[m+2]=d+this._indexDatas[m+2];a+=c.length,this._vertexDatas.set(u,r),r+=u.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),this._combineRenderElementPoolIndex=0,o=0,s=this._materials.length;s>o;o++){var v=this._getCombineRenderElementFromPool(t,n,i);v._type=2,v._staticBatch=null,v.renderObj=this;var g=this._combineRenderElements[this._materialToRenderElementsOffsets[o]]._tempBatchIndexStart,T=o+1===this._materialToRenderElementsOffsets.length?a:this._combineRenderElements[this._materialToRenderElementsOffsets[o+1]]._tempBatchIndexStart;v._tempBatchIndexStart=g,v._tempBatchIndexEnd=T,v._material=this._materials[o],this._merageElements.push(v)}},t._addCombineRenderObjTest=function(t){var n=t.renderObj,i=this._currentCombineIndexCount+n._getIndexBuffer().indexCount,r=this._currentCombineVertexCount+n._getVertexBuffer().vertexCount;return r>e.maxVertexCount||i>e.maxIndexCount?!1:!0},t._addCombineRenderObj=function(e){var t=e.renderObj;this._combineRenderElements.push(e),this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount},t._addCombineMaterial=function(e){this._materials.push(e)},t._addMaterialToRenderElementOffset=function(e){this._materialToRenderElementsOffsets.push(e)},t._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},t._addToRenderQueue=function(e,t,n,i){this._getRenderElement(t,n,i);for(var r=0,a=this._materials.length;a>r;r++)e.getRenderQueue(this._materials[r].renderQueue)._addDynamicBatchElement(this._merageElements[r])},t._beforeRender=function(){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t=e._batchIndexEnd-e._batchIndexStart;P.mainContext.drawElements(4,t,5123,2*e._batchIndexStart),C.drawCall++,C.trianglesFaces+=t/3},t._getVertexBuffers=function(){return null},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,t,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),e.maxVertexCount=2e4,e.maxIndexCount=4e4,e.maxCombineTriangleCount=10,e}()),gt=function(){function e(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}r(e,"laya.d3.graphics.DynamicBatchManager");var t=e.prototype;return t.getDynamicBatch=function(e,t){var n,i=e.id.toString()+t;return this._dynamicBatches[i]?n=this._dynamicBatches[i]:this._dynamicBatches[i]=n=new vt(e),n},t._garbageCollection=function(){for(var e in this._dynamicBatches)0===this._dynamicBatches[e].combineRenderElementsCount&&delete this._dynamicBatches[e]},t._addPrepareRenderElement=function(e){this._prepareDynamicBatchCombineElements.push(e)},t._finishCombineDynamicBatch=function(t){this._prepareDynamicBatchCombineElements.sort(e._sortPrepareDynamicBatch);for(var n,i,r,a,o,s,l,u,c=-1,h=!0,d=0,_=-1,f=0,m=this._prepareDynamicBatchCombineElements.length;m>f;f++){o=this._prepareDynamicBatchCombineElements[f];var p=o.renderObj._getVertexBuffer(0).vertexDeclaration,E=i!==p;E&&(d=0,i=p);var v=d!==c;if(v&&(c=d),(E||v)&&(s=this.getDynamicBatch(p,d),n=null),h)if(s._addCombineRenderObjTest(o)){if(a=o._material,n!==a)l&&(t.getRenderQueue(u._material.renderQueue)._addRenderElement(u),l=null,u=null,_=-1),l=a,_=s.combineRenderElementsCount,u=o,n=a;else if(l){var g=u.renderObj,T=o.renderObj;g._getVertexBuffer().vertexCount+T._getVertexBuffer().vertexCount>vt.maxVertexCount||g._getIndexBuffer().indexCount+T._getIndexBuffer().indexCount>vt.maxIndexCount?(t.getRenderQueue(u._material.renderQueue)._addRenderElement(u),l=a,_=s.combineRenderElementsCount,u=o):(s._addCombineMaterial(l),s._addMaterialToRenderElementOffset(_),s._addCombineRenderObj(u),l=null,u=null,_=-1,s._addCombineRenderObj(o))}else s._addCombineRenderObj(o);h=!0}else l&&(t.getRenderQueue(u._material.renderQueue)._addRenderElement(u),l=null,u=null,_=-1),d++,h=!1;else r=this._prepareDynamicBatchCombineElements[f-1],s._addMaterialToRenderElementOffset(s.combineRenderElementsCount),n=r._material,s._addCombineMaterial(n),s._addCombineRenderObj(r),h=!0,a=o._material,n!==a?(l=a,_=s.combineRenderElementsCount,u=o):s._addCombineRenderObj(o),n=a}l&&(t.getRenderQueue(u._material.renderQueue)._addRenderElement(u),l=null,u=null,_=-1),this._prepareDynamicBatchCombineElements.length=0},t._clearRenderElements=function(){for(var e in this._dynamicBatches)this._dynamicBatches[e]._clearRenderElements()},t._addToRenderQueue=function(e,t,n,i){for(var r in this._dynamicBatches){var a=this._dynamicBatches[r];a.combineRenderElementsCount>0&&a._addToRenderQueue(e,t,n,i)}},t.dispose=function(){this._dynamicBatches=null},e._sortPrepareDynamicBatch=function(e,t){return e._mainSortID-t._mainSortID},e}(),Tt=function(){function e(){}return r(e,"laya.d3.graphics.FrustumCulling"),e.renderShadowObjectCulling=function(e,t,n,i,r){var a=0,o=0,s=0,l=0;for(a=0,s=n.length;s>a;a++){var u=n[a];u&&u._clearRenderElements()}var c,h,d,_=e._cullingRenders;if(r>1){for(a=0,s=e._cullingRendersLength;s>a;a++)if(c=_[a],c.castShadow&&z.isVisible(c._owner.layer.mask)&&c.enable)for(var f=1,m=t.length;m>f;f++)if(h=n[f-1],0!==t[f].containsBoundSphere(c.boundingSphere))for(d=c._renderElements,o=0,l=d.length;l>o;o++)h._addRenderElement(d[o])}else for(a=0,s=e._cullingRendersLength;s>a;a++)if(c=_[a],c.castShadow&&z.isVisible(c._owner.layer.mask)&&c.enable&&0!==t[0].containsBoundSphere(c.boundingSphere))for(c._renderUpdate(i),h=n[0],d=c._renderElements,o=0,l=d.length;l>o;o++)h._addRenderElement(d[o])},e.renderShadowObjectCullingOctree=function(e,t,n,i,r){for(var a=0,o=n.length;o>a;a++){var s=n[a];s&&s._clearRenderElements()}r>1?e.treeRoot.cullingShadowObjects(t,n,!0,0,e):e.treeRoot.cullingShadowObjectsOnePSSM(t[0],n,i,!0,0,e)},e.renderObjectCulling=function(e,t,n,i,r,a){var o=0,s=0,l=0,u=0,c=t._quenes,h=t._dynamicBatchManager,d=t._cullingRenders;for(o=0,s=c.length;s>o;o++){var _=c[o];_&&_._clearRenderElements()}var f=St._staticBatchManagers;for(o=0,s=f.length;s>o;o++)f[o]._clearRenderElements();h._clearRenderElements();var m=n.transform.position;for(o=0,s=t._cullingRendersLength;s>o;o++){var p=d[o];if(z.isVisible(p._owner.layer.mask)&&p.enable&&0!==e.containsBoundSphere(p.boundingSphere)&&p._renderUpdate(a)){p._distanceForSort=On.distance(p.boundingSphere.center,m)+p.sortingFudge;var E=p._renderElements;for(l=0,u=E.length;u>l;l++){var v=E[l],g=v._staticBatch;if(g&&g._material===v._material)g._addBatchRenderElement(v);else{var T=v.renderObj;T.triangleCount<10&&1===T._vertexBufferCount&&T._getIndexBuffer()&&v._material.renderQueue<2&&v._canDynamicBatch&&!p._owner.isStatic?h._addPrepareRenderElement(v):t.getRenderQueue(v._material.renderQueue)._addRenderElement(v)}}}}for(o=0,s=f.length;s>o;o++)f[o]._addToRenderQueue(t,i,r,a);h._finishCombineDynamicBatch(t),h._addToRenderQueue(t,i,r,a)},e.renderObjectCullingOctree=function(e,t,n,i,r,a){var o=0,s=0,l=t._quenes,u=t._dynamicBatchManager;for(o=0,s=l.length;s>o;o++){var c=l[o];c&&c._clearRenderElements()}var h=St._staticBatchManagers;for(o=0,s=h.length;s>o;o++)h[o]._clearRenderElements();for(u._clearRenderElements(),t._cullingRenders.length=0,t.treeRoot.cullingObjects(e,!0,0,n.transform.position,a),o=0,s=h.length;s>o;o++)h[o]._addToRenderQueue(t,i,r,a);u._finishCombineDynamicBatch(t),u._addToRenderQueue(t,i,r,a)},e.renderObjectCullingNoBoundFrustum=function(e,t,n,i,r){var a=0,o=0,s=0,l=0,u=e._quenes,c=e._dynamicBatchManager,h=e._cullingRenders;for(a=0,o=u.length;o>a;a++){var d=u[a];d&&d._clearRenderElements()}var _=St._staticBatchManagers;for(a=0,o=_.length;o>a;a++)_[a]._clearRenderElements();c._clearRenderElements();var f=t.transform.position;for(a=0,o=e._cullingRendersLength;o>a;a++){var m=h[a];if(z.isVisible(m._owner.layer.mask)&&m.enable){m._renderUpdate(r),m._distanceForSort=On.distance(m.boundingSphere.center,f)+m.sortingFudge;var p=m._renderElements;for(s=0,l=p.length;l>s;s++){var E=p[s],v=E._staticBatch;if(v&&v._material===E._material)v._addBatchRenderElement(E);else{var g=E.renderObj;g.triangleCount<10&&1===g._vertexBufferCount&&g._getIndexBuffer()&&E._material.renderQueue<2&&E._canDynamicBatch&&!m._owner.isStatic?c._addPrepareRenderElement(E):e.getRenderQueue(E._material.renderQueue)._addRenderElement(E)}}}}for(a=0,o=_.length;o>a;a++)_[a]._addToRenderQueue(e,n,i,r);c._finishCombineDynamicBatch(e),c._addToRenderQueue(e,n,i,r)},e}(),St=function(){function e(){this._initBatchRenderElements=null,this._staticBatches=null,this._initBatchRenderElements=[],this._staticBatches={}}r(e,"laya.d3.graphics.StaticBatchManager");var t=e.prototype;return t._finishInit=function(){for(var e in this._staticBatches)this._staticBatches[e]._finishInit();this._initBatchRenderElements.length=0},t._initStaticBatchs=function(){throw new Error("StaticBatchManager:must override this function.")},t._addInitBatchSprite=function(e){for(var t=e._render._renderElements,n=0,i=t.length;i>n;n++)this._initBatchRenderElements.push(t[n])},t._clearRenderElements=function(){for(var e in this._staticBatches)this._staticBatches[e]._clearRenderElements()},t._garbageCollection=function(e){var t=e._staticBatch,n=t._initBatchRenderElements,i=n.indexOf(e);n.splice(i,1),0===n.length&&(t.dispose(),delete this._staticBatches[t._key])},t._addToRenderQueue=function(e,t,n,i){for(var r in this._staticBatches){var a=this._staticBatches[r];a._batchRenderElements.length>0&&a._updateToRenderQueue(e,i)}},t.dispose=function(){this._staticBatches=null},e._addToStaticBatchQueue=function(t){t instanceof laya.d3.core.RenderableSprite3D&&t._addToInitStaticBatchManager();
for(var n=0,i=t.numChildren;i>n;n++)e._addToStaticBatchQueue(t._childs[n])},e.combine=function(t,n){var i,r=0,a=0;if(n)for(r=0,a=n.length;a>r;r++){var o=n[r];o._addToInitStaticBatchManager()}else t&&e._addToStaticBatchQueue(t);for(r=0,a=e._staticBatchManagers.length;a>r;r++)i=e._staticBatchManagers[r],i._initStaticBatchs(t),i._finishInit()},e._staticBatchManagers=[],e}(),Dt=function(){function e(e,t,n){this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=null,this._initBatchRenderElements=null,this._batchRenderElements=null,this._material=null,this._rootOwner=null,this._key=null,this._manager=null,this._key=e,this._manager=t,this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=[],this._initBatchRenderElements=[],this._batchRenderElements=[],this._rootOwner=n}r(e,"laya.d3.graphics.StaticBatch");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),t._binarySearch=function(e){for(var t=0,n=this._batchRenderElements.length-1,i=0;n>=t;)i=Math.floor((t+n)/2),this._compareBatchRenderElement(this._batchRenderElements[i],e)?n=i-1:t=i+1;return t},t._compareBatchRenderElement=function(){throw new Error("StaticBatch:must override this function.")},t._getVertexDecLightMap=function(e){return e===nn.vertexDeclaration?Qt.vertexDeclaration:e===tn.vertexDeclaration?qt.vertexDeclaration:e===kt.vertexDeclaration?Ut.vertexDeclaration:e===sn.vertexDeclaration?null:e===wt.vertexDeclaration?Nt.vertexDeclaration:e===an.vertexDeclaration?Jt.vertexDeclaration:e===Kt.vertexDeclaration?jt.vertexDeclaration:e===rn.vertexDeclaration?$t.vertexDeclaration:e===tn.vertexDeclaration?qt.vertexDeclaration:e===Xt.vertexDeclaration?Ht.vertexDeclaration:e===sn.vertexDeclaration?null:e===wt.vertexDeclaration?Nt.vertexDeclaration:e===on.vertexDeclaration?en.vertexDeclaration:e===Kt.vertexDeclaration?jt.vertexDeclaration:e},t._getCombineRenderElementFromPool=function(){throw new Error("StaticBatch:must override this function.")},t._addBatchRenderElement=function(e){this._batchRenderElements.splice(this._binarySearch(e),0,e)},t._updateToRenderQueue=function(e,t){this._combineRenderElementPoolIndex=0,this._getRenderElement(e.getRenderQueue(this._material.renderQueue)._renderElements,e,t)},t._getRenderElement=function(){throw new Error("StaticBatch:must override this function.")},t._finishInit=function(){throw new Error("StaticBatch:must override this function.")},t._clearRenderElements=function(){this._batchRenderElements.length=0},t.dispose=function(){},t._getVertexBuffer=function(e){return void 0===e&&(e=0),null},t._getIndexBuffer=function(){return null},t._beforeRender=function(){return!0},t._render=function(){},t._getVertexBuffers=function(){return null},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"triangleCount",function(){return 0}),e.combine=function(e){console.log("StaticBatch: discard property,please use StaticBatchManager.combine() function instead."),St.combine(e)},e.maxBatchVertexCount=65535,e}(),xt=function(){function e(t,n){if(this._id=0,this._shaderValues=null,this._shaderDefineValue=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._id=++e._uniqueIDCounter,this._id>e.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",e.maxVertexDeclaration);this._shaderValues=new bn,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=n;for(var i=0;i<n.length;i++){var r=n[i],a=r.elementUsage;this._vertexElementsDic[a]=r;var o=[e._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];switch(this._shaderValues.setValue(a,o),a){case 1:this._addShaderDefine(ri.SHADERDEFINE_COLOR);break;case 2:this._addShaderDefine(ri.SHADERDEFINE_UV0);break;case 15:this._addShaderDefine(ri.SHADERDEFINE_UV1)}}}r(e,"laya.d3.graphics.VertexDeclaration");var t=e.prototype;return t._addShaderDefine=function(e){this._shaderDefineValue|=e},t._removeShaderDefine=function(e){this._shaderDefineValue&=~e},t.getVertexElements=function(){return this._vertexElements.slice()},t.getVertexElementByUsage=function(e){return this._vertexElementsDic[e]},t.unBinding=function(){},a(0,t,"shaderDefineValue",function(){return this._shaderDefineValue}),a(0,t,"id",function(){return this._id}),a(0,t,"vertexStride",function(){return this._vertexStride}),a(0,t,"shaderValues",function(){return this._shaderValues}),e._getTypeSize=function(e){switch(e){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"color":return 4;case"byte4":return 4;case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},e.getVertexStride=function(t){for(var n=0,i=0;i<t.Length;i++){var r=t[i],a=r.offset+e._getTypeSize(r.elementFormat);a>n&&(n=a)}return n},e._maxVertexDeclarationBit=1e3,e._uniqueIDCounter=1,i(e,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),e}(),Mt=function(){function e(e,t,n){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=e,this.elementFormat=t,this.elementUsage=n}return r(e,"laya.d3.graphics.VertexElement"),e}(),Rt=(function(){function e(){}return r(e,"laya.d3.graphics.VertexElementFormat"),e.Single="single",e.Vector2="vector2",e.Vector3="vector3",e.Vector4="vector4",e.Color="color",e.Byte4="byte4",e.Short2="short2",e.Short4="short4",e.NormalizedShort2="normalizedshort2",e.NormalizedShort4="normalizedshort4",e.HalfVector2="halfvector2",e.HalfVector4="halfvector4",e}(),function(){function e(){}return r(e,"laya.d3.graphics.VertexElementUsage"),e.POSITION0=0,e.COLOR0=1,e.TEXTURECOORDINATE0=2,e.NORMAL0=3,e.BINORMAL0=4,e.TANGENT0=5,e.BLENDINDICES0=6,e.BLENDWEIGHT0=7,e.DEPTH0=8,e.FOG0=9,e.POINTSIZE0=10,e.SAMPLE0=11,e.TESSELLATEFACTOR0=12,e.COLOR1=13,e.NEXTTEXTURECOORDINATE0=14,e.TEXTURECOORDINATE1=15,e.NEXTTEXTURECOORDINATE1=16,e.CORNERTEXTURECOORDINATE0=17,e.VELOCITY0=18,e.STARTCOLOR0=19,e.STARTSIZE=20,e.AGEADDSCALE0=21,e.STARTROTATION=22,e.ENDCOLOR0=23,e.STARTLIFETIME=24,e.TIME0=33,e.SHAPEPOSITIONSTARTLIFETIME=30,e.DIRECTIONTIME=32,e.SIZEROTATION0=27,e.RADIUS0=28,e.RADIAN0=29,e.STARTSPEED=31,e.RANDOM0=34,e.RANDOM1=35,e.SIMULATIONWORLDPOSTION=36,e.SIMULATIONWORLDROTATION=37,e.TEXTURECOORDINATE0X=38,e.TEXTURECOORDINATE0X1=39,e.TEXTURECOORDINATE0Y=40,e.OFFSETVECTOR=41,e}(),function(){function e(e,t,n){this._position=null,this._textureCoordinate0=null,this._time=0/0,this._position=e,this._textureCoordinate0=t,this._time=n}r(e,"laya.d3.graphics.VertexGlitter");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate0}),a(0,t,"position",function(){return this._position}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(24,[new Mt(0,"vector3",0),new Mt(12,"vector2",2),new Mt(20,"single",33)])}]),e}()),At=(function(){function e(e,t,n,i,r,a,o,s,l,u){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=0/0,this._time=0/0,this._cornerTextureCoordinate=e,this._position=t,this._velocity=n,this._startColor=i,this._endColor=r,this._sizeRotation=a,this._radius=o,this._radian=s,this._ageAddScale=l,this._time=u}r(e,"laya.d3.graphics.VertexParticle");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"endColor",function(){return this._endColor}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"sizeRotation",function(){return this._sizeRotation}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"position",function(){return this._position}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"radius",function(){return this._radius}),a(0,t,"radian",function(){return this._radian}),a(0,t,"ageAddScale",function(){return this._ageAddScale}),a(0,t,"time",function(){return this._time}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(116,[new Mt(0,"vector4",17),new Mt(16,"vector3",0),new Mt(28,"vector3",18),new Mt(40,"vector4",19),new Mt(56,"vector4",23),new Mt(72,"vector3",27),new Mt(84,"vector2",28),new Mt(92,"vector4",29),new Mt(108,"single",24),new Mt(112,"single",33)])}]),e}(),function(){function e(e){this._position=null,this._position=e}r(e,"laya.d3.graphics.VertexPosition");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(12,[new Mt(0,"vector3",0)])}]),e}()),It=function(){function e(e,t){this._position=null,this._normal=null,this._position=e,this._normal=t}r(e,"laya.d3.graphics.VertexPositionNormal");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(24,[new Mt(0,"vector3",0),new Mt(12,"vector3",3)])}]),e}(),yt=function(){function e(e,t,n){this._position=null,this._normal=null,this._color=null,this._position=e,this._normal=t,this._color=n}r(e,"laya.d3.graphics.VertexPositionNormalColor");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(40,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1)])}]),e}(),Ct=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._blendIndex=i,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalColorSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(72,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector4",7),new Mt(56,"vector4",6)])}]),e}(),Ot=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorSkinSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(88,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector4",7),new Mt(56,"vector4",6),new Mt(72,"vector4",5)])}]),e}(),Vt=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(84,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector4",7),new Mt(56,"vector4",6),new Mt(72,"vector3",5)])}]),e}(),Lt=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalColorSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(56,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector4",5)])}]),e}(),Pt=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalColorTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(52,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector3",5)])}]),e}(),wt=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(48,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2)])}]),e}(),Nt=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(56,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector2",15)])}]),e}(),Ft=function(){function e(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=o}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(88,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector2",15),new Mt(56,"vector4",7),new Mt(72,"vector4",6)])}]),e}(),bt=function(){function e(e,t,n,i,r,a,o,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=o,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(104,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector2",15),new Mt(56,"vector4",7),new Mt(72,"vector4",6),new Mt(88,"vector4",5)])}]),e}(),Bt=function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0SkinTangent=function(e,t,n,i,r,a,o,s){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=o,this._blendWeight=s},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(100,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector2",15),new Mt(56,"vector4",7),new Mt(72,"vector4",6),new Mt(88,"vector3",5)])}]),e}(),Ut=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1STangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(72,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector2",15),new Mt(56,"vector4",5)])}]),e}(),Ht=function(){function e(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalColorTexture0Tangent=function(e,t,n,i,r,a){this._position=e,this._normal=t,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(68,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector2",15),new Mt(56,"vector3",5)])}]),e}(),Gt=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(80,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector4",7),new Mt(64,"vector4",6)])}]),e}(),zt=function(){function e(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkinSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(96,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector4",7),new Mt(64,"vector4",6),new Mt(80,"vector4",5)])}]),e}(),Wt=function(){function e(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"color",function(){return this._color}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(92,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector4",7),new Mt(64,"vector4",6),new Mt(80,"vector3",5)])}]),e}(),kt=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(64,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector4",5)])}]),e}(),Xt=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._color=n,this._textureCoordinate=i,this._tangent=r}r(e,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"color",function(){return this._color}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(60,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",1),new Mt(40,"vector2",2),new Mt(48,"vector3",5)])}]),e}(),Yt=function(){function e(e,t,n){this._position=null,this._normal=null,this._tangent=null,this._position=e,this._normal=t,this._tangent=n}r(e,"laya.d3.graphics.VertexPositionNormalSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(40,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector4",5)])}]),e}(),Zt=function(){function e(e,t,n){this._position=null,this._normal=null,this._tangent=null,this._position=e,this._normal=t,this._tangent=n}r(e,"laya.d3.graphics.VertexPositionNormalTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(36,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector3",5)])}]),e}(),Kt=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNormalTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(32,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2)])}]),e}(),jt=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(40,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector2",15)])}]),e}(),qt=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._blendIndex=r,this._blendWeight=a
}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(72,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector2",15),new Mt(40,"vector4",7),new Mt(56,"vector4",6)])}]),e}(),Qt=function(){function e(e,t,n,i,r,a,o){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(88,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector2",15),new Mt(40,"vector4",7),new Mt(56,"vector4",6),new Mt(72,"vector4",5)])}]),e}(),$t=function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0SkinTangent=function(e,t,n,i,r,a,o){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=o},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(84,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector2",15),new Mt(40,"vector4",7),new Mt(56,"vector4",6),new Mt(72,"vector3",5)])}]),e}(),Jt=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1STangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(56,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector2",15),new Mt(40,"vector4",5)])}]),e}(),en=function(){function e(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(e,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),t.VertexPositionNormalTexture0Tangent=function(e,t,n,i,r){this._position=e,this._normal=t,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r},a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(52,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector2",15),new Mt(40,"vector3",5)])}]),e}(),tn=function(){function e(e,t,n,i,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._blendIndex=i,this._blendWeight=r}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(64,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector4",7),new Mt(48,"vector4",6)])}]),e}(),nn=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkinSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(80,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector4",7),new Mt(48,"vector4",6),new Mt(64,"vector4",5)])}]),e}(),rn=function(){function e(e,t,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}r(e,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(76,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector4",7),new Mt(48,"vector4",6),new Mt(64,"vector3",5)])}]),e}(),an=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalTextureSTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(48,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector4",5)])}]),e}(),on=function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=e,this._normal=t,this._textureCoordinate=n,this._tangent=i}r(e,"laya.d3.graphics.VertexPositionNormalTextureTangent");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(44,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector3",5)])}]),e}(),sn=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNTBTexture");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(56,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector3",5),new Mt(36,"vector3",4),new Mt(48,"vector2",2)])}]),e}(),ln=function(){function e(e,t,n,i,r,a,o,s){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this.binormal=null,this._position=e,this._normal=t,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,n=n,this._blendIndex=o,this._blendWeight=s}r(e,"laya.d3.graphics.VertexPositionNTBTexture0Texture1Skin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"tangent",function(){return this._tangent}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(0,t,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,t,"blendIndex",function(){return this._blendIndex}),a(0,t,"blendWeight",function(){return this._blendWeight}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(96,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector3",5),new Mt(36,"vector3",4),new Mt(48,"vector2",2),new Mt(56,"vector2",15),new Mt(64,"vector4",7),new Mt(80,"vector4",6)])}]),e}(),un=function(){function e(e,t,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=e,this._normal=t,this._textureCoordinate=n}r(e,"laya.d3.graphics.VertexPositionNTBTextureSkin");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"textureCoordinate",function(){return this._textureCoordinate}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(88,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector3",5),new Mt(36,"vector3",4),new Mt(48,"vector2",2),new Mt(56,"vector4",7),new Mt(72,"vector4",6)])}]),e}(),cn=(function(){function e(e,t,n,i){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=e,this._normal=t,this._textureCoord0=n,this._textureCoord1=i}r(e,"laya.d3.graphics.VertexPositionTerrain");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"normal",function(){return this._normal}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoord0",function(){return this._textureCoord0}),a(0,t,"textureCoord1",function(){return this._textureCoord1}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(40,[new Mt(0,"vector3",0),new Mt(12,"vector3",3),new Mt(24,"vector2",2),new Mt(32,"vector2",15)])}]),e}(),function(){function e(e,t){this._position=null,this._textureCoordinate0=null,this._position=e,this._textureCoordinate0=t}r(e,"laya.d3.graphics.VertexPositionTexture0");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"position",function(){return this._position}),a(0,t,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(20,[new Mt(0,"vector3",0),new Mt(12,"vector2",2)])}]),e}()),hn=function(){function e(e,t,n,i,r,a,o,s,l,u,c,h,d,_){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=0/0,this._time=0/0,this._startSpeed=0/0,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=o,this._startRotation2=s,this._startLifeTime=l,this._time=u,this._startSpeed=c,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=_}r(e,"laya.d3.graphics.VertexShurikenParticleBillboard");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"random1",function(){return this._randoms1}),a(0,t,"startRotation2",function(){return this._startRotation2}),a(0,t,"positionStartLifeTime",function(){return this._positionStartLifeTime}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"random0",function(){return this._randoms0}),a(0,t,"startSize",function(){return this._startSize}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"startRotation0",function(){return this._startRotation0}),a(0,t,"startRotation1",function(){return this._startRotation1}),a(0,t,"startLifeTime",function(){return this._startLifeTime}),a(0,t,"time",function(){return this._time}),a(0,t,"startSpeed",function(){return this._startSpeed}),a(0,t,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(152,[new Mt(0,"vector4",17),new Mt(16,"vector4",30),new Mt(32,"vector4",32),new Mt(48,"vector4",19),new Mt(64,"vector3",20),new Mt(76,"vector3",22),new Mt(88,"single",31),new Mt(92,"vector4",34),new Mt(108,"vector4",35),new Mt(124,"vector3",36),new Mt(136,"vector4",37)])}]),e}(),dn=function(){function e(e,t,n,i,r,a,o,s,l,u,c,h,d,_){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=0/0,this._time=0/0,this._startSpeed=0/0,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=e,this._positionStartLifeTime=t,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=o,this._startRotation2=s,this._startLifeTime=l,this._time=u,this._startSpeed=c,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=_}r(e,"laya.d3.graphics.VertexShurikenParticleMesh");var t=e.prototype;return n.imps(t,{"laya.d3.graphics.IVertex":!0}),a(0,t,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,t,"velocity",function(){return this._velocity}),a(0,t,"position",function(){return this._positionStartLifeTime}),a(0,t,"random0",function(){return this._randoms0}),a(0,t,"startSize",function(){return this._startSize}),a(0,t,"startColor",function(){return this._startColor}),a(0,t,"startRotation0",function(){return this._startRotation0}),a(0,t,"startRotation1",function(){return this._startRotation1}),a(0,t,"random1",function(){return this._randoms1}),a(0,t,"startRotation2",function(){return this._startRotation2}),a(0,t,"startLifeTime",function(){return this._startLifeTime}),a(0,t,"time",function(){return this._time}),a(0,t,"startSpeed",function(){return this._startSpeed}),a(0,t,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,t,"vertexDeclaration",function(){return e._vertexDeclaration}),a(1,e,"vertexDeclaration",function(){return e._vertexDeclaration}),i(e,["_vertexDeclaration",function(){return this._vertexDeclaration=new xt(172,[new Mt(0,"vector3",0),new Mt(12,"vector4",1),new Mt(28,"vector2",2),new Mt(36,"vector4",30),new Mt(52,"vector4",32),new Mt(68,"vector4",19),new Mt(84,"vector3",20),new Mt(96,"vector3",22),new Mt(108,"single",31),new Mt(112,"vector4",34),new Mt(128,"vector4",35),new Mt(144,"vector3",36),new Mt(156,"vector4",37)])}]),e}(),_n=function(){function e(e,t,n,i,r,a){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._subMeshes=null,this._materialMap=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=n,this._materials=i,this._subMeshes=r,this._materialMap=a,this._version=t,this._onLoaded(e)}r(e,"laya.d3.loaders.LoadModelV01");var t=e.prototype;return t._onLoaded=function(e){this._readData=e,this.READ_BLOCK();for(var t=0;t<this._BLOCK.count;t++){var n=this._readData.getUint16(),i=this._strings[n],r=this["READ_"+i];if(null==r)throw new Error("model file err,no this function:"+n+" "+i);if(!r.call(this))break}return this._mesh},t.onError=function(){},t._readString=function(){return this._strings[this._readData.getUint16()]},t.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},t.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},t.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var e=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var t=0;t<this._STRINGS.size;t++)this._strings[t]=this._readData.readUTFString();return this._readData.pos=e,!0},t.READ_MATERIAL=function(){var e=this._readData.getUint16(),t=(this._readString(),this._readString());return this._materials[e]="null"!==t?g.getRes(this._materialMap[t]):new ci,!0},t.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":case"LAYAMODEL:02":var e=this._readData.__getBuffer(),t=0,n=0,i=this._readData.getUint32(),r=this._readData.getUint32(),a=(new Float32Array(e.slice(i+this._DATA.offset,i+this._DATA.offset+r)),this._readData.getUint32()),o=this._readData.getUint32(),s=new Float32Array(e.slice(a+this._DATA.offset,a+this._DATA.offset+o));for(this.mesh._inverseBindPoses=[],t=0,n=s.length;n>t;t+=16){var l=new xn(s[t+0],s[t+1],s[t+2],s[t+3],s[t+4],s[t+5],s[t+6],s[t+7],s[t+8],s[t+9],s[t+10],s[t+11],s[t+12],s[t+13],s[t+14],s[t+15]);this.mesh._inverseBindPoses.push(l)}break;default:throw new Error("LoadModel:unknown version.")}return!0},t.READ_SUBMESH=function(){var t=(this._readString(),this._readData.getUint8(),this._readString());this._shaderAttributes=t.match(e._attrReg);var n=this._readData.getUint32(),i=this._readData.getUint32(),r=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),a=this._readData.getUint32(),o=this._readData.getUint32(),s=this._readData.getUint32(),l=this._readData.__getBuffer(),u=new wn(this._mesh),c=this._getVertexDeclaration(),h=Bi.create(c,a/c.vertexStride,35044,!0),d=r+this._DATA.offset,_=l.slice(d,d+a);h.setData(new Float32Array(_)),u._vertexBuffer=h;for(var f=h.vertexDeclaration.getVertexElements(),m=0;m<f.length;m++)u._bufferUsage[f[m].elementUsage]=h;var p=Fi.create("ushort",i/2,35044,!0),E=n+this._DATA.offset,v=l.slice(E,E+i);p.setData(new Uint16Array(v)),u._indexBuffer=p;var g=l.slice(o+this._DATA.offset,o+this._DATA.offset+s);return u._boneIndicesList[0]=new Uint8Array(g),this._subMeshes.push(u),!0},t.READ_DATAAREA=function(){return!1},t._getVertexDeclaration=function(){for(var e=!1,t=!1,n=!1,i=!1,r=!1,a=!1,o=!1,s=!1,l=!1,u=0;u<this._shaderAttributes.length;u+=8)switch(this._shaderAttributes[u]){case"POSITION":e=!0;break;case"NORMAL":t=!0;break;case"COLOR":n=!0;break;case"UV":i=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":o=!0;break;case"BLENDINDICES":s=!0;break;case"TANGENT":a=!0;break;case"BINORMAL":l=!0}var c;return e&&t&&n&&i&&r&&o&&s&&a?c=Bt.vertexDeclaration:e&&t&&n&&i&&r&&o&&s?c=Ft.vertexDeclaration:e&&t&&i&&r&&o&&s&&a?c=$t.vertexDeclaration:e&&t&&i&&r&&o&&s?c=qt.vertexDeclaration:e&&t&&n&&i&&o&&s&&a?c=Wt.vertexDeclaration:e&&t&&n&&i&&o&&s?c=Gt.vertexDeclaration:e&&t&&a&&l&&i&&o&&s?c=un.vertexDeclaration:e&&t&&i&&o&&s&&a?c=rn.vertexDeclaration:e&&t&&i&&o&&s?c=tn.vertexDeclaration:e&&t&&n&&o&&s&&a?c=Vt.vertexDeclaration:e&&t&&n&&o&&s?c=Ct.vertexDeclaration:e&&t&&n&&i&&r&&a?c=Ht.vertexDeclaration:e&&t&&n&&i&&r?c=Nt.vertexDeclaration:e&&t&&i&&r&&a?c=en.vertexDeclaration:e&&t&&i&&r?c=jt.vertexDeclaration:e&&t&&n&&i&&a?c=Xt.vertexDeclaration:e&&t&&i&&a&&l?c=sn.vertexDeclaration:e&&t&&n&&i?c=wt.vertexDeclaration:e&&t&&i&&a?c=on.vertexDeclaration:e&&t&&i?c=Kt.vertexDeclaration:e&&t&&n&&a?c=Pt.vertexDeclaration:e&&t&&n&&(c=yt.vertexDeclaration),c},a(0,t,"mesh",function(){return this._mesh}),e._attrReg=new RegExp("(\\w+)|([:,;])","g"),e}(),fn=function(){function e(){}return r(e,"laya.d3.loaders.LoadModelV02"),e.parse=function(t,n,i,r,a,o){e._mesh=i,e._materials=r,e._subMeshes=a,e._materialMap=o,e._version=n,e._readData=t,e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var s=0,l=e._BLOCK.count;l>s;s++){e._readData.pos=e._BLOCK.blockStarts[s];var u=e._readData.getUint16(),c=e._strings[u],h=e["READ_"+c];if(null==h)throw new Error("model file err,no this function:"+u+" "+c);h.call()}e._strings.length=0,e._readData=null,e._version=null,e._mesh=null,e._materials=null,e._subMeshes=null,e._materialMap=null},e._readString=function(){return e._strings[e._readData.getUint16()]},e.READ_DATA=function(){e._DATA.offset=e._readData.getUint32(),e._DATA.size=e._readData.getUint32()},e.READ_BLOCK=function(){for(var t=e._BLOCK.count=e._readData.getUint16(),n=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],r=0;t>r;r++)n.push(e._readData.getUint32()),i.push(e._readData.getUint32())},e.READ_STRINGS=function(){var t=e._readData.getUint32(),n=e._readData.getUint16(),i=e._readData.pos;e._readData.pos=t+e._DATA.offset;for(var r=0;n>r;r++)e._strings[r]=e._readData.readUTFString();e._readData.pos=i},e.READ_MATERIAL=function(){var t=(e._readString(),e._readString(),e._readString());return""!==t&&e._materials.push(g.getRes(e._materialMap[t])),!0},e.READ_MESH=function(){var t=(e._readString(),e._readData.__getBuffer()),n=0,i=0,r=e._readData.getInt16(),a=e._DATA.offset;for(n=0;r>n;n++){var o=a+e._readData.getUint32(),s=e._readData.getUint32(),l=new Float32Array(t.slice(o,o+s)),u=e._readString(),c=u.match(e._attrReg),h=e._getVertexDeclaration(c),d=Bi.create(h,4*l.length/h.vertexStride,35044,!0);d.setData(l),e._mesh._vertexBuffers.push(d)}var _=a+e._readData.getUint32(),f=e._readData.getUint32(),m=new Uint16Array(t.slice(_,_+f)),p=Fi.create("ushort",f/2,35044,!0);p.setData(m),e._mesh._indexBuffer=p;var E=e._mesh._boneNames=[],v=e._readData.getUint16();for(E.length=v,n=0;v>n;n++)E[n]=e._strings[e._readData.getUint16()];var g=e._readData.getUint32(),T=e._readData.getUint32(),S=(new Float32Array(t.slice(a+g,a+g+T)),e._readData.getUint32()),D=e._readData.getUint32(),x=new Float32Array(t.slice(a+S,a+S+D));for(e._mesh._inverseBindPoses=[],n=0,i=x.length;i>n;n+=16){var M=new xn(x[n+0],x[n+1],x[n+2],x[n+3],x[n+4],x[n+5],x[n+6],x[n+7],x[n+8],x[n+9],x[n+10],x[n+11],x[n+12],x[n+13],x[n+14],x[n+15]);e._mesh._inverseBindPoses.push(M)}return e._mesh._skinnedDatas=new Float32Array(16*x.length),!0},e.READ_SUBMESH=function(){var t=e._readData.__getBuffer(),n=new wn(e._mesh),i=e._readData.getInt16(),r=e._readData.getUint32(),a=e._readData.getUint32();n._vertexBuffer=e._mesh._vertexBuffers[i],n._vertexStart=r,n._vertexCount=a;var o=e._readData.getUint32(),s=e._readData.getUint32(),l=e._mesh._indexBuffer;n._indexBuffer=l,n._indexStart=o,n._indexCount=s,n._indices=new Uint16Array(l.getData().buffer,2*o,s);var u=e._DATA.offset,c=n._subIndexBufferStart,h=n._subIndexBufferCount,d=n._boneIndicesList,_=e._readData.getUint16();c.length=_,h.length=_,d.length=_;for(var f=0;_>f;f++){c[f]=e._readData.getUint32(),h[f]=e._readData.getUint32();var m=e._readData.getUint32(),p=e._readData.getUint32();n._boneIndicesList[f]=new Uint8Array(t.slice(u+m,u+m+p))}return e._subMeshes.push(n),!0},e._getVertexDeclaration=function(e){for(var t=!1,n=!1,i=!1,r=!1,a=!1,o=!1,s=!1,l=!1,u=!1,c=0;c<e.length;c++)switch(e[c]){case"POSITION":t=!0;break;case"NORMAL":n=!0;break;case"COLOR":i=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":l=!0;break;case"TANGENT":o=!0;break;case"BINORMAL":u=!0}var h;return t&&n&&i&&r&&a&&s&&l&&o?h=Bt.vertexDeclaration:t&&n&&i&&r&&a&&s&&l?h=Ft.vertexDeclaration:t&&n&&r&&a&&s&&l&&o?h=$t.vertexDeclaration:t&&n&&r&&a&&s&&l?h=qt.vertexDeclaration:t&&n&&i&&r&&s&&l&&o?h=Wt.vertexDeclaration:t&&n&&i&&r&&s&&l?h=Gt.vertexDeclaration:t&&n&&r&&s&&l&&o?h=rn.vertexDeclaration:t&&n&&r&&s&&l?h=tn.vertexDeclaration:t&&n&&i&&s&&l&&o?h=Vt.vertexDeclaration:t&&n&&i&&s&&l?h=Ct.vertexDeclaration:t&&n&&i&&r&&a&&o?h=Ht.vertexDeclaration:t&&n&&i&&r&&a?h=Nt.vertexDeclaration:t&&n&&r&&a&&o?h=en.vertexDeclaration:t&&n&&r&&a?h=jt.vertexDeclaration:t&&n&&i&&r&&o?h=Xt.vertexDeclaration:t&&n&&r&&o&&u?h=sn.vertexDeclaration:t&&n&&i&&r?h=wt.vertexDeclaration:t&&n&&r&&o?h=on.vertexDeclaration:t&&n&&r?h=Kt.vertexDeclaration:t&&n&&i&&o?h=Pt.vertexDeclaration:t&&n&&i&&(h=yt.vertexDeclaration),h},e._attrReg=new RegExp("(\\w+)|([:,;])","g"),e._strings=[],e._readData=null,e._version=null,e._mesh=null,e._materials=null,e._subMeshes=null,e._materialMap=null,i(e,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),e}(),mn=function(){function e(){}return r(e,"laya.d3.loaders.LoadModelV03"),e.parse=function(t,n,i,r,a){e._mesh=i,e._subMeshes=r,e._materialMap=a,e._version=n,e._readData=t,e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var o=0,s=e._BLOCK.count;s>o;o++){e._readData.pos=e._BLOCK.blockStarts[o];var l=e._readData.getUint16(),u=e._strings[l],c=e["READ_"+u];if(null==c)throw new Error("model file err,no this function:"+l+" "+u);c.call()}e._strings.length=0,e._readData=null,e._version=null,e._mesh=null,e._subMeshes=null,e._materialMap=null},e._readString=function(){return e._strings[e._readData.getUint16()]},e.READ_DATA=function(){e._DATA.offset=e._readData.getUint32(),e._DATA.size=e._readData.getUint32()},e.READ_BLOCK=function(){for(var t=e._BLOCK.count=e._readData.getUint16(),n=e._BLOCK.blockStarts=[],i=e._BLOCK.blockLengths=[],r=0;t>r;r++)n.push(e._readData.getUint32()),i.push(e._readData.getUint32())},e.READ_STRINGS=function(){var t=e._readData.getUint32(),n=e._readData.getUint16(),i=e._readData.pos;e._readData.pos=t+e._DATA.offset;for(var r=0;n>r;r++)e._strings[r]=e._readData.readUTFString();e._readData.pos=i},e.READ_MESH=function(){var t=(e._readString(),e._readData.__getBuffer()),n=0,i=0,r=e._readData.getInt16(),a=e._DATA.offset;for(n=0;r>n;n++){var o,s=a+e._readData.getUint32(),l=e._readData.getUint32(),u=new Float32Array(t.slice(s,s+l)),c=e._readString();switch(e._version){case"LAYAMODEL:03":o=e._vertexDeclarationMap_Discard[c];break;case"LAYAMODEL:0301":o=e._vertexDeclarationMap[c];break;default:throw new Error("LoadModelV03: unknown version.")}if(!o)throw new Error("LoadModelV03: unknown vertexDeclaration.");var h=Bi.create(o,4*u.length/o.vertexStride,35044,!0);h.setData(u),e._mesh._vertexBuffers.push(h)}var d=a+e._readData.getUint32(),_=e._readData.getUint32(),f=new Uint16Array(t.slice(d,d+_)),m=Fi.create("ushort",_/2,35044,!0);m.setData(f),e._mesh._indexBuffer=m;var p=e._mesh._boneNames=[],E=e._readData.getUint16();for(p.length=E,n=0;E>n;n++)p[n]=e._strings[e._readData.getUint16()];e._readData.pos+=8;var v=e._readData.getUint32(),g=e._readData.getUint32(),T=new Float32Array(t.slice(a+v,a+v+g));for(e._mesh._inverseBindPoses=[],n=0,i=T.length;i>n;n+=16){var S=new xn(T[n+0],T[n+1],T[n+2],T[n+3],T[n+4],T[n+5],T[n+6],T[n+7],T[n+8],T[n+9],T[n+10],T[n+11],T[n+12],T[n+13],T[n+14],T[n+15]);e._mesh._inverseBindPoses.push(S)}return e._mesh._skinnedDatas=new Float32Array(16*T.length),!0},e.READ_SUBMESH=function(){var t=e._readData.__getBuffer(),n=new wn(e._mesh),i=e._readData.getInt16(),r=e._readData.getUint32(),a=e._readData.getUint32();n._vertexBuffer=e._mesh._vertexBuffers[i],n._vertexStart=r,n._vertexCount=a;var o=e._readData.getUint32(),s=e._readData.getUint32(),l=e._mesh._indexBuffer;n._indexBuffer=l,n._indexStart=o,n._indexCount=s,n._indices=new Uint16Array(l.getData().buffer,2*o,s);var u=e._DATA.offset,c=n._subIndexBufferStart,h=n._subIndexBufferCount,d=n._boneIndicesList,_=e._readData.getUint16();c.length=_,h.length=_,d.length=_;for(var f=0;_>f;f++){c[f]=e._readData.getUint32(),h[f]=e._readData.getUint32();var m=e._readData.getUint32(),p=e._readData.getUint32();d[f]=new Uint8Array(t.slice(u+m,u+m+p))}return e._subMeshes.push(n),!0},e._strings=[],e._readData=null,e._version=null,e._mesh=null,e._subMeshes=null,e._materialMap=null,i(e,["_vertexDeclarationMap_Discard",function(){return this._vertexDeclarationMap_Discard={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":Bt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":Ft.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":ln.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":$t.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":qt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":Wt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":Gt.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":rn.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":tn.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":Vt.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":Ct.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":Ht.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":Nt.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":en.vertexDeclaration,"POSITION,NORMAL,UV,UV1":jt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":Xt.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":sn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":wt.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":on.vertexDeclaration,"POSITION,NORMAL,UV":Kt.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":Pt.vertexDeclaration,"POSITION,NORMAL,COLOR":yt.vertexDeclaration,"POSITION,NORMAL,TANGENT":Zt.vertexDeclaration,"POSITION,NORMAL":It.vertexDeclaration,"POSITION,UV":cn.vertexDeclaration,POSITION:At.vertexDeclaration}
},"_vertexDeclarationMap",function(){return this._vertexDeclarationMap={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":bt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":Ft.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":ln.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":Qt.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":qt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":zt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":Gt.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":nn.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":tn.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":Ot.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":Ct.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":Ut.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":Nt.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":Jt.vertexDeclaration,"POSITION,NORMAL,UV,UV1":jt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":kt.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":sn.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":wt.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":an.vertexDeclaration,"POSITION,NORMAL,UV":Kt.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":Lt.vertexDeclaration,"POSITION,NORMAL,COLOR":yt.vertexDeclaration,"POSITION,NORMAL,TANGENT":Yt.vertexDeclaration,"POSITION,NORMAL":It.vertexDeclaration,"POSITION,UV":cn.vertexDeclaration,POSITION:At.vertexDeclaration}},"_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),e}(),pn=function(){function e(){}return r(e,"laya.d3.loaders.MeshReader"),e.read=function(t,n,i,r,a){var o=new f(t);o.pos=0;var s=o.readUTFString();switch(s){case"LAYAMODEL:01":case"LAYASKINANI:01":e._readVersion01(o,s,n,i,r,a);break;case"LAYAMODEL:02":fn.parse(o,s,n,i,r,a);break;case"LAYAMODEL:03":case"LAYAMODEL:0301":mn.parse(o,s,n,r,a);break;default:throw new Error("MeshReader: unknown mesh version.")}n._setSubMeshes(r)},e._readVersion01=function(e,t,n,i,r,a){new _n(e,t,n,i,r,a)},e}(),En=function(){function e(e,t){this.min=null,this.max=null,this.min=e,this.max=t}r(e,"laya.d3.math.BoundBox");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.getCorners=function(e){e.length=8;var t=this.min.elements,n=this.max.elements,i=t[0],r=t[1],a=t[2],o=n[0],s=n[1],l=n[2];e[0]=new On(i,s,l),e[1]=new On(o,s,l),e[2]=new On(o,r,l),e[3]=new On(i,r,l),e[4]=new On(i,s,a),e[5]=new On(o,s,a),e[6]=new On(o,r,a),e[7]=new On(i,r,a)},t.toDefault=function(){this.min.toDefault(),this.max.toDefault()},t.cloneTo=function(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)},t.clone=function(){var e=new this.constructor(new On,new On);return this.cloneTo(e),e},e.createfromPoints=function(e,t){if(null==e)throw new Error("points");var n=t.min,i=t.max,r=n.elements;r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE;var a=i.elements;a[0]=-Number.MAX_VALUE,a[1]=-Number.MAX_VALUE,a[2]=-Number.MAX_VALUE;for(var o=0,s=e.length;s>o;++o)On.min(n,e[o],n),On.max(i,e[o],i)},e.merge=function(e,t,n){On.min(e.min,t.min,n.min),On.max(e.max,t.max,n.max)},e}(),vn=function(){function e(t){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=t,this._near=new Rn(new On),this._far=new Rn(new On),this._left=new Rn(new On),this._right=new Rn(new On),this._top=new Rn(new On),this._bottom=new Rn(new On),e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}r(e,"laya.d3.math.BoundFrustum");var t=e.prototype;return t.equalsBoundFrustum=function(e){return this._matrix.equalsOtherMatrix(e.matrix)},t.equalsObj=function(e){if(e instanceof laya.d3.math.BoundFrustum){var t=e;return this.equalsBoundFrustum(t)}return!1},t.getPlane=function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},t.getCorners=function(t){e._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(t[0]),e._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(t[1]),e._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(t[2]),e._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(t[3]),e._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(t[4]),e._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(t[5]),e._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(t[6]),e._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(t[7])},t.containsPoint=function(e){for(var t=Rn.PlaneIntersectionType_Front,n=Rn.PlaneIntersectionType_Front,i=0;6>i;i++){switch(i){case 0:n=Tn.intersectsPlaneAndPoint(this._near,e);break;case 1:n=Tn.intersectsPlaneAndPoint(this._far,e);break;case 2:n=Tn.intersectsPlaneAndPoint(this._left,e);break;case 3:n=Tn.intersectsPlaneAndPoint(this._right,e);break;case 4:n=Tn.intersectsPlaneAndPoint(this._top,e);break;case 5:n=Tn.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case Rn.PlaneIntersectionType_Back:return 0;case Rn.PlaneIntersectionType_Intersecting:t=Rn.PlaneIntersectionType_Intersecting}}switch(t){case Rn.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t.containsBoundBox=function(t){for(var n,i=e._tempV30,r=e._tempV31,a=1,o=0;6>o;o++){if(n=this.getPlane(o),this._getBoxToPlanePVertexNVertex(t,n.normal,i,r),Tn.intersectsPlaneAndPoint(n,i)===Rn.PlaneIntersectionType_Back)return 0;Tn.intersectsPlaneAndPoint(n,r)===Rn.PlaneIntersectionType_Back&&(a=2)}return a},t.containsBoundSphere=function(e){for(var t=Rn.PlaneIntersectionType_Front,n=Rn.PlaneIntersectionType_Front,i=0;6>i;i++){switch(i){case 0:n=Tn.intersectsPlaneAndSphere(this._near,e);break;case 1:n=Tn.intersectsPlaneAndSphere(this._far,e);break;case 2:n=Tn.intersectsPlaneAndSphere(this._left,e);break;case 3:n=Tn.intersectsPlaneAndSphere(this._right,e);break;case 4:n=Tn.intersectsPlaneAndSphere(this._top,e);break;case 5:n=Tn.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case Rn.PlaneIntersectionType_Back:return 0;case Rn.PlaneIntersectionType_Intersecting:t=Rn.PlaneIntersectionType_Intersecting}}switch(t){case Rn.PlaneIntersectionType_Intersecting:return 2;default:return 1}},t._getBoxToPlanePVertexNVertex=function(e,t,n,i){var r=e.min,a=r.elements,o=e.max,s=o.elements,l=t.elements,u=l[0],c=l[1],h=l[2];r.cloneTo(n);var d=n.elements;u>=0&&(d[0]=s[0]),c>=0&&(d[1]=s[1]),h>=0&&(d[2]=s[2]),o.cloneTo(i);var _=i.elements;u>=0&&(_[0]=a[0]),c>=0&&(_[1]=a[1]),h>=0&&(_[2]=a[2])},a(0,t,"top",function(){return this._top}),a(0,t,"matrix",function(){return this._matrix},function(t){this._matrix=t,e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),a(0,t,"near",function(){return this._near}),a(0,t,"far",function(){return this._far}),a(0,t,"left",function(){return this._left}),a(0,t,"right",function(){return this._right}),a(0,t,"bottom",function(){return this._bottom}),e._getPlanesFromMatrix=function(e,t,n,i,r,a,o){var s=e.elements,l=s[0],u=s[1],c=s[2],h=s[3],d=s[4],_=s[5],f=s[6],m=s[7],p=s[8],E=s[9],v=s[10],g=s[11],T=s[12],S=s[13],D=s[14],x=s[15],M=t.normal.elements;M[0]=h+c,M[1]=m+f,M[2]=g+v,t.distance=x+D,t.normalize();var R=n.normal.elements;R[0]=h-c,R[1]=m-f,R[2]=g-v,n.distance=x-D,n.normalize();var A=i.normal.elements;A[0]=h+l,A[1]=m+d,A[2]=g+p,i.distance=x+T,i.normalize();var I=r.normal.elements;I[0]=h-l,I[1]=m-d,I[2]=g-p,r.distance=x-T,r.normalize();var y=a.normal.elements;y[0]=h-u,y[1]=m-_,y[2]=g-E,a.distance=x-S,a.normalize();var C=o.normal.elements;C[0]=h+u,C[1]=m+_,C[2]=g+E,o.distance=x+S,o.normalize()},e._get3PlaneInterPoint=function(t,n,i){var r=t.normal,a=n.normal,o=i.normal;On.cross(a,o,e._tempV30),On.cross(o,r,e._tempV31),On.cross(r,a,e._tempV32);var s=On.dot(r,e._tempV30),l=On.dot(a,e._tempV31),u=On.dot(o,e._tempV32);On.scale(e._tempV30,-t.distance/s,e._tempV33),On.scale(e._tempV31,-n.distance/l,e._tempV34),On.scale(e._tempV32,-i.distance/u,e._tempV35),On.add(e._tempV33,e._tempV34,e._tempV36),On.add(e._tempV35,e._tempV36,e._tempV37);var c=e._tempV37;return c},i(e,["_tempV30",function(){return this._tempV30=new On},"_tempV31",function(){return this._tempV31=new On},"_tempV32",function(){return this._tempV32=new On},"_tempV33",function(){return this._tempV33=new On},"_tempV34",function(){return this._tempV34=new On},"_tempV35",function(){return this._tempV35=new On},"_tempV36",function(){return this._tempV36=new On},"_tempV37",function(){return this._tempV37=new On}]),e}(),gn=function(){function e(e,t){this.center=null,this.radius=0/0,this.center=e,this.radius=t}r(e,"laya.d3.math.BoundSphere");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.toDefault=function(){this.center.toDefault(),this.radius=0},t.intersectsRayDistance=function(e){return Tn.intersectsRayAndSphereRD(e,this)},t.intersectsRayPoint=function(e,t){return Tn.intersectsRayAndSphereRP(e,this,t)},t.cloneTo=function(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius},t.clone=function(){var e=new this.constructor(new On,new On);return this.cloneTo(e),e},e.createFromSubPoints=function(t,n,i,r){if(null==t)throw new Error("points");if(0>n||n>=t.length)throw new Error("start"+n+"Must be in the range [0, "+(t.length-1)+"]");if(0>i||n+i>t.length)throw new Error("count"+i+"Must be in the range <= "+t.length+"}");var a=n+i,o=e._tempVector3;o.elements[0]=0,o.elements[1]=0,o.elements[2]=0;for(var s=n;a>s;++s)On.add(t[s],o,o);var l=r.center;On.scale(o,1/i,l);var u=0;for(s=n;a>s;++s){var c=On.distanceSquared(l,t[s]);c>u&&(u=c)}r.radius=Math.sqrt(u)},e.createfromPoints=function(t,n){if(null==t)throw new Error("points");e.createFromSubPoints(t,0,t.length,n)},i(e,["_tempVector3",function(){return this._tempVector3=new On}]),e}(),Tn=function(){function e(){}return r(e,"laya.d3.math.Collision"),e.distancePlaneToPoint=function(e,t){var n=On.dot(e.normal,t);return n-e.distance},e.distanceBoxToPoint=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],o=e.max.elements,s=o[0],l=o[1],u=o[2],c=t.elements,h=c[0],d=c[1],_=c[2],f=0;return i>h&&(f+=(i-h)*(i-h)),h>s&&(f+=(s-h)*(s-h)),r>d&&(f+=(r-d)*(r-d)),d>l&&(f+=(l-d)*(l-d)),a>_&&(f+=(a-_)*(a-_)),_>u&&(f+=(u-_)*(u-_)),Math.sqrt(f)},e.distanceBoxToBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],o=e.max.elements,s=o[0],l=o[1],u=o[2],c=t.min.elements,h=c[0],d=c[1],_=c[2],f=t.max.elements,m=f[0],p=f[1],E=f[2],v=0,g=0/0;return i>m?(g=i-m,v+=g*g):h>s&&(g=h-s,v+=g*g),r>p?(g=r-p,v+=g*g):d>l&&(g=d-l,v+=g*g),a>E?(g=a-E,v+=g*g):_>u&&(g=_-u,v+=g*g),Math.sqrt(v)},e.distanceSphereToPoint=function(e,t){var n=Math.sqrt(On.distanceSquared(e.center,t));return n-=e.radius,Math.max(n,0)},e.distanceSphereToSphere=function(e,t){var n=Math.sqrt(On.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)},e.intersectsRayAndTriangleRD=function(t,n,i,r,a){var o=t.origin,s=o.elements,l=s[0],u=s[1],c=s[2],h=t.direction,d=h.elements,_=d[0],f=d[1],m=d[2],p=n.elements,E=p[0],v=p[1],g=p[2],T=i.elements,S=T[0],D=T[1],x=T[2],M=r.elements,R=M[0],A=M[1],I=M[2],y=e._tempV30.elements,C=y[0],O=y[1],V=y[2];C=S-E,O=D-v,V=x-g;var L=e._tempV31.elements,P=L[0],w=L[1],N=L[2];P=R-E,w=A-v,N=I-g;var F=e._tempV32.elements,b=F[0],B=F[1],U=F[2];b=f*N-m*w,B=m*P-_*N,U=_*w-f*P;var H=C*b+O*B+V*U;if(Sn.isZero(H))return a=0,!1;var G=1/H,z=e._tempV33.elements,W=z[0],k=z[1],X=z[2];W=l-E,k=u-v,X=c-g;var Y=W*b+k*B+X*U;if(Y*=G,0>Y||Y>1)return a=0,!1;var Z=e._tempV34.elements,K=Z[0],j=Z[1],q=Z[2];K=k*V-X*O,j=X*C-W*V,q=W*O-k*C;var Q=_*K+f*j+m*q;if(Q*=G,0>Q||Y+Q>1)return a=0,!1;var $=P*K+w*j+N*q;return $*=G,0>$?(a=0,!1):(a=$,!0)},e.intersectsRayAndTriangleRP=function(t,n,i,r,a){var o=0/0;return e.intersectsRayAndTriangleRD(t,n,i,r,o)?(On.scale(t.direction,o,e._tempV30),On.add(t.origin,e._tempV30,a),!0):(a=On.ZERO,!1)},e.intersectsRayAndPoint=function(t,n){On.subtract(t.origin,n,e._tempV30);var i=On.dot(e._tempV30,t.direction),r=On.dot(e._tempV30,e._tempV30)-Sn.zeroTolerance;if(r>0&&i>0)return!1;var a=i*i-r;return 0>a?!1:!0},e.intersectsRayAndRay=function(t,n,i){var r=t.origin,a=r.elements,o=a[0],s=a[1],l=a[2],u=t.direction,c=u.elements,h=c[0],d=c[1],_=c[2],f=n.origin,m=f.elements,p=m[0],E=m[1],v=m[2],g=n.direction,T=g.elements,S=T[0],D=T[1],x=T[2];On.cross(u,g,e._tempV30);var M=e._tempV30.elements,R=On.scalarLengthSquared(e._tempV30);if(Sn.isZero(R)&&Sn.nearEqual(p,o)&&Sn.nearEqual(E,s)&&Sn.nearEqual(v,l))return On.ZERO.cloneTo(i),!0;var A=p-o,I=E-s,y=v-l,C=S,O=D,V=x,L=M[0],P=M[1],w=M[2],N=A*O*w+I*V*L+y*C*P-A*V*P-I*C*w-y*O*L;C=h,O=d,V=_;var F=A*O*w+I*V*L+y*C*P-A*V*P-I*C*w-y*O*L,b=N/R,B=F/R;On.scale(u,b,e._tempV30),On.scale(g,B,e._tempV31),On.add(r,e._tempV30,e._tempV32),On.add(f,e._tempV31,e._tempV33);var U=e._tempV32.elements,H=e._tempV33.elements;return Sn.nearEqual(H[0],U[0])&&Sn.nearEqual(H[1],U[1])&&Sn.nearEqual(H[2],U[2])?(e._tempV32.cloneTo(i),!0):(On.ZERO.cloneTo(i),!1)},e.intersectsPlaneAndTriangle=function(t,n,i,r){var a=e.intersectsPlaneAndPoint(t,n),o=e.intersectsPlaneAndPoint(t,i),s=e.intersectsPlaneAndPoint(t,r);return a==Rn.PlaneIntersectionType_Front&&o==Rn.PlaneIntersectionType_Front&&s==Rn.PlaneIntersectionType_Front?Rn.PlaneIntersectionType_Front:a==Rn.PlaneIntersectionType_Back&&o==Rn.PlaneIntersectionType_Back&&s==Rn.PlaneIntersectionType_Back?Rn.PlaneIntersectionType_Back:Rn.PlaneIntersectionType_Intersecting},e.intersectsRayAndPlaneRD=function(e,t,n){var i=t.normal,r=On.dot(i,e.direction);if(Sn.isZero(r))return n=0,!1;var a=On.dot(i,e.origin);return n=(-t.distance-a)/r,0>n?(n=0,!1):!0},e.intersectsRayAndPlaneRP=function(t,n,i){var r=0/0;return e.intersectsRayAndPlaneRD(t,n,r)?(On.scale(t.direction,r,e._tempV30),On.add(t.origin,e._tempV30,e._tempV31),i=e._tempV31,!0):(i=On.ZERO,!1)},e.intersectsRayAndBoxRD=function(e,t){var n=e.origin.elements,i=n[0],r=n[1],a=n[2],o=e.direction.elements,s=o[0],l=o[1],u=o[2],c=t.min.elements,h=c[0],d=c[1],_=c[2],f=t.max.elements,m=f[0],p=f[1],E=f[2],v=0,g=Sn.MaxValue;if(Sn.isZero(s)){if(h>i||i>m)return-1}else{var T=1/s,S=(h-i)*T,D=(m-i)*T;if(S>D){var x=S;S=D,D=x}if(v=Math.max(S,v),g=Math.min(D,g),v>g)return-1}if(Sn.isZero(l)){if(d>r||r>p)return-1}else{var M=1/l,R=(d-r)*M,A=(p-r)*M;if(R>A){var I=R;R=A,A=I}if(v=Math.max(R,v),g=Math.min(A,g),v>g)return-1}if(Sn.isZero(u)){if(_>a||a>E)return-1}else{var y=1/u,C=(_-a)*y,O=(E-a)*y;if(C>O){var V=C;C=O,O=V}if(v=Math.max(C,v),g=Math.min(O,g),v>g)return-1}return v},e.intersectsRayAndBoxRP=function(t,n,i){var r=e.intersectsRayAndBoxRD(t,n);return-1===r?(On.ZERO.cloneTo(i),r):(On.scale(t.direction,r,e._tempV30),On.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(i),r)},e.intersectsRayAndSphereRD=function(t,n){var i=n.radius;On.subtract(t.origin,n.center,e._tempV30);var r=On.dot(e._tempV30,t.direction),a=On.dot(e._tempV30,e._tempV30)-i*i;if(a>0&&r>0)return-1;var o=r*r-a;if(0>o)return-1;var s=-r-Math.sqrt(o);return 0>s&&(s=0),s},e.intersectsRayAndSphereRP=function(t,n,i){var r=e.intersectsRayAndSphereRD(t,n);return-1===r?(On.ZERO.cloneTo(i),r):(On.scale(t.direction,r,e._tempV30),On.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(i),r)},e.intersectsSphereAndTriangle=function(t,n,i,r){var a=t.center,o=t.radius;e.closestPointPointTriangle(a,n,i,r,e._tempV30),On.subtract(e._tempV30,a,e._tempV31);var s=On.dot(e._tempV31,e._tempV31);return o*o>=s},e.intersectsPlaneAndPoint=function(e,t){var n=On.dot(e.normal,t)+e.distance;return n>0?Rn.PlaneIntersectionType_Front:0>n?Rn.PlaneIntersectionType_Back:Rn.PlaneIntersectionType_Intersecting},e.intersectsPlaneAndPlane=function(t,n){On.cross(t.normal,n.normal,e._tempV30);var i=On.dot(e._tempV30,e._tempV30);return Sn.isZero(i)?!1:!0},e.intersectsPlaneAndPlaneRL=function(t,n,i){var r=t.normal,a=n.normal;On.cross(r,a,e._tempV34);var o=On.dot(e._tempV34,e._tempV34);return Sn.isZero(o)?!1:(On.scale(a,t.distance,e._tempV30),On.scale(r,n.distance,e._tempV31),On.subtract(e._tempV30,e._tempV31,e._tempV32),On.cross(e._tempV32,e._tempV34,e._tempV33),On.normalize(e._tempV34,e._tempV34),i=new yn(e._tempV33,e._tempV34),!0)},e.intersectsPlaneAndBox=function(t,n){var i=t.distance,r=t.normal,a=r.elements,o=a[0],s=a[1],l=a[2],u=n.min.elements,c=u[0],h=u[1],d=u[2],_=n.max.elements,f=_[0],m=_[1],p=_[2];e._tempV30.elements[0]=o>0?c:f,e._tempV30.elements[1]=s>0?h:m,e._tempV30.elements[2]=l>0?d:p,e._tempV31.elements[0]=o>0?f:c,e._tempV31.elements[1]=s>0?m:h,e._tempV31.elements[2]=l>0?p:d;var E=On.dot(r,e._tempV30);return E+i>0?Rn.PlaneIntersectionType_Front:(E=On.dot(r,e._tempV31),0>E+i?Rn.PlaneIntersectionType_Back:Rn.PlaneIntersectionType_Intersecting)},e.intersectsPlaneAndSphere=function(e,t){var n=t.radius,i=On.dot(e.normal,t.center)+e.distance;return i>n?Rn.PlaneIntersectionType_Front:-n>i?Rn.PlaneIntersectionType_Back:Rn.PlaneIntersectionType_Intersecting},e.intersectsBoxAndBox=function(e,t){var n=e.min.elements,i=e.max.elements,r=t.min.elements,a=t.max.elements;return n[0]>a[0]||r[0]>i[0]?!1:n[1]>a[1]||r[1]>i[1]?!1:n[2]>a[2]||r[2]>i[2]?!1:!0},e.intersectsBoxAndSphere=function(t,n){var i=n.center,r=n.radius;On.Clamp(i,t.min,t.max,e._tempV30);var a=On.distanceSquared(i,e._tempV30);return r*r>=a},e.intersectsSphereAndSphere=function(e,t){var n=e.radius+t.radius;return On.distanceSquared(e.center,t.center)<=n*n},e.boxContainsPoint=function(e,t){var n=e.min.elements,i=e.max.elements,r=t.elements;return n[0]<=r[0]&&i[0]>=r[0]&&n[1]<=r[1]&&i[1]>=r[1]&&n[2]<=r[2]&&i[2]>=r[2]?1:0},e.boxContainsBox=function(e,t){var n=e.min.elements,i=n[0],r=n[1],a=n[2],o=e.max.elements,s=o[0],l=o[1],u=o[2],c=t.min.elements,h=c[0],d=c[1],_=c[2],f=t.max.elements,m=f[0],p=f[1],E=f[2];return h>s||i>m?0:d>l||r>p?0:_>u||a>E?0:h>=i&&m>=m&&d>=r&&l>=p&&_>=a&&u>=E?1:2},e.boxContainsSphere=function(t,n){var i=t.min,r=i.elements,a=r[0],o=r[1],s=r[2],l=t.max,u=l.elements,c=u[0],h=u[1],d=u[2],_=n.center,f=_.elements,m=f[0],p=f[1],E=f[2],v=n.radius;On.Clamp(_,i,l,e._tempV30);var g=On.distanceSquared(_,e._tempV30);return g>v*v?0:m>=a+v&&c-v>=m&&c-a>v&&p>=o+v&&h-v>=p&&h-o>v&&E>=s+v&&d-v>=E&&d-s>v?1:2},e.sphereContainsPoint=function(e,t){return On.distanceSquared(t,e.center)<=e.radius*e.radius?1:0},e.sphereContainsTriangle=function(t,n,i,r){var a=e.sphereContainsPoint(t,n),o=e.sphereContainsPoint(t,i),s=e.sphereContainsPoint(t,r);return 1==a&&1==o&&1==s?1:e.intersectsSphereAndTriangle(t,n,i,r)?2:0},e.sphereContainsBox=function(t,n){var i=t.center,r=i.elements,a=r[0],o=r[1],s=r[2],l=t.radius,u=n.min,c=u.elements,h=c[0],d=c[1],_=c[2],f=n.max,m=f.elements,p=m[0],E=m[1],v=m[2],g=e._tempV30.elements,T=g[0],S=g[1],D=g[2];if(!e.intersectsBoxAndSphere(n,t))return 0;var x=l*l;return T=a-h,S=o-E,D=s-v,On.scalarLengthSquared(e._tempV30)>x?2:(T=a-p,S=o-E,D=s-v,On.scalarLengthSquared(e._tempV30)>x?2:(T=a-p,S=o-d,D=s-v,On.scalarLengthSquared(e._tempV30)>x?2:(T=a-h,S=o-d,D=s-v,On.scalarLengthSquared(e._tempV30)>x?2:(T=a-h,S=o-E,D=s-_,On.scalarLengthSquared(e._tempV30)>x?2:(T=a-p,S=o-E,D=s-_,On.scalarLengthSquared(e._tempV30)>x?2:(T=a-p,S=o-d,D=s-_,On.scalarLengthSquared(e._tempV30)>x?2:(T=a-h,S=o-d,D=s-_,On.scalarLengthSquared(e._tempV30)>x?2:1)))))))},e.sphereContainsSphere=function(e,t){var n=e.radius,i=t.radius,r=On.distance(e.center,t.center);return r>n+i?0:r>n-i?2:1},e.closestPointPointTriangle=function(t,n,i,r,a){On.subtract(i,n,e._tempV30),On.subtract(r,n,e._tempV31),On.subtract(t,n,e._tempV32),On.subtract(t,i,e._tempV33),On.subtract(t,r,e._tempV34);var o=On.dot(e._tempV30,e._tempV32),s=On.dot(e._tempV31,e._tempV32),l=On.dot(e._tempV30,e._tempV33),u=On.dot(e._tempV31,e._tempV33),c=On.dot(e._tempV30,e._tempV34),h=On.dot(e._tempV31,e._tempV34);if(0>=o&&0>=s)return n.cloneTo(a),void 0;if(l>=0&&l>=u)return i.cloneTo(a),void 0;var d=o*u-l*s;if(0>=d&&o>=0&&0>=l){var _=o/(o-l);return On.scale(e._tempV30,_,a),On.add(n,a,a),void 0}if(h>=0&&h>=c)return r.cloneTo(a),void 0;var f=c*s-o*h;if(0>=f&&s>=0&&0>=h){var m=s/(s-h);return On.scale(e._tempV31,m,a),On.add(n,a,a),void 0}var p=l*h-c*u;if(0>=p&&u-l>=0&&c-h>=0){var E=(u-l)/(u-l+(c-h));return On.subtract(r,i,a),On.scale(a,E,a),On.add(i,a,a),void 0}var v=1/(p+f+d),g=f*v,T=d*v;On.scale(e._tempV30,g,e._tempV35),On.scale(e._tempV31,T,e._tempV36),On.add(e._tempV35,e._tempV36,a),On.add(n,a,a)},e.closestPointPlanePoint=function(t,n,i){var r=t.normal,a=On.dot(r,n)-t.distance;On.scale(r,a,e._tempV30),On.subtract(n,e._tempV30,i)},e.closestPointBoxPoint=function(t,n,i){On.max(n,t.min,e._tempV30),On.min(e._tempV30,t.max,i)},e.closestPointSpherePoint=function(e,t,n){var i=e.center;On.subtract(t,i,n),On.normalize(n,n),On.scale(n,e.radius,n),On.add(n,i,n)},e.closestPointSphereSphere=function(e,t,n){var i=e.center;On.subtract(t.center,i,n),On.normalize(n,n),On.scale(n,e.radius,n),On.add(n,i,n)},i(e,["_tempV30",function(){return this._tempV30=new On},"_tempV31",function(){return this._tempV31=new On},"_tempV32",function(){return this._tempV32=new On},"_tempV33",function(){return this._tempV33=new On},"_tempV34",function(){return this._tempV34=new On},"_tempV35",function(){return this._tempV35=new On},"_tempV36",function(){return this._tempV36=new On}]),e}(),Sn=(function(){function e(){}return r(e,"laya.d3.math.ContainmentType"),e.Disjoint=0,e.Contains=1,e.Intersects=2,e}(),function(){function e(){}return r(e,"laya.d3.math.MathUtils3D"),e.isZero=function(t){return Math.abs(t)<e.zeroTolerance},e.nearEqual=function(t,n){return e.isZero(t-n)?!0:!1},e.fastInvSqrt=function(t){return e.isZero(t)?t:1/Math.sqrt(t)},i(e,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),e}()),Dn=function(){function e(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}r(e,"laya.d3.math.Matrix3x3");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8];return t*(u*a-o*l)+n*(-u*r+o*s)+i*(l*r-a*s)},t.translate=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],u=i[4],c=i[5],h=i[6],d=i[7],_=i[8],f=r[0],m=r[1];n[0]=a,n[1]=o,n[2]=s,n[3]=l,n[4]=u,n[5]=c,n[6]=f*a+m*l+h,n[7]=f*o+m*u+d,n[8]=f*s+m*c+_},t.rotate=function(e,t){var n=t.elements,i=this.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=i[4],u=i[5],c=i[6],h=i[7],d=i[8],_=Math.sin(e),f=Math.cos(e);n[0]=f*r+_*s,n[1]=f*a+_*l,n[2]=f*o+_*u,n[3]=f*s-_*r,n[4]=f*l-_*a,n[5]=f*u-_*o,n[6]=c,n[7]=h,n[8]=d},t.scale=function(e,t){var n=t.elements,i=this.elements,r=e.elements,a=r[0],o=r[1];n[0]=a*i[0],n[1]=a*i[1],n[2]=a*i[2],n[3]=o*i[3],n[4]=o*i[4],n[5]=o*i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8]},t.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],u=n[6],c=n[7],h=n[8],d=h*s-l*c,_=-h*o+l*u,f=c*o-s*u,m=i*d+r*_+a*f;m||(e=null),m=1/m,t[0]=d*m,t[1]=(-h*r+a*c)*m,t[2]=(l*r-a*s)*m,t[3]=_*m,t[4]=(h*i-a*u)*m,t[5]=(-l*i+a*o)*m,t[6]=f*m,t[7]=(-c*i+r*u)*m,t[8]=(s*i-r*o)*m},t.transpose=function(e){var t=e.elements,n=this.elements;if(e===this){var i=n[1],r=n[2],a=n[5];t[1]=n[3],t[2]=n[6],t[3]=i,t[5]=n[7],t[6]=r,t[7]=a}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8]},t.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;9>t;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},e.createFromTranslation=function(e,t){var n=(t.elements,e.elements);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=n[0],t[7]=n[1],t[8]=1},e.createFromRotation=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[0]=r,n[1]=i,n[2]=0,n[3]=-i,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.createFromScaling=function(e,t){var n=t.elements,i=e.elements;n[0]=i[0],n[1]=0,n[2]=0,n[3]=0,n[4]=i[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.createFromMatrix4x4=function(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,o=r[0],s=r[1],l=r[2],u=r[3],c=r[4],h=r[5],d=r[6],_=r[7],f=r[8],m=a[0],p=a[1],E=a[2],v=a[3],g=a[4],T=a[5],S=a[6],D=a[7],x=a[8];i[0]=m*o+p*u+E*d,i[1]=m*s+p*c+E*_,i[2]=m*l+p*h+E*f,i[3]=v*o+g*u+T*d,i[4]=v*s+g*c+T*_,i[5]=v*l+g*h+T*f,i[6]=S*o+D*u+x*d,i[7]=S*s+D*c+x*_,i[8]=S*l+D*h+x*f},e.lookAt=function(t,n,i,r){On.subtract(t,n,e._tempV30),On.normalize(e._tempV30,e._tempV30),On.cross(i,e._tempV30,e._tempV31),On.normalize(e._tempV31,e._tempV31),On.cross(e._tempV30,e._tempV31,e._tempV32);var a=e._tempV30.elements,o=e._tempV31.elements,s=e._tempV32.elements,l=r.elements;l[0]=o[0],l[3]=o[1],l[6]=o[2],l[1]=s[0],l[4]=s[1],l[7]=s[2],l[2]=a[0],l[5]=a[1],l[8]=a[2]},e.DEFAULT=new e,i(e,["_tempV30",function(){return this._tempV30=new On},"_tempV31",function(){return this._tempV31=new On},"_tempV32",function(){return this._tempV32=new On}]),e}(),xn=function(){function e(e,t,n,i,r,a,o,s,l,u,c,h,d,_,f,m){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===c&&(c=1),void 0===h&&(h=0),void 0===d&&(d=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===m&&(m=1);var p=this.elements=new Float32Array(16);p[0]=e,p[1]=t,p[2]=n,p[3]=i,p[4]=r,p[5]=a,p[6]=o,p[7]=s,p[8]=l,p[9]=u,p[10]=c,p[11]=h,p[12]=d,p[13]=_,p[14]=f,p[15]=m}r(e,"laya.d3.math.Matrix4x4");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.getElementByRowColumn=function(e,t){if(0>e||e>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(0>t||t>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]},t.setElementByRowColumn=function(e,t,n){if(0>e||e>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(0>t||t>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=n},t.equalsOtherMatrix=function(e){var t=this.elements,n=e.elements;return Sn.nearEqual(t[0],n[0])&&Sn.nearEqual(t[1],n[1])&&Sn.nearEqual(t[2],n[2])&&Sn.nearEqual(t[3],n[3])&&Sn.nearEqual(t[4],n[4])&&Sn.nearEqual(t[5],n[5])&&Sn.nearEqual(t[6],n[6])&&Sn.nearEqual(t[7],n[7])&&Sn.nearEqual(t[8],n[8])&&Sn.nearEqual(t[9],n[9])&&Sn.nearEqual(t[10],n[10])&&Sn.nearEqual(t[11],n[11])&&Sn.nearEqual(t[12],n[12])&&Sn.nearEqual(t[13],n[13])&&Sn.nearEqual(t[14],n[14])&&Sn.nearEqual(t[15],n[15])},t.decomposeTransRotScale=function(t,n,i){var r=e._tempMatrix4x4;return this.decomposeTransRotMatScale(t,r,i)?(An.createFromMatrix4x4(r,n),!0):(n.identity(),!1)},t.decomposeTransRotMatScale=function(t,n,i){var r=this.elements,a=t.elements,o=n.elements,s=i.elements;a[0]=r[12],a[1]=r[13],a[2]=r[14];var l=r[0],u=r[1],c=r[2],h=r[4],d=r[5],_=r[6],f=r[8],m=r[9],p=r[10],E=s[0]=Math.sqrt(l*l+u*u+c*c),v=s[1]=Math.sqrt(h*h+d*d+_*_),g=s[2]=Math.sqrt(f*f+m*m+p*p);if(Sn.isZero(E)||Sn.isZero(v)||Sn.isZero(g))return o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=o[12]=o[13]=o[14]=0,o[0]=o[5]=o[10]=o[15]=1,!1;var T=e._tempVector0,S=T.elements;S[0]=f/g,S[1]=m/g,S[2]=p/g;var D=e._tempVector1,x=D.elements;x[0]=l/E,x[1]=u/E,x[2]=c/E;var M=e._tempVector2;On.cross(T,D,M);var R=e._tempVector1;return On.cross(M,T,R),o[3]=o[7]=o[11]=o[12]=o[13]=o[14]=0,o[15]=1,o[0]=R.x,o[1]=R.y,o[2]=R.z,o[4]=M.x,o[5]=M.y,o[6]=M.z,o[8]=T.x,o[9]=T.y,o[10]=T.z,o[0]*l+o[1]*u+o[2]*c<0&&(s[0]=-E),o[4]*h+o[5]*d+o[6]*_<0&&(s[1]=-v),o[8]*f+o[9]*m+o[10]*p<0&&(s[2]=-g),!0},t.decomposeYawPitchRoll=function(e){var t=e.elements,n=Math.asin(-this.elements[9]);t[1]=n;var i=Math.cos(n);i>Sn.zeroTolerance?(t[2]=Math.atan2(this.elements[1],this.elements[5]),t[0]=Math.atan2(this.elements[8],this.elements[10])):(t[2]=Math.atan2(-this.elements[4],this.elements[0]),t[0]=0)},t.normalize=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=Math.sqrt(t*t+n*n+i*i);return r?(1!=r&&(r=1/r,e[0]=t*r,e[1]=n*r,e[2]=i*r),void 0):(e[0]=0,e[1]=0,e[2]=0,void 0)},t.transpose=function(){var e,t;return e=this.elements,t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},t.invert=function(e){var t=this.elements,n=e.elements,i=t[0],r=t[1],a=t[2],o=t[3],s=t[4],l=t[5],u=t[6],c=t[7],h=t[8],d=t[9],_=t[10],f=t[11],m=t[12],p=t[13],E=t[14],v=t[15],g=i*l-r*s,T=i*u-a*s,S=i*c-o*s,D=r*u-a*l,x=r*c-o*l,M=a*c-o*u,R=h*p-d*m,A=h*E-_*m,I=h*v-f*m,y=d*E-_*p,C=d*v-f*p,O=_*v-f*E,V=g*O-T*C+S*y+D*I-x*A+M*R;0!==Math.abs(V)&&(V=1/V,n[0]=(l*O-u*C+c*y)*V,n[1]=(a*C-r*O-o*y)*V,n[2]=(p*M-E*x+v*D)*V,n[3]=(_*x-d*M-f*D)*V,n[4]=(u*I-s*O-c*A)*V,n[5]=(i*O-a*I+o*A)*V,n[6]=(E*S-m*M-v*T)*V,n[7]=(h*M-_*S+f*T)*V,n[8]=(s*C-l*I+c*R)*V,n[9]=(r*I-i*C-o*R)*V,n[10]=(m*x-p*S+v*g)*V,n[11]=(d*S-h*x-f*g)*V,n[12]=(l*A-s*y-u*R)*V,n[13]=(i*y-r*A+a*R)*V,n[14]=(p*T-m*D-E*g)*V,n[15]=(h*D-d*T+_*g)*V)},t.identity=function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;16>t;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.getTranslationVector=function(e){var t=this.elements,n=e.elements;n[0]=t[12],n[1]=t[13],n[2]=t[14]},t.setTranslationVector=function(e){var t=this.elements,n=e.elements;t[12]=n[0],t[13]=n[1],t[14]=n[2]},t.getForward=function(e){var t=this.elements,n=e.elements;n[0]=-t[8],n[1]=-t[9],n[2]=-t[10]},t.setForward=function(e){var t=this.elements,n=e.elements;t[8]=-n[0],t[9]=-n[1],t[10]=-n[2]},e.createRotationX=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=r,n[6]=i,n[9]=-i},e.createRotationY=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=r,n[2]=-i,n[8]=i},e.createRotationZ=function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=r,n[1]=i,n[4]=-i},e.createRotationYawPitchRoll=function(t,n,i,r){An.createFromYawPitchRoll(t,n,i,e._tempQuaternion),e.createRotationQuaternion(e._tempQuaternion,r)},e.createRotationAxis=function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=Math.cos(t),l=Math.sin(t),u=r*r,c=a*a,h=o*o,d=r*a,_=r*o,f=a*o,m=n.elements;m[3]=m[7]=m[11]=m[12]=m[13]=m[14]=0,m[15]=1,m[0]=u+s*(1-u),m[1]=d-s*d+l*o,m[2]=_-s*_-l*a,m[4]=d-s*d-l*o,m[5]=c+s*(1-c),m[6]=f-s*f+l*r,m[8]=_-s*_+l*a,m[9]=f-s*f-l*r,m[10]=h+s*(1-h)},e.createRotationQuaternion=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],l=r*r,u=a*a,c=o*o,h=r*a,d=o*s,_=o*r,f=a*s,m=a*o,p=r*s;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(u+c),i[1]=2*(h+d),i[2]=2*(_-f),i[4]=2*(h-d),i[5]=1-2*(c+l),i[6]=2*(m+p),i[8]=2*(_+f),i[9]=2*(m-p),i[10]=1-2*(u+l)},e.createTranslate=function(e,t){var n=e.elements,i=t.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},e.createScaling=function(e,t){var n=e.elements,i=t.elements;i[0]=n[0],i[5]=n[1],i[10]=n[2],i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1},e.multiply=function(e,t,n){var i,r,a,o,s,l,u,c;if(r=n.elements,a=e.elements,o=t.elements,r===o)for(o=new Float32Array(16),i=0;16>i;++i)o[i]=r[i];for(i=0;4>i;i++)s=a[i],l=a[i+4],u=a[i+8],c=a[i+12],r[i]=s*o[0]+l*o[1]+u*o[2]+c*o[3],r[i+4]=s*o[4]+l*o[5]+u*o[6]+c*o[7],r[i+8]=s*o[8]+l*o[9]+u*o[10]+c*o[11],r[i+12]=s*o[12]+l*o[13]+u*o[14]+c*o[15]},e.createFromQuaternion=function(e,t){var n=t.elements,i=e.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=r+r,u=a+a,c=o+o,h=r*l,d=a*l,_=a*u,f=o*l,m=o*u,p=o*c,E=s*l,v=s*u,g=s*c;
n[0]=1-_-p,n[1]=d+g,n[2]=f-v,n[3]=0,n[4]=d-g,n[5]=1-h-p,n[6]=m+E,n[7]=0,n[8]=f+v,n[9]=m-E,n[10]=1-h-_,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},e.createAffineTransformation=function(e,t,n,i){var r=e.elements,a=t.elements,o=n.elements,s=i.elements,l=a[0],u=a[1],c=a[2],h=a[3],d=l+l,_=u+u,f=c+c,m=l*d,p=l*_,E=l*f,v=u*_,g=u*f,T=c*f,S=h*d,D=h*_,x=h*f,M=o[0],R=o[1],A=o[2];s[0]=(1-(v+T))*M,s[1]=(p+x)*M,s[2]=(E-D)*M,s[3]=0,s[4]=(p-x)*R,s[5]=(1-(m+T))*R,s[6]=(g+S)*R,s[7]=0,s[8]=(E+D)*A,s[9]=(g-S)*A,s[10]=(1-(m+v))*A,s[11]=0,s[12]=r[0],s[13]=r[1],s[14]=r[2],s[15]=1},e.createLookAt=function(t,n,i,r){var a=r.elements,o=e._tempVector0,s=e._tempVector1,l=e._tempVector2;On.subtract(t,n,l),On.normalize(l,l),On.cross(i,l,o),On.normalize(o,o),On.cross(l,o,s),r.identity(),a[0]=o.x,a[4]=o.y,a[8]=o.z,a[1]=s.x,a[5]=s.y,a[9]=s.z,a[2]=l.x,a[6]=l.y,a[10]=l.z,a[12]=-On.dot(o,t),a[13]=-On.dot(s,t),a[14]=-On.dot(l,t)},e.createPerspective=function(e,t,n,i,r){var a=r.elements,o=1/Math.tan(e/2),s=1/(n-i);a[0]=o/t,a[5]=o,a[10]=(i+n)*s,a[11]=-1,a[14]=2*i*n*s,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},e.createOrthoOffCenterRH=function(e,t,n,i,r,a,o){var s=o.elements,l=1/(e-t),u=1/(n-i),c=1/(r-a);s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=0,s[15]=1,s[0]=-2*l,s[5]=-2*u,s[10]=2*c,s[12]=(e+t)*l,s[13]=(i+n)*u,s[14]=(a+r)*c},e.translation=function(e,t){var n=e.elements,i=t.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},i(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new e},"_tempVector0",function(){return this._tempVector0=new On},"_tempVector1",function(){return this._tempVector1=new On},"_tempVector2",function(){return this._tempVector2=new On},"_tempQuaternion",function(){return this._tempQuaternion=new An},"DEFAULT",function(){return this.DEFAULT=new e},"ZERO",function(){return this.ZERO=new e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}]),e}(),Mn=function(){function e(e,t){this.extents=null,this.transformation=null,this.extents=e,this.transformation=t}r(e,"laya.d3.math.OrientedBoundBox");var t=e.prototype;return t.getCorners=function(t){var n=e._tempV30.elements,i=e._tempV31.elements,r=e._tempV32.elements,a=this.extents.elements;n[0]=a[0],n[1]=n[2]=0,i[1]=a[1],i[0]=i[2]=0,r[2]=a[2],r[0]=r[1]=0,On.TransformNormal(e._tempV30,this.transformation,e._tempV30),On.TransformNormal(e._tempV31,this.transformation,e._tempV31),On.TransformNormal(e._tempV32,this.transformation,e._tempV32);var o=e._tempV33;this.transformation.getTranslationVector(o),t.length=8,On.add(o,e._tempV30,e._tempV34),On.add(e._tempV34,e._tempV31,e._tempV34),On.add(e._tempV34,e._tempV32,t[0]),On.add(o,e._tempV30,e._tempV34),On.add(e._tempV34,e._tempV31,e._tempV34),On.subtract(e._tempV34,e._tempV32,t[1]),On.subtract(o,e._tempV30,e._tempV34),On.add(e._tempV34,e._tempV31,e._tempV34),On.subtract(e._tempV34,e._tempV32,t[2]),On.subtract(o,e._tempV30,e._tempV34),On.add(e._tempV34,e._tempV31,e._tempV34),On.add(e._tempV34,e._tempV32,t[3]),On.add(o,e._tempV30,e._tempV34),On.subtract(e._tempV34,e._tempV31,e._tempV34),On.add(e._tempV34,e._tempV32,t[4]),On.add(o,e._tempV30,e._tempV34),On.subtract(e._tempV34,e._tempV31,e._tempV34),On.subtract(e._tempV34,e._tempV32,t[5]),On.subtract(o,e._tempV30,e._tempV34),On.subtract(e._tempV34,e._tempV31,e._tempV34),On.subtract(e._tempV34,e._tempV32,t[6]),On.subtract(o,e._tempV30,e._tempV34),On.subtract(e._tempV34,e._tempV31,e._tempV34),On.add(e._tempV34,e._tempV32,t[7])},t.transform=function(e){xn.multiply(this.transformation,e,this.transformation)},t.scale=function(e){On.multiply(this.extents,e,this.extents)},t.translate=function(t){this.transformation.getTranslationVector(e._tempV30),On.add(e._tempV30,t,e._tempV31),this.transformation.setTranslationVector(e._tempV31)},t.Size=function(e){On.scale(this.extents,2,e)},t.getSize=function(t){var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],On.TransformNormal(e._tempV30,this.transformation,e._tempV30),On.TransformNormal(e._tempV31,this.transformation,e._tempV31),On.TransformNormal(e._tempV31,this.transformation,e._tempV32);var i=t.elements;i[0]=On.scalarLength(e._tempV30),i[1]=On.scalarLength(e._tempV31),i[2]=On.scalarLength(e._tempV32)},t.getSizeSquared=function(t){var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],On.TransformNormal(e._tempV30,this.transformation,e._tempV30),On.TransformNormal(e._tempV31,this.transformation,e._tempV31),On.TransformNormal(e._tempV31,this.transformation,e._tempV32);var i=t.elements;i[0]=On.scalarLengthSquared(e._tempV30),i[1]=On.scalarLengthSquared(e._tempV31),i[2]=On.scalarLengthSquared(e._tempV32)},t.getCenter=function(e){this.transformation.getTranslationVector(e)},t.containsPoint=function(t){var n=this.extents.elements,i=n[0],r=n[1],a=n[2];this.transformation.invert(e._tempM0),On.transformCoordinate(t,e._tempM0,e._tempV30);var o=e._tempV30.elements,s=Math.abs(o[0]),l=Math.abs(o[1]),u=Math.abs(o[2]);return Sn.nearEqual(s,i)&&Sn.nearEqual(l,r)&&Sn.nearEqual(u,a)?2:i>s&&r>l&&a>u?1:0},t.containsPoints=function(t){var n=this.extents.elements,i=n[0],r=n[1],a=n[2];this.transformation.invert(e._tempM0);for(var o=!0,s=!1,l=0;l<t.length;l++){On.transformCoordinate(t[l],e._tempM0,e._tempV30);var u=e._tempV30.elements,c=Math.abs(u[0]),h=Math.abs(u[1]),d=Math.abs(u[2]);Sn.nearEqual(c,i)&&Sn.nearEqual(h,r)&&Sn.nearEqual(d,a)&&(s=!0),i>c&&r>h&&a>d?s=!0:o=!1}return o?1:s?2:0},t.containsSphere=function(t,n){void 0===n&&(n=!1);var i=this.extents.elements,r=i[0],a=i[1],o=i[2],s=t.radius;this.transformation.invert(e._tempM0),On.transformCoordinate(t.center,e._tempM0,e._tempV30);var l=0/0;n?l=s:(On.scale(On.UnitX,s,e._tempV31),On.TransformNormal(e._tempV31,e._tempM0,e._tempV31),l=On.scalarLength(e._tempV31)),On.scale(this.extents,-1,e._tempV32),On.Clamp(e._tempV30,e._tempV32,this.extents,e._tempV33);var u=On.distanceSquared(e._tempV30,e._tempV33);if(u>l*l)return 0;var c=e._tempV30.elements,h=c[0],d=c[1],_=c[2],f=e._tempV32.elements,m=f[0],p=f[1],E=f[2];return h>=m+l&&r-l>=h&&r-m>l&&d>=p+l&&a-l>=d&&a-p>l&&_>=E+l&&o-l>=_&&o-E>l?1:2},t.containsOrientedBoundBox=function(t){var n=0,i=0;t.getCorners(e._corners);var r=this.containsPoints(e._corners);if(0!=r)return r;var a=this.extents.elements;t.extents.cloneTo(e._tempV35);var o=e._tempV35.elements;e._getRows(this.transformation,e._rows1),e._getRows(t.transformation,e._rows2);var s=0/0,l=0/0,u=0/0,c=0/0;for(n=0;4>n;n++)for(i=0;4>i;i++)3==n||3==i?(e._tempM0.setElementByRowColumn(n,i,0),e._tempM1.setElementByRowColumn(n,i,0)):(c=On.dot(e._rows1[n],e._rows2[i]),e._tempM0.setElementByRowColumn(n,i,c),e._tempM1.setElementByRowColumn(n,i,Math.abs(c)));t.getCenter(e._tempV34),this.getCenter(e._tempV36),On.subtract(e._tempV34,e._tempV36,e._tempV30);var h=e._tempV31.elements;h[0]=On.dot(e._tempV30,e._rows1[0]),h[1]=On.dot(e._tempV30,e._rows1[1]),h[2]=On.dot(e._tempV30,e._rows1[2]);var d=e._tempV32.elements,_=e._tempV33.elements;for(n=0;3>n;n++)if(d[0]=e._tempM1.getElementByRowColumn(n,0),d[1]=e._tempM1.getElementByRowColumn(n,1),d[2]=e._tempM1.getElementByRowColumn(n,2),s=a[n],l=On.dot(e._tempV35,e._tempV32),u=Math.abs(h[n]),u>s+l)return 0;for(i=0;3>i;i++)if(d[0]=e._tempM1.getElementByRowColumn(0,i),d[1]=e._tempM1.getElementByRowColumn(1,i),d[2]=e._tempM1.getElementByRowColumn(2,i),_[0]=e._tempM0.getElementByRowColumn(0,i),_[1]=e._tempM0.getElementByRowColumn(1,i),_[2]=e._tempM0.getElementByRowColumn(2,i),s=On.dot(this.extents,e._tempV32),l=o[i],u=Math.abs(On.dot(e._tempV31,e._tempV33)),u>s+l)return 0;for(n=0;3>n;n++)for(i=0;3>i;i++){var f=(n+1)%3,m=(n+2)%3,p=(i+1)%3,E=(i+2)%3;if(s=a[f]*e._tempM1.getElementByRowColumn(m,i)+a[m]*e._tempM1.getElementByRowColumn(f,i),l=o[p]*e._tempM1.getElementByRowColumn(n,E)+o[E]*e._tempM1.getElementByRowColumn(n,p),u=Math.abs(h[m]*e._tempM0.getElementByRowColumn(f,i)-h[f]*e._tempM0.getElementByRowColumn(m,i)),u>s+l)return 0}return 2},t.containsLine=function(t,n){e._corners[0]=t,e._corners[1]=n;var i=this.containsPoints(e._corners);if(0!=i)return i;var r=this.extents.elements,a=r[0],o=r[1],s=r[2];this.transformation.invert(e._tempM0),On.transformCoordinate(t,e._tempM0,e._tempV30),On.transformCoordinate(n,e._tempM0,e._tempV31),On.add(e._tempV30,e._tempV31,e._tempV32),On.scale(e._tempV32,.5,e._tempV32),On.subtract(e._tempV30,e._tempV32,e._tempV33);var l=e._tempV33.elements,u=l[0],c=l[1],h=l[2],d=e._tempV34.elements,_=d[0]=Math.abs(l[0]),f=d[1]=Math.abs(l[1]),m=d[2]=Math.abs(l[2]),p=e._tempV32.elements,E=p[0],v=p[1],g=p[2];return Math.abs(E)>a+_?0:Math.abs(v)>o+f?0:Math.abs(g)>s+m?0:Math.abs(v*h-g*c)>o*m+s*f?0:Math.abs(E*h-g*u)>a*m+s*_?0:Math.abs(E*c-v*u)>a*f+o*_?0:2},t.containsBoundBox=function(t){var n=0,i=0,r=t.min,a=t.max;t.getCorners(e._corners);var o=this.containsPoints(e._corners);if(0!=o)return o;On.subtract(a,r,e._tempV30),On.scale(e._tempV30,.5,e._tempV30),On.add(r,e._tempV30,e._tempV30),On.subtract(a,e._tempV30,e._tempV31);var s=this.extents.elements,l=e._tempV31.elements;e._getRows(this.transformation,e._rows1),this.transformation.invert(e._tempM0);var u=0/0,c=0/0,h=0/0;for(n=0;3>n;n++)for(i=0;3>i;i++)e._tempM1.setElementByRowColumn(n,i,Math.abs(e._tempM0.getElementByRowColumn(n,i)));this.getCenter(e._tempV35),On.subtract(e._tempV30,e._tempV35,e._tempV32);var d=e._tempV31.elements;d[0]=On.dot(e._tempV32,e._rows1[0]),d[1]=On.dot(e._tempV32,e._rows1[1]),d[2]=On.dot(e._tempV32,e._rows1[2]);var _=e._tempV33.elements,f=e._tempV34.elements;for(n=0;3>n;n++)if(_[0]=e._tempM1.getElementByRowColumn(n,0),_[1]=e._tempM1.getElementByRowColumn(n,1),_[2]=e._tempM1.getElementByRowColumn(n,2),u=s[n],c=On.dot(e._tempV31,e._tempV33),h=Math.abs(d[n]),h>u+c)return 0;for(i=0;3>i;i++)if(_[0]=e._tempM1.getElementByRowColumn(0,i),_[1]=e._tempM1.getElementByRowColumn(1,i),_[2]=e._tempM1.getElementByRowColumn(2,i),f[0]=e._tempM0.getElementByRowColumn(0,i),f[1]=e._tempM0.getElementByRowColumn(1,i),f[2]=e._tempM0.getElementByRowColumn(2,i),u=On.dot(this.extents,e._tempV33),c=l[i],h=Math.abs(On.dot(e._tempV31,e._tempV34)),h>u+c)return 0;for(n=0;3>n;n++)for(i=0;3>i;i++){var m=(n+1)%3,p=(n+2)%3,E=(i+1)%3,v=(i+2)%3;if(u=s[m]*e._tempM1.getElementByRowColumn(p,i)+s[p]*e._tempM1.getElementByRowColumn(m,i),c=l[E]*e._tempM1.getElementByRowColumn(n,v)+l[v]*e._tempM1.getElementByRowColumn(n,E),h=Math.abs(d[p]*e._tempM0.getElementByRowColumn(m,i)-d[m]*e._tempM0.getElementByRowColumn(p,i)),h>u+c)return 0}return 2},t.intersectsRay=function(t,n){On.scale(this.extents,-1,e._tempV30),this.transformation.invert(e._tempM0),On.TransformNormal(t.direction,e._tempM0,e._ray.direction),On.transformCoordinate(t.origin,e._tempM0,e._ray.origin),e._boxBound1.min=e._tempV30,e._boxBound1.max=this.extents;var i=Tn.intersectsRayAndBoxRP(e._ray,e._boxBound1,n);return-1!==i&&On.transformCoordinate(n,this.transformation,n),i},t._getLocalCorners=function(t){t.length=8;var n=this.extents.elements;e._tempV30.x=n[0],e._tempV31.y=n[1],e._tempV32.z=n[2],On.add(e._tempV30,e._tempV31,e._tempV33),On.add(e._tempV33,e._tempV32,t[0]),On.add(e._tempV30,e._tempV31,e._tempV33),On.subtract(e._tempV33,e._tempV32,t[1]),On.subtract(e._tempV31,e._tempV30,e._tempV33),On.subtract(e._tempV33,e._tempV30,t[2]),On.subtract(e._tempV31,e._tempV30,e._tempV33),On.add(e._tempV33,e._tempV32,t[3]),On.subtract(e._tempV30,e._tempV31,e._tempV33),On.add(e._tempV33,e._tempV32,t[4]),On.subtract(e._tempV30,e._tempV31,e._tempV33),On.subtract(e._tempV33,e._tempV32,t[5]),On.scale(t[0],-1,t[6]),On.subtract(e._tempV32,e._tempV30,e._tempV33),On.subtract(e._tempV33,e._tempV31,t[7])},t.equals=function(e){return this.extents==e.extents&&this.transformation==e.transformation},t.cloneTo=function(e){var t=e;this.extents.cloneTo(t.extents),this.transformation.cloneTo(t.transformation)},e.createByBoundBox=function(t,n){var i=t.min,r=t.max;On.subtract(r,i,e._tempV30),On.scale(e._tempV30,.5,e._tempV30),On.add(i,e._tempV30,e._tempV31),On.subtract(r,e._tempV31,e._tempV32),xn.translation(e._tempV31,e._tempM0);var a=e._tempV32.clone(),o=e._tempM0.clone();n.extents=a,n.transformation=o},e.createByMinAndMaxVertex=function(t,n){On.subtract(n,t,e._tempV30),On.scale(e._tempV30,.5,e._tempV30),On.add(t,e._tempV30,e._tempV31),On.subtract(n,e._tempV31,e._tempV32),xn.translation(e._tempV31,e._tempM0);var i=new e(e._tempV32,e._tempM0);return i},e._getRows=function(e,t){t.length=3;var n=e.elements,i=t[0].elements;i[0]=n[0],i[1]=n[1],i[2]=n[2];var r=t[1].elements;r[0]=n[4],r[1]=n[5],r[2]=n[6];var a=t[2].elements;a[0]=n[8],a[1]=n[9],a[2]=n[10]},e.getObbtoObbMatrix4x4=function(t,n,i,r){var a=t.transformation,o=n.transformation;if(i){e._getRows(a,e._rows1),e._getRows(o,e._rows2);for(var s=0;3>s;s++)for(var l=0;3>l;l++)r.setElementByRowColumn(s,l,On.dot(e._rows2[s],e._rows1[l]));n.getCenter(e._tempV30),t.getCenter(e._tempV31),On.subtract(e._tempV30,e._tempV31,e._tempV32);var u=r.elements;u[12]=On.dot(e._tempV32,e._rows1[0]),u[13]=On.dot(e._tempV32,e._rows1[1]),u[14]=On.dot(e._tempV32,e._rows1[2]),u[15]=1}else a.invert(e._tempM0),xn.multiply(o,e._tempM0,r)},e.merge=function(t,n,i){var r=t.extents,a=t.transformation;e.getObbtoObbMatrix4x4(t,n,i,e._tempM0),n._getLocalCorners(e._corners),On.transformCoordinate(e._corners[0],e._tempM0,e._corners[0]),On.transformCoordinate(e._corners[1],e._tempM0,e._corners[1]),On.transformCoordinate(e._corners[2],e._tempM0,e._corners[2]),On.transformCoordinate(e._corners[3],e._tempM0,e._corners[3]),On.transformCoordinate(e._corners[4],e._tempM0,e._corners[4]),On.transformCoordinate(e._corners[5],e._tempM0,e._corners[5]),On.transformCoordinate(e._corners[6],e._tempM0,e._corners[6]),On.transformCoordinate(e._corners[7],e._tempM0,e._corners[7]),On.scale(r,-1,e._boxBound1.min),r.cloneTo(e._boxBound1.max),En.createfromPoints(e._corners,e._boxBound2),En.merge(e._boxBound2,e._boxBound1,e._boxBound3);var o=e._boxBound3.min,s=e._boxBound3.max;On.subtract(s,o,e._tempV30),On.scale(e._tempV30,.5,e._tempV30),On.add(o,e._tempV30,e._tempV32),On.subtract(s,e._tempV32,r),On.transformCoordinate(e._tempV32,a,e._tempV33)},i(e,["_tempV30",function(){return this._tempV30=new On},"_tempV31",function(){return this._tempV31=new On},"_tempV32",function(){return this._tempV32=new On},"_tempV33",function(){return this._tempV33=new On},"_tempV34",function(){return this._tempV34=new On},"_tempV35",function(){return this._tempV35=new On},"_tempV36",function(){return this._tempV36=new On},"_tempM0",function(){return this._tempM0=new xn},"_tempM1",function(){return this._tempM1=new xn},"_corners",function(){return this._corners=[new On,new On,new On,new On,new On,new On,new On,new On]},"_rows1",function(){return this._rows1=[new On,new On,new On]},"_rows2",function(){return this._rows2=[new On,new On,new On]},"_ray",function(){return this._ray=new yn(new On,new On)},"_boxBound1",function(){return this._boxBound1=new En(new On,new On)},"_boxBound2",function(){return this._boxBound2=new En(new On,new On)},"_boxBound3",function(){return this._boxBound3=new En(new On,new On)}]),e}(),Rn=function(){function e(e,t){this.normal=null,this.distance=0/0,void 0===t&&(t=0),this.normal=e,this.distance=t}r(e,"laya.d3.math.Plane");var t=e.prototype;return t.normalize=function(){var e=this.normal.elements,t=e[0],n=e[1],i=e[2],r=1/Math.sqrt(t*t+n*n+i*i);e[0]=t*r,e[1]=n*r,e[2]=i*r,this.distance*=r},e.createPlaneBy3P=function(t,n,i){var r=t.elements,a=n.elements,o=i.elements,s=a[0]-r[0],l=a[1]-r[1],u=a[2]-r[2],c=o[0]-r[0],h=o[1]-r[1],d=o[2]-r[2],_=l*d-u*h,f=u*c-s*d,m=s*h-l*c,p=1/Math.sqrt(_*_+f*f+m*m),E=_*p,v=f*p,g=m*p,T=e._TEMPVec3.elements;T[0]=E,T[1]=v,T[2]=g;var S=-(E*r[0]+v*r[1]+g*r[2]),D=new e(e._TEMPVec3,S);return D},e.PlaneIntersectionType_Back=0,e.PlaneIntersectionType_Front=1,e.PlaneIntersectionType_Intersecting=2,i(e,["_TEMPVec3",function(){return this._TEMPVec3=new On}]),e}(),An=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this.elements[0]=e,this.elements[1]=t,this.elements[2]=n,this.elements[3]=i}r(e,"laya.d3.math.Quaternion");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.scaling=function(e,t){var n=t.elements,i=this.elements;n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e},t.normalize=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=i*i+r*r+a*a+o*o;s>0&&(s=1/Math.sqrt(s),t[0]=i*s,t[1]=r*s,t[2]=a*s,t[3]=o*s)},t.length=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3];return Math.sqrt(t*t+n*n+i*i+r*r)},t.rotateX=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=r*u+s*l,n[1]=a*u+o*l,n[2]=o*u-a*l,n[3]=s*u-r*l},t.rotateY=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=r*u-o*l,n[1]=a*u+s*l,n[2]=o*u+r*l,n[3]=s*u-a*l},t.rotateZ=function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=r*u+a*l,n[1]=a*u-r*l,n[2]=o*u+s*l,n[3]=s*u-o*l},t.getYawPitchRoll=function(t){On.transformQuat(On.ForwardRH,this,e.TEMPVector31),On.transformQuat(On.Up,this,e.TEMPVector32);var n=e.TEMPVector32.elements;e.angleTo(On.ZERO,e.TEMPVector31,e.TEMPVector33);var i=e.TEMPVector33.elements;i[0]==Math.PI/2?(i[1]=e.arcTanAngle(n[2],n[0]),i[2]=0):i[0]==-Math.PI/2?(i[1]=e.arcTanAngle(-n[2],-n[0]),i[2]=0):(xn.createRotationY(-i[1],e.TEMPMatrix0),xn.createRotationX(-i[0],e.TEMPMatrix1),On.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),On.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),i[2]=e.arcTanAngle(n[1],-n[0])),i[1]<=-Math.PI&&(i[1]=Math.PI),i[2]<=-Math.PI&&(i[2]=Math.PI),i[1]>=Math.PI&&i[2]>=Math.PI&&(i[1]=0,i[2]=0,i[0]=Math.PI-i[0]);var r=t.elements;r[0]=i[1],r[1]=i[0],r[2]=i[2]},t.invert=function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=i*i+r*r+a*a+o*o,l=s?1/s:0;t[0]=-i*l,t[1]=-r*l,t[2]=-a*l,t[3]=o*l},t.identity=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1},t.fromArray=function(e,t){void 0===t&&(t=0),this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]},t.cloneTo=function(e){var t,n,i;if(n=this.elements,i=e.elements,n!==i)for(t=0;4>t;++t)i[t]=n[t]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.equals=function(e){var t=this.elements,n=e.elements;return Sn.nearEqual(t[0],n[0])&&Sn.nearEqual(t[1],n[1])&&Sn.nearEqual(t[2],n[2])&&Sn.nearEqual(t[3],n[3])},t.lengthSquared=function(){var e=this.elements[0],t=this.elements[1],n=this.elements[2],i=this.elements[3];return e*e+t*t+n*n+i*i},a(0,t,"x",function(){return this.elements[0]}),a(0,t,"y",function(){return this.elements[1]}),a(0,t,"z",function(){return this.elements[2]}),a(0,t,"w",function(){return this.elements[3]}),e.createFromYawPitchRoll=function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),l=Math.cos(r),u=Math.sin(a),c=Math.cos(a),h=Math.sin(o),d=Math.cos(o),_=i.elements;_[0]=d*u*l+h*c*s,_[1]=h*c*l-d*u*s,_[2]=d*c*s-h*u*l,_[3]=d*c*l+h*u*s},e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],c=r[0],h=r[1],d=r[2],_=r[3],f=s*d-l*h,m=l*c-o*d,p=o*h-s*c,E=o*c+s*h+l*d;a[0]=o*_+c*u+f,a[1]=s*_+h*u+m,a[2]=l*_+d*u+p,a[3]=u*_-E},e.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):0>e?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},e.angleTo=function(t,n,i){On.subtract(n,t,e.TEMPVector30),On.normalize(e.TEMPVector30,e.TEMPVector30),i.elements[0]=Math.asin(e.TEMPVector30.y),i.elements[1]=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)},e.createFromAxisAngle=function(e,t,n){var i=n.elements,r=e.elements;t=.5*t;var a=Math.sin(t);i[0]=a*r[0],i[1]=a*r[1],i[2]=a*r[2],i[3]=Math.cos(t)},e.createFromMatrix3x3=function(e,t){var n,i=t.elements,r=e.elements,a=r[0]+r[4]+r[8];if(a>0)n=Math.sqrt(a+1),i[3]=.5*n,n=.5/n,i[0]=(r[5]-r[7])*n,i[1]=(r[6]-r[2])*n,i[2]=(r[1]-r[3])*n;else{var o=0;r[4]>r[0]&&(o=1),r[8]>r[3*o+o]&&(o=2);var s=(o+1)%3,l=(o+2)%3;n=Math.sqrt(r[3*o+o]-r[3*s+s]-r[3*l+l]+1),i[o]=.5*n,n=.5/n,i[3]=(r[3*s+l]-r[3*l+s])*n,i[s]=(r[3*s+o]+r[3*o+s])*n,i[l]=(r[3*l+o]+r[3*o+l])*n}},e.createFromMatrix4x4=function(e,t){var n,i,r=e.elements,a=t.elements,o=r[0]+r[5]+r[10];o>0?(n=Math.sqrt(o+1),a[3]=.5*n,n=.5/n,a[0]=(r[6]-r[9])*n,a[1]=(r[8]-r[2])*n,a[2]=(r[1]-r[4])*n):r[0]>=r[5]&&r[0]>=r[10]?(n=Math.sqrt(1+r[0]-r[5]-r[10]),i=.5/n,a[0]=.5*n,a[1]=(r[1]+r[4])*i,a[2]=(r[2]+r[8])*i,a[3]=(r[6]-r[9])*i):r[5]>r[10]?(n=Math.sqrt(1+r[5]-r[0]-r[10]),i=.5/n,a[0]=(r[4]+r[1])*i,a[1]=.5*n,a[2]=(r[9]+r[6])*i,a[3]=(r[8]-r[2])*i):(n=Math.sqrt(1+r[10]-r[0]-r[5]),i=.5/n,a[0]=(r[8]+r[2])*i,a[1]=(r[9]+r[6])*i,a[2]=.5*n,a[3]=(r[1]-r[4])*i)},e.slerp=function(e,t,n,i){var r,a,o,s,l,u=e.elements,c=t.elements,h=i.elements,d=u[0],_=u[1],f=u[2],m=u[3],p=c[0],E=c[1],v=c[2],g=c[3];return a=d*p+_*E+f*v+m*g,0>a&&(a=-a,p=-p,E=-E,v=-v,g=-g),1-a>1e-6?(r=Math.acos(a),o=Math.sin(r),s=Math.sin((1-n)*r)/o,l=Math.sin(n*r)/o):(s=1-n,l=n),h[0]=s*d+l*p,h[1]=s*_+l*E,h[2]=s*f+l*v,h[3]=s*m+l*g,h},e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],u=a[2],c=a[3];r[0]=s+n*(o[0]-s),r[1]=l+n*(o[1]-l),r[2]=u+n*(o[2]-u),r[3]=c+n*(o[3]-c)},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},e.dot=function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},e.rotationLookAt=function(t,n,i){e.lookAt(On.ZERO,t,n,i)},e.lookAt=function(t,n,i,r){Dn.lookAt(t,n,i,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,r)},e.invert=function(e,t){var n=e.elements,i=t.elements,r=e.lengthSquared();Sn.isZero(r)||(r=1/r,i[0]=-n[0]*r,i[1]=-n[1]*r,i[2]=-n[2]*r,i[3]=n[3]*r)},e.rotationMatrix=function(e,t){var n=e.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],u=n[6],c=n[7],h=n[8],d=t.elements,_=0/0,f=0/0,m=i+s+h;m>0?(_=Math.sqrt(m+1),d[3]=.5*_,_=.5/_,d[0]=(l-c)*_,d[1]=(u-a)*_,d[2]=(r-o)*_):i>=s&&i>=h?(_=Math.sqrt(1+i-s-h),f=.5/_,d[0]=.5*_,d[1]=(r+o)*f,d[2]=(a+u)*f,d[3]=(l-c)*f):s>h?(_=Math.sqrt(1+s-i-h),f=.5/_,d[0]=(o+r)*f,d[1]=.5*_,d[2]=(c+l)*f,d[3]=(u-a)*f):(_=Math.sqrt(1+h-i-s),f=.5/_,d[0]=(u+a)*f,d[1]=(c+l)*f,d[2]=.5*_,d[3]=(r-o)*f)},e.DEFAULT=new e,i(e,["TEMPVector30",function(){return this.TEMPVector30=new On},"TEMPVector31",function(){return this.TEMPVector31=new On},"TEMPVector32",function(){return this.TEMPVector32=new On},"TEMPVector33",function(){return this.TEMPVector33=new On},"TEMPMatrix0",function(){return this.TEMPMatrix0=new xn},"TEMPMatrix1",function(){return this.TEMPMatrix1=new xn},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new Dn},"NAN",function(){return this.NAN=new e(0/0,0/0,0/0,0/0)}]),e}(),In=function(){function e(e){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}r(e,"laya.d3.math.Rand");var t=e.prototype;return t.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^(this._temp[0]^this._temp[0]>>>8),this.seeds[3]},t.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},t.getSignedFloat=function(){return 2*this.getFloat()-1},a(0,t,"seed",function(){return this.seeds[0]},function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),e.getFloatFromInt=function(e){return(8388607&e)*(1/8388607)},e.getByteFromInt=function(e){return(8388607&e)>>>15},e}(),yn=(function(){function e(){}r(e,"laya.d3.math.RandX");var t=e.prototype;return t.randomint=function(){},t.random=function(){},i(e,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8))},"defaultRand",function(){return this.defaultRand=new In([0,Date.now()/65536,0,Date.now()%65536])}]),e}(),function(){function e(e,t){this.origin=null,this.direction=null,this.origin=e,this.direction=t}return r(e,"laya.d3.math.Ray"),e}()),Cn=function(){function e(e,t){this.elements=new Float32Array(2),void 0===e&&(e=0),void 0===t&&(t=0);var n=this.elements;n[0]=e,n[1]=t}r(e,"laya.d3.math.Vector2");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.fromArray=function(e,t){void 0===t&&(t=0),this.elements[0]=e[t+0],this.elements[1]=e[t+1]},t.cloneTo=function(e){var t=e,n=t.elements,i=this.elements;n[0]=i[0],n[1]=i[1]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t},i(e,["ZERO",function(){return this.ZERO=new e(0,0)},"ONE",function(){return this.ONE=new e(1,1)}]),e}(),On=function(){function e(e,t,n){this.elements=new Float32Array(3),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0);var i=this.elements;i[0]=e,i[1]=t,i[2]=n}r(e,"laya.d3.math.Vector3");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.fromArray=function(e,t){void 0===t&&(t=0),this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2]},t.cloneTo=function(e){var t=e,n=t.elements,i=this.elements;n[0]=i[0],n[1]=i[1],n[2]=i[2]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),a(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),e.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2];return r*r+a*a+o*o},e.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2];return Math.sqrt(r*r+a*a+o*o)},e.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2])},e.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2])},e.transformQuat=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,o=r[0],s=r[1],l=r[2],u=a[0],c=a[1],h=a[2],d=a[3],_=d*o+c*l-h*s,f=d*s+h*o-u*l,m=d*l+u*s-c*o,p=-u*o-c*s-h*l;i[0]=_*d+p*-u+f*-h-m*-c,i[1]=f*d+p*-c+m*-u-_*-h,i[2]=m*d+p*-h+_*-c-f*-u},e.scalarLength=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return Math.sqrt(n*n+i*i+r*r)},e.scalarLengthSquared=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return n*n+i*i+r*r},e.normalize=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=r*r+a*a+o*o;s>0&&(s=1/Math.sqrt(s),i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s)},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2]},e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t},e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],u=a[2];r[0]=s+n*(o[0]-s),r[1]=l+n*(o[1]-l),r[2]=u+n*(o[2]-u)},e.transformV3ToV3=function(t,n,i){var r=e._tempVector4;e.transformV3ToV4(t,n,r);var a=r.elements,o=i.elements;o[0]=a[0],o[1]=a[1],o[2]=a[2]},e.transformV3ToV4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=t.elements,l=n.elements;l[0]=r*s[0]+a*s[4]+o*s[8]+s[12],l[1]=r*s[1]+a*s[5]+o*s[9]+s[13],l[2]=r*s[2]+a*s[6]+o*s[10]+s[14],l[3]=r*s[3]+a*s[7]+o*s[11]+s[15]},e.TransformNormal=function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=t.elements,l=n.elements;l[0]=r*s[0]+a*s[4]+o*s[8],l[1]=r*s[1]+a*s[5]+o*s[9],l[2]=r*s[2]+a*s[6]+o*s[10]},e.transformCoordinate=function(t,n,i){var r=e._tempVector4.elements,a=t.elements,o=a[0],s=a[1],l=a[2],u=n.elements;r[0]=o*u[0]+s*u[4]+l*u[8]+u[12],r[1]=o*u[1]+s*u[5]+l*u[9]+u[13],r[2]=o*u[2]+s*u[6]+l*u[10]+u[14],r[3]=1/(o*u[3]+s*u[7]+l*u[11]+u[15]);var c=i.elements;c[0]=r[0]*r[3],c[1]=r[1]*r[3],c[2]=r[2]*r[3]},e.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],o=r[1],s=r[2],l=t.elements,u=l[0],c=l[1],h=l[2],d=n.elements,_=d[0],f=d[1],m=d[2],p=i.elements;a=a>_?_:a,a=u>a?u:a,o=o>f?f:o,o=c>o?c:o,s=s>m?m:s,s=h>s?h:s,p[0]=a,p[1]=o,p[2]=s},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2]},e.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2]},e.cross=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],u=r[0],c=r[1],h=r[2];a[0]=s*h-l*c,a[1]=l*u-o*h,a[2]=o*c-s*u},e.dot=function(e,t){var n=e.elements,i=t.elements,r=n[0]*i[0]+n[1]*i[1]+n[2]*i[2];return r},e.equals=function(e,t){var n=e.elements,i=t.elements;return Sn.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&Sn.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&Sn.nearEqual(Math.abs(n[2]),Math.abs(i[2]))},e.ZERO=new e(0,0,0),e.ONE=new e(1,1,1),e.NegativeUnitX=new e(-1,0,0),e.UnitX=new e(1,0,0),e.UnitY=new e(0,1,0),e.UnitZ=new e(0,0,1),e.ForwardRH=new e(0,0,-1),e.ForwardLH=new e(0,0,1),e.Up=new e(0,1,0),e.NAN=new e(0/0,0/0,0/0),i(e,["_tempVector4",function(){return this._tempVector4=new Vn}]),e}(),Vn=function(){function e(e,t,n,i){this.elements=new Float32Array(4),void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0);var r=this.elements;r[0]=e,r[1]=t,r[2]=n,r[3]=i}r(e,"laya.d3.math.Vector4");var t=e.prototype;return n.imps(t,{"laya.d3.core.IClone":!0}),t.fromArray=function(e,t){void 0===t&&(t=0),this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]},t.cloneTo=function(e){var t=e,n=t.elements,i=this.elements;n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3]},t.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},a(0,t,"x",function(){return this.elements[0]},function(e){this.elements[0]=e}),a(0,t,"y",function(){return this.elements[1]},function(e){this.elements[1]=e}),a(0,t,"z",function(){return this.elements[2]},function(e){this.elements[2]=e}),a(0,t,"w",function(){return this.elements[3]},function(e){this.elements[3]=e}),e.lerp=function(e,t,n,i){var r=i.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],u=a[2],c=a[3];r[0]=s+n*(o[0]-s),r[1]=l+n*(o[1]-l),r[2]=u+n*(o[2]-u),r[3]=c+n*(o[3]-c)},e.transformByM4x4=function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=t.elements,u=n.elements;u[0]=r*l[0]+a*l[4]+o*l[8]+s*l[12],u[1]=r*l[1]+a*l[5]+o*l[9]+s*l[13],u[2]=r*l[2]+a*l[6]+o*l[10]+s*l[14],u[3]=r*l[3]+a*l[7]+o*l[11]+s*l[15]},e.equals=function(e,t){var n=e.elements,i=t.elements;return Sn.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&Sn.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&Sn.nearEqual(Math.abs(n[2]),Math.abs(i[2]))&&Sn.nearEqual(Math.abs(n[3]),Math.abs(i[3]))},e.normalize=function(e,t){var n=e.elements,i=t.elements,r=e.length();r>0&&(i[0]=n[0]*r,i[1]=n[1]*r,i[2]=n[2]*r,i[3]=n[3]*r)},e.add=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},e.subtract=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2],i[3]=r[3]-a[3]},e.multiply=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2],i[3]=r[3]*a[3]},e.scale=function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t,i[3]=r[3]*t},e.Clamp=function(e,t,n,i){var r=e.elements,a=r[0],o=r[1],s=r[2],l=r[3],u=t.elements,c=u[0],h=u[1],d=u[2],_=u[3],f=n.elements,m=f[0],p=f[1],E=f[2],v=f[3],g=i.elements;a=a>m?m:a,a=c>a?c:a,o=o>p?p:o,o=h>o?h:o,s=s>E?E:s,s=d>s?d:s,l=l>v?v:l,l=_>l?_:l,g[0]=a,g[1]=o,g[2]=s,g[3]=l},e.distanceSquared=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2],s=n[3]-i[3];return r*r+a*a+o*o+s*s
},e.distance=function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2],s=n[3]-i[3];return Math.sqrt(r*r+a*a+o*o+s*s)},e.dot=function(e,t){var n=e.elements,i=t.elements,r=n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3];return r},e.min=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2]),i[3]=Math.min(r[3],a[3])},e.max=function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2]),i[3]=Math.max(r[3],a[3])},i(e,["ZERO",function(){return this.ZERO=new e},"ONE",function(){return this.ONE=new e(1,1,1,1)},"UnitX",function(){return this.UnitX=new e(1,0,0,0)},"UnitY",function(){return this.UnitY=new e(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new e(0,0,1,0)},"UnitW",function(){return this.UnitW=new e(0,0,0,1)}]),e}(),Ln=function(){function e(e,t,n,i){this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=n,this.height=i}r(e,"laya.d3.math.Viewport");var t=e.prototype;return t.project=function(e,t,n){On.transformV3ToV3(e,t,n);var i=e.elements,r=t.elements,a=n.elements,o=i[0]*r[3]+i[1]*r[7]+i[2]*r[11]+r[15];1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(-a[1]+1)*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},t.unprojectFromMat=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=(i[0]-this.x)/this.width*2-1,a[1]=-((i[1]-this.y)/this.height*2-1);var o=(this.maxDepth-this.minDepth)/2;a[2]=(i[2]-this.minDepth-o)/o;var s=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];On.transformV3ToV3(n,t,n),1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s)},t.unprojectFromWVP=function(t,n,i,r,a){xn.multiply(n,i,e._tempMatrix4x4),r&&xn.multiply(e._tempMatrix4x4,r,e._tempMatrix4x4),e._tempMatrix4x4.invert(e._tempMatrix4x4),this.unprojectFromMat(t,e._tempMatrix4x4,a)},i(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new xn}]),e}(),Pn=function(){function e(){this._alphaBlending=1,this._colorIntensity=1,this._shaderValue=new bn}r(e,"laya.d3.resource.models.Sky");var t=e.prototype;return t._setEnvironmentDiffuse=function(){this._environmentDiffuse.loaded?this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse):this._environmentDiffuse.on("loaded",this,this._environmentDiffuseLoaded)},t._setEnvironmentSpecular=function(){if(this._environmentSpecular.loaded){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)}else this._environmentSpecular.on("loaded",this,this._environmentSpecularLoaded)},t._environmentDiffuseLoaded=function(){this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse)},t._environmentSpecularLoaded=function(){var e=this._environmentSpecular.simLodInfo;e&&e instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,e),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)},t._render=function(){},t.destroy=function(){this.__ownerCamera=null},a(0,t,"_ownerCamera",null,function(e){this.__ownerCamera=e,this._environmentDiffuse&&this._setEnvironmentDiffuse(),this._environmentSpecular&&this._setEnvironmentSpecular()}),a(0,t,"alphaBlending",function(){return this._alphaBlending},function(e){this._alphaBlending=e,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1)}),a(0,t,"envDiffuseSHBlue",null,function(e){this.__ownerCamera._shaderValues.setValue(12,e)}),a(0,t,"colorIntensity",function(){return this._colorIntensity},function(e){this._colorIntensity=e,this._colorIntensity<0&&(this._colorIntensity=0)}),a(0,t,"envDiffuseSHGreen",null,function(e){this.__ownerCamera._shaderValues.setValue(11,e)}),a(0,t,"envDiffuseSHRed",null,function(e){this.__ownerCamera._shaderValues.setValue(10,e)}),a(0,t,"environmentDiffuse",function(){return this._environmentDiffuse},function(e){e.minFifter=9728,this._environmentDiffuse=e,this.__ownerCamera&&this._setEnvironmentDiffuse()}),a(0,t,"environmentSpecular",function(){return this._environmentSpecular},function(e){this._environmentSpecular=e,this.__ownerCamera&&this._setEnvironmentSpecular()}),e.MVPMATRIX=0,e.INTENSITY=1,e.ALPHABLENDING=2,e.DIFFUSETEXTURE=3,e}(),wn=function(){function e(e){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._indexInMesh=0,this._vertexBuffer=null,this._vertexStart=0,this._vertexCount=0,this._indexBuffer=null,this._indexStart=0,this._indexCount=0,this._indices=null,this._bufferUsage={},this._mesh=e,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}r(e,"laya.d3.resource.models.SubMesh");var t=e.prototype;return n.imps(t,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),t._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},t._getIndexBuffer=function(){return this._indexBuffer},t._getStaticBatchBakedVertexs=function(t,n){var i,r,a=4,o=this._vertexBuffer,s=o.vertexDeclaration,l=s.getVertexElementByUsage(0).offset/a,u=s.getVertexElementByUsage(3).offset/a,c=n.meshRender.lightmapScaleOffset,h=0,d=0,_=0,f=0,m=0,p=0;if(c)if(r=s.getVertexElementByUsage(15))_=s.vertexStride/a,i=this._vertexCount>0?o.getData().slice(this._vertexStart*_,(this._vertexStart+this._vertexCount)*_):o.getData().slice(),f=r.offset/a;else{p=s.vertexStride/a,_=p+2,i=this._vertexCount?new Float32Array(this._vertexCount*(o.vertexDeclaration.vertexStride/a+2)):new Float32Array(o.vertexCount*(o.vertexDeclaration.vertexStride/a+2)),m=s.getVertexElementByUsage(2).offset/a,f=m+2;var E=o.getData();for(h=0,d=E.length/p;d>h;h++){var v=0;v=this._vertexCount>0?(this._vertexStart+h)*p:h*p;var g=h*_,T=0;for(T=0;f>T;T++)i[g+T]=E[v+T];for(T=f;p>T;T++)i[g+T+2]=E[v+T]}}else _=s.vertexStride/a,i=this._vertexCount?o.getData().slice(this._vertexStart*_,(this._vertexStart+this._vertexCount)*_):o.getData().slice();if(t){var S=t.worldMatrix,D=e._tempMatrix4x40;S.invert(D);var x=e._tempMatrix4x41,M=n.transform.worldMatrix;xn.multiply(D,M,x)}else x=n.transform.worldMatrix;var R=e._tempQuaternion0;for(x.decomposeTransRotScale(e._tempVector30,R,e._tempVector31),h=0,d=i.length/_;d>h;h++){var A=h*_+l,I=h*_+u;if(kn.transformVector3ArrayToVector3ArrayCoordinate(i,A,x,i,A),kn.transformVector3ArrayByQuat(i,I,R,i,I),c){var y=h*_+f;if(r)kn.transformLightingMapTexcoordByUV1Array(i,y,c,i,y);else{var C=h*p+m;kn.transformLightingMapTexcoordByUV0Array(E,C,c,i,y)}}}return i},t._getVertexBuffers=function(){return null},t._beforeRender=function(){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},t._render=function(e){var t,n=0,i=e.renderElement;if(this._indexCount>1){var r=this._boneIndicesList.length;if(r>1){for(var a=0;r>a;a++)t=i._skinAnimationDatas||this._skinAnimationDatas,t&&(i._shaderValue.setValue(0,t[a]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),P.mainContext.drawElements(4,this._subIndexBufferCount[a],5123,2*this._subIndexBufferStart[a]);C.drawCall+=r}else t=i._skinAnimationDatas||this._skinAnimationDatas,t&&(i._shaderValue.setValue(0,t[0]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),P.mainContext.drawElements(4,this._indexCount,5123,2*this._indexStart),C.drawCall++;n=this._indexCount}else n=this._indexBuffer.indexCount,t=i._skinAnimationDatas||this._skinAnimationDatas,t&&(i._shaderValue.setValue(0,t[0]),e._shader.uploadRenderElementUniforms(i._shaderValue.data)),P.mainContext.drawElements(4,n,5123,0),C.drawCall++;C.trianglesFaces+=n/3},t.getIndices=function(){return this._indexCount>0?this._indices:this._indexBuffer.getData()},t.dispose=function(){this._indexBuffer.destroy(),this._vertexBuffer.destroy(),this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._vertexBuffer=null,this._indexBuffer=null},a(0,t,"_vertexBufferCount",function(){return 1}),a(0,t,"triangleCount",function(){return this._indexBuffer.indexCount/3}),i(e,["_tempVector30",function(){return this._tempVector30=new On},"_tempVector31",function(){return this._tempVector31=new On},"_tempQuaternion0",function(){return this._tempQuaternion0=new An},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new xn},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new xn}]),e}(),Nn=function(){function e(e){this.defineCounter=0,this.defines=null,e?(this.defineCounter=e.defineCounter,this.defines=e.defines.slice()):(this.defineCounter=0,this.defines=[])}r(e,"laya.d3.shader.ShaderDefines",null,"ShaderDefines$1");var t=e.prototype;return t.registerDefine=function(e){var t=Math.pow(2,this.defineCounter++);return this.defines[t]=e,t},e}(),Fn=function(){function e(){}return r(e,"laya.d3.shader.ShaderInit3D"),e.__init__=function(){ri._globalRegDefine("HIGHPRECISION",ri.SHADERDEFINE_HIGHPRECISION),ri._globalRegDefine("FOG",ri.SHADERDEFINE_FOG),ri._globalRegDefine("DIRECTIONLIGHT",ri.SHADERDEFINE_DIRECTIONLIGHT),ri._globalRegDefine("POINTLIGHT",ri.SHADERDEFINE_POINTLIGHT),ri._globalRegDefine("SPOTLIGHT",ri.SHADERDEFINE_SPOTLIGHT),ri._globalRegDefine("UV",ri.SHADERDEFINE_UV0),ri._globalRegDefine("COLOR",ri.SHADERDEFINE_COLOR),ri._globalRegDefine("UV1",ri.SHADERDEFINE_UV1),ri._globalRegDefine("CASTSHADOW",Bn.SHADERDEFINE_CAST_SHADOW),ri._globalRegDefine("SHADOWMAP_PSSM1",Bn.SHADERDEFINE_SHADOW_PSSM1),ri._globalRegDefine("SHADOWMAP_PSSM2",Bn.SHADERDEFINE_SHADOW_PSSM2),ri._globalRegDefine("SHADOWMAP_PSSM3",Bn.SHADERDEFINE_SHADOW_PSSM3),ri._globalRegDefine("SHADOWMAP_PCF_NO",Bn.SHADERDEFINE_SHADOW_PCF_NO),ri._globalRegDefine("SHADOWMAP_PCF1",Bn.SHADERDEFINE_SHADOW_PCF1),ri._globalRegDefine("SHADOWMAP_PCF2",Bn.SHADERDEFINE_SHADOW_PCF2),ri._globalRegDefine("SHADOWMAP_PCF3",Bn.SHADERDEFINE_SHADOW_PCF3),ri._globalRegDefine("DEPTHFOG",ri.SAHDERDEFINE_DEPTHFOG),Ci.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n	vec3 normalT = 2.0*normalMapSample - 1.0;\n\n	// Build orthonormal basis.\n	vec3 N = normalize(unitNormal);\n	vec3 T = normalize(tangent- dot(tangent, N)*N);\n	vec3 B = cross(T, N);\n\n	mat3 TBN = mat3(T, B, N);\n\n	// Transform from tangent space to world space.\n	vec3 bumpedNormal = TBN*normalT;\n\n	return bumpedNormal;\n}\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 ambinentColor,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec=-normalize(dirLight.Direction);\n	\n	amb=matAmb*ambinentColor;\n	\n	float  diffuseFactor=dot(lightVec, normal);\n	\n	if(diffuseFactor>0.0)\n	{\n	   vec3 v = reflect(-lightVec, normal);\n	   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n	   \n	   dif = diffuseFactor * matDif * dirLight.Diffuse;\n	   spec = specFactor * matSpe.rgb;\n	}\n	\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight,in vec3 ambinentColor, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec = poiLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > poiLight.Range )\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb*ambinentColor;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if( diffuseFactor > 0.0 )\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * poiLight.Diffuse;\n		spec = specFactor * matSpe.rgb;\n	}\n\n	float attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 ambinentColor,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	amb = vec3(0.0);\n	dif =vec3(0.0);\n	spec= vec3(0.0);\n	vec3 lightVec = spoLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > spoLight.Range)\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb*ambinentColor;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if(diffuseFactor > 0.0)\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * spoLight.Diffuse;\n		spec = specFactor * matSpe.rgb;\n	}\n	\n	float spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n	float attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n	amb *= spot;\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\n"),Ci.addInclude("Lighting.glsl","\nstruct DirectionLight\n{\n	vec3 Color;\n	vec3 Direction;\n};\n\nstruct PointLight\n{\n	vec3 Color;\n	vec3 Position;\n	float Range;\n};\n\nstruct SpotLight\n{\n	vec3 Color;\n	vec3 Position;\n	vec3 Direction;\n	float Spot;\n	float Range;\n};\n\n// U3D中使用衰减纹理,此函数模拟并非正确\n//float U3DAttenuation(in vec3 L,in float invLightRadius)\n//{\n//	float fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n//	fRatio *= fRatio;\n//	return 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n//} \n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius)\n{\n	vec3 distance = L * invLightRadius;\n	float attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius)); 	\n	return attenuation * attenuation;\n} \n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread	\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius)\n{\n	float attenuationFactor = 30.0;\n	vec3 distance = L * invLightRadius;\n	float attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n	attenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n	// Second we move down the function therewith it reaches zero at abscissa 1:\n	attenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n	attenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n	// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n	attenuation /= 1.0 - attenuationFactor;\n	return attenuation;\n} \n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor)\n{\n    mediump vec3 h = normalize(viewDir-lightVec);\n    lowp float ln = max (0.0, dot (-lightVec,normal));\n    float nh = max (0.0, dot (h,normal));\n	diffuseColor=lightColor * ln;\n	specularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n	vec3 lightVec=normalize(light.Direction);\n	LayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec,diffuseColor,specularColor);\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n	vec3 lightVec =  pos-light.Position;\n	//if( length(lightVec) > light.Range )\n	//	return;\n	LayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec/length(lightVec),diffuseColor,specularColor);\n	float attenuate = BasicAttenuation(lightVec, 1.0/light.Range);\n	diffuseColor *= attenuate;\n	specularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n	vec3 lightVec =  pos-light.Position;\n	//if( length(lightVec) > light.Range )\n	//	return;\n	vec3 normalLightVec=lightVec/length(lightVec);\n	LayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,normalLightVec,diffuseColor,specularColor);\n	float spot = pow(max(dot(normalLightVec, normalize(light.Direction)), 0.0), light.Spot);\n	float attenuate = spot*BasicAttenuation(lightVec, 1.0/light.Range);\n	diffuseColor *= attenuate;\n	specularColor*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal)\n{\n	vec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n	\n	// Build orthonormal basis.\n	vec3 N = normalize(unitNormal);\n	vec3 T = normalize(tangent);\n	vec3 B = normalize(binormal);\n	mat3 TBN = mat3(T, B, N);\n	\n	// Transform from tangent space to world space.\n	vec3 bumpedNormal = TBN*normalT;\n\n	return bumpedNormal;\n}\n\n\n"),Ci.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2	  u_shadowPCFoffset;\nuniform vec3     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n	const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n	const vec4 bitMask	= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n	vec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n	res -= res.xxyz * bitMask;\n	return res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n	const vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n	float depth = dot(rgbaDepth, bitShift);\n	return depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n	vec2 texelpos =texcoord / invsize;\n	vec2 lerps = fract( texelpos );\n	float sourcevals[4];\n	sourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n	sourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n	sourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n	sourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n	return mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec3 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n	float value = 1.0;\n	int nPSNum = int(posViewZ>pssmDistance.x);\n	nPSNum += int(posViewZ>pssmDistance.y);\n	nPSNum += int(posViewZ>pssmDistance.z);\n	//真SB,webgl不支持在PS中直接访问数组\n	mat4 lightVP;\n	if( nPSNum == 0 )\n	{\n		lightVP = lightShadowVP[1];\n	}\n	else if( nPSNum == 1 )\n	{\n		lightVP = lightShadowVP[2];\n	}\n	else if( nPSNum == 2 )\n	{\n		lightVP = lightShadowVP[3];\n	}\n	vec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n	//为了效率，在CPU计算/2.0 + 0.5\n	//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n	vec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n	float fMyZ = vText.z - zBias;\n	/*\n	bvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n	bool bInFrustum = all( bInFrustumVec );\n	bvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n	bool bFrustumTest = all( bFrustumTestVec );\n	if ( bFrustumTest ) \n	*/\n	if( fMyZ <= 1.0 )\n	{\n		float zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n		if ( nPSNum == 0 )\n		{\n			value =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,	fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,	fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,	fMyZ );\n			value = value/4.0;\n		} \n		else if( nPSNum == 1 )\n		{\n			value = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 2 )\n		{\n			vec4 color = texture2D( shadowMap3,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n#endif\n#ifdef SHADOWMAP_PCF2\n		if ( nPSNum == 0 )\n		{\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 1 )\n		{\n			value = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 2 )\n		{\n			vec4 color = texture2D( shadowMap3,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n		if ( nPSNum == 0 )\n		{\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 1 )\n		{\n			vec4 color = texture2D( shadowMap2,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n		else if( nPSNum == 2 )\n		{\n			vec4 color = texture2D( shadowMap3,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n		vec4 color;\n		if ( nPSNum == 0 )\n		{\n			color = texture2D( shadowMap1,vText.xy );\n		}\n		else if( nPSNum == 1 )\n		{\n			color = texture2D( shadowMap2,vText.xy );\n		}\n		else if( nPSNum == 2 )\n		{\n			color = texture2D( shadowMap3,vText.xy );\n		}\n		zdepth = unpackDepth(color);\n		value = float(fMyZ < zdepth);\n#endif\n	}\n	return value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec3 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n	float value = 1.0;\n	int nPSNum = int(posViewZ>pssmDistance.x);\n	nPSNum += int(posViewZ>pssmDistance.y);\n	//真SB,webgl不支持在PS中直接访问数组\n	mat4 lightVP;\n	if( nPSNum == 0 )\n	{\n		lightVP = lightShadowVP[1];\n	}\n	else if( nPSNum == 1 )\n	{\n		lightVP = lightShadowVP[2];\n	}\n	vec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n	//为了效率，在CPU计算/2.0 + 0.5\n	//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n	vec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n	float fMyZ = vText.z - zBias;\n	/*\n	bvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n	bool bInFrustum = all( bInFrustumVec );\n	bvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n	bool bFrustumTest = all( bFrustumTestVec );\n	if ( bFrustumTest ) \n	*/\n	if( fMyZ <= 1.0 )\n	{\n		float zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n		if ( nPSNum == 0 )\n		{\n			value =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,	fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,	fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,	fMyZ );\n			value = value/4.0;\n		}\n		else if( nPSNum == 1 )\n		{\n			value = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n		}\n#endif\n#ifdef SHADOWMAP_PCF2\n		if ( nPSNum == 0 )\n		{\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 1 )\n		{\n			value = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n		}\n#endif\n#ifdef SHADOWMAP_PCF1\n		if ( nPSNum == 0 )\n		{\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 1 )\n		{\n			vec4 color = texture2D( shadowMap2,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n		vec4 color;\n		if ( nPSNum == 0 )\n		{\n			color = texture2D( shadowMap1,vText.xy );\n		}\n		else if( nPSNum == 1 )\n		{\n			color = texture2D( shadowMap2,vText.xy );\n		}\n		zdepth = unpackDepth(color);\n		value = float(fMyZ < zdepth);\n#endif\n	}\n	return value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec3 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n	float value = 1.0;\n	if( posViewZ < pssmDistance.x )\n	{\n		vec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n		float fMyZ = vText.z - zBias;\n		/*\n		bvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n		bool bInFrustum = all( bInFrustumVec );\n		bvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n		bool bFrustumTest = all( bFrustumTestVec );\n		*/\n		if ( fMyZ <= 1.0 ) \n		{\n			float zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n			value =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n			value = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2		\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF_NO		\n			vec4 color = texture2D( shadowMap1,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n#endif\n		}\n	}\n	return value;\n}"),Ci.addInclude("WaveFunction.glsl","\nuniform vec2 u_WaveInfoD[20];\nuniform vec4 u_WaveInfo[20];\n\nuniform float TEXWAVE_UV_SCALE ;//= 20.0; //每texwidth像素代表的实际距离\n/**\n	这里的计算都是\n*/\n\n/**\n* 计算一个波形\n*  开始计算的时候都按照z向上，最后输出的时候，颠倒一下。\n* @param tm {float} 毫秒\n*/\nvoid calcGerstnerWave(float curtm, vec3 pos, float deep, vec2 uvpos, out vec3 opos, out vec3 B, out vec3 T, out vec3 N, out float foamS){\n	float tm = curtm/1000.;\n	opos = pos;\n	vec3 wpos=vec3(0.);		//累加的位置\n	N=vec3(0.,0.,0.);	//输出的法线初始化一下\n	T=vec3(0.,0.,0.);\n	B=vec3(0.,0.,0.);\n	vec2 cD ;//= D;\n	//float deepAtt = max(0.,min(deep,1.0));\n	//A*=deepAtt; //TODO\n	\n	for( int i=0; i<4; i++){\n		cD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n		float Q = u_WaveInfo[i].x;//wi.QorK;\n		float A = u_WaveInfo[i].y;//wi.A;\n		float W = u_WaveInfo[i].z;//wi.omega;\n		float P = u_WaveInfo[i].w;//wi.phi;\n		float dop = dot(cD,uvpos);\n		float c = cos(dop*W - tm*P);//TODO 优化\n		float s = sin(dop*W - tm*P);\n		float AWs = A*W*s;\n		float AWc = A*W*c;\n		float _QxyAWs = -Q*cD.x*cD.y*AWs;\n		\n		wpos += vec3(Q*A*cD.x*c,\n					Q*A*cD.y*c,\n					A*s);\n		N += vec3(-cD.x*AWc,\n				-cD.y*AWc,\n				Q*AWs);//记得最后1-\n		T += vec3(_QxyAWs,\n				Q*cD.y*cD.y*AWs,//记得1-\n				cD.y*AWc\n			);\n		B += vec3(Q*cD.x*cD.x*AWs,//记得1-\n				_QxyAWs,\n				cD.x*AWc\n			);\n		//float v1 = exp(-tan((dop*W - tm*P)/2.+1.07));//除2，+pi/2 这样正好能对齐\n#ifdef USE_FOAM		\n		float v1 = 0.5-sin((dop*W - tm*P)/1.+2.0)/2.;\n		foamS += pow(v1,9.)/4.;\n#endif\n	}\n	T.y=1.-T.y; B.x=1.-B.x;N.z=1.-N.z;\n	opos += vec3(wpos.x,wpos.z*min(deep/10.,1.),wpos.y);\n	//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n	T.xyz=T.xzy;\n	B.xyz=B.xzy;\n	N.xyz=N.xzy;\n}\n\n\nvoid calcWave(float curtm, vec2 uv, out vec3 B, out vec3 T, out vec3 N){\n	float tm = curtm/1000.;\n	N=vec3(0.,0.,0.);	//输出的法线初始化一下\n	vec2 uvpos = uv*TEXWAVE_UV_SCALE; //TODO 这个范围是什么 就是1？\n	uvpos.y*=-1.;\n	vec2 cD;// = D;\n	const int NumWaves = 4;\n	float scale = 1./float(NumWaves);\n	for( int i=0; i<NumWaves; i++){\n		cD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n		float k = 1.5;//u_WaveInfo[i].x;//wi.QorK; TODO  不知道为什么，这个取u_WaveInfo[i].x，在mi3w上就会闪。测试发现实际值也传过来了，就是1.5\n		float A = u_WaveInfo[i].y;//wi.A;\n		float W = u_WaveInfo[i].z;//wi.omega;\n		float P = u_WaveInfo[i].w;//wi.phi;\n		\n		float dop = dot(cD,uvpos);\n		float c = cos(dop*W - tm*P);//TODO 优化\n		float s = sin(dop*W - tm*P);\n		/*\n		float AWs = A*W*s;\n		float AWc = A*W*c;\n		float _QxyAWs = -Q*cD.x*cD.y*AWs;\n		\n		N += vec3(-cD.x*AWc,\n				-cD.y*AWc,\n				Q*AWs);//记得最后1-\n		*/\n		float kWAc = scale*c;//k*W*A*c;  为了提高精度，这里只保留sin，cos部分，实际使用的时候再乘回来。\n		//float kWAc = k*W*A*c;  \n		N += vec3(\n			-kWAc*cD.x*pow((s+1.)/2.,k-1.),\n			-kWAc*cD.y*pow((s+1.)/2.,k-1.),\n			1.\n		);\n	}\n	//N.z=1.-N.z;\n	//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n	N.xyz=N.xzy;\n}\n"),Ci.addInclude("BRDF.glsl","vec4 LayaAirBRDF(in vec3 diffuseColor, in vec3 specularColor, in float oneMinusReflectivity, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n	float perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\n	vec3 halfDir = SafeNormalize(viewDir - lightDir);\n	\n	float nv = abs(dot(normal, viewDir));\n	\n	float nl = clamp(dot(normal,   -lightDir),  0.0, 1.0);\n	float nh = clamp(dot(normal,     halfDir),  0.0, 1.0);\n	float lv = clamp(dot(lightDir,   viewDir),  0.0, 1.0);\n	float lh = clamp(dot(lightDir,  -halfDir),  0.0, 1.0);\n	\n	float diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n	\n	float roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\n	\n	//#if UNITY_BRDF_GGX\n	float V = SmithJointGGXVisibilityTerm(nl, nv, roughness);\n	float D = GGXTerm(nh, roughness);\n	\n	float specularTerm = V * D * PI;\n	\n	specularTerm = sqrt(max(0.0001, specularTerm));\n	specularTerm = max(0.0, specularTerm * nl);\n	\n	vec4 color;\n	color.rgb = diffuseColor * (gi + lightColor * diffuseTerm) + specularTerm * lightColor * FresnelTerm (specularColor, lh);\n	\n	color.a = 1.0;\n	return color;\n}"),Ci.addInclude("PBRUtils.glsl","struct DirectionLight\n{\n	vec3 Color;\n	vec3 Direction;\n};\n\nvec3 UnpackScaleNormal(in vec2 uv0)\n{\n	#ifdef NORMALTEXTURE\n		vec3 normalT;\n		vec4 normalMapSample = texture2D(u_NormalTexture, uv0);\n		normalT.x = 2.0 * normalMapSample.x - 1.0;\n		normalT.y = 1.0 - 2.0 * normalMapSample.y;\n		normalT.xy *= u_normalScale;\n		normalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n		\n		vec3 T = normalize(v_Tangent);\n		vec3 B = normalize(v_Binormal);\n		vec3 N = normalize(v_Normal);\n		mat3 TBN = mat3(T, B, N);\n		\n		vec3 bumpedNormal = TBN * normalize(normalT);\n		return bumpedNormal;\n	#else\n		return normalize(v_Normal);\n	#endif\n}\n\nvec4 DielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nfloat PI = 3.14159265359;\n\nvec3 FresnelTerm (in vec3 F0, in float cosA)\n{\n	return F0 + (vec3(1.0) - F0) * pow(1.0 - cosA, 5.0);\n}\n\nfloat PerceptualRoughnessToRoughness(in float perceptualRoughness)\n{\n	return perceptualRoughness * perceptualRoughness;\n}\n\nfloat PerceptualRoughnessToSpecularPower(in float perceptualRoughness)\n{\n	float m = PerceptualRoughnessToRoughness(perceptualRoughness);\n	float sq = max(0.0001, m * m);\n	float n = (2.0 / sq) - 2.0;\n	n = max(n, 0.0001);\n	return n;\n}\n\nfloat RoughnessToPerceptualRoughness(in float roughness)\n{\n	return sqrt(roughness);\n}\n\nfloat SmoothnessToRoughness(in float smoothness)\n{\n	return (1.0 - smoothness) * (1.0 - smoothness);\n}\n\nfloat SmoothnessToPerceptualRoughness(in float smoothness)\n{\n	return (1.0 - smoothness);\n}\n\nvec3 SafeNormalize(in vec3 inVec)\n{\n	float dp3 = max(0.001,dot(inVec,inVec));\n	return inVec * (1.0 / sqrt(dp3));\n}\n\nfloat DisneyDiffuse(in float NdotV, in float NdotL, in float LdotH, in float perceptualRoughness)\n{\n	float fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n	float lightScatter	= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotL,5.0));\n	float viewScatter	= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotV,5.0));\n\n	return lightScatter * viewScatter;\n}\n\nfloat SmithJointGGXVisibilityTerm (float NdotL, float NdotV, float roughness)\n{\n	float a = roughness;\n	float lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n	float lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\n	return 0.5 / (lambdaV + lambdaL + 0.00001);\n}\n\nfloat GGXTerm (float NdotH, float roughness)\n{\n	float a2 = roughness * roughness;\n	float d = (NdotH * a2 - NdotH) * NdotH + 1.0;\n	return 0.31830988618 * a2 / (d * d + 0.0000001);\n}\n\nfloat OneMinusReflectivityFromMetallic(in float metallic)\n{\n	float oneMinusDielectricSpec = DielectricSpecularColor.a;\n	return oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;\n}\n\nfloat SpecularStrength(vec3 specular)\n{\n    //(SHADER_TARGET < 30)return specular.r; \n    return max (max (specular.r, specular.g), specular.b);\n}\n\nvec3 DiffuseAndSpecularFromMetallic(in vec3 diffuseColor, in float metallic, out vec3 specularColor, out float oneMinusReflectivity)\n{\n	specularColor = mix(DielectricSpecularColor.rgb, diffuseColor, metallic);\n	oneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);\n	return diffuseColor * oneMinusReflectivity;\n}\n\nvec3 EnergyConservationBetweenDiffuseAndSpecular(in vec3 diffuseColor, in vec3 specularColor, out float oneMinusReflectivity)\n{\n	oneMinusReflectivity = 1.0 - SpecularStrength(specularColor);\n	return diffuseColor * oneMinusReflectivity;\n}\n\nvec4 Occlusion(in vec2 uv0){\n	#ifdef OCCLUSIONTEXTURE\n		vec4 occlusionTextureColor = texture2D(u_OcclusionTexture, uv0);\n		float occ = occlusionTextureColor.g;\n		float oneMinusT = 1.0 - u_occlusionStrength;\n		float lerpOneTo = oneMinusT + occ * u_occlusionStrength;\n		return occlusionTextureColor * lerpOneTo;\n	#else\n		return vec4(1.0);\n	#endif\n}\n\nvec2 ParallaxOffset(in vec3 viewDir){\n	#ifdef PARALLAXTEXTURE\n		float h = texture2D(u_ParallaxTexture, v_Texcoord0).g;\n		h = h * u_parallaxScale - u_parallaxScale / 2.0;\n		vec3 v = viewDir;\n		v.z += 0.42;\n		vec2 offset = h * (v.xy / v.z);\n		return v_Texcoord0 + offset;\n	#else\n		return v_Texcoord0;\n	#endif\n}\n\n"),Ci.addInclude("PBRStandardLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRStandardLight(in vec3 diffuseColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n	float oneMinusReflectivity;\n	vec3 specularColor;\n	diffuseColor = DiffuseAndSpecularFromMetallic (diffuseColor, metallic, specularColor, oneMinusReflectivity);\n	\n	vec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n	return color;\n}\n\nvec4 PBRStandardDiectionLight (in vec3 diffuseColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n	vec3 lightVec = normalize(light.Direction);\n	return PBRStandardLight(diffuseColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec2 MetallicGloss(in float diffuseTextureAlpha, in vec2 uv0)\n{\n	vec2 mg;\n	\n	#ifdef METALLICGLOSSTEXTURE\n		vec4 metallicGlossTextureColor = texture2D(u_MetallicGlossTexture, uv0);\n		#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n			mg.r = metallicGlossTextureColor.r;\n			mg.g = diffuseTextureAlpha;\n		#else\n		    mg = metallicGlossTextureColor.ra;\n		#endif\n		mg.g *= u_smoothnessScale;\n	#else\n		mg.r = u_metallic;\n		#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n			mg.g = diffuseTextureAlpha * u_smoothnessScale;\n		#else\n			mg.g = u_smoothness;\n		#endif\n	#endif\n	\n	return mg;\n}\n\n'),Ci.addInclude("PBRSpecularLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRSpecularLight(in vec3 diffuseColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n	float oneMinusReflectivity;\n	diffuseColor = EnergyConservationBetweenDiffuseAndSpecular (diffuseColor, specularColor, oneMinusReflectivity);\n	\n	vec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n	return color;\n}\n\nvec4 PBRSpecularDiectionLight (in vec3 diffuseColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n	vec3 lightVec = normalize(light.Direction);\n	return PBRSpecularLight(diffuseColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec4 SpecularGloss(float diffuseTextureAlpha, in vec2 uv0)\n{\n    vec4 sg;\n	\n	#ifdef SPECULARTEXTURE\n		vec4 specularTextureColor = texture2D(u_SpecularTexture, uv0);\n		#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n			sg.rgb = specularTextureColor.rgb;\n			sg.a = diffuseTextureAlpha;\n		#else\n			sg = specularTextureColor;\n		#endif\n		sg.a *= u_smoothnessScale;\n	#else\n		sg.rgb = u_SpecularColor.rgb;\n		#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n			sg.a = diffuseTextureAlpha * u_smoothnessScale;\n		#else\n			sg.a = u_smoothness;\n		#endif\n	#endif\n	\n    return sg;\n}\n\n');
var e,t,n={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_ReflectTexture:[5,1],u_AlphaTestValue:[0,1],u_DiffuseColor:[6,1],u_MaterialSpecular:[8,1],u_Shininess:[9,1],u_MaterialReflect:[10,1],u_TilingOffset:[11,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Color":[4,4],"u_DirectionLight.Direction":[3,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Color":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Color":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},r=Ci.nameKey.add("BLINNPHONG");e='attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n	attribute vec2 a_Texcoord0;\n	varying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n	attribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n	uniform vec4 u_LightmapScaleOffset;\n	varying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n	attribute vec4 a_Color;\n	varying vec4 v_Color;\n#endif\n\n#ifdef BONE\n	const int c_MaxBoneCount = 24;\n	attribute vec4 a_BoneIndices;\n	attribute vec4 a_BoneWeights;\n	uniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n	attribute vec3 a_Normal;\n	varying vec3 v_Normal; \n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n	uniform vec3 u_CameraPos;\n	varying vec3 v_ViewDir; \n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\n	attribute vec4 a_Tangent0;\n	varying vec3 v_Tangent;\n	varying vec3 v_Binormal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n	uniform mat4 u_WorldMat;\n	varying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n	uniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n	#ifdef BONE\n		mat4 skinTransform=mat4(0.0);\n		skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n		skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n		skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n		skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n		vec4 position=skinTransform*a_Position;\n		gl_Position = u_MvpMatrix * position;\n	#else\n		gl_Position = u_MvpMatrix * a_Position;\n	#endif\n	 \n	//TODO没考虑UV动画呢\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		v_Texcoord0=a_Texcoord0;\n	#endif\n		v_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n	#ifdef BONE\n		mat4 skinTransform=mat4(0.0);\n		skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n		skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n		skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n		skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n		vec4 position=skinTransform*a_Position;\n		gl_Position = u_MvpMatrix * position;\n	#else\n		gl_Position = u_MvpMatrix * a_Position;\n	#endif\n\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n		mat3 worldMat;\n		#ifdef BONE\n			worldMat=mat3(u_WorldMat*skinTransform);\n		#else\n			worldMat=mat3(u_WorldMat);\n		#endif  \n		v_Normal=worldMat*a_Normal;//TODO:法线可以用"魔法"矩阵\n		#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n			v_Tangent=worldMat*a_Tangent0.xyz;\n			v_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n		#endif\n	#endif\n\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n		#ifdef BONE\n			v_PositionWorld=(u_WorldMat*position).xyz;\n		#else\n			v_PositionWorld=(u_WorldMat*a_Position).xyz;\n		#endif\n	#endif\n	\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n		v_ViewDir=u_CameraPos-v_PositionWorld;\n	#endif\n\n	#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n		v_Texcoord0=a_Texcoord0;\n		#ifdef TILINGOFFSET\n			v_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n			v_Texcoord0=vec2(v_Texcoord0.x,1.0+v_Texcoord0.y);\n		#endif\n	#endif\n\n	#ifdef LIGHTMAP\n		#ifdef SCALEOFFSETLIGHTINGMAPUV\n			#ifdef UV1\n				v_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n			#else\n				v_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n			#endif \n		#else\n			#ifdef UV1\n				v_LightMapUV=a_Texcoord1;\n			#else\n				v_LightMapUV=a_Texcoord0;\n			#endif \n		#endif \n	#endif\n\n	#ifdef COLOR\n		v_Color=a_Color;\n	#endif\n\n	#ifdef RECEIVESHADOW\n		v_posViewZ = gl_Position.w;\n		#ifdef SHADOWMAP_PSSM1 \n			v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n		#endif\n	#endif\n}\n\nvoid main()\n{\n	#ifdef CASTSHADOW\n		main_castShadow();\n	#else\n		main_normal();\n	#endif\n}',t='#ifdef HIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nuniform vec4 u_DiffuseColor;\n\n#ifdef COLOR\n	varying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n	varying vec3 v_ViewDir; \n#endif\n\n#ifdef ALPHATEST\n	uniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n	uniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\n	uniform samplerCube u_ReflectTexture;\n	uniform vec3 u_MaterialReflect;\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n	varying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n	varying vec2 v_LightMapUV;\n	uniform sampler2D u_LightMap;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	uniform vec3 u_MaterialSpecular;\n	uniform float u_Shininess;\n	#ifdef SPECULARMAP \n		uniform sampler2D u_SpecularTexture;\n	#endif\n#endif\n\n#ifdef FOG\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	#ifdef ADDTIVEFOG\n	#else\n		uniform vec3 u_FogColor;\n	#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n	varying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n	uniform sampler2D u_NormalTexture;\n	varying vec3 v_Tangent;\n	varying vec3 v_Binormal;\n#endif\n\n#ifdef DIRECTIONLIGHT\n	uniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n	uniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n	uniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n	varying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n		uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n		varying vec4 v_lightMVPPos;\n	#endif\n#endif\n\nvoid main_castShadow()\n{\n	//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n	gl_FragColor=packDepth(v_posViewZ);\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		float alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n		if( alpha < u_AlphaTestValue )\n		{\n			discard;\n		}\n	#endif\n}\nvoid main_normal()\n{\n	vec4 mainColor=u_DiffuseColor;\n	#ifdef DIFFUSEMAP\n		vec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n		mainColor=mainColor*difTexColor;\n	#endif \n	#ifdef COLOR\n		mainColor=mainColor*v_Color;\n	#endif \n    \n	#ifdef ALPHATEST\n		if(mainColor.a<u_AlphaTestValue)\n			discard;\n	#endif\n  \n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n		vec3 normal;\n		#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n			vec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n			normal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n		#else\n			normal = normalize(v_Normal);\n		#endif\n	#endif\n	\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		vec3 viewDir= normalize(v_ViewDir);\n		vec3 diffuse = vec3(0.0);\n		vec3 specular= vec3(0.0);\n		vec3 dif,spe;\n		#ifdef SPECULARMAP\n			vec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n		#else\n			#ifdef DIFFUSEMAP\n				vec3 gloss=vec3(difTexColor.a);\n			#else\n				vec3 gloss=vec3(1.0);\n			#endif\n		#endif\n	#endif\n\n	\n	#ifdef DIRECTIONLIGHT\n		LayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\n		diffuse+=dif;\n		specular+=spe;\n	#endif\n \n	#ifdef POINTLIGHT\n		LayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\n		diffuse+=dif;\n		specular+=spe;\n	#endif\n\n	#ifdef SPOTLIGHT\n		LayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\n		diffuse+=dif;\n		specular+=spe;\n	#endif\n\n	\n	vec3 finalDiffuse;\n	#ifdef LIGHTMAP\n		finalDiffuse=texture2D(u_LightMap, v_LightMapUV).rgb*2.0;\n		//float exponent = texture2D(u_LightMap, v_LightMapUV).a;\n		//finalDiffuse = texture2D(u_LightMap, v_LightMapUV).rgb;\n		//float ratio = pow(2.0, exponent * 255.0 - (128.0 + 8.0));\n		//finalDiffuse = finalDiffuse * 255.0 * ratio;	\n		//finalDiffuse = sqrt(finalDiffuse);\n	#else\n		finalDiffuse=vec3(0.0);\n	#endif\n\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		finalDiffuse+=diffuse;\n	#endif\n\n	#ifdef RECEIVESHADOW\n		float shadowValue = 1.0;\n		#ifdef SHADOWMAP_PSSM3\n			shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n		#endif\n		#ifdef SHADOWMAP_PSSM2\n			shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n		#endif \n		#ifdef SHADOWMAP_PSSM1\n			shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n		#endif\n		gl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse)*shadowValue,mainColor.a);\n	#else\n		gl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse),mainColor.a);\n	#endif\n	\n\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		#ifdef RECEIVESHADOW\n			gl_FragColor.rgb+=specular*shadowValue;\n		#else\n			gl_FragColor.rgb+=specular;\n		#endif\n	#endif\n\n\n	#ifdef REFLECTMAP\n		vec3 incident = -viewDir;\n		vec3 reflectionVector = reflect(incident,normal);\n		vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n		gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n	#endif\n	  \n	#ifdef FOG\n		float lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n		#ifdef ADDTIVEFOG\n			gl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n		#else\n			gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n		#endif\n	#endif\n}\n\nvoid main()\n{\n	#ifdef CASTSHADOW		\n		main_castShadow();\n	#else\n	  main_normal();\n	#endif  \n}\n\n';var a=ri.add(r,e,t,n,i);Ii.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),Ii.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),Ii.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),Ii.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),Ii.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),Ii.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),n={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_TexcoordNext0:14,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_AmbientTexture:[5,1],u_ReflectTexture:[6,1],u_AlphaTestValue:[0,1],u_Albedo:[7,1],u_UVMatrix:[13,1],u_UVAge:[14,1],u_UVAniAge:[8,1],u_MaterialDiffuse:[10,1],u_MaterialAmbient:[9,1],u_MaterialSpecular:[11,1],u_MaterialReflect:[12,1],u_TilingOffset:[15,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var o=Ci.nameKey.add("SIMPLE");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#if defined(AMBIENTMAP)||(defined(LIGHTMAP)&&defined(UV1))\nattribute vec2 a_Texcoord1;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_LightMapUV;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n	uniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n#ifdef BONE\n	mat4 skinTransform=mat4(0.0);\n	skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n	skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n	skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n	skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n	vec4 position=skinTransform*a_Position;\n	gl_Position = u_MvpMatrix * position;\n#else\n	gl_Position = u_MvpMatrix * a_Position;\n#endif\n \n//TODO没考虑UV动画呢\n#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n	v_Texcoord0=a_Texcoord0;\n#endif\n	v_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n#ifdef BONE\n	mat4 skinTransform=mat4(0.0);\n	skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n	skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n	skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n	skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n	vec4 position=skinTransform*a_Position;\n	gl_Position = u_MvpMatrix * position;\n#else\n	gl_Position = u_MvpMatrix * a_Position;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n	mat3 worldMat;\n	#ifdef BONE\n		worldMat=mat3(u_WorldMat*skinTransform);\n	#else\n		worldMat=mat3(u_WorldMat);\n	#endif  \n	v_Normal=worldMat*a_Normal;\n	#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n		v_Tangent0=worldMat*a_Tangent0;\n	#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n	#ifdef BONE\n		v_PositionWorld=(u_WorldMat*position).xyz;\n	#else\n		v_PositionWorld=(u_WorldMat*a_Position).xyz;\n	#endif\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\n	v_Texcoord0=a_Texcoord0;\n	#ifdef TILINGOFFSET\n		v_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n		v_Texcoord0=vec2(v_Texcoord0.x,v_Texcoord0.y+1.0);\n	#endif\n	#ifdef UVTRANSFORM\n		v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n	#endif\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\n	#ifdef SCALEOFFSETLIGHTINGMAPUV\n		#ifdef UV1\n			v_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n		#else\n			v_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n		#endif \n	#else\n		#ifdef UV1\n			v_LightMapUV=a_Texcoord1;\n		#else\n			v_LightMapUV=a_Texcoord0;\n		#endif \n	#endif \n#endif\n\n#ifdef COLOR\n	v_Color=a_Color;\n#endif\n\n#ifdef RECEIVESHADOW\n	v_posViewZ = gl_Position.w;\n	#ifdef SHADOWMAP_PSSM1 \n		v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n	#endif\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\n	main_castShadow();\n#else\n	main_normal();\n#endif\n}",t='#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#if   defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nvarying vec2 v_LightMapUV;\n#endif\n#ifdef AMBIENTMAP\nuniform sampler2D u_AmbientTexture;\n#endif\n#ifdef LIGHTMAP\nuniform sampler2D u_LightMap;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP) \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#if defined(FOG)||defined(DEPTHFOG)\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	#ifdef ADDTIVEFOG\n	#else\n		uniform vec3 u_FogColor;\n	#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||(defined(RECEIVESHADOW)&&(defined(SHADOWMAP_PSM2)||defined(SHADOWMAP_PSM3)))\nuniform vec3 u_CameraPos;\n#endif\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)\nvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n	uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n	varying vec4 v_lightMVPPos;\n	#endif\n#endif\nvarying float v_posViewZ;\n\n\n\nvoid main_castShadow()\n{\n	//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n	gl_FragColor=packDepth(v_posViewZ);\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		float alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n		if( alpha < u_AlphaTestValue )\n		{\n			discard;\n		}\n	#endif\n}\nvoid main_normal()\n{\n#if defined(DIFFUSEMAP)&&!defined(COLOR)\n	gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n#endif \n  \n#if defined(COLOR)&&!defined(DIFFUSEMAP)\n	gl_FragColor=v_Color;\n#endif \n  \n#if defined(DIFFUSEMAP)&&defined(COLOR)\n	vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n	gl_FragColor=texColor*v_Color;\n#endif\n  \n#if !defined(DIFFUSEMAP)&&!defined(COLOR)\n	gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n#endif \n    \n#ifdef ALPHATEST\n	if(gl_FragColor.a-u_AlphaTestValue<0.0)\n		discard;\n#endif\n  \n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n	vec3 normal;\n    #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n		vec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n		normal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n	#else\n		normal = normalize(v_Normal);\n    #endif\n#endif\n	\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	vec3 diffuse = vec3(0.0);\n	vec3 ambient = vec3(0.0);\n	vec3 specular= vec3(0.0);\n	vec3 dif, amb, spe;\n#endif\n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n	vec3 toEye;\n	#ifdef FOG\n		toEye=u_CameraPos-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n	#else\n		toEye=normalize(u_CameraPos-v_PositionWorld);\n	#endif\n#endif\n	\n#ifdef DIRECTIONLIGHT\n	computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n	computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n	ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n	float shadowValue = 1.0;\n	#ifdef SHADOWMAP_PSSM3\n		shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif\n	#ifdef SHADOWMAP_PSSM2\n		shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif \n	#ifdef SHADOWMAP_PSSM1\n		shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n	#endif\n#endif\n\n#ifdef AMBIENTMAP\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n	#else\n		#if defined(RECEIVESHADOW)\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb * shadowValue);\n		#else\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n		#endif\n	#endif\n#endif\n\n#ifdef LIGHTMAP\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n	#else\n		#if defined(RECEIVESHADOW)\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n		#else\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n		#endif\n	#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_Albedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	#if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n		specular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n	#ifdef RECEIVESHADOW\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular*shadowValue,gl_FragColor.a);\n	#else\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n	#endif\n#endif\n  \n#ifdef REFLECTMAP\n	vec3 incident = -toEye;\n	vec3 reflectionVector = reflect(incident,normal);\n	vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n	gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n#endif\n  \n#ifdef FOG\n	float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n	#ifdef ADDTIVEFOG\n		gl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n	#else\n		gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n	#endif\n#endif\n#ifdef DEPTHFOG\n	float lerpFact = (-v_PositionWorld.y-u_FogStart)/u_FogRange;\n	gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW		\n	main_castShadow();\n#else\n  main_normal();\n#endif  \n}\n\n',a=ri.add(o,e,t,n,i),Pi.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),Pi.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),Pi.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),Pi.SHADERDEFINE_EMISSIVEMAP=a.registerMaterialDefine("EMISSIVEMAP"),Pi.SHADERDEFINE_AMBIENTMAP=a.registerMaterialDefine("AMBIENTMAP"),Pi.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),Pi.SHADERDEFINE_UVTRANSFORM=a.registerMaterialDefine("UVTRANSFORM"),Pi.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),Pi.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),n={a_Position:0,a_Color:1},i={u_MvpMatrix:[1,2]};var s=Ci.nameKey.add("LINE");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}",t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n  gl_FragColor=v_Color; \n}\n\n",ri.add(s,e,t,n,i),n={a_position:0,a_normal:3,tangent:5,binormal:4,uv:2,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_lodRect:[9,3],irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],u_aoObjPos:[14,1],texBaseColor:[1,1],texNormal:[2,1],texPbrInfo:[3,1],texPrefilterdEnv:[8,3],texHSNoise:[15,1],texPrefilterDiff:[7,3],u_AlphaTestValue:[0,1],texBRDFLUT:[4,1],u_UVAniAge:[5,1],u_roughness:[6,1],u_metaless:[7,1],u_UVMatrix:[8,1],u_UVAge:[9,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var l=Ci.nameKey.add("PBR");e="\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n#ifdef HAS_TANGENT\nattribute vec3 tangent;\nattribute vec3 binormal;\n#endif\nattribute vec2 uv;\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\n\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\nvoid main() {\n#ifdef BONE\n	mat4 skinTransform=mat4(0.0);\n	skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n	skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n	skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n	skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n	gl_Position = mvp*skinTransform*vec4(a_position,1.);\n	mat4 modelMat = modelMatrix*skinTransform;\n#else\n	gl_Position = mvp*vec4(a_position,1.);\n	mat4 modelMat = modelMatrix;\n#endif	\n	vWorldPos = modelMat*vec4(a_position,1.);\n\n#ifdef CASTSHADOW \n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		vUv = uv;\n	#endif	\n#else\n    vUv = uv;\n	vWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n	#ifdef HAS_TANGENT\n	vWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n	vWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n	#endif\n    \n    vViewDir = (vWorldPos.xyz-cameraPosition);//这个不能normalize。否则无法线性差值了\n#ifdef RECEIVESHADOW\n	v_posViewZ = gl_Position.z;\n	#ifdef SHADOWMAP_PSSM1 \n		v_lightMVPPos = u_lightShadowVP[0] * vWorldPos;\n	#endif\n#endif	\n#endif\n}\n",t='//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\nvarying vec3 vViewDir;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n//预计算的贴图\nuniform sampler2D texPrefilterdEnv;\nuniform sampler2D texBRDFLUT;\nuniform sampler2D texPrefilterDiff;\n#ifdef HAS_PBRINFO\nuniform sampler2D texPbrInfo;   //Ao, Roughness, Metallic\n#endif\nuniform float u_hdrexposure;\nuniform float u_AlphaTestValue;\n\nuniform float u_roughness;\nuniform float u_metaless;\nconst float maxlv = 7.;	//现在只支持512分辨率的环境贴图\nconst int nmaxlv = 9;//\n							\nuniform mat4 irrad_mat_red;\nuniform mat4 irrad_mat_green;\nuniform mat4 irrad_mat_blue;							\n\nvec3 speccontrib = vec3(0.);\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\nvec4 tex2dLod(sampler2D tex, float u, float v, float lod){\n	vec2 uv = vec2(u,v);\n	uv+=mod(gl_FragCoord.xy-vec2(0.5),2.0)*vec2(128.,0.);\n	return texture2D(tex,uv,lod-16.);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n	float envu = atan(dir.z,dir.x)/_2PI+0.5; 	\n	float envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n	return texture2D(tex,vec2(envu,envv));\n}\n\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n	float envu = atan(dir.z,dir.x)/_2PI+0.5; 	\n	float envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n	return tex2dLod(tex,envu,envv,lod);\n}\n\n/*\n    计算sh光照。\n    使用level=2，所以需要9个系数。\n    https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\n*/\nfloat environment_exposure = 1.0;\nvec3 diff_sh9(vec3 dir){\n	vec4 shDir = vec4(dir.x,-dir.z,dir.y,1.0);\n  return max(vec3(0.0), vec3(\n	dot(shDir, irrad_mat_red * shDir),\n	dot(shDir, irrad_mat_green * shDir),\n	dot(shDir, irrad_mat_blue * shDir)\n	)) * environment_exposure;	\n}\n\n#ifdef HAS_TANGENT\nvec3 applyNormalTex( vec3 norm, vec3 surf_norm ) {\n    vec3 mapN = norm * 2.0 - 1.0;\n    //mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( vWorldTangent, vWorldBinormal, surf_norm );\n    return normalize( tsn * mapN );\n}\n#endif\n\nvec4 pbrlight(vec3 normal, float rough, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n	basecolor.rgb = pow(basecolor.rgb,vec3(2.2));\n	float metaless = 1.0; 	\n	const float ismetalinfov = (128./255.);\n	if(basecolor.a>=ismetalinfov){//这时候表示金属度\n		metaless = (basecolor.a-ismetalinfov)*2.;\n		basecolor.a = 1.0;\n	}else{\n		metaless = 0.;\n		basecolor.a = basecolor.a*2.0;\n	}\n	#ifdef FIX_METALESS\n	metaless = u_metaless;\n	#endif\n	#ifdef HAS_PBRINFO	\n	vec4 pbrinfo = texture2D(texPbrInfo, vUv);\n	metaless = pbrinfo.b;\n	rough = pbrinfo.g;\n	#endif\n    const vec3 nonmetalF0 =vec3(0.02);\n    vec3 F0 =  mix(nonmetalF0, basecolor.rgb, metaless);\n	\n    vec4 PrefilteredColor = texPanoramaLod(texPrefilterdEnv, R, rough*maxlv);\n    PrefilteredColor.rgb = _RGBEToRGB(PrefilteredColor);\n    vec4 EnvBRDF = texture2D(texBRDFLUT,vec2(rough , NoV));//TODO lod\n    vec2 rg = _RGBAToU16(EnvBRDF);    \n    speccontrib = (F0* rg.x + saturate( 50.0 * PrefilteredColor.g ) * rg.y);\n	vec3 color_spec = PrefilteredColor.rgb*speccontrib;\n	\n	vec3 color_diff=diff_sh9(normal);\n	vec3 outc =  color_diff*mix(basecolor.rgb,vec3(0.),metaless)*(vec3(1.0)-speccontrib)+color_spec;\n	#ifdef HAS_PBRINFO\n	outc*=pbrinfo.r;\n	#endif\n	return vec4(outc, basecolor.a);\n}\n\nvec3 oldlight(vec4 normal, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n	const vec3 lightdir=normalize(vec3(1.,1.,0.));\n	const vec3 spcecol = vec3(1.,0.8,0.8);\n	const vec3 amb = vec3(0.5);\n	vec3 diffv =  (vec3(saturate(dot(lightdir,normal.xyz)))+amb);\n	//vec3 spec = spcecol* pow(saturate(dot(R,lightdir)),(1.-pbrinfo.g)*5.);\n	return diffv*basecolor.rgb;//+spec;\n}\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n	uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n	varying vec4 v_lightMVPPos;\n	#endif\n#endif\n\nvoid main() {\n#ifdef CASTSHADOW\n	gl_FragColor=packDepth(gl_FragCoord.w);\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		float alpha = texture2D(texBaseColor,vUv).w;\n		if( alpha < u_AlphaTestValue ){\n			discard;\n		}\n	#endif\n#else\n\n	#ifdef RECEIVESHADOW\n		float shadowValue = 1.0;\n		#ifdef SHADOWMAP_PSSM3\n			shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n		#endif\n		#ifdef SHADOWMAP_PSSM2\n			shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n		#endif \n		#ifdef SHADOWMAP_PSSM1\n			shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.0001);\n		#endif\n	#endif	\n	\n    vec3 normal =  normalize(vWorldNorm);\n	vec4 normtex = texture2D( texNormal, vUv );\n	#ifdef HAS_TANGENT	\n	normal = applyNormalTex(normtex.xyz, normal);\n	#endif\n    vec3 view   = -normalize(vViewDir);\n    float NoV = saturate(dot( view, normal ));\n    vec3 R = 2. * NoV * normal - view;\n	float roughness = normtex.a;\n	#ifdef FIX_ROUGHNESS\n	roughness = u_roughness;\n	#endif\n	\n	vec4 pbrl = pbrlight(normal,roughness,NoV,R)*u_hdrexposure;\n    gl_FragColor.rgb =  pow(pbrl.rgb,vec3(0.45455));\n	//gl_FragColor.rgb = oldlight(normtex,NoV,R);\n	#ifdef RECEIVESHADOW\n	gl_FragColor.rgb *= max(shadowValue,0.7);\n	#endif\n	\n    gl_FragColor.a = pbrl.a;\n\n#endif\n}\n',a=ri.add(l,e,t,n,i),Oi.SHADERDEFINE_FIX_METALESS=a.registerMaterialDefine("FIX_METALESS"),Oi.SHADERDEFINE_FIX_ROUGHNESS=a.registerMaterialDefine("FIX_ROUGHNESS"),Oi.SHADERDEFINE_HAS_TANGENT=a.registerMaterialDefine("HAS_TANGENT"),Oi.SHADERDEFINE_HAS_PBRINFO=a.registerMaterialDefine("HAS_PBRINFO"),Oi.SHADERDEFINE_USE_GROUNDTRUTH=a.registerMaterialDefine("USE_GROUNDTRUTH"),Oi.SHADERDEFINE_TEST_CLIPZ=a.registerMaterialDefine("CLIPZ"),n={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},i={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_EmissionColor:[8,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_MetallicGlossTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_metallic:[9,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};
var u=Ci.nameKey.add("PBRStandard");e="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n	uniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n	  varying vec4 v_lightMVPPos;\n	  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n	const int c_MaxBoneCount = 24;\n	attribute vec4 a_BoneIndices;\n	attribute vec4 a_BoneWeights;\n	uniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n	#ifdef BONE\n		mat4 skinTransform=mat4(0.0);\n		skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n		skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n		skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n		skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n		vec4 position = skinTransform * a_Position;\n		gl_Position = u_MvpMatrix * position;\n	#else\n		gl_Position = u_MvpMatrix * a_Position;\n	#endif\n	 \n	//TODO没考虑UV动画呢\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		v_Texcoord0 = a_Texcoord0;\n	#endif\n		v_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n	mat3 worldMat;\n	#ifdef BONE\n		mat4 skinTransform = mat4(0.0);\n		skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n		skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n		skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n		skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n		vec4 position = skinTransform * a_Position;\n		gl_Position = u_MvpMatrix * position;\n		worldMat=mat3(u_WorldMat*skinTransform);\n		v_PositionWorld = (u_WorldMat * position).xyz;\n	#else\n		gl_Position = u_MvpMatrix * a_Position;\n		worldMat = mat3(u_WorldMat);\n		v_PositionWorld = (u_WorldMat * a_Position).xyz;\n	#endif\n	\n	v_Normal = worldMat * a_Normal;\n	v_Tangent = worldMat * a_Tangent0.xyz;\n	v_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n	v_Texcoord0 = a_Texcoord0;\n	#ifdef TILINGOFFSET\n		v_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n	#endif\n		v_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n	v_ViewDir = u_CameraPos - v_PositionWorld;\n  \n	#ifdef RECEIVESHADOW\n		v_posViewZ = gl_Position.w;\n		#ifdef SHADOWMAP_PSSM1 \n			v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n		#endif\n	#endif\n}\n\nvoid main()\n{\n	#ifdef CASTSHADOW\n		main_castShadow();\n	#else\n		main_normal();\n	#endif\n}",t='#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec3 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\n\n#ifdef DIFFUSETEXTURE\n	uniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef METALLICGLOSSTEXTURE\n	uniform sampler2D u_MetallicGlossTexture;\n#endif\n#ifdef NORMALTEXTURE\n	uniform sampler2D u_NormalTexture;\n	uniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n	uniform sampler2D u_ParallaxTexture;\n	uniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n	uniform sampler2D u_OcclusionTexture;\n	uniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n	#ifdef EMISSIONTEXTURE\n		uniform sampler2D u_EmissionTexture;\n	#endif\n	uniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRStandardLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n		uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n		varying vec4 v_lightMVPPos;\n	#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n	gl_FragColor=packDepth(v_posViewZ);\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		float alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n		if( alpha < u_AlphaTestValue )\n		{\n			discard;\n		}\n	#endif\n}\n\nvoid main_normal()\n{	\n	vec3 viewDir = normalize(v_ViewDir);\n	\n	vec2 uv0 = ParallaxOffset(viewDir);\n	\n	vec2 mg;\n	#ifdef DIFFUSETEXTURE\n		vec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n		vec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n		mg = MetallicGloss(diffuseTextureColor.a, uv0);\n	#else\n		vec4 diffuseColor = u_DiffuseColor;\n		mg = MetallicGloss(1.0, uv0);\n	#endif\n	\n	#ifdef ALPHATEST\n		if(diffuseColor.a < u_AlphaTestValue)\n			discard;\n	#endif\n	\n	gl_FragColor = diffuseColor;\n	\n	vec3 normal = UnpackScaleNormal(uv0);\n  \n	vec3 gi =  u_AmbientColor * Occlusion(uv0).rgb;\n  \n	vec4 color = PBRStandardDiectionLight(diffuseColor.rgb, mg.r, mg.g, normal, viewDir, u_DirectionLight, gi);\n	\n	color.a = diffuseColor.a;\n	\n	#ifdef EMISSION\n		vec4 emissionColor = u_EmissionColor;\n		#ifdef EMISSIONTEXTURE\n			emissionColor *=  texture2D(u_EmissionTexture, uv0);\n		#endif\n		color.rgb += emissionColor.rgb;\n	#endif\n	\n	#ifdef RECEIVESHADOW\n		float shadowValue = 1.0;\n		#ifdef SHADOWMAP_PSSM3\n			shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n		#endif\n		#ifdef SHADOWMAP_PSSM2\n			shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n		#endif \n		#ifdef SHADOWMAP_PSSM1\n			shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n		#endif\n		gl_FragColor = vec4(color.rgb * shadowValue, color.a);\n	#else\n		gl_FragColor = color;\n	#endif\n}\n\nvoid main()\n{\n	#ifdef CASTSHADOW		\n		main_castShadow();\n	#else\n		main_normal();\n	#endif  \n}\n\n',a=ri.add(u,e,t,n,i),Li.SHADERDEFINE_DIFFUSETEXTURE=a.registerMaterialDefine("DIFFUSETEXTURE"),Li.SHADERDEFINE_METALLICGLOSSTEXTURE=a.registerMaterialDefine("METALLICGLOSSTEXTURE"),Li.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=a.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),Li.SHADERDEFINE_NORMALTEXTURE=a.registerMaterialDefine("NORMALTEXTURE"),Li.SHADERDEFINE_PARALLAXTEXTURE=a.registerMaterialDefine("PARALLAXTEXTURE"),Li.SHADERDEFINE_OCCLUSIONTEXTURE=a.registerMaterialDefine("OCCLUSIONTEXTURE"),Li.SHADERDEFINE_EMISSION=a.registerMaterialDefine("EMISSION"),Li.SHADERDEFINE_EMISSIONTEXTURE=a.registerMaterialDefine("EMISSIONTEXTURE"),Li.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),n={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},i={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_SpecularColor:[8,1],u_EmissionColor:[9,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_SpecularTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var c=Ci.nameKey.add("PBRSpecular");e="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n	uniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n	  varying vec4 v_lightMVPPos;\n	  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n	const int c_MaxBoneCount = 24;\n	attribute vec4 a_BoneIndices;\n	attribute vec4 a_BoneWeights;\n	uniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n	#ifdef BONE\n		mat4 skinTransform=mat4(0.0);\n		skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n		skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n		skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n		skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n		vec4 position = skinTransform * a_Position;\n		gl_Position = u_MvpMatrix * position;\n	#else\n		gl_Position = u_MvpMatrix * a_Position;\n	#endif\n	 \n	//TODO没考虑UV动画呢\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		v_Texcoord0 = a_Texcoord0;\n	#endif\n		v_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n	mat3 worldMat;\n	#ifdef BONE\n		mat4 skinTransform = mat4(0.0);\n		skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n		skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n		skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n		skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n		vec4 position = skinTransform * a_Position;\n		gl_Position = u_MvpMatrix * position;\n		worldMat=mat3(u_WorldMat*skinTransform);\n		v_PositionWorld = (u_WorldMat * position).xyz;\n	#else\n		gl_Position = u_MvpMatrix * a_Position;\n		worldMat = mat3(u_WorldMat);\n		v_PositionWorld = (u_WorldMat * a_Position).xyz;\n	#endif\n	\n	v_Normal = worldMat * a_Normal;\n	v_Tangent = worldMat * a_Tangent0.xyz;\n	v_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n	v_Texcoord0 = a_Texcoord0;\n	#ifdef TILINGOFFSET\n		v_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n	#endif\n		v_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n	v_ViewDir = u_CameraPos - v_PositionWorld;\n  \n	#ifdef RECEIVESHADOW\n		v_posViewZ = gl_Position.w;\n		#ifdef SHADOWMAP_PSSM1 \n			v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n		#endif\n	#endif\n}\n\nvoid main()\n{\n	#ifdef CASTSHADOW\n		main_castShadow();\n	#else\n		main_normal();\n	#endif\n}",t='#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec3 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\nuniform vec4 u_SpecularColor;\n\n#ifdef DIFFUSETEXTURE\n	uniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef SPECULARTEXTURE\n	uniform sampler2D u_SpecularTexture;\n#endif\n#ifdef NORMALTEXTURE\n	uniform sampler2D u_NormalTexture;\n	uniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n	uniform sampler2D u_ParallaxTexture;\n	uniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n	uniform sampler2D u_OcclusionTexture;\n	uniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n	#ifdef EMISSIONTEXTURE\n		uniform sampler2D u_EmissionTexture;\n	#endif\n	uniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRSpecularLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n		uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n		varying vec4 v_lightMVPPos;\n	#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n	gl_FragColor=packDepth(v_posViewZ);\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		float alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n		if( alpha < u_AlphaTestValue )\n		{\n			discard;\n		}\n	#endif\n}\n\nvoid main_normal()\n{	\n	vec3 viewDir = normalize(v_ViewDir);\n	\n	vec2 uv0 = ParallaxOffset(viewDir);\n	\n	vec4 sg;\n	#ifdef DIFFUSETEXTURE\n		vec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n		vec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n		sg = SpecularGloss(diffuseTextureColor.a, uv0);\n	#else\n		vec4 diffuseColor = u_DiffuseColor;\n		sg = SpecularGloss(1.0, uv0);\n	#endif\n	\n	#ifdef ALPHATEST\n		if(diffuseColor.a < u_AlphaTestValue)\n			discard;\n	#endif\n  \n	vec3 normal = UnpackScaleNormal(uv0);\n	\n	vec3 gi =  u_AmbientColor * Occlusion(uv0).rgb;\n	\n	//float a = (sg.r+sg.g+sg.b) / 3.0;\n  \n	vec4 color = PBRSpecularDiectionLight(diffuseColor.rgb, sg.rgb, sg.a, normal,viewDir, u_DirectionLight, gi);\n	\n	color.a = diffuseColor.a;\n	\n	#ifdef EMISSION\n		vec4 emissionColor = u_EmissionColor;\n		#ifdef EMISSIONTEXTURE\n			emissionColor *=  texture2D(u_EmissionTexture, uv0);\n		#endif\n		color.rgb += emissionColor.rgb;\n	#endif\n	\n	#ifdef RECEIVESHADOW\n		float shadowValue = 1.0;\n		#ifdef SHADOWMAP_PSSM3\n			shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n		#endif\n		#ifdef SHADOWMAP_PSSM2\n			shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n		#endif \n		#ifdef SHADOWMAP_PSSM1\n			shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n		#endif\n		gl_FragColor = vec4(color.rgb * shadowValue, color.a);\n	#else\n		gl_FragColor = color;\n	#endif\n}\n\nvoid main()\n{\n	#ifdef CASTSHADOW		\n		main_castShadow();\n	#else\n		main_normal();\n	#endif  \n}\n\n',a=ri.add(c,e,t,n,i),Vi.SHADERDEFINE_DIFFUSETEXTURE=a.registerMaterialDefine("DIFFUSETEXTURE"),Vi.SHADERDEFINE_SPECULARTEXTURE=a.registerMaterialDefine("SPECULARTEXTURE"),Vi.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=a.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),Vi.SHADERDEFINE_NORMALTEXTURE=a.registerMaterialDefine("NORMALTEXTURE"),Vi.SHADERDEFINE_PARALLAXTEXTURE=a.registerMaterialDefine("PARALLAXTEXTURE"),Vi.SHADERDEFINE_OCCLUSIONTEXTURE=a.registerMaterialDefine("OCCLUSIONTEXTURE"),Vi.SHADERDEFINE_EMISSION=a.registerMaterialDefine("EMISSION"),Vi.SHADERDEFINE_EMISSIONTEXTURE=a.registerMaterialDefine("EMISSIONTEXTURE"),Vi.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),n={a_position:0,a_normal:3,uv:2},i={irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],texBaseColor:[1,1],texNormal:[2,1],texSky:[11,1],texUnderWater:[3,1],texPrefilterdEnv:[8,3],texPrefilterDiff:[7,3],texWaterDisp:[4,1],texWaveDetail:[9,1],texDeepColor:[10,1],texWaterInfo:[16,1],texFoam:[17,1],GEOWAVE_UV_SCALE:[18,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_curTm:[8,1],u_scrsize:[15,1],u_WaveInfoD:[13,1],u_WaveInfo:[12,1],u_WaveMainDir:[14,1],u_DeepScale:[20,1],u_SeaColor:[19,1],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4]};var h=Ci.nameKey.add("Water");e='\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\nuniform float u_curTm;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n//uniform sampler2D texWaterDisp;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nuniform sampler2D texWaterInfo;\nvarying vec4 vWaterInfo;\nuniform float u_DeepScale;//texWaterInfo.r*vDeepScale\n#endif\nuniform float u_WaveMainDir;	//主波方向\nuniform float GEOWAVE_UV_SCALE ;//= 100.0;\n\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\nvarying vec3 vDisp;\nvarying float fDeep;\nvarying mat2 matUVTrans;\nvarying float fFoam;\n\nconst float PI = 3.14159265358979323846264;\n\n#include "WaveFunction.glsl"\n\nvec2 getPosFromUV(vec2 uv){\n	return uv*50.;\n}\n\nvoid main() {\n	vec3 pos = a_position;\n    vUv = uv;\n	\n	//vDisp = texture2D(texWaterDisp,uv).rgb;\n	//vec3 disp = vDisp;\n	\n	//TODO 这里有个潜规则。\n	float tt = pos.y; pos.y=pos.z; pos.z=-tt;\n	\n	#ifdef USE_VERTEX_DEEPINFO\n	fDeep = -pos.y;\n	pos.y=0.0;\n	#else\n	vWaterInfo = texture2D(texWaterInfo,uv);\n	fDeep = vWaterInfo.r*u_DeepScale;\n	#endif\n	\n	\n	//计算波形\n	mat4 modelMat = modelMatrix;\n	vec3 opos, T,B,N;\n	float foams=0.;\n	vec2 uvpos = uv*GEOWAVE_UV_SCALE+vec2(modelMat[3][0],0.);//TODO 如果有旋转缩放怎么办\n	calcGerstnerWave(u_curTm, pos,fDeep, uvpos,opos,B,T,N,foams);\n	fFoam = foams;\n	gl_Position = mvp*vec4(opos,1.);\n	vWorldPos = modelMat*vec4(opos,1.);\n\n	vWorldNorm = normalize((modelMatrix*vec4(N,0.0)).xyz);\n	vWorldTan = normalize((modelMatrix*vec4(T,0.0)).xyz);\n	vWorldBin = normalize((modelMatrix*vec4(B,0.0)).xyz);\n    vViewDir = vWorldPos.xyz-cameraPosition; //这个不能取normalize，否则会引入非线性\n	\n	float s = sin(u_WaveMainDir);\n	float c = cos(u_WaveMainDir);\n	matUVTrans = mat2(c,-s,s,c);\n}\n',t="//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec3 vViewDir;//入射。pos-cam\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying float fDeep;\nvarying mat2 matUVTrans;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nvarying vec4 vWaterInfo;\n#endif\nmat3 matTBNOff;//\n\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n#ifdef CUBE_ENV\nuniform samplerCube texSky;\n#else\nuniform sampler2D texSky;\n#endif\nuniform sampler2D texUnderWater;\nuniform sampler2D texWaveDetail;\n//uniform sampler2D texDeepColor;\nuniform sampler2D texFoam;\nvarying float fFoam;\nuniform float u_curTm;\nuniform vec2 u_scrsize;\nuniform vec3 u_SeaColor;//\n\nconst int NumTexWaves=4;\nconst float Amp_over_L = 0.01;\n//const vec3 SEA_COLOR1 = vec3(0.0292,0.672,0.7467);//大洋\n//const vec3 SEA_COLOR2 = vec3(0,0.927,0.43);//近海\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\n/*\n	各种 ToneMap\n*/\n//Reinhard\nvec3 ReinhardToneMapping(vec3 color, float adapted_lum) {\n    const float MIDDLE_GREY = 1.;\n    color *= MIDDLE_GREY / adapted_lum;\n    return color / (1.0 + color);\n}\n\n//CE2\nvec3 CEToneMapping(vec3 color, float adapted_lum){\n    return 1. - exp(-adapted_lum * color);\n}\n\n//UC2\nvec3 F1(vec3 x){\n	const float A = 0.22;\n	const float B = 0.30;\n	const float C = 0.10;\n	const float D = 0.20;\n	const float E = 0.01;\n	const float F = 0.30;\n \n	return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;\n}\n\nvec3 Uncharted2ToneMapping(vec3 color, float adapted_lum){\n	const vec3 WHITE = vec3(11.2);\n	return F1(1.6 * adapted_lum * color) / F1(WHITE);\n}\n\n//ACES\nvec3 ACESToneMapping(vec3 color, float adapted_lum){\n	const float A = 2.51;\n	const float B = 0.03;\n	const float C = 2.43;\n	const float D = 0.59;\n	const float E = 0.14;\n\n	color *= adapted_lum;\n	return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n	float envu = atan(dir.z,dir.x)/_2PI+0.5; 	\n	float envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n	return texture2D(tex,vec2(envu,envv));\n}\n\n/*\n	与位于0点的测试棒的相交测试交点\n	这个是瞎写的，只是为了测试\n*/\nbool hitClydiner(vec3 pos, vec3 dir, out vec3 hitpos, out vec3 hitnormal){\n	const float r = 0.5;\n	float a = dir.x*dir.x+dir.z*dir.z;\n	float b = 2.*dir.x*pos.x+2.*dir.z*pos.z;\n	float c = pos.x*pos.x+pos.z*pos.z-r*r;\n	float d = b*b-4.*a*c;\n	if(d>=0.0){\n		float t = (-b+sqrt(d))/2./a;\n		t =min(t, (-b-sqrt(d))/2./a);\n		hitpos = pos+dir*t;\n		return true;\n	}\n	/*\n	vec3 v1 = normalize(cross(dir,vec3(0.,1.,0.)));//公垂线\n	float dist = dot(pos,v1);//最短距离\n	if(abs(dist)<r){\n		return true;\n	}\n	*/\n	return false;\n}\n\n///* 根据散射公式来计算某个方向的颜色 *///\n//\nfloat phase_function(float costheta, float g, float g2){\n	return 1.5*( (1.0-g2) / (2.0+g2) ) * (1.0+costheta*costheta) / pow(1.0+g2-2.0*g*costheta, 1.5);	\n}\n\nconst float _density = .2;\nconst vec3 _vLightDir=vec3(0.,-1.,0.);//必须是规格化的\nconst int _SAMPLENUM = 20;\nconst float _K1 = 1.0;\nconst float _g = -0.93;\n//\nvec3 calcScatter(vec3 start, vec3 dir, vec3 end){\n	float len = length(end-start);\n	float costheta = dot(dir,_vLightDir);\n	float g2 = _g*_g;\n	float K = _K1*len*_density*phase_function(costheta,_g,g2);\n	//用分段的方式来积分\n	float dlen = len/float(_SAMPLENUM);//距离平分\n	float ddeep = (start.y-end.y)/float(_SAMPLENUM);//深度平分\n	float sum=0.;\n	for( int i=0; i<_SAMPLENUM; i++){\n		float fi = float(i);\n		float v1 = exp(-_density*(dlen+ddeep)*fi);//TODO 应该可以用分析法计算出来\n		sum += v1;\n	}\n	return vec3(K*sum);\n}\n///* 根据散射公式来计算某个方向的亮度  END *///\n\nconst float cDeep = -2.;	//假设水的深度\nvec3 getShuiDiColor(vec3 pos, vec3 dir, vec3 normal){\n	//一个无限大的水底，黑白格纹理。纹理长度为1米\n	float t = ( cDeep-pos.y )/dir.y;\n	if(t<0.) return vec3(1.,0.,0.);//TEST\n	bool bhit = false;\n	vec3 hitpos;\n	vec3 hitcolor;\n	vec3 hn;\n	if(hitClydiner(pos,dir,hitpos,hn) && hitpos.y>cDeep && hitpos.y<pos.y){\n		bhit=true;\n		hitcolor = vec3(.8,.8,.8);\n\n	}else\n	{\n		hitpos = pos+dir*t;\n		vec3 hp = floor(hitpos);\n		float a = mod((hp.x+hp.z),2.);\n		hitcolor = (a<.9)?vec3(0.,0.,0.):vec3(1.,1.,1.);\n		//hitcolor = texture2D(texUnderWater,hitpos.xz/10.).rgb;\n	}\n	\n	float l = length(hitpos-pos);\n	//return texture2D(texDeepColor,vec2(min(max(l/400.,0.),1.),0.5)).rgb;\n	//return SEA_COLOR1*calcScatter(pos,dir,hitpos);\n	float left = pow(0.8,l);//假设透过率为80%，则到达水底的时候的光强。\n	return mix(hitcolor,u_SeaColor,1.-left);\n}\n\n/*\n	view已经normalize了\n*/\nvec3 getRefractColor(vec3 view,vec3 normal){\n	vec3 T = refract(-view, normal, 0.7);\n	return getShuiDiColor(vWorldPos.xyz,T,normal); \n}\n\nvec4 calcWaterC(vec3 view, vec3 normal, float von, vec3 R, float rough){\n	/*\n	只有浪顶的法线向下，也就是波形形成了交叠的时候，才会这样，所以要通过参数控制避免出现这种情况，而不是在这里保护。\n	if(dot(R,vec3(0.,1.,0.))<0.){\n		R = -R;\n	}\n	*/\n	//vec3 refr = getRefractColor(-view,normal);\n#ifdef USE_REFR_TEX	\n	vec3 refr = texture2D(texUnderWater, gl_FragCoord.xy/u_scrsize+normal.xz/8.).rgb;\n#else\n	vec3 refr = u_SeaColor;\n#endif\n	float F0=0.02;\n	//菲涅尔，越大反射越强\n	float f =  F0+(1.0-F0)*exp2((-5.55473*von-6.98316)*von);\n	//float f = F0+(1.0-F0)*pow(1.-von,5.);\n	//能看到水底的程度。反射剩余的*水中的衰减\n	//float a = (1.-f)*(1.-deepk);\n#ifdef CUBE_ENV\n	vec4 reflc = textureCube(texSky,R);\n#else\n	vec4 reflc = texPanorama(texSky, R);\n#endif\n#ifdef HDR_ENV\n	vec3 refl = _RGBEToRGB(reflc)*f;\n#else\n	vec3 refl = reflc.rgb*f;\n#endif\n	//return vec4(refl*(1.-rough),1.);\n	\n	//vec3 refl = reflc.rgb*f;\n	vec3 final = mix(refr, u_SeaColor, min(fDeep/10.,1.))+refl*(max(0.,1.-rough));\n#ifdef HDR_ENV\n	final = ACESToneMapping(final,1.);//TODO 这个要uniform传入\n#endif\n	return vec4(final,f);\n}\n\nvoid main() {\n    vec3 normal =  normalize(vWorldNorm);\n	//如果uv=1为100米，希望每个细节纹理表示20米的小波形，则uv缩放是 100/20。细节纹理内部也要用这个值，即pos=uv*20\n	vec2 ruv = matUVTrans*vUv;\n	vec3 detailNorm = texture2D(texWaveDetail,fract(ruv*5.)).rgb*2.-vec3(1.);//TODO uv怎么算\n	float texNormScale = 2.*PI*float(NumTexWaves)*Amp_over_L*2.5;\n	detailNorm *= vec3(texNormScale,1.,texNormScale);\n	//旋转\n	//细节纹理来自rendertarget，因此需要颠倒z\n	\n	matTBNOff = mat3(matUVTrans[0][0],0.,matUVTrans[1][0],\n	0.,1.,0.,\n	matUVTrans[0][1],0.,matUVTrans[1][1]\n	);\n	\n	/*\n	matTBNOff = mat3(0.,0.,1.,\n	0.,1.,0.,\n	-1.,0.,0.\n	);\n	*/\n\n    mat3 tsn = mat3( vWorldBin, normal, vWorldTan);	\n    //normal = normalize(tsn * matTBNOff * detailNorm);\n	normal = normalize(tsn * detailNorm); //这个应该更正确。因为本身方向就是根据uv算的，如果是静态图片才需要转换。\n	//vec4 normtex = texture2D( texNormal, vUv );\n    vec3 view   = -normalize(vViewDir);//view 是指向camera的\n    float NoV = saturate(dot( view, normal ));\n    //vec3 R = 2. * NoV * normal - view;\n	\n#ifdef USE_FOAM	\n	vec4 foamc = (texture2D(texFoam,vUv*50.)+texture2D(texFoam,vUv*20.))/2.;\n	float nearcoast = 1.-min(fDeep/10.,1.);// 1.-vWaterInfo.r;\n	float foams = (nearcoast/4.+fFoam)*2.*nearcoast;\n#else\n	float foams =0.;\n#endif\n	\n	vec3 R = reflect(-view,normal);\n	vec4 wc = calcWaterC(view, normal,NoV,R, foams);\n\n	gl_FragColor.rgb = wc.rgb;//normalize(detailNorm).rrr;//((normal)+vec3(0.0))/1.;//normalize(normal).rgb;//texture2D(texWaveDetail,vUv).rgb;// fracColor * texture2D(texUnderWater, vUv*20.0).rgb;// vec3(1.0);//pbrl.rgb;\n    gl_FragColor.a = 1.0;//wc.a;\n#ifdef USE_FOAM\n	gl_FragColor.rgb = mix(gl_FragColor.rgb,vec3(1.),foamc.a*foams);\n	gl_FragColor.a = foamc.r;\n#endif\n	//if(mod(vUv.x*100.,1.0)<0.02 || mod(vUv.y*100.,1.0)<0.02) gl_FragColor.rgb=vec3(0.5,.5,.5);\n	//gl_FragColor.rgb = detailNorm;\n}\n",a=ri.add(h,e,t,n,i),Ni.SHADERDEFINE_CUBE_ENV=a.registerMaterialDefine("CUBE_ENV"),Ni.SHADERDEFINE_HDR_ENV=a.registerMaterialDefine("HDR_ENV"),Ni.SHADERDEFINE_SHOW_NORMAL=a.registerMaterialDefine("SHOW_NORMAL"),Ni.SHADERDEFINE_USEVERTEXHEIGHT=a.registerMaterialDefine("USE_VERTEX_DEEPINFO"),Ni.SHADERDEFINE_USE_FOAM=a.registerMaterialDefine("USE_FOAM"),Ni.SHADERDEFINE_USE_REFRACT_TEX=a.registerMaterialDefine("USE_REFR_TEX"),n={a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshColor:1,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},i={u_Tintcolor:[2,1],u_TilingOffset:[3,1],u_texture:[1,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]};var d=Ci.nameKey.add("PARTICLESHURIKEN");e="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n	attribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n	attribute vec3 a_MeshPosition;\n	attribute vec4 a_MeshColor;\n	attribute vec2 a_MeshTextureCoordinate;\n	varying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n	varying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n	uniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n	uniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n	uniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n	varying vec3 v_PositionWorld;\n#endif\n\n#ifdef TILINGOFFSET\n	uniform vec4 u_TilingOffset;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n	float halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n	float halfYaw = rot.y * 0.5;\n\n	float sinRoll = sin(halfRoll);\n	float cosRoll = cos(halfRoll);\n	float sinPitch = sin(halfPitch);\n	float cosPitch = cos(halfPitch);\n	float sinYaw = sin(halfYaw);\n	float cosYaw = cos(halfYaw);\n\n	float quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n	float quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n	float quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n	float quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n	\n	//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n	//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n	//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n	\n	float x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n	float xx = quaX * x;\n    float xy = quaX * y;\n	float xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n	\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n	float halfAngle = angle * 0.5;\n	float sin = sin(halfAngle);\n	\n	float quaX = axis.x * sin;\n	float quaY = axis.y * sin;\n	float quaZ = axis.z * sin;\n	float quaW = cos(halfAngle);\n	\n	//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n	//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n	//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n	\n	float x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n	float xx = quaX * x;\n    float xy = quaX * y;\n	float xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n	\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n	return v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n	float curValue;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientNumber=gradientNumbers[i];\n		float key=gradientNumber.x;\n		if(key>=normalizedAge)\n		{\n			vec2 lastGradientNumber=gradientNumbers[i-1];\n			float lastKey=lastGradientNumber.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			curValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n			break;\n		}\n	}\n	return curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n	float totalValue=0.0;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientNumber=gradientNumbers[i];\n		float key=gradientNumber.x;\n		vec2 lastGradientNumber=gradientNumbers[i-1];\n		float lastValue=lastGradientNumber.y;\n		\n		if(key>=normalizedAge){\n			float lastKey=lastGradientNumber.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			totalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n			break;\n		}\n		else{\n			totalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n		}\n	}\n	return totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n	vec4 overTimeColor;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientAlpha=gradientAlphas[i];\n		float alphaKey=gradientAlpha.x;\n		if(alphaKey>=normalizedAge)\n		{\n			vec2 lastGradientAlpha=gradientAlphas[i-1];\n			float lastAlphaKey=lastGradientAlpha.x;\n			float age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n			overTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n			break;\n		}\n	}\n	\n	for(int i=1;i<4;i++)\n	{\n		vec4 gradientColor=gradientColors[i];\n		float colorKey=gradientColor.x;\n		if(colorKey>=normalizedAge)\n		{\n			vec4 lastGradientColor=gradientColors[i-1];\n			float lastColorKey=lastGradientColor.x;\n			float age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n			overTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n			break;\n		}\n	}\n	return overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n	float overTimeFrame;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientFrame=gradientFrames[i];\n		float key=gradientFrame.x;\n		if(key>=normalizedAge)\n		{\n			vec2 lastGradientFrame=gradientFrames[i-1];\n			float lastKey=lastGradientFrame.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			overTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n			break;\n		}\n	}\n	return floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n	 outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n	 outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n	                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n					 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n					\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n	#ifdef VELOCITYOVERLIFETIMECONSTANT\n		  startPosition=startVelocity*age;\n		  lifePosition=lifeVelocity*age;\n	#endif\n	#ifdef VELOCITYOVERLIFETIMECURVE\n		  startPosition=startVelocity*age;\n		  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n	#endif\n	#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n		  startPosition=startVelocity*age;\n		  lifePosition=lifeVelocity*age;\n	#endif\n	#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n		  startPosition=startVelocity*age;\n		  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n	      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n	      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n	#endif\n	\n	vec3 finalPosition;\n	if(u_VOLSpaceType==0){\n	  if(u_ScalingMode!=2)\n	   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n	  else\n	   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n	}\n	else{\n	  if(u_ScalingMode!=2)\n	    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n	  else\n	    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n	}\n  #else\n	 startPosition=startVelocity*age;\n	 vec3 finalPosition;\n	 if(u_ScalingMode!=2)\n	   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n	 else\n	   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n	#ifdef COLOROVERLIFETIME\n	  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n	#endif\n	\n	#ifdef RANDOMCOLOROVERLIFETIME\n	  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n	#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n	#ifdef SIZEOVERLIFETIMECURVE\n		size*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVES\n	    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n	#endif\n	#ifdef SIZEOVERLIFETIMECURVESEPERATE\n		size*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n	    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n	    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n	#endif\n	return size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n	#ifdef SIZEOVERLIFETIMECURVE\n		size*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVES\n	    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n	#endif\n	#ifdef SIZEOVERLIFETIMECURVESEPERATE\n		size*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n	    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n	    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n		,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n	#endif\n	return size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n	#ifdef ROTATIONOVERLIFETIME\n		#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConst*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n		#endif\n	#endif\n	#ifdef ROTATIONOVERLIFETIMESEPERATE\n		#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n		#endif\n	#endif\n	return rotation;\n}\n\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n	#ifdef ROTATIONOVERLIFETIME\n	#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConst*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n		#endif\n	#endif\n	#ifdef ROTATIONOVERLIFETIMESEPERATE\n	#ifdef ROTATIONOVERLIFETIMECONSTANT\n			vec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			vec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n	        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n	        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n		#endif\n	#endif\n	return rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n	#ifdef TEXTURESHEETANIMATIONCURVE\n		float cycleNormalizedAge=normalizedAge*u_TSACycles;\n		float frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n		float totalULength=frame*u_TSASubUVLength.x;\n		float floorTotalULength=floor(totalULength);\n	    uv.x+=totalULength-floorTotalULength;\n		uv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n	#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n		float cycleNormalizedAge=normalizedAge*u_TSACycles;\n		float uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n	    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n		float totalULength=frame*u_TSASubUVLength.x;\n		float floorTotalULength=floor(totalULength);\n	    uv.x+=totalULength-floorTotalULength;\n		uv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n	return uv;\n}\n\nvoid main()\n{\n	float age = u_CurrentTime - a_DirectionTime.w;\n	float normalizedAge = age/a_ShapePositionStartLifeTime.w;\n	vec3 lifeVelocity;\n	if(normalizedAge<1.0){ \n	vec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n	#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n		lifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n	#endif \n	vec3 gravityVelocity=u_Gravity*age;\n	\n	vec4 worldRotation;\n	if(u_SimulationSpace==0)\n		worldRotation=a_SimulationWorldRotation;\n	else\n		worldRotation=u_WorldRotation;\n	\n	vec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n	    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n		#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n			if(u_ThreeDStartRotation){\n				vec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n				center += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n			}\n			else{\n				float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n				float c = cos(rot);\n				float s = sin(rot);\n				mat2 rotation= mat2(c, -s, s, c);\n				corner=rotation*corner;\n				center += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n			}\n		#else\n			if(u_ThreeDStartRotation){\n				center += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n			}\n			else{\n				float c = cos(a_StartRotation0.x);\n				float s = sin(a_StartRotation0.x);\n				mat2 rotation= mat2(c, -s, s, c);\n				corner=rotation*corner;\n				center += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n			}\n		#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n	vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n	vec3 velocity;\n	#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n	    if(u_VOLSpaceType==0)\n		  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n	    else\n		  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n	    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif	\n		vec3 cameraUpVector = normalize(velocity);\n		vec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n		\n		sideVector=u_SizeScale.xzy*sideVector;\n		cameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n		\n	    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n		\n	    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n	    corner=rotaionZHalfPI*corner;\n	    corner.y=corner.y-abs(corner.y);\n		\n	    float speed=length(velocity);//TODO:\n	    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n	    const vec3 sideVector = vec3(-1.0,0.0,0.0);\n		\n		float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n	    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n		corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n		\n		float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n	    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n		corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n	    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n		#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n			if(u_ThreeDStartRotation){\n				vec3 rotation=vec3(a_StartRotation0.xy,-computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n				center+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n			}\n			else{\n				#ifdef ROTATIONOVERLIFETIME\n					float angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n					if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n						center+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n					}\n					else{\n						#ifdef SHAPE\n							center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n						#else\n							if(u_SimulationSpace==0)\n								center+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n							else if(u_SimulationSpace==1)\n								center+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n						#endif\n					}\n				#endif\n				#ifdef ROTATIONOVERLIFETIMESEPERATE\n					//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n					vec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,a_StartRotation0.z), age,normalizedAge);\n					center+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n				#endif	\n			}\n		#else\n			if(u_ThreeDStartRotation){\n				center+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n			}\n			else{\n				if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n					if(u_SimulationSpace==0)\n						center+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n					else if(u_SimulationSpace==1)\n						center+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n				}\n				else{\n					#ifdef SHAPE\n						if(u_SimulationSpace==0)\n							center+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n						else if(u_SimulationSpace==1)\n							center+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);	\n					#else\n						if(u_SimulationSpace==0)\n							center+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n						else if(u_SimulationSpace==1)\n							center+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n					#endif\n				}\n			}\n		#endif\n		v_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n	#ifdef DIFFUSEMAP\n		#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n			v_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n		#endif\n		#ifdef RENDERMODE_MESH\n			v_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n		#endif\n		\n		#ifdef TILINGOFFSET\n			v_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset.xy+vec2(u_TilingOffset.z,-u_TilingOffset.w);//需要特殊处理\n			v_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n		#endif\n	#endif\n    v_Discard=0.0;\n	  \n	#ifdef FOG\n		v_PositionWorld=center;\n	#endif\n   }\n   else\n	{\n		v_Discard=1.0;\n	}\n}\n\n",t="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n	varying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n	varying vec3 v_PositionWorld;\n	uniform vec3 u_CameraPosition;\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	#ifdef ADDTIVEFOG\n	#else\n		uniform vec3 u_FogColor;\n	#endif\n#endif\n\n\nvoid main()\n{	\n	#ifdef RENDERMODE_MESH\n		gl_FragColor=v_MeshColor;\n	#else\n		gl_FragColor=vec4(1.0);	\n	#endif\n		\n	#ifdef DIFFUSEMAP\n		if(v_Discard!=0.0)\n			discard;\n		#ifdef TINTCOLOR\n			gl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n		#else\n			gl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n		#endif\n	#else\n		#ifdef TINTCOLOR\n			gl_FragColor*=u_Tintcolor*2.0*v_Color;\n		#else\n			gl_FragColor*=v_Color;\n		#endif\n	#endif\n	\n	#ifdef FOG\n		vec3 toEye=u_CameraPosition-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n		\n		float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n		#ifdef ADDTIVEFOG\n			gl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n		#else\n			gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n		#endif\n	#endif\n}",a=ri.add(d,e,t,n,i),bi.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),bi.SHADERDEFINE_TINTCOLOR=a.registerMaterialDefine("TINTCOLOR"),bi.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),bi.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),lr.SHADERDEFINE_RENDERMODE_BILLBOARD=a.registerSpriteDefine("SPHERHBILLBOARD"),lr.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=a.registerSpriteDefine("STRETCHEDBILLBOARD"),lr.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=a.registerSpriteDefine("HORIZONTALBILLBOARD"),lr.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=a.registerSpriteDefine("VERTICALBILLBOARD"),lr.SHADERDEFINE_COLOROVERLIFETIME=a.registerSpriteDefine("COLOROVERLIFETIME"),lr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=a.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),lr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),lr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),lr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),lr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),lr.SHADERDEFINE_ROTATIONOVERLIFETIME=a.registerSpriteDefine("ROTATIONOVERLIFETIME"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=a.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=a.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=a.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),lr.SHADERDEFINE_SIZEOVERLIFETIMECURVE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),lr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),lr.SHADERDEFINE_RENDERMODE_MESH=a.registerSpriteDefine("RENDERMODE_MESH"),lr.SHADERDEFINE_SHAPE=a.registerSpriteDefine("SHAPE"),n={a_Position:0,a_Texcoord0:2,a_Time:33},i={u_Texture:[1,1],u_Albedo:[2,1],u_Color:[3,1],u_CurrentTime:[2,2],u_Duration:[3,2],u_MvpMatrix:[1,2]};
var _=Ci.nameKey.add("GLITTER");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",t="#ifdef HIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{	\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",a=ri.add(_,e,t,n,i),n={a_Position:0},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_CubeTexture:[3,1],u_MvpMatrix:[4,3]};var f=Ci.nameKey.add("SkyBox");e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{	\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",ri.add(f,e,t,n,i),n={a_Position:0,a_Texcoord0:2},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_texture:[3,1],u_MvpMatrix:[4,3]};var m=Ci.nameKey.add("SkyDome");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",t="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{	\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",ri.add(m,e,t,n,i),n={a_Position:0,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15},i={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_NormalTexture:[1,1],u_DiffuseTexture1:[2,1],u_DiffuseTexture2:[3,1],u_DiffuseTexture3:[4,1],u_DiffuseTexture4:[5,1],u_DiffuseScale1:[6,1],u_DiffuseScale2:[7,1],u_DiffuseScale3:[8,1],u_DiffuseScale4:[9,1],u_MaterialDiffuse:[11,1],u_MaterialAmbient:[10,1],u_MaterialSpecular:[12,1],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var p=Ci.nameKey.add("Terrain");e="attribute vec4 a_Position;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n	attribute vec3 a_Normal;\n	varying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n	uniform mat4 u_WorldMat;\n	varying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef LIGHTMAP\n	uniform vec4 u_LightmapScaleOffset;\n	varying vec2 v_LightMapUV;\n#endif\n\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nuniform mat4 u_MvpMatrix;\n\nvoid main()\n{\n	gl_Position = u_MvpMatrix * a_Position;\n	v_Texcoord0=a_Texcoord0;\n	v_Texcoord1=a_Texcoord1;\n	\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	v_Normal=a_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n	v_PositionWorld=(u_WorldMat*a_Position).xyz;\n#endif\n\n#ifdef LIGHTMAP\n	//这个地方使用a_Normal 并不是真的代表normal，其实凑巧法线图的uv正好是符合 light_Map的UV\n	v_LightMapUV=vec2(a_Normal.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Normal.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n#endif\n\n#ifdef RECEIVESHADOW\n	v_posViewZ = gl_Position.w;\n	#ifdef SHADOWMAP_PSSM1\n		v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n	#endif\n#endif\n\n}",t='#ifdef HIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	uniform vec3 u_MaterialDiffuse;\n	uniform vec4 u_MaterialSpecular;\n	uniform vec3 u_CameraPos;\n	varying vec3 v_Normal;\n	varying vec3 v_PositionWorld;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n	uniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	uniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n	uniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n	uniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n	uniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n	uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n	varying vec4 v_lightMVPPos;\n	#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\nuniform sampler2D u_NormalTexture;\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform vec2 u_DiffuseScale1;\nuniform vec2 u_DiffuseScale2;\nuniform vec2 u_DiffuseScale3;\nuniform vec2 u_DiffuseScale4;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#ifdef LIGHTMAP\n	uniform sampler2D u_LightMap;\n	varying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n#ifdef DETAIL_NUM1\n	vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n	vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n	gl_FragColor.xyz = color1.xyz;\n#endif\n#ifdef DETAIL_NUM2\n	vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n	vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n	vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n	gl_FragColor.xyz = color1.xyz * (1.0-splatAlpha.r) + color2.xyz * splatAlpha.r;\n#endif\n#ifdef DETAIL_NUM3\n	vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n	vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n	vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n	vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n	gl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g)) + color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g;\n#endif\n#ifdef DETAIL_NUM4\n	vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n	vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n	vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n	vec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord1/u_DiffuseScale4);\n	vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n	gl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g+splatAlpha.b))+ color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g + color4.xyz * splatAlpha.b;\n#endif\n	gl_FragColor.w = splatAlpha.a;\n		\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = texture2D(u_NormalTexture,v_Normal.xy).xyz;\n	normal = normal*2.0 - vec3(1.0);\n	vec3 diffuse = vec3(0.0);\n	vec3 ambient = vec3(0.0);\n	vec3 specular= vec3(0.0);\n	vec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n	vec3 toEye;\n	#ifdef FOG\n		toEye=u_CameraPos-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n	#else\n		toEye=normalize(u_CameraPos-v_PositionWorld);\n	#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n	computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n	computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n	ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n	float shadowValue = 1.0;\n	#ifdef SHADOWMAP_PSSM3\n		shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif\n	#ifdef SHADOWMAP_PSSM2\n		shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif \n	#ifdef SHADOWMAP_PSSM1\n		shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n	#endif\n#endif\n\n#ifdef LIGHTMAP\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n	#else\n		#if defined(RECEIVESHADOW)\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n		#else\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n		#endif\n	#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	#ifdef RECEIVESHADOW\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n	#else\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n	#endif\n#endif\n\n#ifdef FOG\n	float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n	gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n';var E=ri.add(p,e,t,n,i);wi.SHADERDEFINE_DETAIL_NUM1=E.registerMaterialDefine("DETAIL_NUM1"),wi.SHADERDEFINE_DETAIL_NUM2=E.registerMaterialDefine("DETAIL_NUM2"),wi.SHADERDEFINE_DETAIL_NUM4=E.registerMaterialDefine("DETAIL_NUM4"),wi.SHADERDEFINE_DETAIL_NUM3=E.registerMaterialDefine("DETAIL_NUM3"),n={a_Position:0,a_Normal:3,a_Texcoord0:2},i={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_DiffuseTexture1:[1,1],u_DiffuseTexture2:[2,1],u_DiffuseTexture3:[3,1],u_DiffuseTexture4:[4,1],u_DiffuseTexture5:[5,1],u_DiffuseScaleOffset1:[6,1],u_DiffuseScaleOffset2:[7,1],u_DiffuseScaleOffset3:[8,1],u_DiffuseScaleOffset4:[9,1],u_DiffuseScaleOffset5:[10,1],u_MaterialAlbedo:[14,1],u_MaterialDiffuse:[12,1],u_MaterialAmbient:[11,1],u_MaterialSpecular:[13,1],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var v=Ci.nameKey.add("ExtendTerrain");e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n	attribute vec3 a_Normal;\n	varying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n	uniform mat4 u_WorldMat;\n	varying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n	varying vec2 v_LightMapUV;\n	uniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n	varying float v_posViewZ;\n	#ifdef SHADOWMAP_PSSM1 \n		varying vec4 v_lightMVPPos;\n		uniform mat4 u_lightShadowVP[4];\n	#endif\n#endif\n\nvoid main()\n{\n	gl_Position = u_MvpMatrix * a_Position;\n  \n	v_Texcoord0 = a_Texcoord0;\n  \n	#ifdef LIGHTMAP\n		v_LightMapUV = vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n	#endif\n  \n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		v_Normal = a_Normal;\n	#endif\n\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n		v_PositionWorld=(u_WorldMat*a_Position).xyz;\n	#endif\n\n	#ifdef RECEIVESHADOW\n		v_posViewZ = gl_Position.w;\n		#ifdef SHADOWMAP_PSSM1\n			v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n		#endif\n	#endif\n}",t='#ifdef HIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n	uniform vec3 u_MaterialDiffuse;\n	uniform vec4 u_MaterialSpecular;\n	uniform vec3 u_CameraPos;\n	varying vec3 v_Normal;\n	varying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	uniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n	uniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n	uniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n	uniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n	uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n	varying vec4 v_lightMVPPos;\n	#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\nuniform vec3 u_MaterialAmbient;\nuniform vec4 u_MaterialAlbedo;\n\n#ifdef LIGHTMAP\n	uniform sampler2D u_LightMap;\n	varying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n	#ifdef ExtendTerrain_DETAIL_NUM1\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r;\n	#endif\n	#ifdef ExtendTerrain_DETAIL_NUM2\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n	#endif\n	#ifdef ExtendTerrain_DETAIL_NUM3\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n		vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n	#endif\n	#ifdef ExtendTerrain_DETAIL_NUM4\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n		vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n		vec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n	#endif\n	#ifdef ExtendTerrain_DETAIL_NUM5\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n		vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n		vec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n		vec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n	#endif\n		gl_FragColor.w = splatAlpha.a;\n		\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n	vec3 diffuse = vec3(0.0);\n	vec3 ambient = vec3(0.0);\n	vec3 specular= vec3(0.0);\n	vec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n	vec3 toEye;\n	#ifdef FOG\n		toEye=u_CameraPos-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n	#else\n		toEye=normalize(u_CameraPos-v_PositionWorld);\n	#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n	computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n	computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n	ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n	float shadowValue = 1.0;\n	#ifdef SHADOWMAP_PSSM3\n		shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif\n	#ifdef SHADOWMAP_PSSM2\n		shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif \n	#ifdef SHADOWMAP_PSSM1\n		shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n	#endif\n#endif\n\n#ifdef LIGHTMAP\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n	#else\n		#if defined(RECEIVESHADOW)		\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n			//vec3 tColor= u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue + mix(vec3(0.15,0.15,0.15),vec3(0.0),shadowValue);\n			//gl_FragColor.rgb*=tColor;\n		#else\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n		#endif\n	#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_MaterialAlbedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	#ifdef RECEIVESHADOW\n		gl_FragColor = vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n	#else\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n	#endif\n#endif\n\n#ifdef FOG\n	float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n	gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n';var g=ri.add(v,e,t,n,i);g.addSpriteDefines(nr.shaderDefines),g.addMaterialDefines(yi.shaderDefines),n={a_Position:0,a_OffsetVector:41,a_Texcoord0X:38,a_Texcoord0Y:40,a_BirthTime:33},i={u_MvpMatrix:[1,2],u_VMatrix:[1,3],u_PMatrix:[2,3],u_TilingOffset:[3,1],u_MainTexture:[1,1],u_MainColor:[2,1],u_CurTime:[3,2],u_LifeTime:[4,2],u_WidthCurve:[5,2],u_WidthCurveKeyLength:[6,2],u_GradientColorkey:[7,2],u_GradientAlphakey:[8,2]};var T=Ci.nameKey.add("Trail");e="attribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute vec4 a_Color;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0Y;\nattribute float a_BirthTime;\n\nuniform mat4 u_VMatrix;\nuniform mat4 u_PMatrix;\n\nuniform vec4 u_TilingOffset;\n\nuniform float u_CurTime;\nuniform float u_LifeTime;\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nuniform vec4 u_GradientColorkey[10];\nuniform vec2 u_GradientAlphakey[10];\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n	float t2 = t * t;\n	float t3 = t2 * t;\n	float a = 2.0 * t3 - 3.0 * t2 + 1.0;\n	float b = t3 - 2.0 * t2 + t;\n	float c = t3 - t2;\n	float d = -2.0 * t3 + 3.0 * t2;\n	return a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n	if(normalizeTime == 0.0){\n		return u_WidthCurve[0].w;\n	}\n	else if(normalizeTime >= 1.0){\n		return u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n	}\n	else{\n		for(int i = 0; i < 10; i ++ )\n		{\n			if(normalizeTime == u_WidthCurve[i].x)\n			{\n				return u_WidthCurve[i].w;\n			}\n			\n			vec4 lastFrame = u_WidthCurve[i];\n			vec4 nextFrame = u_WidthCurve[i + 1];\n			if(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n			{\n				float duration = nextFrame.x - lastFrame.x;\n				float t = (normalizeTime - lastFrame.x) / duration;\n				float outTangent = lastFrame.z;\n				float inTangent = nextFrame.y;\n				float value1 = lastFrame.w;\n				float value2 = nextFrame.w;\n				return hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n			}\n		}	\n	}\n}	\n\nvec4 getColorFromGradientByBlend(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n	vec4 color;\n	for(int i = 1; i < 10; i++)\n	{\n		vec4 gradientColor = gradientColors[i];\n		float colorKey = gradientColor.w;\n		if(colorKey >= normalizeTime)\n		{\n			vec4 lastGradientColor = gradientColors[i-1];\n			float lastColorKey = lastGradientColor.w;\n			float age = (normalizeTime - lastColorKey) / (colorKey - lastColorKey);\n			color.rgb = mix(gradientColors[i-1].xyz, gradientColor.xyz, age);\n			break;\n		}\n	}\n	for(int i = 1; i < 10; i++)\n	{\n		vec2 gradientAlpha = gradientAlphas[i];\n		float alphaKey = gradientAlpha.y;\n		if(alphaKey >= normalizeTime)\n		{\n			vec2 lastGradientAlpha = gradientAlphas[i-1];\n			float lastAlphaKey = lastGradientAlpha.y;\n			float age = (normalizeTime - lastAlphaKey) / (alphaKey - lastAlphaKey);\n			color.a = mix(lastGradientAlpha.x, gradientAlpha.x, age);\n			break;\n		}\n	}\n	return color;\n}\n\nvec4 getColorFromGradientByFixed(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n	vec4 color;\n	for(int i = 1; i < 10; i++)\n	{\n		vec4 gradientColor = gradientColors[i];\n		if(gradientColor.w >= normalizeTime)\n		{\n			color.rgb = gradientColor.xyz;\n			break;\n		}\n	}\n	for(int i = 1; i < 10; i++)\n	{\n		vec2 gradientAlpha = gradientAlphas[i];\n		if(gradientAlpha.y >= normalizeTime)\n		{\n			color.a = gradientAlpha.x;\n			break;\n		}\n	}\n	return color;\n}\n\nvoid main()\n{\n	float normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\n	\n	gl_Position = u_PMatrix * u_VMatrix * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\n	\n	#ifdef TILINGOFFSET\n		v_Texcoord0 = (vec2(a_Texcoord0X, a_Texcoord0Y) * u_TilingOffset.xy) + u_TilingOffset.zw;\n	#else\n		v_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\n	#endif\n	\n	#ifdef GRADIENTMODE_BLEND\n		v_Color = getColorFromGradientByBlend(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n	#else\n		v_Color = getColorFromGradientByFixed(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n	#endif\n}\n\n\n\n",t="#ifdef HIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{	\n	vec4 color = 2.0 * u_MainColor * v_Color;\n	#ifdef DIFFUSETEXTURE\n		vec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n		color *= mainTextureColor;\n	#endif\n	gl_FragColor = color;\n}\n\n";var S=ri.add(T,e,t,n,i);Ui.SHADERDEFINE_DIFFUSETEXTURE=S.registerMaterialDefine("DIFFUSETEXTURE"),Ui.SHADERDEFINE_TILINGOFFSET=S.registerSpriteDefine("TILINGOFFSET"),cr.SHADERDEFINE_GRADIENTMODE_BLEND=S.registerSpriteDefine("GRADIENTMODE_BLEND")},e}(),bn=function(){function e(){this._data=null,this._data=[]}r(e,"laya.d3.shader.ValusArray");var t=e.prototype;return t.setValue=function(e,t){this._data[e]=t},a(0,t,"data",function(){return this._data}),e}(),Bn=function(){function e(){this._currentPSSM=-1,this._numberOfPSSM=3,this._maxDistance=200,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0,this._lightCulling=null,this._renderTarget=null,this._lightVPMatrix=null,this._lightCameras=null,this._shadowQuenes=null,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._shaderValueVPs=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new On(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new On,this._tempLookAt4=new Vn,this._tempValue=new Vn,this._tempPos=new On,this._tempLightUp=new On,this._tempMin=new Vn,this._tempMax=new Vn,this._tempMatrix44=new xn,this._splitFrustumCulling=new vn(xn.DEFAULT),this._tempScaleMatrix44=new xn,this._shadowPCFOffset=new Cn(1/1024,1/1024),this._shaderValueDistance=new Vn;var e=0;for(e=0;e<this._spiltDistance.length;e++)this._spiltDistance[e]=0;for(e=0;e<this._dimension.length;e++)this._dimension[e]=new Cn;for(e=0;e<this._frustumPos.length;e++)this._frustumPos[e]=new On;for(e=0;e<this._boundingBox.length;e++)this._boundingBox[e]=new En(new On,new On);for(e=0;e<this._boundingSphere.length;e++)this._boundingSphere[e]=new gn(new On,0);xn.createScaling(new On(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}r(e,"laya.d3.shadowMap.ParallelSplitShadowMap");var t=e.prototype;return t.setInfo=function(e,t,n,i,r,a){r>3&&(this._numberOfPSSM=3),this._scene=e,this._maxDistance=t,this.PSSMNum=r,this._globalParallelLightDir=n,this._ratioOfDistance=1/this._numberOfPSSM;for(var o=0;o<this._spiltDistance.length;o++)this._spiltDistance[o]=0;this._shadowMapTextureSize=i,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(a),this._statesDirty=!0},t.setPCFType=function(e){switch(this._PCFType=e,this._PCFType){case 0:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 1:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 2:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 3:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2)}},t.getPCFType=function(){return this._PCFType},t.setFarDistance=function(e){this._maxDistance!=e&&(this._maxDistance=e,this._statesDirty=!0)},t.getFarDistance=function(){return this._maxDistance},t._setGlobalParallelLightDir=function(e){this._globalParallelLightDir=e},t.getGlobalParallelLightDir=function(){return this._globalParallelLightDir},t.getCurrentPSSM=function(){return this._currentPSSM},t.getLightCamera=function(e){return this._lightCameras[e]},t._beginSampler=function(e,t){if(0>e||e>this._numberOfPSSM)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=e,this._update(t)},t.endSampler=function(){this._currentPSSM=-1},t._calcAllLightCameraInfo=function(e){if(1===this._numberOfPSSM)this._beginSampler(0,e),this.endSampler(e);else for(var t=0,n=this._numberOfPSSM+1;n>t;t++)this._beginSampler(t,e),this.endSampler(e)},t._recalculate=function(e,t,n){this._calcSplitDistance(e),this._calcBoundingBox(t,n),this._rebuildRenderInfo()},t._update=function(e){var t=e.nearPlane,n=e.fieldOfView,i=e.aspectRatio;(this._statesDirty||this.lastNearPlane!==t||this.lastFieldOfView!==n||this.lastAspectRatio!==i)&&(this._recalculate(t,n,i),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=t,this.lastFieldOfView=n,this.lastAspectRatio=i),this._calcLightViewProject(e)},t._uploadShaderValue=function(){var e=this._scene;switch(this._numberOfPSSM){case 1:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 2:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 3:e.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),e.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2)}var t=e._shaderValues;switch(t.setValue(15,this._shaderValueDistance.elements),t.setValue(16,this._shaderValueLightVP),t.setValue(17,this._shadowPCFOffset.elements),this._numberOfPSSM){case 3:t.setValue(18,this.getRenderTarget(1)),t.setValue(19,this.getRenderTarget(2)),t.setValue(20,this.getRenderTarget(3));
break;case 2:t.setValue(18,this.getRenderTarget(1)),t.setValue(19,this.getRenderTarget(2));break;case 1:t.setValue(18,this.getRenderTarget(1))}},t._calcSplitDistance=function(e){var t=this._maxDistance,n=1/this._numberOfPSSM,i=0;for(i=0;i<=this._numberOfPSSM;i++)this._uniformDistance[i]=e+(t-e)*i*n;var r=t/e;for(i=0;i<=this._numberOfPSSM;i++){var a=Math.pow(r,i*n);this._logDistance[i]=e*a}for(i=0;i<=this._numberOfPSSM;i++)this._spiltDistance[i]=this._uniformDistance[i]*this._ratioOfDistance+this._logDistance[i]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3]},t._calcBoundingBox=function(e,t){var n=3.1415926*e/180,i=Math.tan(n/2),r=0/0,a=0/0,o=0/0,s=0;for(s=0;s<=this._numberOfPSSM;s++){o=this._spiltDistance[s],r=o*i,a=r*t;var l=this._frustumPos[4*s+0].elements;l[0]=-a,l[1]=-r,l[2]=-o,l=this._frustumPos[4*s+1].elements,l[0]=a,l[1]=-r,l[2]=-o,l=this._frustumPos[4*s+2].elements,l[0]=-a,l[1]=r,l[2]=-o,l=this._frustumPos[4*s+3].elements,l[0]=a,l[1]=r,l[2]=-o,l=this._dimension[s].elements,l[0]=a,l[1]=r}var u,c,h,d;for(s=1;s<=this._numberOfPSSM;s++)u=this._dimension[s].elements,c=this._boundingBox[s].min.elements,c[0]=-u[0],c[1]=-u[1],c[2]=-this._spiltDistance[s],h=this._boundingBox[s].max.elements,h[0]=u[0],h[1]=u[1],h[2]=-this._spiltDistance[s-1],d=this._boundingSphere[s].center.elements,d[0]=.5*(c[0]+h[0]),d[1]=.5*(c[1]+h[1]),d[2]=.5*(c[2]+h[2]),this._boundingSphere[s].radius=.5*Math.sqrt(Math.pow(h[0]-c[0],2)+Math.pow(h[1]-c[1],2)+Math.pow(h[2]-c[2],2));c=this._boundingBox[0].min.elements,u=this._dimension[this._numberOfPSSM].elements,c[0]=-u[0],c[1]=-u[1],c[2]=-this._spiltDistance[this._numberOfPSSM],h=this._boundingBox[0].max.elements,h[0]=u[0],h[1]=u[1],h[2]=-this._spiltDistance[0],d=this._boundingSphere[0].center.elements,d[0]=.5*(c[0]+h[0]),d[1]=.5*(c[1]+h[1]),d[2]=.5*(c[2]+h[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(h[0]-c[0],2)+Math.pow(h[1]-c[1],2)+Math.pow(h[2]-c[2],2))},t.calcSplitFrustum=function(e){this._currentPSSM>0?xn.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):xn.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._numberOfPSSM],this._tempMatrix44),xn.multiply(this._tempMatrix44,e.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},t._rebuildRenderInfo=function(){var e=this._numberOfPSSM+1,t=0;if(null==this._renderTarget)for(this._renderTarget=o(e),this._renderTarget[0]=null,t=1;e>t;t++)this._renderTarget[t]=new ji(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else if(this._renderTarget.length!=e)for(this.disposeAllRenderTarget(),this._renderTarget.length=e,this._renderTarget[0]=null,t=1;e>t;t++)this._renderTarget[t]=new ji(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else for(t=1;e>t;t++)(null==this._renderTarget[t]||this._renderTarget[t].width!=this._shadowMapTextureSize||this._renderTarget[t].height!=this._shadowMapTextureSize)&&(null!=this._renderTarget[t]&&this._renderTarget[t].destroy(),this._renderTarget[t]=new ji(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728));if(null==this._lightCulling||this._lightCulling.length!=e)for(this._lightCulling?this._lightCulling.length=e:this._lightCulling=o(e),t=0;t<this._lightCulling.length;t++)this._lightCulling[t]=new vn(xn.DEFAULT);if(null==this._lightVPMatrix||this._lightVPMatrix.length!=e)for(this._lightVPMatrix?this._lightVPMatrix.length=e:this._lightVPMatrix=o(e),t=0;t<this._lightVPMatrix.length;t++)this._lightVPMatrix[t]=new xn;if(null==this._lightCameras||this._lightCameras.length!=e)for(this._lightCameras?this._lightCameras.length=e:this._lightCameras=o(e),t=0;t<this._lightCameras.length;t++)this._lightCameras[t]=new ar,this._lightCameras[t].name="lightCamera"+t;if(null==this._shadowQuenes||this._shadowQuenes.length!=this._numberOfPSSM)for(this._shadowQuenes?this._shadowQuenes.length=this._numberOfPSSM:this._shadowQuenes=o(this._numberOfPSSM),t=0;t<this._shadowQuenes.length;t++)this._shadowQuenes[t]=new ct(this._scene);if(null==this._shaderValueVPs||this._shaderValueVPs.length!=e)for(this._shaderValueVPs?this._shaderValueVPs.length=e:this._shaderValueVPs=o(e),this._shaderValueLightVP=new Float32Array(16*e),t=0;e>t;t++)this._shaderValueVPs[t]=new Float32Array(this._shaderValueLightVP.buffer,64*t)},t._calcLightViewProject=function(t){{var n=this._boundingSphere[this._currentPSSM],i=t.transform.worldMatrix;n.radius}n.center.cloneTo(this._tempLookAt3),On.transformV3ToV4(this._tempLookAt3,i,this._tempLookAt4);var r=this._tempLookAt3.elements,a=this._tempLookAt4.elements;r[0]=a[0],r[1]=a[1],r[2]=a[2];var o=this._tempLightUp.elements,s=t.forward.elements;o[0]=s[0],o[1]=1,o[2]=s[2],On.normalize(this._tempLightUp,this._tempLightUp),On.scale(this._globalParallelLightDir,4*n.radius,this._tempPos),On.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var l=this._lightCameras[this._currentPSSM];l.transform.position=this._tempPos,l.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var u=this._tempMax.elements,c=this._tempMin.elements;u[0]=u[1]=u[2]=-1e5,u[3]=1,c[0]=c[1]=c[2]=1e5,c[3]=1,xn.multiply(l.viewMatrix,i,this._tempMatrix44);var h=this._tempValue.elements,d=[];d.length=8,this._boundingBox[this._currentPSSM].getCorners(d);for(var _=0;8>_;_++){var f=d[_].elements;h[0]=f[0],h[1]=f[1],h[2]=f[2],h[3]=1,Vn.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),c[0]=h[0]<c[0]?h[0]:c[0],c[1]=h[1]<c[1]?h[1]:c[1],c[2]=h[2]<c[2]?h[2]:c[2],u[0]=h[0]>u[0]?h[0]:u[0],u[1]=h[1]>u[1]?h[1]:u[1],u[2]=h[2]>u[2]?h[2]:u[2]}Vn.add(this._tempMax,this._tempMin,this._tempValue),h[0]*=.5,h[1]*=.5,h[2]*=.5,h[3]=1,Vn.transformByM4x4(this._tempValue,l.transform.worldMatrix,this._tempValue);var m=Math.abs(-this._tempMax.z),p=m>this._maxDistance?m:this._maxDistance;On.scale(this._globalParallelLightDir,p,this._tempPos);var E=this._tempPos.elements;E[0]=h[0]-E[0],E[1]=h[1]-E[1],E[2]=h[2]-E[2],l.transform.position=this._tempPos,l.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),xn.createOrthoOffCenterRH(c[0],u[0],c[1],u[1],1,p+.5*(u[2]-c[2]),l.projectionMatrix),l.projectionViewMatrix.cloneTo(this._lightVPMatrix[this._currentPSSM]),this._lightCulling[this._currentPSSM].matrix=this._lightVPMatrix[this._currentPSSM],e.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,this._lightVPMatrix[this._currentPSSM],this._shaderValueVPs[this._currentPSSM])},t.getLightFrustumCulling=function(e){return this._lightCulling[e]},t.getSplitFrustumCulling=function(){return this._splitFrustumCulling},t.getSplitDistance=function(e){return this._spiltDistance[e]},t.setShadowMapTextureSize=function(e){e!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=e,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)},t.getShadowMapTextureSize=function(){return this._shadowMapTextureSize},t.beginRenderTarget=function(e){this._renderTarget[e].start()},t.endRenderTarget=function(e){this._renderTarget[e].end()},t.getRenderTarget=function(e){return this._renderTarget[e]},t.disposeAllRenderTarget=function(){for(var e=0,t=this._numberOfPSSM+1;t>e;e++)this._renderTarget[e]&&(this._renderTarget[e].destroy(),this._renderTarget[e]=null)},a(0,t,"PSSMNum",function(){return this._numberOfPSSM},function(e){e=e>0?e:1,e=3>=e?e:3,this._numberOfPSSM!=e&&(this._numberOfPSSM=e,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0)}),e.multiplyMatrixOutFloat32Array=function(e,t,n){var i,r,a,o,s,l,u;for(r=e.elements,a=t.elements,i=0;4>i;i++)o=r[i],s=r[i+4],l=r[i+8],u=r[i+12],n[i]=o*a[0]+s*a[1]+l*a[2]+u*a[3],n[i+4]=o*a[4]+s*a[5]+l*a[6]+u*a[7],n[i+8]=o*a[8]+s*a[9]+l*a[10]+u*a[11],n[i+12]=o*a[12]+s*a[13]+l*a[14]+u*a[15]},e.SHADERDEFINE_RECEIVE_SHADOW=1,e.SHADERDEFINE_CAST_SHADOW=512,e.SHADERDEFINE_SHADOW_PSSM1=1024,e.SHADERDEFINE_SHADOW_PSSM2=2048,e.SHADERDEFINE_SHADOW_PSSM3=4096,e.SHADERDEFINE_SHADOW_PCF_NO=8192,e.SHADERDEFINE_SHADOW_PCF1=16384,e.SHADERDEFINE_SHADOW_PCF2=32768,e.SHADERDEFINE_SHADOW_PCF3=65536,e.MAX_PSSM_COUNT=3,e}(),Un=function(){function e(){}r(e,"laya.d3.terrain.TerrainLeaf");var t=e.prototype;return t.calcVertextNorml=function(){},t.calcVertextNormlUV=function(){},t.calcVertextBuffer=function(){},t.calcSkirtVertextBuffer=function(){},t.calcOriginalBoudingBoxAndSphere=function(){},t.calcLeafBoudingBox=function(){},t.calcLeafBoudingSphere=function(){},t.calcLODErrors=function(){},t.determineLod=function(){},e.__init__=function(){},e.getPlaneLODIndex=function(){},e.getSkirtLODIndex=function(){},e.calcPlaneLODIndex=function(){},e.calcSkirtLODIndex=function(){},e.getHeightFromTerrainHeightData=function(){},e.CHUNK_GRID_NUM=64,e.LEAF_GRID_NUM=32,e.__ADAPT_MATRIX__=null,e.__ADAPT_MATRIX_INV__=null,e._planeLODIndex=null,e._skirtLODIndex=null,e._bInit=!1,i(e,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(e.LEAF_GRID_NUM+1)*(e.LEAF_GRID_NUM+1)},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(e.LEAF_GRID_NUM+1)*4},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=e.LEAF_PLANE_VERTEXT_COUNT+e.LEAF_SKIRT_VERTEXT_COUNT},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=e.LEAF_GRID_NUM*e.LEAF_GRID_NUM*6},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*e.LEAF_GRID_NUM*6},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=e.LEAF_PLANE_MAX_INDEX_COUNT+e.LEAF_SKIRT_MAX_INDEX_COUNT},"__VECTOR3__",function(){return this.__VECTOR3__=new On},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(e.LEAF_GRID_NUM)}]),e}(),Hn=(function(){function e(){this.alphaMap=null,this.detailID=null,this.normalMap=null}return r(e,"laya.d3.terrain.unit.ChunkInfo"),e}(),function(){function e(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null}return r(e,"laya.d3.terrain.unit.DetailTextureInfo"),e}(),function(){function e(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null}return r(e,"laya.d3.terrain.unit.MaterialInfo"),e}(),function(){function e(){}return r(e,"laya.d3.utils.Physics"),e.__init__=function(){var t=31;e._layerCollsionMatrix.length=t;for(var n=0;t>n;n++){var i=[],r=t-n;i.length=r;for(var a=0;r>a;a++)i[a]=a===r-1?!0:!1;e._layerCollsionMatrix[n]=i}},e.setLayerCollision=function(t,n,i){e._layerCollsionMatrix[t.number][30-n.number]=i},e.getLayerCollision=function(t,n){return e._layerCollsionMatrix[t.number][30-n.number]},e.setColliderCollision=function(e,t,n){n?(delete e._ignoreCollisonMap[t.id],delete t._ignoreCollisonMap[e.id]):(e._ignoreCollisonMap[t.id]=t,t._ignoreCollisonMap[e.id]=e)},e.getIColliderCollision=function(e,t){return e._ignoreCollisonMap[t.id]?!0:!1},e.rayCast=function(t,n,i,r){void 0===i&&(i=1.79e308),void 0===r&&(r=0),e._outHitAllInfo.length=0;for(var a=z.getLayerByNumber(r)._colliders,o=0,s=a.length;s>o;o++){var l=a[o];if(l.enable&&(l.raycast(t,e._outHitInfo,i),-1!==e._outHitInfo.distance&&e._outHitInfo.distance<=i)){var u=new zn;e._outHitInfo.cloneTo(u),e._outHitAllInfo.push(u)}}if(0==e._outHitAllInfo.length)return n.sprite3D=null,n.distance=-1,void 0;for(var c=Number.MAX_VALUE,h=0,d=0;d<e._outHitAllInfo.length;d++)e._outHitAllInfo[d].distance<c&&(c=e._outHitAllInfo[d].distance,h=d);e._outHitAllInfo[h].cloneTo(n)},e.rayCastAll=function(t,n,i,r){void 0===i&&(i=1.79e308),void 0===r&&(r=0),n.length=0;for(var a=z.getLayerByNumber(r)._colliders,o=0,s=a.length;s>o;o++){var l=a[o];if(l.enable&&(e._outHitInfo.distance=-1,e._outHitInfo.sprite3D=null,l.raycast(t,e._outHitInfo,i),-1!==e._outHitInfo.distance&&e._outHitInfo.distance<=i)){var u=new zn;e._outHitInfo.cloneTo(u),n.push(u)}}},e._outHitAllInfo=[],e._layerCollsionMatrix=[],i(e,["_outHitInfo",function(){return this._outHitInfo=new zn},"collisionManager",function(){return this.collisionManager=new Qn},"gravity",function(){return this.gravity=new On(0,-9.81,0)}]),e}()),Gn=function(){function e(){}return r(e,"laya.d3.utils.Picker"),e.calculateCursorRay=function(t,n,i,r,a,o){var s=t.elements[0],l=t.elements[1],u=e._tempVector30,c=u.elements;c[0]=s,c[1]=l,c[2]=n.minDepth;var h=e._tempVector31,d=h.elements;d[0]=s,d[1]=l,d[2]=n.maxDepth;var _=o.origin,f=e._tempVector32;n.unprojectFromWVP(u,i,r,a,_),n.unprojectFromWVP(h,i,r,a,f);var m=o.direction.elements;m[0]=f.x-_.x,m[1]=f.y-_.y,m[2]=f.z-_.z,On.normalize(o.direction,o.direction)},e.rayIntersectsPositionsAndIndices=function(t,n,i,r,a){for(var o=i.vertexStride/4,s=i.getVertexElementByUsage(0).offset/4,l=Number.MAX_VALUE,u=-1,c=-1,h=-1,d=0;d<r.length;d+=3){var _=e._tempVector35,f=_.elements,m=r[d]*o,p=m+s;f[0]=n[p],f[1]=n[p+1],f[2]=n[p+2];var E=e._tempVector36,v=E.elements,g=r[d+1]*o,T=g+s;v[0]=n[T],v[1]=n[T+1],v[2]=n[T+2];var S=e._tempVector37,D=S.elements,x=r[d+2]*o,M=x+s;D[0]=n[M],D[1]=n[M+1],D[2]=n[M+2];var R=laya.d3.utils.Picker.rayIntersectsTriangle(t,_,E,S);!isNaN(R)&&l>R&&(l=R,u=m,c=g,h=x)}if(l!==Number.MAX_VALUE){a.distance=l,On.scale(t.direction,l,a.position),On.add(t.origin,a.position,a.position);var A=a.trianglePositions,I=A[0],y=A[1],C=A[2],O=I.elements,V=y.elements,L=C.elements,P=u+s;O[0]=n[P],O[1]=n[P+1],O[2]=n[P+2];var w=c+s;V[0]=n[w],V[1]=n[w+1],V[2]=n[w+2];var N=h+s;L[0]=n[N],L[1]=n[N+1],L[2]=n[N+2];var F=i.getVertexElementByUsage(3);if(F){var b=F.offset/4,B=a.triangleNormals,U=B[0],H=B[1],G=B[2],z=U.elements,W=H.elements,k=G.elements,X=u+b;z[0]=n[X],z[1]=n[X+1],z[2]=n[X+2];var Y=c+b;W[0]=n[Y],W[1]=n[Y+1],W[2]=n[Y+2];var Z=h+b;k[0]=n[Z],k[1]=n[Z+1],k[2]=n[Z+2]}return!0}return a.position.toDefault(),a.distance=Number.MAX_VALUE,a.trianglePositions[0].toDefault(),a.trianglePositions[1].toDefault(),a.trianglePositions[2].toDefault(),a.triangleNormals[0].toDefault(),a.triangleNormals[1].toDefault(),a.triangleNormals[2].toDefault(),!1},e.rayIntersectsTriangle=function(t,n,i,r){var a,o=e._tempVector30,s=e._tempVector31;On.subtract(i,n,o),On.subtract(r,n,s);var l=e._tempVector32;On.cross(t.direction,s,l);var u;if(u=On.dot(o,l),u>-Number.MIN_VALUE&&u<Number.MIN_VALUE)return a=Number.NaN;var c=1/u,h=e._tempVector33;On.subtract(t.origin,n,h);var d;if(d=On.dot(h,l),d*=c,0>d||d>1)return a=Number.NaN;var _=e._tempVector34;On.cross(h,o,_);var f;if(f=On.dot(t.direction,_),f*=c,0>f||d+f>1)return a=Number.NaN;var m;return m=On.dot(s,_),m*=c,a=0>m?Number.NaN:m},i(e,["_tempVector30",function(){return this._tempVector30=new On},"_tempVector31",function(){return this._tempVector31=new On},"_tempVector32",function(){return this._tempVector32=new On},"_tempVector33",function(){return this._tempVector33=new On},"_tempVector34",function(){return this._tempVector34=new On},"_tempVector35",function(){return this._tempVector35=new On},"_tempVector36",function(){return this._tempVector36=new On},"_tempVector37",function(){return this._tempVector37=new On}]),e}(),zn=function(){function e(){this.distance=0/0,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.sprite3D=null,this.distance=-1,this.trianglePositions=[new On,new On,new On],this.trianglePositions.length=3,this.triangleNormals=[new On,new On,new On],this.triangleNormals.length=3,this.position=new On}r(e,"laya.d3.utils.RaycastHit");var t=e.prototype;return t.cloneTo=function(e){e.distance=this.distance,this.trianglePositions[0].cloneTo(e.trianglePositions[0]),this.trianglePositions[1].cloneTo(e.trianglePositions[1]),this.trianglePositions[2].cloneTo(e.trianglePositions[2]),this.triangleNormals[0].cloneTo(e.triangleNormals[0]),this.triangleNormals[1].cloneTo(e.triangleNormals[1]),this.triangleNormals[2].cloneTo(e.triangleNormals[2]),this.position.cloneTo(e.position),e.sprite3D=this.sprite3D},e}(),Wn=function(){function e(e,t){this._width=0,this._height=0,this._width=e,this._height=t}r(e,"laya.d3.utils.Size");var t=e.prototype;return a(0,t,"width",function(){return-1===this._width?ht.clientWidth:this._width}),a(0,t,"height",function(){return-1===this._height?ht.clientHeight:this._height}),a(1,e,"fullScreen",function(){return new e(-1,-1)}),e}(),kn=function(){function e(){}return r(e,"laya.d3.utils.Utils3D"),e._rotationTransformScaleSkinAnimation=function(t,n,i,r,a,o,s,l,u,c,h,d){var _=e._tempArray16_0,f=e._tempArray16_1,m=e._tempArray16_2,p=r+r,E=a+a,v=o+o,g=r*p,T=a*p,S=a*E,D=o*p,x=o*E,M=o*v,R=s*p,A=s*E,I=s*v;_[15]=1,_[0]=1-S-M,_[1]=T+I,_[2]=D-A,_[4]=T-I,_[5]=1-g-M,_[6]=x+R,_[8]=D+A,_[9]=x-R,_[10]=1-g-S,f[15]=1,f[0]=l,f[5]=u,f[10]=c;var y,C,O,V,L;for(y=0;4>y;y++)C=_[y],O=_[y+4],V=_[y+8],L=_[y+12],m[y]=C,m[y+4]=O,m[y+8]=V,m[y+12]=C*t+O*n+V*i+L;for(y=0;4>y;y++)C=m[y],O=m[y+4],V=m[y+8],L=m[y+12],h[y+d]=C*f[0]+O*f[1]+V*f[2]+L*f[3],h[y+d+4]=C*f[4]+O*f[5]+V*f[6]+L*f[7],h[y+d+8]=C*f[8]+O*f[9]+V*f[10]+L*f[11],h[y+d+12]=C*f[12]+O*f[13]+V*f[14]+L*f[15]},e._createNodeByJson=function(t,n,i,r){if(!i)switch(n.type){case"Sprite3D":i=new Ai;break;case"MeshSprite3D":i=new sr;break;case"SkinnedMeshSprite3D":i=new ur;break;case"ShuriKenParticle3D":i=new lr;break;case"TrailSprite3D":i=new cr;break;case"Terrain":i=new rr;break;case"Camera":i=new ar;break;case"DirectionLight":i=new or;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var a=n.props;if(a)for(var o in a)i[o]=a[o];var s=n.customProps;s&&(i instanceof laya.d3.core.Sprite3D?(i._parseBaseCustomProps(s),i._parseCustomProps(t,r,s,n),i._parseCustomComponent(t,r,n.components)):i._parseCustomProps(t,r,s,n));var l=n.child;if(l)for(var u=0,c=l.length;c>u;u++){var h=e._createNodeByJson(t,l[u],null,r);i.addChild(h)}return i},e._computeBoneAndAnimationDatasByBindPoseMatrxix=function(e,t,n,i,r,a){var o,s,l=0,u=0,c=e.length;for(o=0;c>o;l+=e[o].keyframeWidth,u+=16,o++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[l+0],t[l+1],t[l+2],t[l+3],t[l+4],t[l+5],t[l+6],t[l+7],t[l+8],t[l+9],i,u),0!=o&&(s=16*e[o].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,s,i,u,i,u));var h=n.length;for(o=0;h>o;o++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,16*a[o],n[o],r,16*o)},e._computeAnimationDatasByArrayAndMatrixFast=function(e,t,n,i){for(var r=0,a=e.length;a>r;r++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,16*i[r],e[r],n,16*r)},e._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(e,t,n,i,r){var a,o,s=0,l=0,u=e.length;for(a=0;u>a;s+=e[a].keyframeWidth,l+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(t[s+7],t[s+8],t[s+9],t[s+3],t[s+4],t[s+5],t[s+6],t[s+0],t[s+1],t[s+2],i,l),0!=a&&(o=16*e[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,o,i,l,i,l));var c=n.length;for(a=0;c>a;a++){var h=16*a;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,h,n[a],r,h)}},e._computeAnimationDatasByArrayAndMatrixFastOld=function(e,t,n){for(var i=e.length,r=0;i>r;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(t,a,e[r],n,a)}},e._computeRootAnimationData=function(e,t,n){for(var i=0,r=0,a=0,o=e.length;o>i;r+=e[i].keyframeWidth,a+=16,i++)laya.d3.utils.Utils3D.createAffineTransformationArray(t[r+0],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7],t[r+8],t[r+9],n,a)},e.transformVector3ArrayByQuat=function(e,t,n,i,r){var a=n.elements,o=e[t],s=e[t+1],l=e[t+2],u=a[0],c=a[1],h=a[2],d=a[3],_=d*o+c*l-h*s,f=d*s+h*o-u*l,m=d*l+u*s-c*o,p=-u*o-c*s-h*l;i[r]=_*d+p*-u+f*-h-m*-c,i[r+1]=f*d+p*-c+m*-u-_*-h,i[r+2]=m*d+p*-h+_*-c-f*-u},e.mulMatrixByArray=function(t,n,i,r,a,o){var s,l,u,c,h;if(a===i){for(i=e._tempArray16_3,s=0;16>s;++s)i[s]=a[o+s];r=0}for(s=0;4>s;s++)l=t[n+s],u=t[n+s+4],c=t[n+s+8],h=t[n+s+12],a[o+s]=l*i[r+0]+u*i[r+1]+c*i[r+2]+h*i[r+3],a[o+s+4]=l*i[r+4]+u*i[r+5]+c*i[r+6]+h*i[r+7],a[o+s+8]=l*i[r+8]+u*i[r+9]+c*i[r+10]+h*i[r+11],a[o+s+12]=l*i[r+12]+u*i[r+13]+c*i[r+14]+h*i[r+15]},e.mulMatrixByArrayFast=function(e,t,n,i,r,a){var o,s,l,u,c;for(o=0;4>o;o++)s=e[t+o],l=e[t+o+4],u=e[t+o+8],c=e[t+o+12],r[a+o]=s*n[i+0]+l*n[i+1]+u*n[i+2]+c*n[i+3],r[a+o+4]=s*n[i+4]+l*n[i+5]+u*n[i+6]+c*n[i+7],r[a+o+8]=s*n[i+8]+l*n[i+9]+u*n[i+10]+c*n[i+11],r[a+o+12]=s*n[i+12]+l*n[i+13]+u*n[i+14]+c*n[i+15]},e.mulMatrixByArrayAndMatrixFast=function(e,t,n,i,r){var a,o,s,l,u,c=n.elements,h=c[0],d=c[1],_=c[2],f=c[3],m=c[4],p=c[5],E=c[6],v=c[7],g=c[8],T=c[9],S=c[10],D=c[11],x=c[12],M=c[13],R=c[14],A=c[15],I=t,y=t+4,C=t+8,O=t+12,V=r,L=r+4,P=r+8,w=r+12;for(a=0;4>a;a++)o=e[I+a],s=e[y+a],l=e[C+a],u=e[O+a],i[V+a]=o*h+s*d+l*_+u*f,i[L+a]=o*m+s*p+l*E+u*v,i[P+a]=o*g+s*T+l*S+u*D,i[w+a]=o*x+s*M+l*R+u*A},e.createAffineTransformationArray=function(e,t,n,i,r,a,o,s,l,u,c,h){var d=i+i,_=r+r,f=a+a,m=i*d,p=i*_,E=i*f,v=r*_,g=r*f,T=a*f,S=o*d,D=o*_,x=o*f;c[h+0]=(1-(v+T))*s,c[h+1]=(p+x)*s,c[h+2]=(E-D)*s,c[h+3]=0,c[h+4]=(p-x)*l,c[h+5]=(1-(m+T))*l,c[h+6]=(g+S)*l,c[h+7]=0,c[h+8]=(E+D)*u,c[h+9]=(g-S)*u,c[h+10]=(1-(m+v))*u,c[h+11]=0,c[h+12]=e,c[h+13]=t,c[h+14]=n,c[h+15]=1},e.transformVector3ArrayToVector3ArrayCoordinate=function(t,n,i,r,a){var o=e._tempArray4_0,s=t[n+0],l=t[n+1],u=t[n+2],c=i.elements;o[0]=s*c[0]+l*c[4]+u*c[8]+c[12],o[1]=s*c[1]+l*c[5]+u*c[9]+c[13],o[2]=s*c[2]+l*c[6]+u*c[10]+c[14],o[3]=1/(s*c[3]+l*c[7]+u*c[11]+c[15]),r[a+0]=o[0]*o[3],r[a+1]=o[1]*o[3],r[a+2]=o[2]*o[3]},e.transformLightingMapTexcoordByUV0Array=function(e,t,n,i,r){var a=n.elements;i[r+0]=e[t+0]*a[0]+a[2],i[r+1]=(e[t+1]-1)*a[1]+a[3]},e.transformLightingMapTexcoordByUV1Array=function(e,t,n,i,r){var a=n.elements;i[r+0]=e[t+0]*a[0]+a[2],i[r+1]=1+e[t+1]*a[1]+a[3]},e.getURLVerion=function(e){var t=e.indexOf("?");return t>=0?e.substr(t):null},e._quaternionCreateFromYawPitchRollArray=function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),l=Math.cos(r),u=Math.sin(a),c=Math.cos(a),h=Math.sin(o),d=Math.cos(o);i[0]=d*u*l+h*c*s,i[1]=h*c*l-d*u*s,i[2]=d*c*s-h*u*l,i[3]=d*c*l+h*u*s},e._createAffineTransformationArray=function(e,t,n,i){var r=t[0],a=t[1],o=t[2],s=t[3],l=r+r,u=a+a,c=o+o,h=r*l,d=r*u,_=r*c,f=a*u,m=a*c,p=o*c,E=s*l,v=s*u,g=s*c,T=n[0],S=n[1],D=n[2];i[0]=(1-(f+p))*T,i[1]=(d+g)*T,i[2]=(_-v)*T,i[3]=0,i[4]=(d-g)*S,i[5]=(1-(h+p))*S,i[6]=(m+E)*S,i[7]=0,i[8]=(_+v)*D,i[9]=(m-E)*D,i[10]=(1-(h+f))*D,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1},e._mulMatrixArray=function(e,t,n,i){var r,a,o,s,l,u=t.elements,c=u[0],h=u[1],d=u[2],_=u[3],f=u[4],m=u[5],p=u[6],E=u[7],v=u[8],g=u[9],T=u[10],S=u[11],D=u[12],x=u[13],M=u[14],R=u[15],A=i,I=i+4,y=i+8,C=i+12;for(r=0;4>r;r++)a=e[r],o=e[r+4],s=e[r+8],l=e[r+12],n[A+r]=a*c+o*h+s*d+l*_,n[I+r]=a*f+o*m+s*p+l*E,n[y+r]=a*v+o*g+s*T+l*S,n[C+r]=a*D+o*x+s*M+l*R},e.getYawPitchRoll=function(t,n){e.transformQuat(On.ForwardRH,t,An.TEMPVector31),e.transformQuat(On.Up,t,An.TEMPVector32);var i=An.TEMPVector32.elements;e.angleTo(On.ZERO,An.TEMPVector31,An.TEMPVector33);var r=An.TEMPVector33.elements;r[0]==Math.PI/2?(r[1]=e.arcTanAngle(i[2],i[0]),r[2]=0):r[0]==-Math.PI/2?(r[1]=e.arcTanAngle(-i[2],-i[0]),r[2]=0):(xn.createRotationY(-r[1],An.TEMPMatrix0),xn.createRotationX(-r[0],An.TEMPMatrix1),On.transformCoordinate(An.TEMPVector32,An.TEMPMatrix0,An.TEMPVector32),On.transformCoordinate(An.TEMPVector32,An.TEMPMatrix1,An.TEMPVector32),r[2]=e.arcTanAngle(i[1],-i[0])),r[1]<=-Math.PI&&(r[1]=Math.PI),r[2]<=-Math.PI&&(r[2]=Math.PI),r[1]>=Math.PI&&r[2]>=Math.PI&&(r[1]=0,r[2]=0,r[0]=Math.PI-r[0]),n[0]=r[1],n[1]=r[0],n[2]=r[2]},e.arcTanAngle=function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):0>e?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0},e.angleTo=function(t,n,i){On.subtract(n,t,An.TEMPVector30),On.normalize(An.TEMPVector30,An.TEMPVector30),i.elements[0]=Math.asin(An.TEMPVector30.y),i.elements[1]=e.arcTanAngle(-An.TEMPVector30.z,-An.TEMPVector30.x)},e.transformQuat=function(e,t,n){var i=n.elements,r=e.elements,a=t,o=r[0],s=r[1],l=r[2],u=a[0],c=a[1],h=a[2],d=a[3],_=d*o+c*l-h*s,f=d*s+h*o-u*l,m=d*l+u*s-c*o,p=-u*o-c*s-h*l;i[0]=_*d+p*-u+f*-h-m*-c,i[1]=f*d+p*-c+m*-u-_*-h,i[2]=m*d+p*-h+_*-c-f*-u},e.quaterionNormalize=function(e,t){var n=e[0],i=e[1],r=e[2],a=e[3],o=n*n+i*i+r*r+a*a;o>0&&(o=1/Math.sqrt(o),t[0]=n*o,t[1]=i*o,t[2]=r*o,t[3]=a*o)},e.matrix4x4MultiplyFFF=function(e,t,n){var i,r,a,o,s;if(n===t)for(t=new Float32Array(16),i=0;16>i;++i)t[i]=n[i];for(i=0;4>i;i++)r=e[i],a=e[i+4],o=e[i+8],s=e[i+12],n[i]=r*t[0]+a*t[1]+o*t[2]+s*t[3],n[i+4]=r*t[4]+a*t[5]+o*t[6]+s*t[7],n[i+8]=r*t[8]+a*t[9]+o*t[10]+s*t[11],n[i+12]=r*t[12]+a*t[13]+o*t[14]+s*t[15]},e.matrix4x4MultiplyMFM=function(t,n,i){e.matrix4x4MultiplyFFF(t.elements,n,i.elements)},i(e,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}},"_tempVector3_0",function(){return this._tempVector3_0=new On},"_tempVector3_1",function(){return this._tempVector3_1=new On},"_tempVector3_2",function(){return this._tempVector3_2=new On},"_tempVector3_3",function(){return this._tempVector3_3=new On},"_tempVector3_4",function(){return this._tempVector3_4=new On},"_tempVector3_5",function(){return this._tempVector3_5=new On},"_tempVector3_6",function(){return this._tempVector3_6=new On},"_tempArray4_0",function(){return this._tempArray4_0=new Float32Array(4)},"_tempArray16_0",function(){return this._tempArray16_0=new Float32Array(16)},"_tempArray16_1",function(){return this._tempArray16_1=new Float32Array(16)},"_tempArray16_2",function(){return this._tempArray16_2=new Float32Array(16)},"_tempArray16_3",function(){return this._tempArray16_3=new Float32Array(16)}]),e}(),Xn=function(){function e(){}return r(e,"Laya3D"),e._cancelLoadByUrl=function(t){n.loader.cancelLoadByUrl(t),e._innerFirstLevelLoaderManager.cancelLoadByUrl(t),e._innerSecondLevelLoaderManager.cancelLoadByUrl(t),e._innerThirdLevelLoaderManager.cancelLoadByUrl(t),e._innerFourthLevelLoaderManager.cancelLoadByUrl(t)},e._changeWebGLSize=function(e,t){P.onStageResize(e,t),ht.clientWidth=e,ht.clientHeight=t},e.__init__=function(){var t=T.createMap;t.lh=[Ai,"SPRITE3DHIERARCHY"],t.ls=[Ri,"SPRITE3DHIERARCHY"],t.lm=[Ki,"MESH"],t.lmat=[Pi,"MATERIAL"],t.lpbr=[Oi,"MATERIAL"],t.ltc=[Ji,"TEXTURECUBE"],t.jpg=[$i,"nativeimage"],t.jpeg=[$i,"nativeimage"],t.png=[$i,"nativeimage"],t.pkm=[$i,"arraybuffer"],t.lsani=[l,"arraybuffer"],t.lrani=[l,"arraybuffer"],t.raw=[Yi,"arraybuffer"],t.mipmaps=[Yi,"arraybuffer"],t.thdata=[_i,"arraybuffer"],t.lt=[fi,"TERRAIN"],t.lani=[li,"arraybuffer"],t.lav=[ui,"json"],t.ani=[l,"arraybuffer"],g.parserMap.SPRITE3DHIERARCHY=e._loadHierarchy,g.parserMap.MESH=e._loadMesh,g.parserMap.MATERIAL=e._loadMaterial,g.parserMap.TEXTURECUBE=e._loadTextureCube,g.parserMap.TERRAIN=e._loadTerrain,e._innerFirstLevelLoaderManager.on("error",null,e._eventLoadManagerError),e._innerSecondLevelLoaderManager.on("error",null,e._eventLoadManagerError),e._innerThirdLevelLoaderManager.on("error",null,e._eventLoadManagerError),e._innerFourthLevelLoaderManager.on("error",null,e._eventLoadManagerError)},e.READ_BLOCK=function(){return e._readData.pos+=4,!0},e.READ_DATA=function(){return e._DATA.offset=e._readData.getUint32(),e._DATA.size=e._readData.getUint32(),!0},e.READ_STRINGS=function(){var t=[],n={offset:0,size:0};n.offset=e._readData.getUint16(),n.size=e._readData.getUint16();e._readData.pos;e._readData.pos=n.offset+e._DATA.offset;for(var i=0;i<n.size;i++){var r=e._readData.readUTFString();(-1!==r.lastIndexOf(".lmat")||-1!==r.lastIndexOf(".lpbr"))&&t.push(r)}return t},e.formatRelativePath=function(e,t){var n,i=t.charAt(0);if("."===i){for(var r=(e+t).split("/"),a=0,o=r.length;o>a;a++)if(".."==r[a]){var s=a-1;s>0&&".."!==r[s]&&(r.splice(s,2),a-=2)}n=r.join("/")}else n=e+t;return null!=V.customFormat&&(n=V.customFormat(n,null)),n},e._eventLoadManagerError=function(e){n.loader.event("error",e)},e._addHierarchyInnerUrls=function(t,n,i,r,a,o){var s=e.formatRelativePath(r,a);i&&(s+=i),t.push({url:s,clas:o}),n[a]=s},e._getSprite3DHierarchyInnerUrls=function(t,n,i,r,a,o,s){var l,u=0,c=0;switch(t.type){case"Scene":var h=t.customProps.lightmaps;for(u=0,c=h.length;c>u;u++){var _=h[u].replace(".exr",".png");e._addHierarchyInnerUrls(r,a,o,s,_,$i)}break;case"MeshSprite3D":case"TrailSprite3D":case"LineSprite3D":case"SkinnedMeshSprite3D":var f;if(t.instanceParams)f=t.instanceParams.loadPath,f&&e._addHierarchyInnerUrls(n,a,o,s,f,Ki);else{l=t.customProps,f=l.meshPath,f&&e._addHierarchyInnerUrls(n,a,o,s,f,Ki);var m=l.materials;if(m)for(u=0,c=m.length;c>u;u++){var p=m[u],E=p.type.split("."),v=d.window;if(E.forEach(function(e){v=v[e]}),"function"!=typeof v)throw"_getSprite3DHierarchyInnerUrls 错误: "+p.type+" 不是类";e._addHierarchyInnerUrls(i,a,o,s,p.path,v)}}break;case"ShuriKenParticle3D":l=t.customProps;var g=l.meshPath;g&&e._addHierarchyInnerUrls(n,a,o,s,g,Ki);var T=l.material;if(T)E=T.type.split("."),v=d.window,E.forEach(function(e){v=v[e]}),e._addHierarchyInnerUrls(i,a,o,s,T.path,v);else{var S=l.materialPath;if(S)e._addHierarchyInnerUrls(i,a,o,s,S,bi);else{var D=l.texturePath;D&&e._addHierarchyInnerUrls(r,a,o,s,D,$i)}}break;case"Terrain":e._addHierarchyInnerUrls(r,a,o,s,t.customProps.dataPath,fi)}var x=t.components;for(var M in x){var R=x[M];switch(M){case"Animator":var A=R.avatarPath;if(A)e._addHierarchyInnerUrls(r,a,o,s,A,ui);else{var I=R.avatar;I&&e._addHierarchyInnerUrls(r,a,o,s,I.path,ui)}var y=R.clipPaths;for(u=0,c=y.length;c>u;u++)e._addHierarchyInnerUrls(r,a,o,s,y[u],li)}}var C=t.child;for(u=0,c=C.length;c>u;u++)e._getSprite3DHierarchyInnerUrls(C[u],n,i,r,a,o,s)},e._loadHierarchy=function(t){t.on("loaded",null,e._onHierarchylhLoaded,[t,t._class._getGroup()]),t.load(t.url,"json",!1,null,!0)},e._onHierarchylhLoaded=function(t,n,i){if(t._class.destroyed)t.endLoad();else{var r=t.url,a=kn.getURLVerion(r),o=V.getPath(r),s=[],l=[],u=[],c={};e._getSprite3DHierarchyInnerUrls(i,s,l,u,c,a,o);var h=s.length+l.length+u.length,d=h+1,_=1/d;if(e._onProcessChange(t,0,_,1),u.length>0){var f=h/d,m=v.create(null,e._onProcessChange,[t,_,f],!1);e._innerFourthLevelLoaderManager.create(u,v.create(null,e._onHierarchyInnerForthLevResouLoaded,[t,n,m,i,c,s,l,_+f*u.length,f]),m,null,null,1,!0,n)}else e._onHierarchyInnerForthLevResouLoaded(t,n,null,i,c,s,l,_,f)}},e._onHierarchyInnerForthLevResouLoaded=function(t,n,i,r,a,o,s,l,u){if(t._class.destroyed)t.endLoad();else if(i&&i.recover(),s.length>0){var c=v.create(null,e._onProcessChange,[t,l,u],!1);e._innerSecondLevelLoaderManager.create(s,v.create(null,e._onHierarchyInnerSecondLevResouLoaded,[t,n,c,r,a,o,l+u*s.length,u]),i,null,null,1,!0,n)}else e._onHierarchyInnerSecondLevResouLoaded(t,n,null,r,a,o,l,u)},e._onHierarchyInnerSecondLevResouLoaded=function(t,n,i,r,a,o,s,l){if(t._class.destroyed)t.endLoad();else if(i&&i.recover(),o.length>0){var u=v.create(null,e._onProcessChange,[t,s,l],!1);e._innerFirstLevelLoaderManager.create(o,v.create(null,e._onHierarchyInnerFirstLevResouLoaded,[t,u,r,a]),i,null,null,1,!0,n)}else e._onHierarchyInnerFirstLevResouLoaded(t,null,r,a)},e._onHierarchyInnerFirstLevResouLoaded=function(e,t,n,i){t&&t.recover(),e.endLoad([n,i])},e._loadTerrain=function(t){t.on("loaded",null,e._onTerrainLtLoaded,[t,t._class._getGroup()]),t.load(t.url,"json",!1,null,!0)},e._onTerrainLtLoaded=function(){},e._onTerrainHeightMapLoaded=function(){},e._onTerrainTexturesLoaded=function(){},e._loadMesh=function(t){t.on("loaded",null,e._onMeshLmLoaded,[t,t._class._getGroup()]),t.load(t.url,"arraybuffer",!1,null,!0)},e._onMeshLmLoaded=function(t,n,i){if(t._class.destroyed)t.endLoad();else{var r,a,o=t.url,s=kn.getURLVerion(o),l=V.getPath(o),u={},c=0,h=0,d=0;e._readData=new f(i),e._readData.pos=0;var _=e._readData.readUTFString();switch(_){case"LAYAMODEL:02":case"LAYAMODEL:03":case"LAYAMODEL:0301":var m=e._readData.getUint32();e._readData.pos=e._readData.pos+4,d=e._readData.getUint16(),e._readData.pos=e._readData.pos+8*d;var p=e._readData.getUint32();for(d=e._readData.getUint16(),e._readData.pos=m+p,r=[],c=0;d>c;c++){var E=e._readData.readUTFString();-1!==E.lastIndexOf(".lmat")&&r.push(E)}break;default:for(e.READ_BLOCK(),c=0;2>c;c++){var g=e._readData.getUint16(),T=e._strings[g],S=e["READ_"+T];
if(null==S)throw new Error("model file err,no this function:"+g+" "+T);1===c?r=S.call():S.call()}}for(c=0,h=r.length;h>c;c++){var D=r[c];a=e.formatRelativePath(l,D),s&&(a+=s),r[c]=a,u[D]=a}if(r.length>0){var x=1,M=x+1,R=1/M;e._onProcessChange(t,0,R,1);var A=v.create(null,e._onProcessChange,[t,R,x/M],!1);e._innerSecondLevelLoaderManager.create(r,v.create(null,e._onMeshMateialLoaded,[t,A,i,u]),A,null,null,1,!0,n)}else t.endLoad([i,u])}},e._onMeshMateialLoaded=function(e,t,n,i){e.endLoad([n,i]),t.recover()},e._getMaterialTexturePath=function(t,n,i){var r=t.length-4;return(t.indexOf(".dds")==r||t.indexOf(".tga")==r||t.indexOf(".exr")==r||t.indexOf(".DDS")==r||t.indexOf(".TGA")==r||t.indexOf(".EXR")==r)&&(t=t.substr(0,r)+".png"),t=e.formatRelativePath(i,t),n&&(t+=n),t},e._loadMaterial=function(t){t.on("loaded",null,e._onMaterilLmatLoaded,[t,t._class._getGroup()]),t.load(t.url,"json",!1,null,!0)},e._onMaterilLmatLoaded=function(t,n,i){if(t._class.destroyed)t.endLoad();else{var r,a=t.url,o=kn.getURLVerion(a),s=V.getPath(a),l=[],u={},c=i.customProps,h=i.version;if(h)switch(h){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(var d=i.props.textures,_=0,f=d.length;f>_;_++){var m=d[_],p=m.path;if(p){var E=p.length-4;(p.indexOf(".exr")==E||p.indexOf(".EXR")==E)&&(p=p.substr(0,E)+".png"),r=e.formatRelativePath(s,p),o&&(r+=o),l.push({url:r,params:m.params}),u[p]=r}}break;default:throw new Error("Laya3D:unkonwn version.")}else{var g=c.diffuseTexture.texture2D;if(g&&(r=e._getMaterialTexturePath(g,o,s),l.push(r),u[g]=r),c.normalTexture){var T=c.normalTexture.texture2D;T&&(r=e._getMaterialTexturePath(T,o,s),l.push(r),u[T]=r)}if(c.specularTexture){var S=c.specularTexture.texture2D;S&&(r=e._getMaterialTexturePath(S,o,s),l.push(r),u[S]=r)}if(c.emissiveTexture){var D=c.emissiveTexture.texture2D;D&&(r=e._getMaterialTexturePath(D,o,s),l.push(r),u[D]=r)}if(c.ambientTexture){var x=c.ambientTexture.texture2D;x&&(r=e._getMaterialTexturePath(x,o,s),l.push(r),u[x]=r)}if(c.reflectTexture){var M=c.reflectTexture.texture2D;M&&(r=e._getMaterialTexturePath(M,o,s),l.push(r),u[M]=r)}}var R=l.length,A=R+1,I=1/A;if(e._onProcessChange(t,0,I,1),R>0){var y=v.create(null,e._onProcessChange,[t,I,R/A],!1);e._innerFourthLevelLoaderManager.create(l,v.create(null,e._onMateialTexturesLoaded,[t,y,i,u]),y,$i,null,1,!0,n)}else e._onMateialTexturesLoaded(t,null,i,null)}},e._onMateialTexturesLoaded=function(e,t,n,i){e.endLoad([n,i]),t&&t.recover()},e._loadTextureCube=function(t){t.on("loaded",null,e._onTextureCubeLtcLoaded,[t]),t.load(t.url,"json",!1,null,!0)},e._onTextureCubeLtcLoaded=function(t,n){if(t._class.destroyed)t.endLoad();else{var i=V.getPath(t.url),r=[e.formatRelativePath(i,n.px),e.formatRelativePath(i,n.nx),e.formatRelativePath(i,n.py),e.formatRelativePath(i,n.ny),e.formatRelativePath(i,n.pz),e.formatRelativePath(i,n.nz)],a=1/7;e._onProcessChange(t,0,a,1);var o=v.create(null,e._onProcessChange,[t,a,6/7],!1);e._innerFourthLevelLoaderManager.load(r,v.create(null,e._onTextureCubeImagesLoaded,[t,r,o]),o,"nativeimage")}},e._onTextureCubeImagesLoaded=function(e,t,n){var i=[];i.length=6;for(var r=0;6>r;r++){var a=t[r];i[r]=g.getRes(a),g.clearRes(a)}e.endLoad(i),n.recover()},e._onProcessChange=function(e,t,n,i){i=t+i*n,1>i&&e.event("progress",i)},e.init=function(t,i,r,a,o,s){if(void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===o&&(o=!0),void 0===s&&(s=!0),!e._isinit){if(e._isinit=!0,A.update3DLoop=function(){Qn._triggerCollision()},A.cancelLoadByUrl=function(t){e._cancelLoadByUrl(t)},p.isAntialias=r,p.isAlpha=a,p.premultipliedAlpha=o,p.isStencil=s,!P.enable())return alert("Laya3D init error,must support webGL!"),void 0;A.changeWebGLSize=e._changeWebGLSize,x.is3DMode=!0,n.init(t,i),z.__init__(),Hn.__init__(),yi.__init__(),Fn.__init__(),sr.__init__(),B.__init__(),e.__init__(),c.maxTextureCount=2,(e.debugMode||dt.debugMode)&&(e._debugPhasorSprite=new lt)}},e.HIERARCHY="SPRITE3DHIERARCHY",e.MESH="MESH",e.MATERIAL="MATERIAL",e.PBRMATERIAL="PBRMTL",e.TEXTURECUBE="TEXTURECUBE",e.TERRAIN="TERRAIN",e._readData=null,e._debugPhasorSprite=null,e.debugMode=!1,e._isinit=!1,i(e,["_DATA",function(){return this._DATA={offset:0,size:0}},"_strings",function(){return this._strings=["BLOCK","DATA","STRINGS"]},"_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new T},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new T},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new T},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new T}]),e}(),Yn=function(e){function t(e){t.__super.call(this),this._owner=e,this._childs=[],this._localMatrix=new Float32Array(16),this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0}r(t,"laya.d3.animation.AnimationTransform3D",e);var n=t.prototype;return n._getlocalMatrix=function(){return this._localUpdate&&(kn._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix},n._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0;for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._onWorldTransform()}},n._setWorldMatrixAndUpdate=function(e){if(this._worldMatrix=e,null==this._parent)throw new Error("don't need to set worldMatrix to root Node.");if(null==this._parent._parent)for(var t=this._getlocalMatrix(),n=0;16>n;++n)this._worldMatrix[n]=t[n];else kn.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);this._worldUpdate=!1},n._setWorldMatrixNoUpdate=function(e){this._worldMatrix=e},n._setWorldMatrixIgnoreUpdate=function(e){this._worldMatrix=e,this._worldUpdate=!1},n.getLocalPosition=function(){return this._localPosition},n.setLocalPosition=function(e){if(this._parent)this._localPosition=e,this._localUpdate=!0,this._onWorldTransform();else{var t=this._entity.owner._transform,n=this._entity.localPosition,i=n.elements;i[0]=e[0],i[1]=e[1],i[2]=e[2],t.localPosition=n}},n.getLocalRotation=function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler;kn._quaternionCreateFromYawPitchRollArray(e[1]/t._angleToRandin,e[0]/t._angleToRandin,e[2]/t._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},n.setLocalRotation=function(e){if(this._parent)this._localRotation=e,kn.quaterionNormalize(this._localRotation,this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform();else{var t=this._entity.owner._transform,n=this._entity.localRotation,i=n.elements;i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],t.localRotation=n}},n.getLocalScale=function(){return this._localScale},n.setLocalScale=function(e){if(this._parent)this._localScale=e,this._localUpdate=!0,this._onWorldTransform();else{var t=this._entity.owner._transform,n=this._entity.localScale,i=n.elements;i[0]=e[0],i[1]=e[1],i[2]=e[2],t.localScale=n}},n.getLocalRotationEuler=function(){if(this._locaEulerlUpdate){kn.getYawPitchRoll(this._localRotation,t._tempVector3);var e=t._tempVector3,n=this._localRotationEuler;n[0]=e[1]*t._angleToRandin,n[1]=e[0]*t._angleToRandin,n[2]=e[2]*t._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler},n.setLocalRotationEuler=function(e){if(this._parent)kn._quaternionCreateFromYawPitchRollArray(e[1]/t._angleToRandin,e[0]/t._angleToRandin,e[2]/t._angleToRandin,this._localRotation),this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform();else{var n=this._entity.owner._transform,i=this._entity.localRotationEuler,r=i.elements;r[0]=e[0],r[1]=e[1],r[2]=e[2],n.localRotationEuler=i}},n.getWorldMatrix=function(){if(this._worldUpdate){if(null!=this._parent._parent)kn.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else for(var e=this._getlocalMatrix(),t=0;16>t;++t)this._worldMatrix[t]=e[t];this._worldUpdate=!1}return this._worldMatrix},n.setParent=function(e){if(this._parent!==e){if(this._parent){var t=this._parent._childs,n=t.indexOf(this);t.splice(n,1)}e&&(e._childs.push(this),e&&this._onWorldTransform()),this._parent=e}},i(t,["_tempVector3",function(){return this._tempVector3=new Float32Array(3)},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]),t}(E),Zn=function(e){function t(){this._destroyed=!1,this._id=0,this._enable=!1,this._owner=null,this.started=!1,t.__super.call(this),this._destroyed=!1,this._id=t._uniqueIDCounter,t._uniqueIDCounter++}r(t,"laya.d3.component.Component3D",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IUpdate":!0,"laya.resource.IDestroy":!0}),i._initialize=function(e){this._owner=e,this._enable=!0,this.started=!1,this._load(e)},i._destroy=function(){this._unload(this._owner),this._owner=null,this._destroyed=!0},i._load=function(){},i._start=function(){},i._update=function(){},i._lateUpdate=function(){},i._preRenderUpdate=function(){},i._postRenderUpdate=function(){},i._unload=function(){this.offAll()},i._cloneTo=function(){},a(0,i,"id",function(){return this._id}),a(0,i,"destroyed",function(){return this._destroyed}),a(0,i,"owner",function(){return this._owner}),a(0,i,"enable",function(){return this._enable},function(e){this._enable!==e&&(this._enable=e,this.event("enablechanged",this._enable))}),a(0,i,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!0,t._uniqueIDCounter=1,t}(E),Kn=function(e){function t(){this._destroyed=!1,t.__super.call(this),this._destroyed=!1}r(t,"laya.d3.core.GeometryFilter",e);var i=t.prototype;return n.imps(i,{"laya.resource.IDestroy":!0}),i._destroy=function(){this.offAll(),this._destroyed=!0},a(0,i,"_isAsyncLoaded",function(){return!0}),a(0,i,"_originalBoundingBoxCorners",function(){throw new Error("BaseRender: must override it.")}),a(0,i,"_originalBoundingSphere",function(){throw new Error("BaseRender: must override it.")}),a(0,i,"_originalBoundingBox",function(){throw new Error("BaseRender: must override it.")}),a(0,i,"destroyed",function(){return this._destroyed}),t}(E),jn=function(e){function t(e){t.__super.call(this),this._id=++t._uniqueIDCounter,this._indexInSceneFrustumCullingObjects=-1,this._boundingBox=new En(new On,new On),this._boundingBoxCenter=new On,this._boundingSphere=new gn(new On,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._materials=[],this._renderElements=[],this._isPartOfStaticBatch=!1,this._destroyed=!1,this._owner=e,this._enable=!0,this._materialsInstance=[],this.lightmapIndex=-1,this.castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange)}r(t,"laya.d3.core.render.BaseRender",e);var o=t.prototype;return n.imps(o,{"laya.resource.IDestroy":!0}),o._changeMaterialReference=function(e,t){e&&e._removeReference(),t._addReference()},o._getInstanceMaterial=function(e,t){var n=new e.constructor;return e.cloneTo(n),n.name=n.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._materials[t],n),this._materials[t]=n,n},o._setShaderValuelightMap=function(e){this._setShaderValueTexture(3,e)},o._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},o._renderRenderableBoundBox=function(){var e=Xn._debugPhasorSprite,n=this.boundingBox,i=t._tempBoundBoxCorners;n.getCorners(i),e.line(i[0],t._greenColor,i[1],t._greenColor),e.line(i[2],t._greenColor,i[3],t._greenColor),e.line(i[4],t._greenColor,i[5],t._greenColor),e.line(i[6],t._greenColor,i[7],t._greenColor),e.line(i[0],t._greenColor,i[3],t._greenColor),e.line(i[1],t._greenColor,i[2],t._greenColor),e.line(i[2],t._greenColor,i[6],t._greenColor),e.line(i[3],t._greenColor,i[7],t._greenColor),e.line(i[0],t._greenColor,i[4],t._greenColor),e.line(i[1],t._greenColor,i[5],t._greenColor),e.line(i[4],t._greenColor,i[7],t._greenColor),e.line(i[5],t._greenColor,i[6],t._greenColor)},o._calculateBoundingSphere=function(){throw"BaseRender: must override it."},o._calculateBoundingBox=function(){throw"BaseRender: must override it."},o._setShaderValueTexture=function(e,t){this._owner._shaderValues.setValue(e,t)},o._setShaderValueMatrix4x4=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},o._setShaderValueColor=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},o._setShaderValueBuffer=function(e,t){this._owner._shaderValues.setValue(e,t)},o._setShaderValueInt=function(e,t){this._owner._shaderValues.setValue(e,t)},o._setShaderValueBool=function(e,t){this._owner._shaderValues.setValue(e,t)},o._setShaderValueNumber=function(e,t){this._owner._shaderValues.setValue(e,t)},o._setShaderValueVector2=function(e,t){this._owner._shaderValues.setValue(e,t?t.elements:null)},o._addShaderDefine=function(e){this._owner._shaderDefineValue|=e},o._removeShaderDefine=function(e){this._owner._shaderDefineValue&=~e},o._renderUpdate=function(){return!0},o._applyLightMapParams=function(){if(this._lightmapIndex>=0){var e=this._owner.scene;if(e){var t=e.getlightmaps(),n=t[this._lightmapIndex];n?(this._addShaderDefine(nr.SAHDERDEFINE_LIGHTMAP),n.loaded?this._setShaderValuelightMap(n):n.once("loaded",this,this._setShaderValuelightMap)):this._removeShaderDefine(nr.SAHDERDEFINE_LIGHTMAP)}else this._removeShaderDefine(nr.SAHDERDEFINE_LIGHTMAP)}else this._removeShaderDefine(nr.SAHDERDEFINE_LIGHTMAP)},o._updateOctreeNode=function(){var e=this._treeNode;e&&this._octreeNodeNeedChange&&(e.updateObject(this),this._octreeNodeNeedChange=!1)},o._destroy=function(){this.offAll();var e=0,t=0;for(e=0,t=this._renderElements.length;t>e;e++)this._renderElements[e]._destroy();for(e=0,t=this._materials.length;t>e;e++)this._materials[e]._removeReference();this._renderElements=null,this._owner=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._lightmapScaleOffset=null,this._destroyed=!0},a(0,o,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),a(0,o,"id",function(){return this._id}),a(0,o,"material",function(){var e=this._materials[0];if(e&&!this._materialsInstance[0]){var t=this._getInstanceMaterial(e,0);this.event("materialchanged",[this,0,t])}return this._materials[0]},function(e){this.sharedMaterial=e}),a(0,o,"sharedMaterial",function(){return this._materials[0]},function(e){var t=this._materials[0];t!==e&&(this._materials[0]=e,this._materialsInstance[0]=!1,this._changeMaterialReference(t,e),this.event("materialchanged",[this,0,e]))}),a(0,o,"lightmapIndex",function(){return this._lightmapIndex},function(e){this._lightmapIndex=e,this._applyLightMapParams()}),a(0,o,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(e){this._lightmapScaleOffset=e,this._setShaderValueColor(2,e),this._addShaderDefine(nr.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV)}),a(0,o,"enable",function(){return this._enable},function(e){this._enable=e,this.event("enablechanged",[this,e])}),a(0,o,"materials",function(){for(var e=0,t=this._materials.length;t>e;e++)if(!this._materialsInstance[e]){var n=this._getInstanceMaterial(this._materials[e],e);this.event("materialchanged",[this,e,n])}return this._materials.slice()},function(e){this.sharedMaterials=e}),a(0,o,"sharedMaterials",function(){var e=this._materials.slice();return e},function(e){if(!e)throw new Error("MeshRender: shadredMaterials value can't be null.");var t=e.length;this._materialsInstance.length=t;for(var n=0;t>n;n++){var i=this._materials[n];i!==e[n]&&(this._materialsInstance[n]=!1,this._changeMaterialReference(i,e[n]),this.event("materialchanged",[this,n,e[n]]))}this._materials=e}),a(0,o,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),a(0,o,"boundingBoxCenter",function(){if(this._boundingBoxCenterNeedChange){var e=this.boundingBox;On.add(e.min,e.max,this._boundingBoxCenter),On.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1}return this._boundingBoxCenter}),a(0,o,"receiveShadow",function(){return this._receiveShadow},function(e){this._receiveShadow!==e&&(this._receiveShadow=e,e?this._addShaderDefine(Bn.SHADERDEFINE_RECEIVE_SHADOW):this._removeShaderDefine(Bn.SHADERDEFINE_RECEIVE_SHADOW))}),a(0,o,"destroyed",function(){return this._destroyed}),t._uniqueIDCounter=0,i(t,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new On,new On,new On,new On,new On,new On,new On,new On]},"_greenColor",function(){return this._greenColor=new Vn(0,1,0,1)}]),t}(E),qn=function(e){function t(e){this._owner=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._dummy=null,this.pivot=null,t.__super.call(this),this._localPosition=new On,this._localRotation=new An(0,0,0,1),this._localScale=new On(1,1,1),this._localRotationEuler=new On,this._localMatrix=new xn,this._position=new On,this._rotation=new An(0,0,0,1),this._scale=new On(1,1,1),this._worldMatrix=new xn,this._forward=new On,this._up=new On,this._right=new On,this._owner=e,this._childs=[]}r(t,"laya.d3.core.Transform3D",e);var n=t.prototype;return n._updateLocalMatrix=function(){if(!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z)xn.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix);else{var e=t._tempVector30;On.multiply(this.pivot,this._localScale,e);var n=t._tempVector31;On.subtract(e,this.pivot,n);var i=t._tempVector32,r=this.localRotation;On.transformQuat(e,r,i),On.subtract(i,e,i);var a=t._tempVector33;On.subtract(this._localPosition,n,a),On.subtract(a,i,a),xn.createAffineTransformation(a,r,this._localScale,this._localMatrix)}},n._onWorldPositionRotationTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._rotationUpdate){this._worldUpdate=this._positionUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._onWorldPositionRotationTransform()}},n._onWorldPositionScaleTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._scaleUpdate){this._worldUpdate=this._positionUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._onWorldPositionScaleTransform()}},n._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._onWorldPositionTransform()}},n._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._onWorldPositionRotationTransform()}},n._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._onWorldPositionScaleTransform()}},n._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._onWorldTransform()}},n.translate=function(e,n){void 0===n&&(n=!0),n?(xn.createFromQuaternion(this.localRotation,t._tempMatrix0),On.transformCoordinate(e,t._tempMatrix0,t._tempVector30),On.add(this.localPosition,t._tempVector30,this._localPosition),this.localPosition=this._localPosition):(On.add(this.position,e,this._position),this.position=this._position)},n.rotate=function(e,n,i){void 0===n&&(n=!0),void 0===i&&(i=!0);var r;i?r=e:(On.scale(e,Math.PI/180,t._tempVector30),r=t._tempVector30),An.createFromYawPitchRoll(r.y,r.x,r.z,t._tempQuaternion0),n?(An.multiply(this._localRotation,t._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(An.multiply(t._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},n.lookAt=function(e,t,n){void 0===n&&(n=!1);var i,r=e.elements;if(n){if(i=this._localPosition.elements,Math.abs(i[0]-r[0])<Sn.zeroTolerance&&Math.abs(i[1]-r[1])<Sn.zeroTolerance&&Math.abs(i[2]-r[2])<Sn.zeroTolerance)return;An.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(i=a.elements,Math.abs(i[0]-r[0])<Sn.zeroTolerance&&Math.abs(i[1]-r[1])<Sn.zeroTolerance&&Math.abs(i[2]-r[2])<Sn.zeroTolerance)return;An.lookAt(a,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}},a(0,n,"_isFrontFaceInvert",function(){var e=this.scale,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}),a(0,n,"owner",function(){return this._owner}),a(0,n,"localRotation",function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler.elements;An.createFromYawPitchRoll(e[1]/t._angleToRandin,e[0]/t._angleToRandin,e[2]/t._angleToRandin,this._localRotation)}return this._localRotation},function(e){this._localRotation=e,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),a(0,n,"worldMatrix",function(){return this._worldUpdate&&(null!=this._parent?xn.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix},function(e){null===this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),xn.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix=e,this._worldUpdate=!1}),a(0,n,"worldNeedUpdate",function(){return this._worldUpdate}),a(0,n,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(e){this._localMatrix=e,this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._localUpdate=!1,this._onWorldTransform()}),a(0,n,"dummy",function(){return this._dummy},function(e){this._dummy!==e&&(this._dummy&&(this._dummy._entity=null),e&&(e._entity=this),this._dummy=e)}),a(0,n,"localPosition",function(){return this._localPosition},function(e){this._localPosition=e,this._localUpdate=!0,this._onWorldPositionTransform()}),a(0,n,"position",function(){if(this._positionUpdate){if(null!=this._parent){var e=this._parent.position;On.multiply(this._localPosition,this._parent.scale,t._tempVector30),On.transformQuat(t._tempVector30,this._parent.rotation,t._tempVector30),On.add(e,t._tempVector30,this._position)}else this._localPosition.cloneTo(this._position);this._positionUpdate=!1}return this._position},function(e){if(null!=this._parent){On.subtract(e,this._parent.position,this._localPosition);var n=this._parent.scale.elements,i=n[0],r=n[1],a=n[2];if(1!==i||1!==r||1!==a){var o=t._tempVector30,s=o.elements;s[0]=1/i,s[1]=1/r,s[2]=1/a,On.multiply(this._localPosition,o,this._localPosition)}var l=this._parent.rotation;l.invert(t._tempQuaternion0),On.transformQuat(this._localPosition,t._tempQuaternion0,this._localPosition)}else e.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position=e,this._positionUpdate=!1}),a(0,n,"localScale",function(){return this._localScale},function(e){this._localScale=e,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldScaleTransform():this._onWorldPositionScaleTransform()}),a(0,n,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(t._tempVector30);var e=t._tempVector30.elements,n=this._localRotationEuler.elements;n[0]=e[1]*t._angleToRandin,n[1]=e[0]*t._angleToRandin,n[2]=e[2]*t._angleToRandin}return this._localRotationEuler},function(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),a(0,n,"rotation",function(){return this._rotationUpdate&&(null!=this._parent?An.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._rotationUpdate=!1),this._rotation},function(e){null!=this._parent?(this._parent.rotation.invert(t._tempQuaternion0),An.multiply(e,t._tempQuaternion0,this._localRotation)):e.cloneTo(this._localRotation),this.localRotation=this._localRotation,this._rotation=e,this._rotationUpdate=!1}),a(0,n,"scale",function(){return this._scaleUpdate?(null!==this._parent?On.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1,this._scale):this._scale},function(e){if(null!==this._parent){var n=this._parent.scale.elements,i=t._tempVector30.elements;i[0]=1/n[0],i[1]=1/n[1],i[2]=1/n[2],On.multiply(e,t._tempVector30,this._localScale)}else e.cloneTo(this._localScale);this.localScale=this._localScale,this._scale=e,this._scaleUpdate=!1}),a(0,n,"rotationEuler",null,function(e){An.createFromYawPitchRoll(e.y,e.x,e.z,this._rotation),this.rotation=this._rotation}),a(0,n,"forward",function(){var e=this.worldMatrix.elements;return this._forward.elements[0]=-e[8],this._forward.elements[1]=-e[9],this._forward.elements[2]=-e[10],this._forward}),a(0,n,"up",function(){var e=this.worldMatrix.elements;return this._up.elements[0]=e[4],this._up.elements[1]=e[5],this._up.elements[2]=e[6],this._up}),a(0,n,"right",function(){var e=this.worldMatrix.elements;return this._right.elements[0]=e[0],this._right.elements[1]=e[1],this._right.elements[2]=e[2],this._right}),a(0,n,"parent",function(){return this._parent},function(e){if(this._parent!==e){if(this._parent){var t=this._parent._childs,n=t.indexOf(this);t.splice(n,1)}e&&(e._childs.push(this),e&&this._onWorldTransform()),this._parent=e}}),i(t,["_tempVector30",function(){return this._tempVector30=new On},"_tempVector31",function(){return this._tempVector31=new On},"_tempVector32",function(){return this._tempVector32=new On},"_tempVector33",function(){return this._tempVector33=new On},"_tempQuaternion0",function(){return this._tempQuaternion0=new An},"_tempMatrix0",function(){return this._tempMatrix0=new xn},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]),t}(E),Qn=(function(e){function t(){this._rotation=0,this._matNeedUpdte=!1,t.__super.call(this),this._matrix=new xn,this._offset=new Cn,this._tiling=new Cn(1,1)}r(t,"laya.d3.core.TransformUV",e);var o=t.prototype;return n.imps(o,{"laya.d3.core.IClone":!0}),o._updateMatrix=function(){t._tempOffsetV3.elements[0]=this._offset.x,t._tempOffsetV3.elements[1]=this._offset.y,An.createFromYawPitchRoll(0,0,this._rotation,t._tempRotationQua),t._tempTitlingV3.elements[0]=this._tiling.x,t._tempTitlingV3.elements[1]=this._tiling.y,xn.createAffineTransformation(t._tempOffsetV3,t._tempRotationQua,t._tempTitlingV3,this._matrix)},o.cloneTo=function(e){e._matrix=this._matrix.clone(),e._offset=this._offset.clone(),e._rotation=this._rotation,e._tiling=this._tiling.clone()},o.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,o,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),a(0,o,"tiling",function(){return this._tiling},function(e){this._tiling=e,this._matNeedUpdte=!0}),a(0,o,"offset",function(){return this._offset},function(e){this._offset=e,this._matNeedUpdte=!0}),a(0,o,"rotation",function(){return this._rotation},function(e){this._rotation=e,this._matNeedUpdte=!0}),i(t,["_tempOffsetV3",function(){return this._tempOffsetV3=new On(0,0,0)},"_tempRotationQua",function(){return this._tempRotationQua=new An},"_tempTitlingV3",function(){return this._tempTitlingV3=new On(1,1,1)}]),t}(E),function(e){function t(){t.__super.call(this)}return r(t,"laya.d3.utils.CollisionManager",e),t._onTrigger=function(e,t,n,i,r){var a=0,o=0,s=e.id,l=t.id;if(!e._ignoreCollisonMap[l]){var u=Hn.collisionManager,c=e._runtimeCollisonTestMap[l];if(null!=c)if(c)if(e._collisonTo(t))if(e._runtimeCollisonMap[l]){for(a=0,o=n.length;o>a;a++)n[a].onTriggerStay(t);for(a=0,o=i.length;o>a;a++)i[a].onTriggerStay(e);u.event("triggerstay",[e,t])}else{for(e._runtimeCollisonMap[l]=t,e._runtimeCollisonTestMap[l]=!1,t._runtimeCollisonMap[s]=e,r&&(t._runtimeCollisonTestMap[s]=!1),a=0,o=n.length;o>a;a++)n[a].onTriggerEnter(t);for(a=0,o=i.length;o>a;a++)i[a].onTriggerEnter(e);u.event("triggerenter",[e,t])}else{var h=e._runtimeCollisonMap;if(h[l]){for(delete h[l],delete e._runtimeCollisonTestMap[l],delete t._runtimeCollisonMap[s],r&&delete t._runtimeCollisonTestMap[s],a=0,o=n.length;o>a;a++)n[a].onTriggerExit(t);for(a=0,o=i.length;o>a;a++)i[a].onTriggerExit(e);u.event("triggerexit",[e,t])}}else{for(a=0,o=n.length;o>a;a++)n[a].onTriggerStay(t);for(a=0,o=i.length;o>a;a++)i[a].onTriggerStay(e);u.event("triggerstay",[e,t])}else if(e._collisonTo(t)){for(e._runtimeCollisonMap[l]=t,e._runtimeCollisonTestMap[l]=!1,t._runtimeCollisonMap[s]=e,r&&(t._runtimeCollisonTestMap[s]=!1),a=0,o=n.length;o>a;a++)n[a].onTriggerEnter(t);for(a=0,o=i.length;o>a;a++)i[a].onTriggerEnter(e);u.event("triggerenter",[e,t])}}},t._triggerCollision=function(){for(var e=z._collsionTestList,n=e.length,i=Hn._layerCollsionMatrix,r=0;n>r;r++)for(var a=e[r],o=z.getLayerByNumber(a),s=o._colliders,l=o._nonRigidbodyOffset,u=n-1;u>=r;u--){var c=e[u],h=i[a][30-c];if(h){var d,_,f,m=0,p=0,E=0,v=0,g=z.getLayerByNumber(c),T=g._colliders,S=g._nonRigidbodyOffset;if(o!==g){for(m=0;l>m;m++)if(d=s[m],d.enable){for(f=d.owner._scripts,E=0,v=S;v>E;E++)_=T[E],_.enable&&t._onTrigger(d,_,f,_.owner._scripts,!0);for(E=S,v=T.length;v>E;E++)_=T[E],_.enable&&t._onTrigger(d,_,f,_.owner._scripts,!1)}for(m=l,p=s.length;p>m;m++)if(d=s[m],d.enable)for(f=d.owner._scripts,E=0,v=g._nonRigidbodyOffset;v>E;E++)_=T[E],_.enable&&t._onTrigger(_,d,f,_.owner._scripts,!1)}else for(m=0;l>m;m++)if(d=s[m],d.enable){for(f=d.owner._scripts,E=m+1,v=l;v>E;E++)_=T[E],_.enable&&t._onTrigger(d,_,f,_.owner._scripts,!0);for(E=l,v=s.length;v>E;E++)_=T[E],_.enable&&t._onTrigger(d,_,f,_.owner._scripts,!1)}}}},t}(E)),$n=(function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.glitter.SplineCurvePosition",e);var n=t.prototype;return n._CalcVelocity=function(e,t,n){On.subtract(e,t,n),On.scale(n,.5,n)},n.Init=function(t,n,i,r){this._CalcVelocity(n,t,this._tempVector30),this._CalcVelocity(r,i,this._tempVector31),e.prototype.Init.call(this,n,this._tempVector30,r,this._tempVector31)},t}(G),function(e){function t(){this.x=0/0,this.y=0/0,this.z=0/0,t.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.BoxShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=.5*-this.x,t[1]=.5*-this.y,t[2]=.5*-this.z;var n=e.max.elements;n[0]=.5*this.x,n[1]=.5*this.y,n[2]=.5*this.z},n._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=0,t[1]=0,t[2]=0;var n=e.max.elements;n[0]=0,n[1]=1,n[2]=0},n.generatePositionAndDirection=function(e,t,n,i){var r=e.elements,a=t.elements;n?(n.seed=i[16],nt._randomPointInsideHalfUnitBox(e,n),i[16]=n.seed):nt._randomPointInsideHalfUnitBox(e),r[0]=this.x*r[0],r[1]=this.y*r[1],r[2]=this.z*r[2],this.randomDirection?n?(n.seed=i[17],nt._randomPointUnitSphere(t,n),i[17]=n.seed):nt._randomPointUnitSphere(t):(a[0]=0,a[1]=0,a[2]=1)
},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.x=this.x,n.y=this.y,n.z=this.z,n.randomDirection=this.randomDirection},t}(tt)),Jn=function(e){function t(){this.radius=0/0,this.arc=0/0,this.emitFromEdge=!1,t.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.CircleShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[2]=-this.radius,t[1]=0;var n=e.max.elements;n[0]=n[2]=this.radius,n[1]=0},n._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=-1,t[2]=0;var n=e.max.elements;n[0]=n[1]=1,n[2]=0},n.generatePositionAndDirection=function(e,n,i,r){var a=e.elements,o=t._tempPositionPoint.elements;i?(i.seed=r[16],this.emitFromEdge?nt._randomPointUnitArcCircle(this.arc,t._tempPositionPoint,i):nt._randomPointInsideUnitArcCircle(this.arc,t._tempPositionPoint,i),r[16]=i.seed):this.emitFromEdge?nt._randomPointUnitArcCircle(this.arc,t._tempPositionPoint):nt._randomPointInsideUnitArcCircle(this.arc,t._tempPositionPoint),a[0]=-o[0],a[1]=o[1],a[2]=0,On.scale(e,this.radius,e),this.randomDirection?i?(i.seed=r[17],nt._randomPointUnitSphere(n,i),r[17]=i.seed):nt._randomPointUnitSphere(n):e.cloneTo(n)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.arc=this.arc,n.emitFromEdge=this.emitFromEdge,n.randomDirection=this.randomDirection},i(t,["_tempPositionPoint",function(){return this._tempPositionPoint=new Cn}]),t}(tt),ei=function(e){function t(){this.angle=0/0,this.radius=0/0,this.length=0/0,this.emitType=0,t.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.ConeShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=this.radius+this.length*Math.sin(this.angle),n=this.length*Math.cos(this.angle),i=e.min.elements;i[0]=i[1]=-t,i[2]=0;var r=e.max.elements;r[0]=r[1]=t,r[2]=n},n._getSpeedBoundBox=function(e){var t=Math.sin(this.angle),n=e.min.elements;n[0]=n[1]=-t,n[2]=0;var i=e.max.elements;i[0]=n[1]=t,i[2]=1},n.generatePositionAndDirection=function(e,n,i,r){var a,o=e.elements,s=n.elements,l=t._tempPositionPoint.elements,u=0/0,c=0/0,h=Math.cos(this.angle),d=Math.sin(this.angle);switch(this.emitType){case 0:i?(i.seed=r[16],nt._randomPointInsideUnitCircle(t._tempPositionPoint,i),r[16]=i.seed):nt._randomPointInsideUnitCircle(t._tempPositionPoint),u=l[0],c=l[1],o[0]=u*this.radius,o[1]=c*this.radius,o[2]=0,this.randomDirection?(i?(i.seed=r[17],nt._randomPointInsideUnitCircle(t._tempDirectionPoint,i),r[17]=i.seed):nt._randomPointInsideUnitCircle(t._tempDirectionPoint),a=t._tempDirectionPoint.elements,s[0]=a[0]*d,s[1]=a[1]*d):(s[0]=u*d,s[1]=c*d),s[2]=h;break;case 1:i?(i.seed=r[16],nt._randomPointUnitCircle(t._tempPositionPoint,i),r[16]=i.seed):nt._randomPointUnitCircle(t._tempPositionPoint),u=l[0],c=l[1],o[0]=u*this.radius,o[1]=c*this.radius,o[2]=0,this.randomDirection?(i?(i.seed=r[17],nt._randomPointInsideUnitCircle(t._tempDirectionPoint,i),r[17]=i.seed):nt._randomPointInsideUnitCircle(t._tempDirectionPoint),a=t._tempDirectionPoint.elements,s[0]=a[0]*d,s[1]=a[1]*d):(s[0]=u*d,s[1]=c*d),s[2]=h;break;case 2:i?(i.seed=r[16],nt._randomPointInsideUnitCircle(t._tempPositionPoint,i)):nt._randomPointInsideUnitCircle(t._tempPositionPoint),u=l[0],c=l[1],o[0]=u*this.radius,o[1]=c*this.radius,o[2]=0,s[0]=u*d,s[1]=c*d,s[2]=h,On.normalize(n,n),i?(On.scale(n,this.length*i.getFloat(),n),r[16]=i.seed):On.scale(n,this.length*Math.random(),n),On.add(e,n,e),this.randomDirection&&(i?(i.seed=r[17],nt._randomPointUnitSphere(n,i),r[17]=i.seed):nt._randomPointUnitSphere(n));break;case 3:i?(i.seed=r[16],nt._randomPointUnitCircle(t._tempPositionPoint,i)):nt._randomPointUnitCircle(t._tempPositionPoint),u=l[0],c=l[1],o[0]=u*this.radius,o[1]=c*this.radius,o[2]=0,s[0]=u*d,s[1]=c*d,s[2]=h,On.normalize(n,n),i?(On.scale(n,this.length*i.getFloat(),n),r[16]=i.seed):On.scale(n,this.length*Math.random(),n),On.add(e,n,e),this.randomDirection&&(i?(i.seed=r[17],nt._randomPointUnitSphere(n,i),r[17]=i.seed):nt._randomPointUnitSphere(n));break;default:throw new Error("ConeShape:emitType is invalid.")}},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.angle=this.angle,n.radius=this.radius,n.length=this.length,n.emitType=this.emitType,n.randomDirection=this.randomDirection},i(t,["_tempPositionPoint",function(){return this._tempPositionPoint=new Cn},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new Cn}]),t}(tt),ti=function(e){function t(){this.radius=0/0,this.emitFromShell=!1,t.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-this.radius;var n=e.max.elements;n[0]=n[1]=this.radius,n[2]=0},n._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=-1,t[2]=0;var n=e.max.elements;n[0]=n[1]=n[2]=1},n.generatePositionAndDirection=function(e,t,n,i){var r=e.elements;n?(n.seed=i[16],this.emitFromShell?nt._randomPointUnitSphere(e,n):nt._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?nt._randomPointUnitSphere(e):nt._randomPointInsideUnitSphere(e),On.scale(e,this.radius,e);var a=r[2];0>a&&(r[2]=-1*a),this.randomDirection?n?(n.seed=i[17],nt._randomPointUnitSphere(t,n),i[17]=n.seed):nt._randomPointUnitSphere(t):e.cloneTo(t)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection},t}(tt),ni=function(e){function t(){this.radius=0/0,this.emitFromShell=!1,t.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.SphereShape",e);var n=t.prototype;return n._getShapeBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-this.radius;var n=e.max.elements;n[0]=n[1]=n[2]=this.radius},n._getSpeedBoundBox=function(e){var t=e.min.elements;t[0]=t[1]=t[2]=-1;var n=e.max.elements;n[0]=n[1]=n[2]=1},n.generatePositionAndDirection=function(e,t,n,i){n?(n.seed=i[16],this.emitFromShell?nt._randomPointUnitSphere(e,n):nt._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?nt._randomPointUnitSphere(e):nt._randomPointInsideUnitSphere(e),On.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],nt._randomPointUnitSphere(t,n),i[17]=n.seed):nt._randomPointUnitSphere(t):e.cloneTo(t)},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection},t}(tt),ii=function(e){function t(){this._batchIndexStart=0,this._batchIndexEnd=0,this._skinAnimationDatas=null,t.__super.call(this)}return r(t,"laya.d3.core.render.SubMeshRenderElement",e),t}(ut),ri=function(e){function t(e,n,i,r,a){this._name=0/0,this._attributeMap=null,this._renderElementUniformMap=null,this._materialUniformMap=null,this._spriteUniformMap=null,this._cameraUniformMap=null,this._sceneUniformMap=null,this.sharders=null,this._spriteDefineCounter=3,this._spriteInt2name=[],this._spriteName2Int={},this._materialDefineCounter=1,this._materialInt2name=[],this._materialName2Int={},this._conchShader=null,this._name=e,this._renderElementUniformMap={},this._materialUniformMap={},this._spriteUniformMap={},this._cameraUniformMap={},this._sceneUniformMap={},this.sharders=[],this._spriteInt2name[Bn.SHADERDEFINE_RECEIVE_SHADOW]="RECEIVESHADOW",this._spriteInt2name[nr.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV]="SCALEOFFSETLIGHTINGMAPUV",this._spriteInt2name[nr.SAHDERDEFINE_LIGHTMAP]="LIGHTMAP",this._spriteInt2name[ur.SHADERDEFINE_BONE]="BONE",this._materialInt2name[ci.SHADERDEFINE_ALPHATEST]="ALPHATEST";var o={};t.__super.call(this,e,n,i,null,o),this._attributeMap=r;var s;for(s in a){var l=a[s];switch(l[1]){case 0:this._renderElementUniformMap[s]=l[0];break;case 1:this._materialUniformMap[s]=l[0];break;case 2:this._spriteUniformMap[s]=l[0];break;case 3:this._cameraUniformMap[s]=l[0];break;case 4:this._sceneUniformMap[s]=l[0];break;default:throw new Error("ShaderCompile3D: period is unkonw.")}}}r(t,"laya.d3.shader.ShaderCompile3D",e);var n=t.prototype;return n._definesToNameDic=function(e,t){for(var n={},i=1,r=0;32>r&&(i=1<<r,!(i>e));r++)if(e&i){var a=t[i];a&&(n[a]="")}return n},n.withCompile=function(e,n,i){var r,a,o;if(a=this.sharders[e])if(o=a[n]){if(r=o[i])return r}else o=a[n]=[];else a=this.sharders[e]=[],o=a[n]=[];var s,l=this._definesToNameDic(e,t._globalInt2name),u=this._definesToNameDic(n,this._spriteInt2name),c=this._definesToNameDic(i,this._materialInt2name);if(laya.d3.shader.ShaderCompile3D.debugMode){var h="";for(s in l)h+=s+" ";var d="";for(s in u)d+=s+" ";var _="";for(s in c)_+=s+" ";console.log("ShaderCompile3DDebugMode---(Name:"+Ci.nameKey.getName(this._name)+" PublicDefine:"+e+" SpriteDefine:"+n+" MaterialDefine:"+i+" PublicDefineGroup:"+h+" SpriteDefineGroup:"+d+"MaterialDefineGroup: "+_+")---ShaderCompile3DDebugMode")}var f={},m="";if(l)for(s in l)m+="#define "+s+"\n",f[s]=!0;if(u)for(s in u)m+="#define "+s+"\n",f[s]=!0;if(c)for(s in c)m+="#define "+s+"\n",f[s]=!0;var p=this._VS.toscript(f,[]),E=this._PS.toscript(f,[]);return r=Ci.create(m+p.join("\n"),m+E.join("\n"),this._attributeMap,this._sceneUniformMap,this._cameraUniformMap,this._spriteUniformMap,this._materialUniformMap,this._renderElementUniformMap),o[i]=r,r},n.precompileShaderWithShaderDefine=function(e,t,n){this.withCompile(e,t,n)},n.addMaterialDefines=function(e){var t=e.defines;for(var n in t){var i=t[n],r=parseInt(n);this._materialInt2name[r]=i,this._materialName2Int[i]=r}},n.addSpriteDefines=function(e){var t=e.defines;for(var n in t){var i=t[n],r=parseInt(n);this._spriteInt2name[r]=i,this._spriteName2Int[i]=r}},n.getMaterialDefineByName=function(e){return this._materialName2Int[e]},n.registerMaterialDefine=function(e){var t=Math.pow(2,this._materialDefineCounter++);return this._materialInt2name[t]=e,this._materialName2Int[e]=t,t},n.registerSpriteDefine=function(e){var t=Math.pow(2,this._spriteDefineCounter++);return this._spriteInt2name[t]=e,this._spriteName2Int[e]=t,t},t._globalRegDefine=function(e,n){t._globalInt2name[n]=e},t.add=function(e,n,i,r,a){return laya.d3.shader.ShaderCompile3D._preCompileShader[e]=new t(e,n,i,r,a,I.includes)},t.get=function(e){return laya.d3.shader.ShaderCompile3D._preCompileShader[Ci.nameKey.getID(e)]},t._preCompileShader={},t._globalInt2name=[],t.debugMode=!1,t.SHADERDEFINE_HIGHPRECISION=1,t.SHADERDEFINE_FOG=4,t.SHADERDEFINE_DIRECTIONLIGHT=8,t.SHADERDEFINE_POINTLIGHT=16,t.SHADERDEFINE_SPOTLIGHT=32,t.SHADERDEFINE_UV0=64,t.SHADERDEFINE_COLOR=128,t.SHADERDEFINE_UV1=256,t.SAHDERDEFINE_DEPTHFOG=131072,t}(I),ai=function(e){function t(){t.__super.call(this)}r(t,"laya.d3.graphics.MeshSprite3DStaticBatchManager",e);var n=t.prototype;return n._getStaticBatch=function(e,t,n,i){var r,a;return a=e?e.id.toString()+n.id.toString()+t.id.toString()+i.toString():n.id.toString()+t.id.toString()+i.toString(),this._staticBatches[a]?r=this._staticBatches[a]:this._staticBatches[a]=r=new oi(a,this,e,t,n),r},n._initStaticBatchs=function(e){this._initBatchRenderElements.sort(t._sortPrepareStaticBatch);for(var n,i,r,a=!1,o=0,s=0,l=this._initBatchRenderElements.length;l>s;s++){{var u=this._initBatchRenderElements[s],c=u.renderObj._getVertexBuffer(0);u._sprite3D}if(i===c.vertexDeclaration&&n===u._material){var h;if(a)r._addCombineBatchRenderObjTest(u)?(h=u._staticBatch,h!==r&&(h&&h._deleteCombineBatchRenderObj(u),r._addCombineBatchRenderObj(u))):(a=!1,o++);else{var d=this._initBatchRenderElements[s-1],_=d.renderObj,f=u.renderObj;_._getVertexBuffer().vertexCount+f._getVertexBuffer().vertexCount>65535?a=!1:(r=this._getStaticBatch(e,i,n,o),h=d._staticBatch,h!==r&&(h&&h._deleteCombineBatchRenderObj(d),r._addCombineBatchRenderObj(d)),h=u._staticBatch,h!==r&&(h&&h._deleteCombineBatchRenderObj(u),r._addCombineBatchRenderObj(u)),a=!0)}}else a=!1,o=0;n=u._material,i=c.vertexDeclaration}},t._sortPrepareStaticBatch=function(e,t){var n=e._render,i=t._render,r=n.lightmapIndex-i.lightmapIndex;if(0===r){var a=n.receiveShadow-i.receiveShadow;if(0===a){var o=e._mainSortID-t._mainSortID;return 0===o?e.renderObj.triangleCount-t.renderObj.triangleCount:o}return a}return r},t}(St),oi=function(e){function t(e,n,i,r,a){this._batchOwnerIndices=null,this._batchOwners=null,this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=null,this._vertexBuffer=null,this._indexBuffer=null,t.__super.call(this,e,n,i),this._batchOwnerIndices=[],this._batchOwners=[],this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=r,this._material=a}r(t,"laya.d3.graphics.SubMeshStaticBatch",e);var n=t.prototype;return n._compareBatchRenderElement=function(e,t){return e._batchIndexStart>t._batchIndexStart},n._addCombineBatchRenderObjTest=function(e){var t=0,n=e.renderObj._vertexCount;return t=n>0?this._currentCombineVertexCount+n:this._currentCombineVertexCount+e.renderObj._getVertexBuffer().vertexCount,t>65535?!1:!0},n._addCombineBatchRenderObj=function(e){var t=e.renderObj,n=t._vertexCount;this._initBatchRenderElements.push(e),e._staticBatch=this,n>0?(this._currentCombineIndexCount+=t._indexCount,this._currentCombineVertexCount+=n):(this._currentCombineIndexCount=this._currentCombineIndexCount+t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+t._getVertexBuffer().vertexCount),this._needFinishCombine=!0},n._deleteCombineBatchRenderObj=function(e){var t=e.renderObj,n=this._initBatchRenderElements.indexOf(e);if(-1!==n){this._initBatchRenderElements.splice(n,1),e._staticBatch=null;var i=t._vertexCount;i>0?(this._currentCombineIndexCount=this._currentCombineIndexCount-t._indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-i):(this._currentCombineIndexCount=this._currentCombineIndexCount-t._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-t._getVertexBuffer().vertexCount),this._needFinishCombine=!0}},n._finishInit=function(){if(this._needFinishCombine){var e=0,t=0;this._initBatchRenderElements[0]._sprite3D._render.lightmapIndex>=0?this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration):this._material instanceof laya.d3.core.material.StandardMaterial&&this._material.ambientTexture&&(this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration));var n=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount),i=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy()),this._vertexBuffer=Bi.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=Fi.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._initBatchRenderElements.length;a>r;r++){var o=this._initBatchRenderElements[r],s=o.renderObj,l=s._getStaticBatchBakedVertexs(this._rootOwner?this._rootOwner._transform:null,o._sprite3D),u=s.getIndices(),c=o._sprite3D.transform._isFrontFaceInvert,h=e/(this._vertexDeclaration.vertexStride/4)-s._vertexStart,d=t,_=d+u.length;o._batchIndexStart=d,o._batchIndexEnd=_,i.set(u,t);var f=0;if(c)for(f=d;_>f;f+=3){i[f]=h+i[f];var m=i[f+1],p=i[f+2];i[f+1]=h+p,i[f+2]=h+m}else for(f=d;_>f;f+=3)i[f]=h+i[f],i[f+1]=h+i[f+1],i[f+2]=h+i[f+2];t+=u.length,n.set(l,e),e+=l.length}this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this._needFinishCombine=!1}},n._getCombineRenderElementFromPool=function(){var e=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return e||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new ii)},n._getRenderElement=function(e,t,n){for(var i,r,a=this._batchRenderElements.length,o=!0,s=0;a>s;s++){r=this._batchRenderElements[s];var l,u=r._sprite3D._render;0!==s&&(i=this._batchRenderElements[s-1],l=i._sprite3D._render,o=l.lightmapIndex!==u.lightmapIndex||l.receiveShadow!==u.receiveShadow||i._batchIndexEnd!==r._batchIndexStart);var c;if(o){c=this._getCombineRenderElementFromPool(),c.renderObj=this,c._material=this._material,c._batchIndexStart=r._batchIndexStart,c._batchIndexEnd=r._batchIndexEnd;var h=u.lightmapIndex,d=h+1,_=this._batchOwnerIndices[d];_||(_=this._batchOwnerIndices[d]=[]);var f,m=_[r._render.receiveShadow?1:0];void 0===m?(_[u.receiveShadow?1:0]=this._batchOwners.length,f=new sr(null,"StaticBatchMeshSprite3D"),f._scene=t,f._transform=this._rootOwner?this._rootOwner._transform:null,f._render.lightmapIndex=h,f._render.receiveShadow=r._render.receiveShadow,this._batchOwners.push(f)):f=this._batchOwners[m],f._render._renderUpdate(n),c._sprite3D=f,e.push(c)}else c._batchIndexEnd=r._batchIndexEnd}},n._beforeRender=function(){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},n._render=function(e){var t=e.renderElement,n=t._batchIndexStart,i=t._batchIndexEnd-n;P.mainContext.drawElements(4,i,5123,2*n),C.drawCall++,C.trianglesFaces+=i/3},n.dispose=function(){this._batchOwnerIndices=null,this._batchOwners=null,this._vertexDeclaration=null,this._vertexBuffer.destroy(),this._indexBuffer.destroy()},n._getVertexBuffer=function(e){return void 0===e&&(e=0),this._vertexBuffer},t}(Dt),si=(function(e){function t(){t.__super.call(this),t._nameNumber++,this.loadShaderParams(),this.createResource(),this.alphaBlending=1,this.colorIntensity=1}r(t,"laya.d3.resource.models.SkyBox",e);var n=t.prototype;return n._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(t,0,0),this._shader},n.createResource=function(){this._numberVertices=36,this._numberIndices=36;var e=new Uint16Array(this._numberIndices),n=t._vertexDeclaration.vertexStride/4,i=new Float32Array(this._numberVertices*n),r=1,a=1,o=1,s=r/2,l=a/2,u=o/2,c=new On(-s,l,u),h=new On(-s,-l,u),d=new On(s,l,u),_=new On(s,-l,u),f=new On(-s,l,-u),m=new On(s,l,-u),p=new On(-s,-l,-u),E=new On(s,-l,-u),v=0;v=this._addVertex(i,v,c),v=this._addVertex(i,v,h),v=this._addVertex(i,v,d),v=this._addVertex(i,v,h),v=this._addVertex(i,v,_),v=this._addVertex(i,v,d),v=this._addVertex(i,v,f),v=this._addVertex(i,v,m),v=this._addVertex(i,v,p),v=this._addVertex(i,v,p),v=this._addVertex(i,v,m),v=this._addVertex(i,v,E),v=this._addVertex(i,v,c),v=this._addVertex(i,v,m),v=this._addVertex(i,v,f),v=this._addVertex(i,v,c),v=this._addVertex(i,v,d),v=this._addVertex(i,v,m),v=this._addVertex(i,v,h),v=this._addVertex(i,v,p),v=this._addVertex(i,v,E),v=this._addVertex(i,v,h),v=this._addVertex(i,v,E),v=this._addVertex(i,v,_),v=this._addVertex(i,v,c),v=this._addVertex(i,v,p),v=this._addVertex(i,v,h),v=this._addVertex(i,v,f),v=this._addVertex(i,v,p),v=this._addVertex(i,v,c),v=this._addVertex(i,v,d),v=this._addVertex(i,v,_),v=this._addVertex(i,v,E),v=this._addVertex(i,v,m),v=this._addVertex(i,v,d),v=this._addVertex(i,v,E);for(var g=0;36>g;g++)e[g]=g;this._vertexBuffer=new Bi(t._vertexDeclaration,this._numberVertices,35044,!0),this._indexBuffer=new Fi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(e)},n._addVertex=function(e,t,n){var i=n.elements;return e[t+0]=i[0],e[t+1]=i[1],e[t+2]=i[2],t+3},n.loadShaderParams=function(){this._sharderNameID=Ci.nameKey.getID("SkyBox"),this._shaderCompile=ri._preCompileShader[this._sharderNameID]},n._render=function(e){this._textureCube&&this._textureCube.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(e),this._shader.bind(),e.camera.transform.worldMatrix.cloneTo(t._tempMatrix4x40),t._tempMatrix4x40.transpose(),xn.multiply(e._projectionMatrix,t._tempMatrix4x40,t._tempMatrix4x41),e.camera._shaderValues.setValue(4,t._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(e.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.textureCube),this._shader.uploadAttributes(t._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),P.mainContext.drawElements(4,36,5123,0),C.trianglesFaces+=12,C.drawCall++)},n.destroy=function(){e.prototype.destroy.call(this),this._textureCube&&(this._textureCube._removeReference(),this._textureCube=null)},a(0,n,"textureCube",function(){return this._textureCube},function(e){this._textureCube!==e&&(this._textureCube&&this._textureCube._removeReference(),this._textureCube=e,e&&e._addReference())}),t._nameNumber=1,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new xn},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new xn},"_vertexDeclaration",function(){return this._vertexDeclaration=new xt(12,[new Mt(0,"vector3",0)])}]),t}(Pn),function(e){function t(){}r(t,"laya.d3.resource.models.SkyDome",e);var n=t.prototype;return n._getShader=function(e){var t=e.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(t,0,0),this._shader},n.recreateResource=function(){},n.loadShaderParams=function(){},n._render=function(){},n.onEnvDescLoaded=function(){},n.loadEnvInfo=function(){},n.destroy=function(){},a(0,n,"texture",function(){}),t._nameNumber=1,i(t,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new xn},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new xn},"_vertexDeclaration",function(){return this._vertexDeclaration=new xt(20,[new Mt(0,"vector3",0),new Mt(12,"vector2",2)])}]),t}(Pn),function(e){function t(){this._componentsMap=null,this._typeComponentsIndices=null,this._components=null,this._scripts=null,t.__super.call(this),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[],this._scripts=[]}r(t,"laya.d3.core.ComponentNode",e);var n=t.prototype;return n.addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=m.getInstance(e);return t.push(this._components.length),this._components.push(i),i instanceof laya.d3.component.Script&&this._scripts.push(i),i._initialize(this),i},n._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];this._components.splice(i,1),r instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(r),1),n.splice(t,1),0===n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var a=0,o=this._componentsMap.length;o>a;a++){n=this._typeComponentsIndices[a];for(var s=n.length-1;s>=0;s--){var l=n[s];if(!(l>i))break;n[s]=--l}}r._destroy()},n.getComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);return-1===n?null:this._components[this._typeComponentsIndices[n][t]]},n.getComponentsByType=function(e,t){var n=this._componentsMap.indexOf(e);if(-1===n)return t.length=0,void 0;var i=this._typeComponentsIndices[n],r=i.length;t.length=r;for(var a=0;r>a;a++)t[a]=this._components[i[a]]},n.getComponentByIndex=function(e){return this._components[e]},n.removeComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);-1!==n&&this._removeComponent(n,t)},n.removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(-1!==t)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;r>i;n.length<r?r--:i++)this._removeComponent(t,i)},n.removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;t>e;this._componentsMap.length<t?t--:e++)this.removeComponentsByType(this._componentsMap[e])},n._updateComponents=function(e){for(var t=0,n=this._components.length;n>t;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.enable&&i._update(e)}},n._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._lateUpdate(e)}},n._preRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},n._postRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}},t}(D)),li=function(e){function t(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyMap=null,this._duration=0/0,this._frameRate=0,this._animationEvents=null,this._publicClipDatas=null,this.islooping=!1,t.__super.call(this),this._fullKeyframeIndicesCache={},this._animationDatasCache=[],this._avatarDatasCache=[],this._skinnedDatasCache=[],this._animationEvents=[]}r(t,"laya.d3.animation.AnimationClip",e);var i=t.prototype;return i.duration=function(){return this._duration},i._hermiteInterpolate=function(e,t,n,i){for(var r=e.data,a=e.outTangent,o=e.next,s=o.data,l=o.inTangent,u=!1,c=0/0,h=0/0,d=0/0,_=0/0,f=0,m=i.length;m>f;f++){var p=a[f],E=l[f];if(Number.isFinite(p)&&Number.isFinite(E)){if(!u){var v=t*t,g=v*t;c=2*g-3*v+1,h=g-2*v+t,d=g-v,_=-2*g+3*v,u=!0}i[f]=c*r[f]+h*p*n+d*E*n+_*s[f]}else i[f]=r[f]}},i._getFullKeyframeIndicesWithCache=function(e){return this._fullKeyframeIndicesCache[e]},i._cacheFullKeyframeIndices=function(e,t){this._fullKeyframeIndicesCache[e]=t},i._getAnimationDataWithCache=function(e,t){var n=this._animationDatasCache[e];return n?n[t]:null},i._cacheAnimationData=function(e,t,n){var i=this._animationDatasCache[e]||(this._animationDatasCache[e]=[]);i[t]=n},i._getAvatarDataWithCache=function(e,t,n){var i=this._avatarDatasCache[e.id];if(i){var r=i[t];return r?r[n]:null}return null},i._cacheAvatarData=function(e,t,n,i){var r=this._avatarDatasCache[e.id]||(this._avatarDatasCache[e.id]=[]),a=r[t]||(r[t]=[]);a[n]=i},i._evaluateAnimationlDatasCacheMode=function(e,t,n,i,r){for(var a=0,o=0,s=0,l=r?r.length:this._nodes.length;l>s;s++){var u=r?r[s]:s,c=this._nodes[u],h=c._cacheProperty;if(e[u]){var d,_=t[u],f=_[n.currentFrameIndex],m=0;if(-1!==f){var p=c.keyFrames[f],E=p.next;if(E){r&&!h?(d=i[u],d||(d=i[u]=new Float32Array(c.keyFrameWidth))):(d=new Float32Array(c.keyFrameWidth),i[s]=d);var v=0/0,g=p.duration;v=0!==g?(n.currentFrameTime-p.startTime)/g:0,this._hermiteInterpolate(p,v,g,d)}else{if(r&&!h)d=i[u],d||(d=i[u]=new Float32Array(c.keyFrameWidth));else{if(m=n._lastFrameIndex,-1!==m&&_[m]===f)continue;d=new Float32Array(c.keyFrameWidth),i[s]=d}var T=p.data;for(a=0,o=d.length;o>a;a++)d[a]=T[a]}}else{if(r&&!h)d=i[u],d||(d=i[u]=new Float32Array(c.keyFrameWidth));else{if(m=n._lastFrameIndex,-1!==m&&_[m]===f)continue;d=new Float32Array(c.keyFrameWidth),i[s]=d}var S=c.keyFrames[0].data;for(a=0,o=d.length;o>a;a++)d[a]=S[a]}}}},i._evaluateAnimationlDatasRealTime=function(e,t,n,i){var r=0,a=0,o=this._nodes;if(!this._realTimeCurrentFrameIndexes){for(this._realTimeCurrentFrameIndexes=new Int32Array(o.length),r=0,a=o.length;a>r;r++)this._realTimeCurrentFrameIndexes[r]=-1;this._realTimeCurrentTimes=new Float32Array(o.length)}for(r=0,a=i?i.length:this._nodes.length;a>r;r++){var s=i?i[r]:r,l=o[s];t<this._realTimeCurrentTimes[s]&&(this._realTimeCurrentFrameIndexes[s]=-1),this._realTimeCurrentTimes[s]=t;for(var u=this._realTimeCurrentFrameIndexes[s]+1,c=l.keyFrames,h=c.length;h>u;){if(c[u].startTime>t){this._realTimeCurrentFrameIndexes[s]=u-1;break}u++}u===h&&(this._realTimeCurrentFrameIndexes[s]=h-1);var d=0,_=0,f=n[s];f||(f=n[s]=new Float32Array(l.keyFrameWidth));var m=c[this._realTimeCurrentFrameIndexes[s]];if(m){var p=m.next;if(p){var E=m.duration,v=0/0;v=0!==E?(t-m.startTime)/E:0,this._hermiteInterpolate(m,v,E,f)}else{var g=m.data;for(d=0,_=f.length;_>d;d++)f[d]=g[d]}}else{var T=l.keyFrames[0].data;for(d=0,_=f.length;_>d;d++)f[d]=T[d]}var S=e[s];S&&(i?B._propertySetFuncs[l.propertyNameID](S,null,f):B._propertySetFuncs[l.propertyNameID](null,S,f))}},i._binarySearchEventIndex=function(e){for(var t=0,n=this._animationEvents.length-1,i=0;n>=t;){i=Math.floor((t+n)/2);var r=this._animationEvents[i].time;if(r==e)return i;r>e?n=i-1:t=i+1}return t},i.addEvent=function(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)},i.onAsynLoaded=function(e,t){var n=new f(t);switch(this._version=n.readUTFString(),this._version){case"LAYAANIMATION:01":N.parse(this,n);break;case"LAYAANIMATION:02":F.parse(this,n)}this.completeCreate(),this._endLoaded()},i.disposeResource=function(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyMap=null,this._publicClipDatas=null},t.load=function(e){return n.loader.create(e,null,null,t)},t}(R),ui=function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.Avatar",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.IClone":!0}),i._initCloneToAnimator=function(e,t){t._avatarNodeMap[e.name]=e,t._avatarNodes.push(e);for(var n=0,i=e.getChildCount();i>n;n++)this._initCloneToAnimator(e.getChildByIndex(n),t)},i._parseNode=function(e,t){var n=e.props.name;if(t.name=n,t._parent){var i=e.customProps,r=t.transform;r._localRotationEuler=new Float32Array(3),r.setLocalPosition(new Float32Array(i.translate)),r.setLocalRotation(new Float32Array(i.rotation)),r.setLocalScale(new Float32Array(i.scale)),r._setWorldMatrixAndUpdate(new Float32Array(16))}for(var a=e.child,o=0,s=a.length;s>o;o++){var l=a[o],u=new B;t.addChild(u),this._parseNode(l,u)}},i.onAsynLoaded=function(e,t){if(this._rootNode=new B,t.version){this._version=t.version;var n=t.rootNode;n&&this._parseNode(n,this._rootNode)}else this._parseNode(t,this._rootNode);this._endLoaded()},i._cloneDatasToAnimator=function(e){var t=this._rootNode.clone();t.transform._setWorldMatrixIgnoreUpdate(null);var n=[];e._avatarNodeMap={},e._avatarNodes=n,this._initCloneToAnimator(t,e)},i.cloneTo=function(e){var t=e,n=this._rootNode.clone();t._rootNode=n},i.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},t.load=function(e){return n.loader.create(e,null,null,t)},t}(R),ci=function(e){function t(){t.__super.call(this),this._shaderDefineValue=0,this._disablePublicShaderDefine=0,this._shaderValues=new bn,this._values=[],this.renderQueue=2e3,this._alphaTest=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new Vn(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=513,this.depthWrite=!0}r(t,"laya.d3.core.material.BaseMaterial",e);var o=t.prototype;return n.imps(o,{"laya.d3.core.IClone":!0}),o._addShaderDefine=function(e){this._shaderDefineValue|=e},o._removeShaderDefine=function(e){this._shaderDefineValue&=~e},o._addDisablePublicShaderDefine=function(e){this._disablePublicShaderDefine|=e},o._removeDisablePublicShaderDefine=function(e){this._disablePublicShaderDefine&=~e},o._setBuffer=function(e,t){var n=this._shaderValues;n.setValue(e,t),this._values[e]=t},o._getBuffer=function(e){return this._values[e]},o._setMatrix4x4=function(e,t){this._shaderValues.setValue(e,t?t.elements:null),this._values[e]=t},o._getMatrix4x4=function(e){return this._values[e]},o._setInt=function(e,t){var n=this._shaderValues;n.setValue(e,t),this._values[e]=t},o._getInt=function(e){return this._values[e]},o._setNumber=function(e,t){var n=this._shaderValues;n.setValue(e,t),this._values[e]=t},o._getNumber=function(e){return this._values[e]},o._setBool=function(e,t){var n=this._shaderValues;
n.setValue(e,t),this._values[e]=t},o._getBool=function(e){return this._values[e]},o._setVector2=function(e,t){var n=this._shaderValues;n.setValue(e,t?t.elements:null),this._values[e]=t},o._getVector2=function(e){return this._values[e]},o._setColor=function(e,t){var n=this._shaderValues;n.setValue(e,t?t.elements:null),this._values[e]=t},o._getColor=function(e){return this._values[e]},o._setTexture=function(e,t){var n=this._values[e];this._values[e]=t,this._shaderValues.setValue(e,t),this.referenceCount>0&&(n&&n._removeReference(),t&&t._addReference())},o._getTexture=function(e){return this._values[e]},o._upload=function(){this._shader.uploadMaterialUniforms(this._shaderValues.data)},o._getShader=function(e,t,n){var i=(e|t)&~this._disablePublicShaderDefine;return this._shader=this._shaderCompile.withCompile(i,n,this._shaderDefineValue),this._shader},o._setRenderStateBlendDepth=function(){var e=P.mainContext;switch(w.setDepthMask(e,this.depthWrite),0===this.depthTest?w.setDepthTest(e,!1):(w.setDepthTest(e,!0),w.setDepthFunc(e,this.depthTest)),this.blend){case 0:w.setBlend(e,!1);break;case 1:w.setBlend(e,!0),w.setBlendFunc(e,this.srcBlend,this.dstBlend);break;case 2:w.setBlend(e,!0)}},o._setRenderStateFrontFace=function(e,t){var n=P.mainContext,i=0;switch(this.cull){case 0:w.setCullFace(n,!1);break;case 1:w.setCullFace(n,!0),i=e?t&&t._isFrontFaceInvert?2305:2304:t&&t._isFrontFaceInvert?2304:2305,w.setFrontFace(n,i);break;case 2:w.setCullFace(n,!0),i=e?t&&t._isFrontFaceInvert?2304:2305:t&&t._isFrontFaceInvert?2305:2304,w.setFrontFace(n,i)}},o.onAsynLoaded=function(e,t){var n=t[0],i=t[1];switch(n.version){case"LAYAMATERIAL:01":var r=0,a=0,o=n.props;for(var s in o)switch(s){case"vectors":var l=o[s];for(r=0,a=l.length;a>r;r++){var u=l[r],c=u.value;switch(c.length){case 2:this[u.name]=new Cn(c[0],c[1]);break;case 3:this[u.name]=new On(c[0],c[1],c[2]);break;case 4:this[u.name]=new Vn(c[0],c[1],c[2],c[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var h=o[s];for(r=0,a=h.length;a>r;r++){var d=h[r],_=d.path;_&&(this[d.name]=g.getRes(i[_]))}break;case"defines":var f=o[s];for(r=0,a=f.length;a>r;r++){var m=this._shaderCompile.getMaterialDefineByName(f[r]);this._addShaderDefine(m)}break;case"cull":case"blend":case"srcBlend":case"dstBlend":case"depthWrite":this[s]=o[s];break;case"renderQueue":var p=o[s];switch(p){case 1:this.renderQueue=2e3;break;case 2:this.renderQueue=3e3}break;default:this[s]=o[s]}break;case"LAYAMATERIAL:02":o=n.props;for(s in o)switch(s){case"vectors":for(l=o[s],r=0,a=l.length;a>r;r++)switch(u=l[r],c=u.value,c.length){case 2:this[u.name]=new Cn(c[0],c[1]);break;case 3:this[u.name]=new On(c[0],c[1],c[2]);break;case 4:this[u.name]=new Vn(c[0],c[1],c[2],c[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}break;case"textures":for(h=o[s],r=0,a=h.length;a>r;r++)d=h[r],_=d.path,_&&(this[d.name]=g.getRes(i[_]));break;case"defines":for(f=o[s],r=0,a=f.length;a>r;r++)m=this._shaderCompile.getMaterialDefineByName(f[r]),this._addShaderDefine(m);break;default:this[s]=o[s]}break;default:throw new Error("BaseMaterial:unkonwn version.")}this._endLoaded()},o._addReference=function(){e.prototype._addReference.call(this);for(var t=this._values.length,n=0,i=t;i>n;n++){var r=this._values[n];r&&r instanceof laya.d3.resource.BaseTexture&&r._addReference()}},o._removeReference=function(){e.prototype._removeReference.call(this);for(var t=this._values.length,n=0,i=t;i>n;n++){var r=this._values[n];r&&r instanceof laya.d3.resource.BaseTexture&&r._removeReference()}},o.disposeResource=function(){this.blendConstColor=null,this._shader=null,this._shaderValues=null;for(var e=this._values.length,t=0,n=e;n>t;t++){var i=this._values[t];i&&i instanceof laya.d3.resource.BaseTexture&&i._removeReference()}this._values=null},o.setShaderName=function(e){var t=Ci.nameKey.getID(e);if(-1===t)throw new Error("BaseMaterial: unknown shader name.");this._shaderCompile=ri._preCompileShader[t]},o.cloneTo=function(e){var t=e;t.name=this.name,t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.renderQueue=this.renderQueue,t._shader=this._shader,t._disablePublicShaderDefine=this._disablePublicShaderDefine,t._shaderDefineValue=this._shaderDefineValue;var n=0,i=0,r=t._shaderValues;t._shaderValues.data.length=this._shaderValues.data.length;var a=this._values.length,o=t._values;for(o.length=a,n=0,i=a;i>n;n++){var s=this._values[n];if(s)if("number"==typeof s)o[n]=s,r.data[n]=s;else if("number"==typeof s&&Math.floor(s)==s)o[n]=s,r.data[n]=s;else if("boolean"==typeof s)o[n]=s,r.data[n]=s;else if(s instanceof laya.d3.math.Vector2){var l=o[n]||(o[n]=new Cn);s.cloneTo(l),r.data[n]=l.elements}else if(s instanceof laya.d3.math.Vector3){var u=o[n]||(o[n]=new On);s.cloneTo(u),r.data[n]=u.elements}else if(s instanceof laya.d3.math.Vector4){var c=o[n]||(o[n]=new Vn);s.cloneTo(c),r.data[n]=c.elements}else if(s instanceof laya.d3.math.Matrix4x4){var h=o[n]||(o[n]=new xn);s.cloneTo(h),r.data[n]=h.elements}else s instanceof laya.d3.resource.BaseTexture&&(o[n]=s,r.data[n]=s)}},o.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},a(0,o,"alphaTestValue",function(){return this._getNumber(0)},function(e){this._setNumber(0,e)}),a(0,o,"alphaTest",function(){return this._alphaTest},function(e){this._alphaTest=e,e?this._addShaderDefine(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST):this._removeShaderDefine(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST)}),t.__init__=function(){t.SHADERDEFINE_ALPHATEST=t.shaderDefines.registerDefine("ALPHATEST")},t.RENDERQUEUE_OPAQUE=2e3,t.RENDERQUEUE_ALPHATEST=2450,t.RENDERQUEUE_TRANSPARENT=3e3,t.CULL_NONE=0,t.CULL_FRONT=1,t.CULL_BACK=2,t.BLEND_DISABLE=0,t.BLEND_ENABLE_ALL=1,t.BLEND_ENABLE_SEPERATE=2,t.BLENDPARAM_ZERO=0,t.BLENDPARAM_ONE=1,t.BLENDPARAM_SRC_COLOR=768,t.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,t.BLENDPARAM_DST_COLOR=774,t.BLENDPARAM_ONE_MINUS_DST_COLOR=775,t.BLENDPARAM_SRC_ALPHA=770,t.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,t.BLENDPARAM_DST_ALPHA=772,t.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,t.BLENDPARAM_SRC_ALPHA_SATURATE=776,t.BLENDEQUATION_ADD=0,t.BLENDEQUATION_SUBTRACT=1,t.BLENDEQUATION_REVERSE_SUBTRACT=2,t.DEPTHTEST_OFF=0,t.DEPTHTEST_NEVER=512,t.DEPTHTEST_LESS=513,t.DEPTHTEST_EQUAL=514,t.DEPTHTEST_LEQUAL=515,t.DEPTHTEST_GREATER=516,t.DEPTHTEST_NOTEQUAL=517,t.DEPTHTEST_GEQUAL=518,t.DEPTHTEST_ALWAYS=519,t.SHADERDEFINE_ALPHATEST=1,t.ALPHATESTVALUE=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn}]),t}(R),hi=function(e){function t(){this._type=0,this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._format=0,this._source=null,this._conchTexture=null,this._wrapModeU=0,this._wrapModeV=0,t.__super.call(this),this._repeat=!0,this.mipmap=!0,this.minFifter=-1,this.magFifter=-1}r(t,"laya.d3.resource.BaseTexture",e);var n=t.prototype;return a(0,n,"width",function(){return this._width}),a(0,n,"repeat",function(){return this._repeat},function(e){if(this._repeat!==e&&(this._repeat=e,this._source)){var t=P.mainContext;w.bindTexture(t,this._type,this._source);var n=u.isPOT(this._width,this._height);n&&this._repeat?(t.texParameteri(this._type,10242,10497),t.texParameteri(this._type,10243,10497)):(t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071))}}),a(0,n,"height",function(){return this._height}),a(0,n,"magFifter",function(){return this._magFifter},function(e){this._magFifter=e,e!=this._magFifter&&this._conchTexture&&this._conchTexture.setMaxFifter(e)}),a(0,n,"wrapModeV",function(){return this._wrapModeV}),a(0,n,"size",function(){return this._size}),a(0,n,"wrapModeU",function(){return this._wrapModeU}),a(0,n,"mipmap",function(){return this._mipmap},function(e){this._mipmap=e,this._mipmap!=e&&this._conchTexture&&this._conchTexture.setMipMap(e)}),a(0,n,"minFifter",function(){return this._minFifter},function(e){this._minFifter=e,this._minFifter!=e&&this._conchTexture&&this._conchTexture.setMinFifter(e)}),a(0,n,"format",function(){return this._format}),a(0,n,"source",function(){return this.activeResource(),this._source}),a(0,n,"defaulteTexture",function(){return qi.grayTexture}),t.WARPMODE_REPEAT=0,t.WARPMODE_CLAMP=1,t}(R),di=function(e){function t(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._positions=null,t.__super.call(this),this._boundingBoxCorners=o(8,null)}r(t,"laya.d3.resource.models.BaseMesh",e);var n=t.prototype;return n._getPositions=function(){throw new Error("未Override,请重载该属性！")},n._generateBoundingObject=function(){this._boundingSphere=new gn(new On,0),gn.createfromPoints(this._positions,this._boundingSphere),this._boundingBox=new En(new On,new On),En.createfromPoints(this._positions,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},n.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},n.getRenderElement=function(){throw new Error("未Override,请重载该属性！")},a(0,n,"subMeshCount",function(){return this._subMeshCount}),a(0,n,"boundingBox",function(){return this._boundingBox}),a(0,n,"boundingBoxCorners",function(){return this._boundingBoxCorners}),a(0,n,"boundingSphere",function(){return this._boundingSphere}),t}(R),_i=function(e){function t(){}r(t,"laya.d3.terrain.TerrainHeightData",e);var n=t.prototype;return n.onAsynLoaded=function(){},t.load=function(){},t}(R),fi=function(e){function t(){}r(t,"laya.d3.terrain.TerrainRes",e);var n=t.prototype;return n.parseData=function(){},n.onLoadTerrainComplete=function(){},n.onAsynLoaded=function(){},t.load=function(){},t}(R),mi=function(e){function t(){this._player=null,this._templet=null,t.__super.call(this),this._player=new s}r(t,"laya.d3.component.animation.KeyframeAnimations",e);var i=t.prototype;return i._updateAnimtionPlayer=function(){this._player._update(n.timer.delta)},i._addUpdatePlayerToTimer=function(){n.timer.frameLoop(1,this,this._updateAnimtionPlayer)},i._removeUpdatePlayerToTimer=function(){n.timer.clear(this,this._updateAnimtionPlayer)},i._onOwnerActiveHierarchyChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},i._load=function(e){e.activeInHierarchy&&this._addUpdatePlayerToTimer(),e.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},i._unload=function(t){e.prototype._unload.call(this,t),t.activeInHierarchy&&this._removeUpdatePlayerToTimer(),t.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._player._destroy(),this._player=null,this._templet=null},a(0,i,"url",null,function(e){console.log("Warning: discard property,please use templet property instead.");var t=n.loader.create(e,null,null,l);this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this.event("animationchanged",this))}),a(0,i,"player",function(){return this._player}),a(0,i,"templet",function(){return this._templet},function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this.event("animationchanged",this))}),a(0,i,"currentFrameIndex",function(){return this._player.currentKeyframeIndex}),a(0,i,"currentAnimationClipIndex",function(){return this._player.currentAnimationClipIndex}),a(0,i,"nodeCount",function(){return this._templet.getNodeCount(this._player.currentAnimationClipIndex)}),t}(Zn),pi=function(e){function t(){t.__super.call(this),this._clipNames=[],this._clips=[],this._playStartFrames=[],this._playEndFrames=[],this._cacheNodesSpriteOwners=[],this._cacheNodesAvatarOwners=[],this._cacheNodesDefaultlValues=[],this._cacheNodesToSpriteMap=[],this._cacheSpriteToNodesMap=[],this._cacheFullFrames=[],this._publicClipsDatas=[],this._playEventIndex=-1,this._updateTransformPropertyLoopCount=-1,this._lastFrameIndex=-1,this._defaultClipIndex=-1,this._cachePlayRate=1,this._currentPlayClip=null,this._currentFrameIndex=-1,this._currentTime=0,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this.isCache=!0,this.cacheFrameRate=60,this.playbackRate=1,this.playOnWake=!0}r(t,"laya.d3.component.Animator",e);var o=t.prototype;return n.imps(o,{"laya.resource.IDestroy":!0}),o._getAvatarOwnersByClip=function(e){var t=this._clips[e]._nodes,n=t.length,i=this._cacheNodesAvatarOwners[e];i.length=n;var r=this._cacheNodesDefaultlValues[e];r.length=n;for(var a=0;n>a;a++){for(var o=this._avatarNodes[0],s=t[a],l=s.path,u=0,c=l.length;c>u;u++){var h=l[u];if(""===h)break;if(o=o.getChildByName(h),!o)break}if(o){i[a]=o;var d=B._propertyGetFuncs[s.propertyNameID](o);if(d){var _=new Float32Array(s.keyFrameWidth);for(r[a]=_,u=0,c=d.length;c>u;u++)_[u]=d[u]}}}},o._handleSpriteOwnersByClip=function(e){var t=this._clips[e]._nodes,n=t.length,i=this._cacheNodesSpriteOwners[e];i.length=n;var r=this._cacheNodesDefaultlValues[e];r.length=n;for(var a=0;n>a;a++){var o=this._owner,s=t[a],l=s.path,u=0,c=0;for(u=0,c=l.length;c>u;u++){var h=l[u];if(""===h)break;if(o=o.getChildByName(h),!o)break}if(o){i[a]=o;var d=B._propertyGetFuncs[s.propertyNameID](null,o);if(d){var _=new Float32Array(s.keyFrameWidth);for(r[a]=_,u=0,c=d.length;c>u;u++)_[u]=d[u]}}}},o._offClipAndAvatarRelateEvent=function(e,t){e.loaded?t.loaded||t.off("loaded",this,this._getAvatarOwnersByClip):e.off("loaded",this,this._getAvatarOwnersAndInitDatasAsync)},o._getAvatarOwnersByClipAsync=function(e,t){t.loaded?this._getAvatarOwnersByClip(e):t.once("loaded",this,this._getAvatarOwnersByClip,[e])},o._offGetSpriteOwnersByClipAsyncEvent=function(e){e.loaded||e.off("loaded",this,this._getSpriteOwnersByClipAsync)},o._getSpriteOwnersByClipAsync=function(e,t){t.loaded?this._handleSpriteOwnersByClip(e):t.once("loaded",this,this._handleSpriteOwnersByClip,[e])},o._getAvatarOwnersAndInitDatasAsync=function(){for(var e=0,t=this._clips.length;t>e;e++)this._getAvatarOwnersByClipAsync(e,this._clips[e]);for(this._avatar._cloneDatasToAnimator(this),e=0,t=this._avatarNodes.length;t>e;e++)this._checkAnimationNode(this._avatarNodes[e],this._owner)},o._offGetClipCacheFullKeyframeIndicesEvent=function(e){e.loaded||e.off("loaded",this,this._computeCacheFullKeyframeIndices)},o._computeCacheFullKeyframeIndices=function(e){var t=this._clips[e],n=this._cacheFrameRateInterval*this._cachePlayRate,i=t._getFullKeyframeIndicesWithCache(n);if(i)return this._cacheFullFrames[e]=i,void 0;i=this._cacheFullFrames[e]=[];var r=t._nodes,a=r.length;i.length=a;for(var o=Math.ceil(t._duration/n-1e-5)+1,s=0;a>s;s++){var l=r[s],u=new Int32Array(o);u.fill(-1);for(var c=l.keyFrames,h=0,d=c.length;d>h;h++)for(var _=c[h],f=_.startTime,m=f+_.duration;m>=f;){var p=Math.ceil(f/n-1e-5);u[p]=h,f+=n}i[s]=u}t._cacheFullKeyframeIndices(n,i)},o._updateAnimtionPlayer=function(){this._updatePlayer(n.timer.delta/1e3)},o._onOwnerActiveHierarchyChanged=function(){var e=this._owner;e.activeInHierarchy?(n.timer.frameLoop(1,this,this._updateAnimtionPlayer),this.playOnWake&&this.clip&&this.play()):(0!==this.playState&&(this._stoped=!0),n.timer.clear(this,this._updateAnimtionPlayer))},o._eventScript=function(e,t){for(var n=this._currentPlayClip._animationEvents,i=n.length;this._playEventIndex<i;this._playEventIndex++){var r=n[this._playEventIndex],a=r.time;if(!(a>=e&&t>a))break;for(var o=this._owner._scripts,s=0,l=o.length;l>s;s++){var u=o[s],c=u[r.eventName];c&&c.apply(u,r.params)}}},o._setPlayParams=function(e,t){var n=this._currentTime;this._currentTime=e,this._currentFrameIndex=Math.max(Math.floor(this.currentPlayTime/t-1e-5),0),this._currentFrameTime=this._currentFrameIndex*t,this._eventScript(n,e)},o._setPlayParamsWhenStop=function(e,t){var n=this._currentTime;this._currentTime=e,this._currentFrameIndex=Math.max(Math.floor(e/t-1e-5),0),this._currentFrameTime=this._currentFrameIndex*t,this._eventScript(n,e),this._currentPlayClip=null},o._revertKeyframeNodes=function(e,t){var n=this._cacheNodesDefaultlValues[t],i=e._nodes;if(this._avatar)for(var r=this._cacheNodesAvatarOwners[t],a=0,o=r.length;o>a;a++){var s=r[a];s&&B._propertySetFuncs[i[a].propertyNameID](s,null,n[a])}else{var l=this._cacheNodesSpriteOwners[t];for(a=0,o=l.length;o>a;a++){var u=l[a];u&&B._propertySetFuncs[i[a].propertyNameID](null,u,n[a])}}},o._onAnimationStop=function(){var e,t,n,i=0,r=0;this._lastFrameIndex=-1;var a=this._currentPlayClip._nodes;if(this._avatar){var o=this._cacheNodesAvatarOwners[this._currentPlayClipIndex];for(i=0,r=o.length;r>i;i++){var s=o[i];e=a[i],t=e.keyFrames,n=t[t.length-1].data,s&&B._propertySetFuncs[e.propertyNameID](s,null,n)}}else{var l=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];for(i=0,r=l.length;r>i;i++){var u=l[i];e=a[i],t=e.keyFrames,n=t[t.length-1].data,u&&B._propertySetFuncs[e.propertyNameID](null,u,n)}}},o._setAnimationClipPropertyToAnimationNode=function(e,t,n){for(var i=0,r=t.length;r>i;i++){var a=t[i],o=e[a];if(o){var s=this._currentPlayClip._nodes[a],l=n[a];l&&B._propertySetFuncs[s.propertyNameID](o,null,l)}}},o._setAnimationClipPropertyToSprite3D=function(e,t){for(var n=0,i=e.length;i>n;n++){var r=e[n];if(r){var a=this._currentPlayClip._nodes[n],o=t[n];o&&B._propertySetFuncs[a.propertyNameID](null,r,o)}}},o._handleSpriteOwnersBySprite=function(e,t,n,i){var r=this._clips[e],a=n.join("/"),o=r._nodesMap[a];if(o)for(var s=this._cacheNodesSpriteOwners[e],l=r._nodes,u=this._cacheNodesDefaultlValues[e],c=0,h=o.length;h>c;c++){var d=o[c],_=l.indexOf(d);if(t){s[_]=i;var f=B._propertyGetFuncs[d.propertyNameID](null,i);if(f){var m=u[_];m||(u[_]=m=new Float32Array(d.keyFrameWidth));for(var p=0,E=f.length;E>p;p++)m[p]=f[p]}}else s[_]=null}},o._evaluateAvatarNodesCacheMode=function(e,n,i,r,a){n._evaluateAnimationlDatasCacheMode(e,this._cacheFullFrames[this._currentPlayClipIndex],this,i,a),this._setAnimationClipPropertyToAnimationNode(e,a,i);for(var o=0,s=this._avatarNodes.length;s>o;o++){var l=this._avatarNodes[o],u=l.transform;if(u._worldUpdate){var c=new Float32Array(16);r[o]=c,u._setWorldMatrixAndUpdate(c)}else{var h=u.getWorldMatrix();r[o]=h?h:t.deafaultMatrix}}},o._evaluateAvatarNodesRealTime=function(e,n,i,r,a){n._evaluateAnimationlDatasRealTime(e,this.currentPlayTime,i,a),this._setAnimationClipPropertyToAnimationNode(e,a,i);for(var o=0,s=this._avatarNodes.length;s>o;o++){var l=this._avatarNodes[o].transform;l._worldUpdate?l._setWorldMatrixNoUpdate(r[o]):r[o]=t.deafaultMatrix}},o._updateAvatarNodesToSpriteCacheMode=function(e,n){for(var i=0,r=this._cacheSpriteToNodesMap.length;r>i;i++){var a=this._cacheSpriteToNodesMap[i],o=n[a];if(o!==t.deafaultMatrix){var s=this._avatarNodes[a].transform._entity;if(!s)return;var l=s.worldMatrix;kn.matrix4x4MultiplyMFM(this._owner._transform.worldMatrix,o,l),s.worldMatrix=l}}},o._updateAvatarNodesToSpriteRealTime=function(){for(var e=0,n=this._cacheSpriteToNodesMap.length;n>e;e++){var i=this._avatarNodes[this._cacheSpriteToNodesMap[e]],r=i.transform._entity,a=i.transform;if(a._worldUpdate){var o=t._tempMatrix4x40;a._setWorldMatrixAndUpdate(o);var s=r.worldMatrix;kn.matrix4x4MultiplyMFM(this._owner._transform.worldMatrix,o,s),r.worldMatrix=s}}},o._updatePlayer=function(e){if(null!=this._currentPlayClip&&!this._stoped&&this._currentPlayClip.loaded){var t=this._cacheFrameRateInterval*this._cachePlayRate,n=0;this._startUpdateLoopCount!==C.loopCount&&(n=e*this.playbackRate,this._elapsedPlaybackTime+=n);var i=this._currentPlayClip._frameRate,r=this._playStartFrames[this._currentPlayClipIndex]/i,a=Math.min(this._playEndFrames[this._currentPlayClipIndex]/i,this._currentPlayClip._duration),o=a-r;if(!this._currentPlayClip.islooping&&this._elapsedPlaybackTime>=o)return this._onAnimationStop(),this._setPlayParamsWhenStop(o,t),this.event("stopped"),void 0;if(n+=this._currentTime,o>0)if(n>=o){do n-=o,o>n&&(this._setPlayParams(n,t),this.event("complete")),this._playEventIndex=0,this._eventScript(0,n);while(n>=o)}else this._setPlayParams(n,t);else this._currentTime=this._currentFrameTime=this._currentFrameIndex=this._playEventIndex=0,this.event("complete")}},o._update=function(){var e=this._currentPlayClip;if(2===this.playState&&e&&e.loaded){var t=this.playbackRate*n.timer.scale,i=this._cachePlayRate;this._canCache=this.isCache&&t>=i;var r,a=-1;if(this._canCache){if(a=this._currentFrameIndex,this._lastFrameIndex===a)return;if(r=e._getAnimationDataWithCache(i,a),this._avatar){var o=this._cacheNodesAvatarOwners[this._currentPlayClipIndex],s=e._cachePropertyMap,l=s.length;l>0&&(r||(r=[],r.length=l,e._cacheAnimationData(i,a,r),e._evaluateAnimationlDatasCacheMode(o,this._cacheFullFrames[this._currentPlayClipIndex],this,r,s)),this._setAnimationClipPropertyToAnimationNode(o,s,r)),this._curAvatarNodeDatas=e._getAvatarDataWithCache(this._avatar,this._cachePlayRate,a),this._curAvatarNodeDatas||(this._curAvatarNodeDatas=[],this._curAvatarNodeDatas.length=this._avatarNodes.length,e._cacheAvatarData(this._avatar,this._cachePlayRate,a,this._curAvatarNodeDatas),this._evaluateAvatarNodesCacheMode(o,e,e._publicClipDatas,this._curAvatarNodeDatas,e._unCachePropertyMap)),this._updateAvatarNodesToSpriteCacheMode(e,this._curAvatarNodeDatas)}else{var u=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];r||(r=[],r.length=this._currentPlayClip._nodes.length,e._evaluateAnimationlDatasCacheMode(u,this._cacheFullFrames[this._currentPlayClipIndex],this,r,null),e._cacheAnimationData(i,a,r)),this._setAnimationClipPropertyToSprite3D(u,r)}}else if(r=e._publicClipDatas,this._avatar){if(e._evaluateAnimationlDatasRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],this.currentPlayTime,r,e._cachePropertyMap),!this._publicAvatarNodeDatas){this._publicAvatarNodeDatas=[];var c=this._avatarNodes.length;this._publicAvatarNodeDatas.length=c;for(var h=1;c>h;h++)this._publicAvatarNodeDatas[h]=new Float32Array(16)}this._curAvatarNodeDatas=this._publicAvatarNodeDatas,this._evaluateAvatarNodesRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],e,r,this._curAvatarNodeDatas,e._unCachePropertyMap),this._updateAvatarNodesToSpriteRealTime()}else e._evaluateAnimationlDatasRealTime(this._cacheNodesSpriteOwners[this._currentPlayClipIndex],this.currentPlayTime,r,null);this._lastFrameIndex=a}},o._checkAnimationNode=function(e,t){e.name!==t.name||t._transform.dummy||t._isLinkSpriteToAnimationNode(this,e,!0);for(var n=0,i=t._childs.length;i>n;n++)this._checkAnimationNode(e,t.getChildAt(n))},o._load=function(e){e.activeInHierarchy&&n.timer.frameLoop(1,this,this._updateAnimtionPlayer),this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},o._unload=function(t){e.prototype._unload.call(this,t),t.activeInHierarchy&&n.timer.clear(this,this._updateAnimtionPlayer),this._owner.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._curAvatarNodeDatas=null},o._destroy=function(){e.prototype._destroy.call(this);for(var t=0,n=this._clips.length;n>t;t++)this._clips[t]._removeReference();this._currentPlayClip=null,this._clipNames=null,this._cacheNodesSpriteOwners=null,this._cacheNodesAvatarOwners=null,this._cacheNodesDefaultlValues=null,this._clips=null,this._cacheFullFrames=null},o._cloneTo=function(e){var t=e;t.avatar=this.avatar;for(var n=(this._clips.length,0),i=this._clips.length;i>n;n++)t.addClip(this._clips[n]);if(this.clip&&(t.clip=this.clip),this._linkSpritesData){t._linkSpritesData={};for(var r in this._linkSpritesData)t._linkSpritesData[r]=this._linkSpritesData[r].slice()}},o.addClip=function(e,t,n,i){void 0===n&&(n=0),void 0===i&&(i=4294967295),t=t||e.name;var r=this._clipNames.indexOf(t);if(-1!==r){if(this._clips[r]!==e)throw new Error("Animation:this playName has exist with another clip.")}else{var a=this._clips.indexOf(e);if(0>n||0>i)throw new Error("Animator:startFrame and endFrame must large than zero.");if(n>i)throw new Error("Animator:startFrame must less than endFrame.");this._clipNames.push(t),this._clips.push(e),this._playStartFrames.push(n),this._playEndFrames.push(i),this._cacheNodesSpriteOwners.push([]),this._cacheNodesAvatarOwners.push([]),this._cacheNodesDefaultlValues.push([]),this._publicClipsDatas.push([]),e._addReference(),a=this._clips.length-1,this._avatar?this._avatar.loaded?this._getAvatarOwnersByClipAsync(a,e):this._avatar.once("loaded",this,this._getAvatarOwnersByClipAsync,[a,e]):this._getSpriteOwnersByClipAsync(a,e),e.loaded?this._computeCacheFullKeyframeIndices(a):e.once("loaded",this,this._computeCacheFullKeyframeIndices,[a])}},o.removeClip=function(e){var t=this._clips.indexOf(e);-1!==t&&(this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,e):this._offGetSpriteOwnersByClipAsyncEvent(e),this._offGetClipCacheFullKeyframeIndicesEvent(e),this._clipNames.splice(t,1),this._clips.splice(t,1),this._playStartFrames.splice(t,1),this._playEndFrames.splice(t,1),this._cacheNodesSpriteOwners.splice(t,1),this._cacheNodesAvatarOwners.splice(t,1),this._cacheNodesDefaultlValues.splice(t,1),this._publicClipsDatas.splice(t,1),e._removeReference())},o.removeClipByName=function(e){var t=this._clipNames.indexOf(e);if(-1!==t){var n=this._clips[t];this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,n):this._offGetSpriteOwnersByClipAsyncEvent(n),this._offGetClipCacheFullKeyframeIndicesEvent(n),this._clipNames.splice(t,1),this._clips.splice(t,1),this._playStartFrames.splice(t,1),this._playEndFrames.splice(t,1),this._cacheNodesSpriteOwners.splice(t,1),this._cacheNodesAvatarOwners.splice(t,1),this._cacheNodesDefaultlValues.splice(t,1),this._publicClipsDatas.splice(t,1)}},o.getClip=function(e){var t=this._clipNames.indexOf(e);return-1!==t?this._clips[t]:null},o.getClipCount=function(){return this._clips.length},o.play=function(e,t){if(void 0===t&&(t=1),!e&&-1==this._defaultClipIndex)throw new Error("Animator:must have  default clip value,please set clip property.");e?(this._currentPlayClipIndex=this._clipNames.indexOf(e),this._currentPlayClip=this._clips[this._currentPlayClipIndex]):(this._currentPlayClipIndex=this._defaultClipIndex,this._currentPlayClip=this._clips[this._defaultClipIndex]),this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this._playEventIndex=0,this.playbackRate=t,this._stoped=!1,this._currentFrameIndex=0,this._startUpdateLoopCount=C.loopCount,this._lastPlayAnimationClip&&this._lastPlayAnimationClip!==this._currentPlayClip&&this._revertKeyframeNodes(this._lastPlayAnimationClip,this._lastPlayAnimationClipIndex),this._updatePlayer(0),this._lastPlayAnimationClip=this._currentPlayClip,this._lastPlayAnimationClipIndex=this._currentPlayClipIndex},o.stop=function(){0!==this.playState&&(this._stoped=!0,this.event("stopped"))},o._getLinkSpritePath=function(e,t){t.unshift(e.name);var n=e._parent;n._hierarchyAnimator===this?this._getLinkSpritePath(n,t):t.shift()},o.linkSprite3DToAvatarNode=function(e,t){if(this._avatar){var n=this._avatarNodeMap[e];return n?(t._isLinkSpriteToAnimationNode(this,n,!0),!0):!1}return!1},o.unLinkSprite3DToAvatarNode=function(e){if(this._avatar){var t=e.transform.dummy;if(t){var n=this._avatarNodeMap[t._owner.name];return e._isLinkSpriteToAnimationNode(this,n,!1),!0}return!1}return!1},a(0,o,"playState",function(){return null==this._currentPlayClip?0:this._stoped?0:2}),a(0,o,"avatar",function(){return this._avatar},function(e){if(this._avatar!==e){var t=this._avatar;this._avatar=e;for(var n=this._clips.length,i=0;n>i;i++)this._offClipAndAvatarRelateEvent(t,this._clips[i]);e&&(e.loaded?this._getAvatarOwnersAndInitDatasAsync():e.once("loaded",this,this._getAvatarOwnersAndInitDatasAsync))}}),a(0,o,"cacheFrameRate",function(){return this._cacheFrameRate},function(e){if(this._cacheFrameRate!==e){this._cacheFrameRate=e,this._cacheFrameRateInterval=1/this._cacheFrameRate;for(var t=0,n=this._clips.length;n>t;t++)this._clips[t].loaded&&this._computeCacheFullKeyframeIndices(t)}}),a(0,o,"clip",function(){return this._clips[this._defaultClipIndex]},function(e){var t=e?this._clips.indexOf(e):-1;this._defaultClipIndex!==t&&(-1!==this._defaultClipIndex&&this.removeClip(this._clips[this._defaultClipIndex]),-1!==t&&this.addClip(e,e.name),this._defaultClipIndex=t)}),a(0,o,"currentFrameIndex",function(){return this._currentFrameIndex}),a(0,o,"cachePlayRate",function(){return this._cachePlayRate},function(e){if(this._cachePlayRate!==e){this._cachePlayRate=e;for(var t=0,n=this._clips.length;n>t;t++)this._clips[t].loaded&&this._computeCacheFullKeyframeIndices(t)}}),a(0,o,"currentFrameTime",function(){return this._currentFrameTime}),a(0,o,"currentPlayClip",function(){return this._currentPlayClip}),a(0,o,"currentPlayTime",function(){return this._currentTime+this._playStartFrames[this._currentPlayClipIndex]/this._currentPlayClip._frameRate}),a(0,o,"playbackTime",null,function(e){if(null!=this._currentPlayClip&&this._currentPlayClip&&this._currentPlayClip.loaded){this._startUpdateLoopCount=C.loopCount;var t=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=e,this._currentFrameIndex=Math.floor(this.currentPlayTime/t),this._currentFrameTime=this._currentFrameIndex*t}}),a(0,o,"paused",function(){return this._stoped},function(e){this._stoped=e,e&&this.event("paused")}),i(t,["deafaultMatrix",function(){return this.deafaultMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Float32Array(16)}]),t}(Zn),Ei=(function(e){function t(){this._attachSkeleton=null,this._extenData=null,this.attachBones=null,this.matrixs=null,t.__super.call(this),this.attachBones=[],this.matrixs=[]}r(t,"laya.d3.component.AttachPoint",e);var n=t.prototype;return n._load=function(t){e.prototype._load.call(this,t),this._attachSkeleton=t.getComponentByType(zi)},n._update=function(){if(this._attachSkeleton&&!this._attachSkeleton.destroyed&&0!==this._attachSkeleton.player.state&&this._attachSkeleton.curBonesDatas){var e=this._attachSkeleton.player,t=this._attachSkeleton.templet;this.matrixs.length=this.attachBones.length;for(var n=this._attachSkeleton.curBonesDatas,i=this.owner.transform.worldMatrix,r=0,a=this.attachBones.length;a>r;r++){var o=16*t.getNodeIndexWithName(e.currentAnimationClipIndex,this.attachBones[r]),s=this.matrixs[r];s||(s=this.matrixs[r]=new xn);for(var l=s.elements,u=0;16>u;u++)l[u]=n[o+u];xn.multiply(i,s,s)}this.event("complete")}},t}(Zn),function(e){function t(){t.__super.call(this),this._isRigidbody=!1,this._runtimeCollisonMap={},this._runtimeCollisonTestMap={},this._ignoreCollisonMap={},this.isTrigger=!0}r(t,"laya.d3.component.physics.Collider",e);var n=t.prototype;return n._clearCollsionMap=function(){for(var e in this._runtimeCollisonMap){var t=this._runtimeCollisonMap[e];delete t._runtimeCollisonMap[this.id],t._isRigidbody&&delete t._runtimeCollisonTestMap[this.id];var n=t.id;delete this._runtimeCollisonMap[n],this._isRigidbody&&delete this._runtimeCollisonTestMap[n]}},n._unload=function(){for(var e in this._runtimeCollisonMap){var t=this._runtimeCollisonMap[e];delete t._runtimeCollisonMap[this.id],t._isRigidbody&&delete t._runtimeCollisonTestMap[this.id],delete this._ignoreCollisonMap[e]._ignoreCollisonMap[this.id]}},n._setIsRigidbody=function(e){if(this._isRigidbody!==e){this._isRigidbody=e;var t=this._owner;if(t.displayedInStage){var n=t.layer;n._removeCollider(this),n._addCollider(this)}}},n._getType=function(){return-1},n._collisonTo=function(){return!1},n.raycast=function(e,t,n){throw void 0===n&&(n=1.79e308),new Error("Collider:Must override it.")},a(0,n,"enable",e.prototype._$get_enable,function(e){if(this._enable!==e){var t=this._owner;t.displayedInStage&&(e||this._clearCollsionMap()),this._enable=e,this.event("enablechanged",this._enable)}}),a(0,n,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!1,t}(Zn)),vi=function(e){function t(){t.__super.call(this)
}r(t,"laya.d3.component.Rigidbody",e);var n=t.prototype;return a(0,n,"enable",e.prototype._$get_enable,function(e){if(this._enable!==e){for(var t=this._owner._colliders,n=0,i=t.length;i>n;n++){var r=t[n];r._setIsRigidbody(e);var a=r._runtimeCollisonMap,o=r._runtimeCollisonTestMap;if(!e)for(var s in a)delete o[s]}this._enable=e,this.event("enablechanged",this._enable)}}),t}(Zn),gi=(function(e){function t(){t.__super.call(this)}r(t,"laya.d3.component.Script",e);var n=t.prototype;return n.onTriggerEnter=function(){},n.onTriggerExit=function(){},n.onTriggerStay=function(){},a(0,n,"isSingleton",function(){return t._isSingleton}),t._isSingleton=!1,t}(Zn),function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.core.GlitterRender",e);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},n._renderUpdate=function(e){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var t=this._owner.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,t);var n=this._owner.templet;return this._setShaderValueNumber(3,n.lifeTime),this._setShaderValueNumber(2,n._currentTime),!0},t}(jn),function(e){function t(e){this._owner=null,this._sharedMesh=null,t.__super.call(this),this._owner=e}r(t,"laya.d3.core.MeshFilter",e);var n=t.prototype;return n._sharedMeshLoaded=function(){this.event("loaded")},n._destroy=function(){e.prototype._destroy.call(this),this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)},a(0,n,"sharedMesh",function(){return this._sharedMesh},function(e){var t=this._sharedMesh;t&&t._removeReference(),this._sharedMesh=e,e._addReference(),this.event("meshchanged",[this,t,e]),e.loaded||this._sharedMesh.once("loaded",this,this._sharedMeshLoaded)}),a(0,n,"_isAsyncLoaded",function(){return this._sharedMesh.loaded}),a(0,n,"_originalBoundingBoxCorners",function(){return this._sharedMesh.boundingBoxCorners}),a(0,n,"_originalBoundingSphere",function(){return this._sharedMesh.boundingSphere}),a(0,n,"_originalBoundingBox",function(){return this._sharedMesh.boundingBox}),t}(Kn)),Ti=function(e){function t(e){t.__super.call(this,e),e.meshFilter.on("meshchanged",this,this._onMeshChanged)}r(t,"laya.d3.core.MeshRender",e);var n=t.prototype;return n._onMeshChanged=function(e,t,n){n.loaded?this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0:n.once("loaded",this,this._onMeshLoaed)},n._onMeshLoaed=function(){this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0},n._calculateBoundingSphereByInitSphere=function(e){var t=0/0,n=this._owner.transform,i=n.scale.elements,r=Math.abs(i[0]),a=Math.abs(i[1]),o=Math.abs(i[2]);t=r>=a&&r>=o?r:a>=o?a:o,On.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*t},n._calculateBoundBoxByInitCorners=function(e){for(var t=this._owner.transform.worldMatrix,n=0;8>n;n++)On.transformCoordinate(e[n],t,jn._tempBoundBoxCorners[n]);En.createfromPoints(jn._tempBoundBoxCorners,this._boundingBox)},n._calculateBoundingSphere=function(){var e=this._owner.meshFilter.sharedMesh;null==e||null==e.boundingSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(e.boundingSphere)},n._calculateBoundingBox=function(){var e=this._owner.meshFilter.sharedMesh;null==e||null==e.boundingBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(e.boundingBoxCorners)},n._renderUpdate=function(e){var t=this._owner.transform;if(t){this._setShaderValueMatrix4x4(0,t.worldMatrix);var n=this._owner.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,n)}else this._setShaderValueMatrix4x4(0,xn.DEFAULT),this._setShaderValueMatrix4x4(1,e);return Xn.debugMode&&this._renderRenderableBoundBox(),!0},t}(jn),Si=function(e){function t(e){t.__super.call(this),this._tempRotationMatrix=new xn,this._uvLength=new Cn,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=e,this._ownerRender=e.particleRender,this._boundingBoxCorners=o(8,null),this._boundingSphere=new gn(new On,Number.MAX_VALUE),this._boundingBox=new En(new On(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new On(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new Q,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new Q,this._startLifeTimeGradientMax=new Q,this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new On(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new On(0,0,0),this.startSizeConstantMaxSeparate=new On(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new On(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new On(0,0,0),this.startRotationConstantMaxSeparate=new On(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new Vn(1,1,1,1),this.startColorConstantMin=new Vn(1,1,1,1),this.startColorConstantMax=new Vn(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new In(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(t._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._emission=new X,this._emission.enbale=!0,this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",e);var s=t.prototype;return n.imps(s,{"laya.d3.core.render.IRenderable":!0,"laya.d3.core.IClone":!0}),s._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},s._getIndexBuffer=function(){return this._indexBuffer},s._generateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},s._generateBoundingBox=function(){var e=this._owner,n=e.particleRender,i=this._boundingBox.min,r=this._boundingBox.max,a=0,o=0,s=0/0;switch(this.startLifetimeType){case 0:s=this.startLifetimeConstant;break;case 1:s=-Number.MAX_VALUE;var l=l;for(a=0,o=l.gradientCount;o>a;a++)s=Math.max(s,l.getValueByIndex(a));break;case 2:s=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:s=-Number.MAX_VALUE;var u=u;for(a=0,o=u.gradientCount;o>a;a++)s=Math.max(s,u.getValueByIndex(a));var c=c;for(a=0,o=c.gradientCount;o>a;a++)s=Math.max(s,c.getValueByIndex(a))}var h=0/0,d=0/0;switch(this.startSpeedType){case 0:h=d=this.startSpeedConstant;break;case 1:break;case 2:h=this.startLifetimeConstantMin,d=this.startLifetimeConstantMax;break;case 3:}var _,f,m,p;this._shape&&this._shape.enable||(_=f=On.ZERO,m=On.ZERO,p=On.UnitZ);var E=new On(m.x*h,m.y*h,m.z*h),v=new On(p.x*d,p.y*d,p.z*d);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var g,T,S=this._velocityOverLifetime.velocity;switch(S.type){case 0:g=T=S.constant;break;case 1:g=T=new On(S.gradientX.getAverageValue(),S.gradientY.getAverageValue(),S.gradientZ.getAverageValue());break;case 2:g=S.constantMin,T=S.constantMax;break;case 3:g=new On(S.gradientXMin.getAverageValue(),S.gradientYMin.getAverageValue(),S.gradientZMin.getAverageValue()),T=new On(S.gradientXMax.getAverageValue(),S.gradientYMax.getAverageValue(),S.gradientZMax.getAverageValue())}}var D,x,M=this._owner.transform,R=M.position,A=t._tempVector39,I=A.elements,y=n.renderMode;switch(this.scaleMode){case 0:var C=M.scale;D=C,I[0]=C.x,I[1]=C.z,I[2]=C.y,1===y&&(x=C);break;case 1:var O=M.localScale;D=O,I[0]=O.x,I[1]=O.z,I[2]=O.y,1===y&&(x=O);break;case 2:D=M.scale,I[0]=I[1]=I[2]=1,1===y&&(x=On.ONE)}var V,L;switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(V=new On(E.x*s,E.y*s,E.z*s),L=new On(v.x*s,v.y*s,v.z*s),2!=this.scaleMode?(On.add(_,V,i),On.multiply(D,i,i),On.add(f,L,r),On.multiply(D,r,r)):(On.multiply(D,_,i),On.add(i,V,i),On.multiply(D,f,r),On.add(r,L,r))),this.simulationSpace){case 0:break;case 1:On.add(i,R,i),On.add(r,R,r)}var P=0/0,w=0/0;switch(this.startSizeType){case 0:if(this.threeDStartSize){var N=N;P=Math.max(N.x,N.y),1===y&&(w=N.y)}else P=this.startSizeConstant,1===y&&(w=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var F=F;P=Math.max(F.x,F.y),1===y&&(w=F.y)}else P=this.startSizeConstantMax,1===y&&(w=this.startSizeConstantMax);break;case 3:}if(this._sizeOverLifetime&&this._sizeOverLifetime.enbale){{this._sizeOverLifetime.size}P*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var b=t._tempVector30,B=b.elements,U=0/0,H=0/0;switch(y){case 0:U=P*t.halfKSqrtOf2,On.scale(A,P,b),On.subtract(i,b,i),On.add(r,b,r);break;case 1:var G=t._tempVector31,z=t._tempVector32,W=t._tempVector33,k=t._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(On.multiply(x,v,z),On.multiply(x,E,W));var X=w*n.stretchedBillboardLengthScale,Y=On.scalarLength(z)*n.stretchedBillboardSpeedScale+X,Z=On.scalarLength(W)*n.stretchedBillboardSpeedScale+X,K=t._tempVector35,j=t._tempVector36;On.normalize(z,K),On.scale(K,Y,k),On.subtract(L,k,k),On.normalize(W,j),On.scale(j,Z,G),On.add(V,G,G),U=P*t.halfKSqrtOf2,On.scale(A,U,b);var q=t._tempVector37,Q=t._tempVector38;On.scale(K,.5,q),On.scale(j,.5,Q),On.multiply(q,A,q),On.multiply(Q,A,Q),On.add(i,Q,i),On.min(i,k,i),On.subtract(i,b,i),On.subtract(r,q,r),On.max(r,G,r),On.add(r,b,r);break;case 2:P*=Math.cos(.7853981633974483),H=.5*P,B[0]=A.x*H,B[1]=A.z*H,On.subtract(i,b,i),On.add(r,b,r);break;case 3:P*=Math.cos(.7853981633974483),H=.5*P,On.scale(A,H,b),On.subtract(i,b,i),On.add(r,b,r)}this._boundingBox.getCorners(this._boundingBoxCorners)},s._updateEmission=function(){if(n.stage.isVisibility&&this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var e=this._startUpdateLoopCount===C.loopCount||this._isPaused?0:n.timer.delta/1e3;e=Math.min(t._maxElapsedTime,e),this._updateParticles(e)}},s._updateParticles=function(e){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay||this._emission.enbale&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime))},s._updateParticlesSimulationRestart=function(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=e;var t=e;return t<this._playStartDelay?(this._totalDelayTime=t,void 0):(this._emission.enbale&&this._advanceTime(e,e),void 0)},s._addUpdateEmissionToTimer=function(){n.timer.frameLoop(1,this,this._updateEmission)},s._removeUpdateEmissionToTimer=function(){n.timer.clear(this,this._updateEmission)},s._onOwnerActiveHierarchyChanged=function(e){this._owner.displayedInStage&&(e?this._addUpdateEmissionToTimer():this._removeUpdateEmissionToTimer())},s._retireActiveParticles=function(){for(var e=1e-4;this._firstActiveElement!=this._firstNewElement;){var t=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,n=t+this._timeIndex,i=this._currentTime-this._vertices[n];if(i+e<this._vertices[t+this._startLifeTimeIndex])break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},s._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&3>e)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},s._burst=function(e,t){for(var n=0,i=this._emission._bursts,r=i.length;this._burstsIndex<r;this._burstsIndex++){var a=i[this._burstsIndex],o=a.time;if(!(o>=e&&t>o))break;var s=0;this.autoRandomSeed?s=S.lerp(a.minCount,a.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],s=S.lerp(a.minCount,a.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),n+=s}return n},s._advanceTime=function(e,t){var n=0,i=this._emissionTime;this._emissionTime+=e;var r=0;if(this._emissionTime>this.duration){if(!this.looping){for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;r>n;n++)this.emit(t);return this._isPlaying=!1,this.stop(),void 0}r+=this._burst(i,this._emissionTime),this._emissionTime-=this.duration,this.event("complete"),this._burstsIndex=0,r+=this._burst(0,this._emissionTime)}else r+=this._burst(i,this._emissionTime);for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;r>n;n++)this.emit(t);var a=this.emission.emissionRate;if(a>0){var o=1/a;for(this._frameRateTime+=o,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=o;this._frameRateTime=Math.floor(t/o)*o}},s._initBufferDatas=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy());var e=this._ownerRender,t=e.renderMode;if(-1!==t&&this.maxParticles>0){var n,i,r=0,a=0,o=0,s=0,l=0,u=e.mesh;if(4===t){if(u){var c=u._vertexBuffers.length;if(c>1)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");i=dn.vertexDeclaration,this._floatCountPerVertex=i.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=u._vertexBuffers[0].vertexCount;var h=this._bufferMaxParticles*this._vertexStride,d=Math.floor(h/65535)+1,_=h%65535;if(d>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");this._vertexBuffer=Bi.create(i,_,35048),this._vertices=new Float32Array(this._floatCountPerVertex*_),this._indexStride=u._indexBuffer.indexCount;var f=u._indexBuffer.getData(),m=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=Fi.create("ushort",m,35044),n=new Uint16Array(m),s=0,r=0;r<this._bufferMaxParticles;r++){var p=r*this._vertexStride;for(a=0,o=f.length;o>a;a++)n[s++]=p+f[a]}this._indexBuffer.setData(n)}}else{for(i=hn.vertexDeclaration,this._floatCountPerVertex=i.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,this._vertexBuffer=Bi.create(i,this._bufferMaxParticles*this._vertexStride,35048),this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),r=0;r<this._bufferMaxParticles;r++)l=r*this._floatCountPerVertex*this._vertexStride,this._vertices[l]=-.5,this._vertices[l+1]=-.5,this._vertices[l+2]=0,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=-.5,this._vertices[l+2]=1,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=.5,this._vertices[l+2]=1,this._vertices[l+3]=0,l+=this._floatCountPerVertex,this._vertices[l]=-.5,this._vertices[l+1]=.5,this._vertices[l+2]=0,this._vertices[l+3]=0;for(this._indexStride=6,this._indexBuffer=Fi.create("ushort",6*this._bufferMaxParticles,35044),n=new Uint16Array(6*this._bufferMaxParticles),r=0;r<this._bufferMaxParticles;r++){s=6*r;var E=r*this._vertexStride,v=E+2;n[s++]=E,n[s++]=v,n[s++]=E+1,n[s++]=E,n[s++]=E+3,n[s++]=v}this._indexBuffer.setData(n)}}},s._destroy=function(){e.prototype._destroy.call(this),this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission._destroy(),this._owner=null,this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},s.emit=function(e){var n=t._tempPosition,i=t._tempDirection;if(this._shape&&this._shape.enable)this.autoRandomSeed?this._shape.generatePositionAndDirection(n,i):this._shape.generatePositionAndDirection(n,i,this._rand,this._randomSeeds);else{var r=n.elements,a=i.elements;r[0]=r[1]=r[2]=0,a[0]=a[1]=0,a[2]=1}return this.addParticle(n,i,e)},s.addParticle=function(e,t,n){On.normalize(t,t);var i=this._firstFreeElement+1;if(i>=this._bufferMaxParticles&&(i=0),i===this._firstRetiredElement)return!1;st.create(this,this._ownerRender,this._owner.transform);var r=this._currentTime-n;if(r>=st.startLifeTime)return!0;var a=0/0,o=0/0,s=0/0,l=0/0,u=0/0,c=0/0,h=0/0,d=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(d){var _=this._velocityOverLifetime.velocity.type;2===_||3===_?this.autoRandomSeed?(a=Math.random(),o=Math.random(),s=Math.random()):(this._rand.seed=this._randomSeeds[9],a=this._rand.getFloat(),o=this._rand.getFloat(),s=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):d=!1}else d=!1;var f=this._colorOverLifetime&&this._colorOverLifetime.enbale;if(f){var m=this._colorOverLifetime.color.type;3===m?this.autoRandomSeed?l=Math.random():(this._rand.seed=this._randomSeeds[10],l=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):f=!1}else f=!1;var p=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;if(p){var E=this._sizeOverLifetime.size.type;3===E?this.autoRandomSeed?u=Math.random():(this._rand.seed=this._randomSeeds[11],u=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):p=!1}else p=!1;var v=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(v){var g=this._rotationOverLifetime.angularVelocity.type;2===g||3===g?this.autoRandomSeed?c=Math.random():(this._rand.seed=this._randomSeeds[12],c=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):v=!1}else v=!1;var T=this._textureSheetAnimation&&this._textureSheetAnimation.enable;if(T){var S=this._textureSheetAnimation.frame.type;3===S?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[15],h=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):T=!1}else T=!1;var D,x=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,M=st.startUVInfo[0],R=st.startUVInfo[1],A=st.startUVInfo[2],I=st.startUVInfo[3],y=e.elements,C=t.elements,O=0,V=0,L=0,P=0,w=0,N=this._ownerRender;if(4===N.renderMode){var F=N.mesh._vertexBuffers[0];D=F.getData();var b=F.vertexDeclaration;V=b.getVertexElementByUsage(0).offset/4;var B=b.getVertexElementByUsage(1);L=B?B.offset/4:-1;var U=b.getVertexElementByUsage(2);P=U?U.offset/4:-1,O=b.vertexStride/4,w=0}else{this._vertices[x+2]=A,this._vertices[x+3]=I+R;var H=x+this._floatCountPerVertex;this._vertices[H+2]=A+M,this._vertices[H+3]=I+R;var G=H+this._floatCountPerVertex;this._vertices[G+2]=A+M,this._vertices[G+3]=I;var z=G+this._floatCountPerVertex;this._vertices[z+2]=A,this._vertices[z+3]=I}for(var W=x,k=x+this._floatCountPerVertex*this._vertexStride;k>W;W+=this._floatCountPerVertex){var X=0;if(4===N.renderMode){X=W;var Y=O*w++,Z=Y+V;this._vertices[X++]=D[Z++],this._vertices[X++]=D[Z++],this._vertices[X++]=D[Z],-1===L?(this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1):(Z=Y+L,this._vertices[X++]=D[Z++],this._vertices[X++]=D[Z++],this._vertices[X++]=D[Z++],this._vertices[X++]=D[Z]),-1===P?(this._vertices[X++]=0,this._vertices[X++]=0):(Z=Y+P,this._vertices[X++]=A+D[Z++]*M,this._vertices[X++]=I+D[Z]*R)}else X=W+4;switch(this._vertices[X++]=y[0],this._vertices[X++]=y[1],this._vertices[X++]=y[2],this._vertices[X++]=st.startLifeTime,this._vertices[X++]=C[0],this._vertices[X++]=C[1],this._vertices[X++]=C[2],this._vertices[X++]=n,this._vertices[X++]=st.startColor[0],this._vertices[X++]=st.startColor[1],this._vertices[X++]=st.startColor[2],this._vertices[X++]=st.startColor[3],this._vertices[X++]=st.startSize[0],this._vertices[X++]=st.startSize[1],this._vertices[X++]=st.startSize[2],this._vertices[X++]=st.startRotation[0],this._vertices[X++]=st.startRotation[1],this._vertices[X++]=st.startRotation[2],this._vertices[X++]=st.startSpeed,f&&(this._vertices[X+1]=l),p&&(this._vertices[X+2]=u),v&&(this._vertices[X+3]=c),T&&(this._vertices[X+4]=h),d&&(this._vertices[X+5]=a,this._vertices[X+6]=o,this._vertices[X+7]=s),this.simulationSpace){case 0:X+=8,this._vertices[X++]=st.simulationWorldPostion[0],this._vertices[X++]=st.simulationWorldPostion[1],this._vertices[X++]=st.simulationWorldPostion[2],this._vertices[X++]=st.simulationWorldRotation[0],this._vertices[X++]=st.simulationWorldRotation[1],this._vertices[X++]=st.simulationWorldRotation[2],this._vertices[X++]=st.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=i,!0},s.addNewParticlesToVertexBuffer=function(){var e=0;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(e=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},s._beforeRender=function(){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement?(this._vertexBuffer._bind(),this._indexBuffer._bind(),!0):!1},s._render=function(){var e=0,t=P.mainContext;this._firstActiveElement<this._firstFreeElement?(e=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,t.drawElements(4,e,5123,2*this._firstActiveElement*this._indexStride),C.trianglesFaces+=e/3,C.drawCall++):(e=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,t.drawElements(4,e,5123,2*this._firstActiveElement*this._indexStride),C.trianglesFaces+=e/3,C.drawCall++,this._firstFreeElement>0&&(e=this._firstFreeElement*this._indexStride,t.drawElements(4,e,5123,0),C.trianglesFaces+=e/3,C.drawCall++))},s.play=function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,n=this._randomSeeds.length;n>e;e++)this._randomSeeds[e]=this.randomSeed[0]+t._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=S.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=S.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=C.loopCount,this.event("played")},s.pause=function(){this._isPaused=!0,this.event("paused")},s.simulate=function(e,t){void 0===t&&(t=!0),this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()},s.stop=function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0,this.event("stopped")},s.cloneTo=function(e){var t=e;t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t._maxStartLifetime=this._maxStartLifetime,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.maxParticles=this.maxParticles,this._emission&&(t._emission=this._emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isEmitting=this._isEmitting,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameRateTime=this._frameRateTime,t._emissionTime=this._emissionTime,t._totalDelayTime=this._totalDelayTime,t._burstsIndex=this._burstsIndex},s.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},s._getVertexBuffers=function(){return null},a(0,s,"maxParticles",function(){return this._bufferMaxParticles-1},function(e){var t=e+1;t!==this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._initBufferDatas())}),a(0,s,"isEmitting",function(){return this._isEmitting}),a(0,s,"isAlive",function(){return this._isPlaying||this.aliveParticleCount>0?!0:!1}),a(0,s,"shape",function(){return this._shape},function(e){this._shape!==e&&(e&&e.enable?this._ownerRender._addShaderDefine(lr.SHADERDEFINE_SHAPE):this._ownerRender._removeShaderDefine(lr.SHADERDEFINE_SHAPE),this._shape=e)}),a(0,s,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.angularVelocity;if(!n)return;var i=n.separateAxes,r=n.type;if(e.enbale)switch(i?t._addShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t._addShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIME),r){case 0:t._addShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t._addShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t._addShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t._addShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIME),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(r){case 0:i?t._setShaderValueColor(35,n.constantSeparate):t._setShaderValueNumber(34,n.constant);break;case 1:i?(t._setShaderValueBuffer(37,n.gradientX._elements),t._setShaderValueBuffer(38,n.gradientY._elements),t._setShaderValueBuffer(39,n.gradientZ._elements),t._setShaderValueBuffer(40,n.gradientW._elements)):t._setShaderValueBuffer(36,n.gradient._elements);break;case 2:i?(t._setShaderValueColor(35,n.constantMinSeparate),t._setShaderValueColor(42,n.constantMaxSeparate)):(t._setShaderValueNumber(34,n.constantMin),t._setShaderValueNumber(41,n.constantMax));break;case 3:i?(t._setShaderValueBuffer(37,n.gradientXMin._elements),t._setShaderValueBuffer(44,n.gradientXMax._elements),t._setShaderValueBuffer(38,n.gradientYMin._elements),t._setShaderValueBuffer(45,n.gradientYMax._elements),t._setShaderValueBuffer(39,n.gradientZMin._elements),t._setShaderValueBuffer(46,n.gradientZMax._elements),t._setShaderValueBuffer(40,n.gradientWMin._elements),t._setShaderValueBuffer(47,n.gradientWMax._elements)):(t._setShaderValueBuffer(36,n.gradientMin._elements),t._setShaderValueBuffer(43,n.gradientMax._elements))}}else t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIME),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t._removeShaderDefine(lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),t._setShaderValueColor(35,null),t._setShaderValueColor(42,null),t._setShaderValueNumber(34,void 0),t._setShaderValueNumber(41,void 0),t._setShaderValueBuffer(37,null),t._setShaderValueBuffer(44,null),t._setShaderValueBuffer(38,null),t._setShaderValueBuffer(45,null),t._setShaderValueBuffer(39,null),t._setShaderValueBuffer(46,null),t._setShaderValueBuffer(40,null),t._setShaderValueBuffer(47,null),t._setShaderValueBuffer(36,null),t._setShaderValueBuffer(43,null);this._rotationOverLifetime=e}),a(0,s,"emission",function(){return this._emission}),a(0,s,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),a(0,s,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),a(0,s,"isPlaying",function(){return this._isPlaying
}),a(0,s,"isPaused",function(){return this._isPaused}),a(0,s,"startLifetimeType",function(){return this._startLifetimeType},function(e){var t=0,n=0;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(t=0,n=i.gradientCount;n>t;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var r=r;for(t=0,n=r.gradientCount;n>t;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(t));var a=a;for(t=0,n=a.gradientCount;n>t;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t))}this._startLifetimeType=e}),a(0,s,"_originalBoundingSphere",function(){return this._boundingSphere}),a(0,s,"startLifetimeConstant",function(){return this._startLifetimeConstant},function(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}),a(0,s,"startLifetimeConstantMin",function(){return this._startLifetimeConstantMin},function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}),a(0,s,"startLifeTimeGradient",function(){return this._startLifeTimeGradient},function(e){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,n=e.gradientCount;n>t;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}),a(0,s,"startLifetimeConstantMax",function(){return this._startLifetimeConstantMax},function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}),a(0,s,"startLifeTimeGradientMin",function(){return this._startLifeTimeGradientMin},function(e){if(3===this._startLifetimeType){var t=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=e.gradientCount;n>t;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,n=this._startLifeTimeGradientMax.gradientCount;n>t;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}),a(0,s,"startLifeTimeGradientMax",function(){return this._startLifeTimeGradientMax},function(e){if(3===this._startLifetimeType){var t=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=this._startLifeTimeGradientMin.gradientCount;n>t;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,n=e.gradientCount;n>t;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}),a(0,s,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.velocity,i=n.type;if(e.enbale)switch(i){case 0:t._addShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t._addShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t._addShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t._addShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t._removeShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t._removeShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t._removeShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t._removeShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(i){case 0:t._setShaderValueColor(13,n.constant);break;case 1:t._setShaderValueBuffer(14,n.gradientX._elements),t._setShaderValueBuffer(15,n.gradientY._elements),t._setShaderValueBuffer(16,n.gradientZ._elements);break;case 2:t._setShaderValueColor(13,n.constantMin),t._setShaderValueColor(17,n.constantMax);break;case 3:t._setShaderValueBuffer(14,n.gradientXMin._elements),t._setShaderValueBuffer(18,n.gradientXMax._elements),t._setShaderValueBuffer(15,n.gradientYMin._elements),t._setShaderValueBuffer(19,n.gradientYMax._elements),t._setShaderValueBuffer(16,n.gradientZMin._elements),t._setShaderValueBuffer(20,n.gradientZMax._elements)}t._setShaderValueInt(21,e.space)}else t._removeShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t._removeShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t._removeShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t._removeShaderDefine(lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),t._setShaderValueColor(13,null),t._setShaderValueBuffer(14,null),t._setShaderValueBuffer(15,null),t._setShaderValueBuffer(16,null),t._setShaderValueColor(13,null),t._setShaderValueColor(17,null),t._setShaderValueBuffer(14,null),t._setShaderValueBuffer(18,null),t._setShaderValueBuffer(15,null),t._setShaderValueBuffer(19,null),t._setShaderValueBuffer(16,null),t._setShaderValueBuffer(20,null),t._setShaderValueInt(21,void 0);this._velocityOverLifetime=e}),a(0,s,"colorOverLifetime",function(){return this._colorOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.color;if(e.enbale)switch(n.type){case 1:t._addShaderDefine(lr.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t._addShaderDefine(lr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t._removeShaderDefine(lr.SHADERDEFINE_COLOROVERLIFETIME),t._removeShaderDefine(lr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(n.type){case 1:var i=n.gradient;t._setShaderValueBuffer(22,i._alphaElements),t._setShaderValueBuffer(23,i._rgbElements);break;case 3:var r=n.gradientMin,a=n.gradientMax;t._setShaderValueBuffer(22,r._alphaElements),t._setShaderValueBuffer(23,r._rgbElements),t._setShaderValueBuffer(24,a._alphaElements),t._setShaderValueBuffer(25,a._rgbElements)}}else t._removeShaderDefine(lr.SHADERDEFINE_COLOROVERLIFETIME),t._removeShaderDefine(lr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t._setShaderValueBuffer(22,i._alphaElements),t._setShaderValueBuffer(23,i._rgbElements),t._setShaderValueBuffer(22,r._alphaElements),t._setShaderValueBuffer(23,r._rgbElements),t._setShaderValueBuffer(24,a._alphaElements),t._setShaderValueBuffer(25,a._rgbElements);this._colorOverLifetime=e}),a(0,s,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(e){var t=this._ownerRender;if(e){var n=e.size,i=n.separateAxes,r=n.type;if(e.enbale)switch(r){case 0:i?t._addShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t._addShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:i?t._addShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t._addShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t._removeShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t._removeShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t._removeShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t._removeShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(r){case 0:i?(t._setShaderValueBuffer(27,n.gradientX._elements),t._setShaderValueBuffer(28,n.gradientY._elements),t._setShaderValueBuffer(29,n.gradientZ._elements)):t._setShaderValueBuffer(26,n.gradient._elements);break;case 2:i?(t._setShaderValueBuffer(27,n.gradientXMin._elements),t._setShaderValueBuffer(31,n.gradientXMax._elements),t._setShaderValueBuffer(28,n.gradientYMin._elements),t._setShaderValueBuffer(32,n.gradientYMax._elements),t._setShaderValueBuffer(29,n.gradientZMin._elements),t._setShaderValueBuffer(33,n.gradientZMax._elements)):(t._setShaderValueBuffer(26,n.gradientMin._elements),t._setShaderValueBuffer(30,n.gradientMax._elements))}}else t._removeShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t._removeShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t._removeShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t._removeShaderDefine(lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),t._setShaderValueBuffer(27,null),t._setShaderValueBuffer(31,null),t._setShaderValueBuffer(28,null),t._setShaderValueBuffer(32,null),t._setShaderValueBuffer(29,null),t._setShaderValueBuffer(33,null),t._setShaderValueBuffer(26,null),t._setShaderValueBuffer(30,null);this._sizeOverLifetime=e}),a(0,s,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(e){var t=this._ownerRender;if(e){var n=e.frame,i=n.type;if(e.enable)switch(i){case 1:t._addShaderDefine(lr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:t._addShaderDefine(lr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else t._removeShaderDefine(lr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t._removeShaderDefine(lr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===i||3===i){t._setShaderValueInt(48,e.cycles);var r=e.tiles,a=this._uvLength.elements;a[0]=1/r.x,a[1]=1/r.y,t._setShaderValueVector2(49,this._uvLength)}switch(i){case 1:t._setShaderValueBuffer(50,n.frameOverTimeData._elements);break;case 3:t._setShaderValueBuffer(50,n.frameOverTimeDataMin._elements),t._setShaderValueBuffer(51,n.frameOverTimeDataMax._elements)}}else t._removeShaderDefine(lr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t._removeShaderDefine(lr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),t._setShaderValueInt(48,void 0),t._setShaderValueVector2(49,null),t._setShaderValueBuffer(50,null),t._setShaderValueBuffer(51,null);this._textureSheetAnimation=e}),a(0,s,"_vertexBufferCount",function(){return 1}),a(0,s,"triangleCount",function(){return this._indexBuffer?this._indexBuffer.indexCount/3:0}),a(0,s,"_originalBoundingBox",function(){return this._boundingBox}),a(0,s,"_originalBoundingBoxCorners",function(){return this._boundingBoxCorners}),t.halfKSqrtOf2=.71,i(t,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3},"_tempVector30",function(){return this._tempVector30=new On},"_tempVector31",function(){return this._tempVector31=new On},"_tempVector32",function(){return this._tempVector32=new On},"_tempVector33",function(){return this._tempVector33=new On},"_tempVector34",function(){return this._tempVector34=new On},"_tempVector35",function(){return this._tempVector35=new On},"_tempVector36",function(){return this._tempVector36=new On},"_tempVector37",function(){return this._tempVector37=new On},"_tempVector38",function(){return this._tempVector38=new On},"_tempVector39",function(){return this._tempVector39=new On},"_tempPosition",function(){return this._tempPosition=new On},"_tempDirection",function(){return this._tempDirection=new On}]),t}(Kn),Di=function(e){function t(e){this._finalGravity=new On,this._tempRotationMatrix=new xn,t.__super.call(this,e),this._defaultBoundBox=new En(new On,new On),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleRender",e);var i=t.prototype;return i._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},i._calculateBoundingSphere=function(){var e=this._owner.particleSystem._boundingSphere,t=0/0,n=this._owner.transform,i=n.scale.elements,r=Math.abs(i[0]),a=Math.abs(i[1]),o=Math.abs(i[2]);t=r>=a&&r>=o?r:a>=o?a:o,On.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*t},i._renderUpdate=function(){var e=this._owner.particleSystem;if(!n.stage.isVisibility||!e.isAlive)return!1;var t=this._owner.transform;switch(e.simulationSpace){case 0:break;case 1:this._setShaderValueColor(0,t.position),this._setShaderValueColor(1,t.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(e.scaleMode){case 0:var i=t.scale;this._setShaderValueColor(4,i),this._setShaderValueColor(5,i);break;case 1:var r=t.localScale;this._setShaderValueColor(4,r),this._setShaderValueColor(5,r);break;case 2:this._setShaderValueColor(4,t.scale),this._setShaderValueColor(5,On.ONE)}var a=this._finalGravity.elements,o=Hn.gravity.elements,s=e.gravityModifier;return a[0]=o[0]*s,a[1]=o[1]*s,a[2]=o[2]*s,this._setShaderValueBuffer(7,a),this._setShaderValueInt(11,e.simulationSpace),this._setShaderValueBool(8,e.threeDStartRotation),this._setShaderValueInt(6,e.scaleMode),this._setShaderValueInt(9,this.stretchedBillboardLengthScale),this._setShaderValueInt(10,this.stretchedBillboardSpeedScale),this._setShaderValueNumber(12,e._currentTime),Xn.debugMode&&this._renderRenderableBoundBox(),!0},i._destroy=function(){e.prototype._destroy.call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)},a(0,i,"boundingBox",function(){return this._owner.particleSystem.isAlive?(this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox):this._defaultBoundBox}),a(0,i,"renderMode",function(){return this._renderMode},function(e){if(this._renderMode!==e){switch(this._renderMode){case 0:this._removeShaderDefine(lr.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._removeShaderDefine(lr.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._removeShaderDefine(lr.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._removeShaderDefine(lr.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._removeShaderDefine(lr.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e,e){case 0:this._addShaderDefine(lr.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._addShaderDefine(lr.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._addShaderDefine(lr.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._addShaderDefine(lr.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._addShaderDefine(lr.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}this._owner.particleSystem._initBufferDatas()}}),a(0,i,"mesh",function(){return this._mesh},function(e){this._mesh!==e&&(this._mesh&&this._mesh._removeReference(),this._mesh=e,e&&e._addReference(),this._owner.particleSystem._initBufferDatas())}),t}(jn),xi=(function(e){function t(){}r(t,"laya.d3.core.trail.TrailFilter",e);var n=t.prototype;return n.getRenderElementsCount=function(){},n.addRenderElement=function(){},n.getRenderElement=function(){},n._update=function(){},n.reset=function(){},n._destroy=function(){},a(0,n,"widthMultiplier",function(){}),a(0,n,"time",function(){}),a(0,n,"widthCurve",function(){}),a(0,n,"minVertexDistance",function(){}),a(0,n,"colorGradient",function(){}),a(0,n,"textureMode",function(){}),t}(Kn),function(e){function t(){}r(t,"laya.d3.core.trail.TrailRenderer",e);var n=t.prototype;return n._calculateBoundingBox=function(){},n._calculateBoundingSphere=function(){},n._renderUpdate=function(){},t}(jn),function(e){function t(){}r(t,"laya.d3.extension.domino.DominoFilter",e);var n=t.prototype;return n.addDomino=function(){},n.updateDomino=function(){},n.updateDominos=function(){},n.addDominoRenderElement=function(){},n.getDominoRenderElementsCount=function(){},n.getRenderElement=function(){},n._update=function(){},n.initPositionsAndNormal=function(){},t._positions=[],t._normals=[],t}(Kn),function(e){function t(){}r(t,"laya.d3.extension.lineRender.LineFilter",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i.addPosition=function(){},i._updateVertexBuffer1=function(){},i._updateVertexBuffer2=function(){},i._updateVertexBuffer3=function(){},i._beforeRender=function(){},i._render=function(){},i._updateVertices2=function(){},i._initData=function(){},i._update=function(){},i._getVertexBuffer=function(){},i._getVertexBuffers=function(){},i._getIndexBuffer=function(){},i._destroy=function(){},a(0,i,"widthCurve",function(){}),a(0,i,"useWorldSpace",function(){}),a(0,i,"triangleCount",function(){}),a(0,i,"widthMultiplier",function(){}),a(0,i,"colorGradient",function(){}),a(0,i,"textureMode",function(){}),a(0,i,"_vertexBufferCount",function(){}),t}(Kn)),Mi=(function(e){function t(){}r(t,"laya.d3.extension.domino.DominoRenderer",e);var n=t.prototype;return n._calculateBoundingBox=function(){},n._calculateBoundingSphere=function(){},n._renderUpdate=function(){},t}(jn),function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.extension.lineRender.LineRenderer",e);var n=t.prototype;return n._calculateBoundingBox=function(){var e=this._boundingBox.min.elements;e[0]=-Number.MAX_VALUE,e[1]=-Number.MAX_VALUE,e[2]=-Number.MAX_VALUE;var t=this._boundingBox.min.elements;t[0]=Number.MAX_VALUE,t[1]=Number.MAX_VALUE,t[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var e=this._boundingSphere.center.elements;e[0]=0,e[1]=0,e[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},n._renderUpdate=function(e){var t=this._owner.transform;if(t){this._setShaderValueMatrix4x4(0,t.worldMatrix);var n=this._owner.getProjectionViewWorldMatrix(e);this._setShaderValueMatrix4x4(1,n)}else this._setShaderValueMatrix4x4(0,xn.DEFAULT),this._setShaderValueMatrix4x4(1,e);return!0},t}(jn)),Ri=(function(e){function t(e){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0/0,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=0/0,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=0/0,this.lifeTime=0/0,this.minSegmentDistance=0/0,this.minInterpDistance=0/0,this.maxSlerpCount=0,this._maxSegments=0,t.__super.call(this),this._tempVector0=new On,this._tempVector1=new On,this._tempVector2=new On,this._tempVector3=new On,this._posModeLastPosition0=new On,this._posModeLastPosition1=new On,this._posModePosition0=new On,this._posModePosition1=new On,this._posVelModePosition0=new On,this._posVelModeVelocity0=new On,this._posVelModePosition1=new On,this._posVelModeVelocity1=new On,this._owner=e,this._lastTime=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this._lastPatchAddPos0=new On,this._lastPatchAddPos1=new On,this.scLeft=new G,this.scRight=new G,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this._maxSegments=200,this._owner.on("activeinhierarchychanged",this,this._onActiveHierarchyChanged)}r(t,"laya.d3.resource.tempelet.GlitterTemplet",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},i._getIndexBuffer=function(){return null},i._initialize=function(){this._vertexBuffer=Bi.create(Rt.vertexDeclaration,2*this.maxSegments,35048),this._vertices=new Float32Array(this.maxSegments*this._floatCountPerVertex*2)},i._onActiveHierarchyChanged=function(e){e||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},i._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},i._updateSubTextureCoordinates=function(e,t){for(var n=2*e,i=0;t>i;i+=2){var r=n+i,a=r*this._floatCountPerVertex,o=(r+1)*this._floatCountPerVertex;this._vertices[a+3]=this._vertices[o+3]=(this._vertices[a+5]-this._currentTime)/this.lifeTime}},i._retireActiveGlitter=function(){for(var e=this.lifeTime,t=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var n=this._firstActiveElement*t+5,i=this._currentTime-this._vertices[n];if(e>i)break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.maxSegments&&(this._firstActiveElement=0)}},i._freeRetiredGlitter=function(){for(var e=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement;){var t=this._drawCounter-this._vertices[this._firstRetiredElement*e+5];if(3>t)break;this._firstRetiredElement++,this._firstRetiredElement>=this.maxSegments&&(this._firstRetiredElement=0)}},i._calcVelocity=function(e,t,n){On.subtract(e,t,n),On.scale(n,.5,n)},i._addNewGlitterSegementToVertexBuffer=function(){var e=0;this._firstActiveElement<this._firstFreeElement?(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(e=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,e,e,2*(this.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},i._addGlitter=function(e,t,n){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));var i=this._firstFreeElement+1;i>=this.maxSegments&&(i=0,e.cloneTo(this._lastPatchAddPos0),t.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=n,this._needPatch=!0),i===this._firstRetiredElement&&console.log("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency.");var r=e.elements,a=t.elements,o=0,s=this._firstFreeElement*this._floatCountPerVertex*2;for(o=0;3>o;o++)this._vertices[s+o]=r[o];this._vertices[s+3]=0,this._vertices[s+4]=0,this._vertices[s+5]=n;var l=s+this._floatCountPerVertex;for(o=0;3>o;o++)this._vertices[l+o]=a[o];this._vertices[l+3]=0,this._vertices[l+4]=1,this._vertices[l+5]=n,this._firstFreeElement=i},i._update=function(e){this._currentTime+=e/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},i._beforeRender=function(){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement?(this._vertexBuffer.bindWithIndexBuffer(null),!0):!1},i._render=function(){var e=0,t=P.mainContext;this._firstActiveElement<this._firstFreeElement?(e=2*(this._firstFreeElement-this._firstActiveElement),t.drawArrays(5,2*this._firstActiveElement,e),C.trianglesFaces+=e-2,C.drawCall++):(e=2*(this.maxSegments-this._firstActiveElement),t.drawArrays(5,2*this._firstActiveElement,e),C.trianglesFaces+=e-2,C.drawCall++,this._firstFreeElement>0&&(e=2*this._firstFreeElement,t.drawArrays(5,0,e),C.trianglesFaces+=e-2,C.drawCall++))},i.addVertexPosition=function(e,t){if(this._owner.activeInHierarchy)if(this._numPositionMode<2)0===this._numPositionMode?(e.cloneTo(this._posModeLastPosition0),t.cloneTo(this._posModeLastPosition1)):(e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)),this._numPositionMode++;else{var n=this._tempVector2;this._calcVelocity(e,this._posModeLastPosition0,n);var i=this._tempVector3;this._calcVelocity(t,this._posModeLastPosition1,i),this.addVertexPositionVelocity(this._posModePosition0,n,this._posModePosition1,i),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),e.cloneTo(this._posModePosition0),t.cloneTo(this._posModePosition1)}},i.addVertexPositionVelocity=function(e,t,n,i){if(this._owner.activeInHierarchy){if(0===this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r=this._tempVector0;On.subtract(e,this._posVelModePosition0,r);var a=On.scalarLength(r);On.subtract(n,this._posVelModePosition1,r);var o=On.scalarLength(r),s=0,l=l;if(l>a&&l>o)return;if(s=1+Math.floor(Math.max(a,o)/this.minInterpDistance),1===s)this._addGlitter(e,n,this._currentTime);else{s=Math.min(s,this.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,e,t),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,n,i);for(var u=1/s,c=u,h=this._currentTime-this._lastTime,d=1;s>=d;d++){var _=this._tempVector0;this.scLeft.Slerp(c,_);var f=this._tempVector1;this.scRight.Slerp(c,f);var m=this._lastTime+h*d/s;this._addGlitter(_,f,m),c+=u}}}this._lastTime=this._currentTime,e.cloneTo(this._posVelModePosition0),t.cloneTo(this._posVelModeVelocity0),n.cloneTo(this._posVelModePosition1),i.cloneTo(this._posVelModeVelocity1)}},i._destroy=function(){e.prototype._destroy.call(this),this._tempVector0=null,this._tempVector1=null,this._tempVector2=null,this._tempVector3=null,this._owner=null,this._vertices=null,this._vertexBuffer.destroy(),this._vertexBuffer=null,this.scLeft=null,this.scRight=null,this._posModeLastPosition0=null,this._posModeLastPosition1=null,this._posModePosition0=null,this._posModePosition1=null,this._posVelModePosition0=null,this._posVelModeVelocity0=null,this._posVelModePosition1=null,this._posVelModeVelocity1=null,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null},i._getVertexBuffers=function(){return null},a(0,i,"maxSegments",function(){return this._maxSegments-1},function(e){var t=e+1;t!==this._maxSegments&&(this._maxSegments=t,this._vertexBuffer&&this._vertexBuffer.destroy(),this._initialize())}),a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){var e=0;return this._firstActiveElement<this._firstFreeElement?e=2*(this._firstFreeElement-this._firstActiveElement)-2:(e=2*(this.maxSegments-this._firstActiveElement)-2,e+=2*this._firstFreeElement-2),e}),a(0,i,"_originalBoundingSphere",function(){return n.superGet(Kn,this,"_originalBoundingSphere")}),a(0,i,"_originalBoundingBox",function(){return n.superGet(Kn,this,"_originalBoundingBox")}),t}(Kn),function(e){function t(){}r(t,"laya.d3.terrain.TerrainFilter",e);var o=t.prototype;return n.imps(o,{"laya.d3.core.render.IRenderable":!0}),o._destroy=function(){},o.recreateResource=function(){},o.setLODLevel=function(){},o.assembleIndexInit=function(){},o.isNeedAssemble=function(){},o.assembleIndex=function(){},o.calcOriginalBoudingBoxAndSphere=function(){},o.calcLeafBoudingBox=function(){},o.calcLeafBoudingSphere=function(){},o._getVertexBuffer=function(){},o._getIndexBuffer=function(){},o._beforeRender=function(){},o._getVertexBuffers=function(){},o._render=function(){},a(0,o,"_originalBoundingSphere",function(){}),a(0,o,"_originalBoundingBox",function(){}),a(0,o,"_vertexBufferCount",function(){}),a(0,o,"triangleCount",function(){}),i(t,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(Un.CHUNK_GRID_NUM/Un.LEAF_GRID_NUM*Un.CHUNK_GRID_NUM/Un.LEAF_GRID_NUM)}]),t}(Kn),function(e){function t(){}r(t,"laya.d3.terrain.TerrainRender",e);var n=t.prototype;return n._calculateBoundingSphere=function(){},n._calculateBoundingBox=function(){},n._renderUpdate=function(){},n._destroy=function(){},t}(jn),function(e){function t(e){t.__super.call(this,e)}r(t,"laya.d3.water.WaterRender",e);var n=t.prototype;return n._calculateBoundingSphere=function(){},n._calculateBoundingBox=function(){},n._destroy=function(){e.prototype._destroy.call(this)},t}(jn),function(e){function t(){this._time=0,this._enableLightCount=3,this._customRenderQueneIndex=11,this.enableLight=!0,t.__super.call(this),this._renderState=new ht,this._lights=[],this._quenes=[],this._cameraPool=[],this._renderableSprite3Ds=[],this.__loaded=!0,this._lightmaps=[],this._shaderValues=new bn,this.parallelSplitShadowMaps=[],this._dynamicBatchManager=new gt,this._cullingRenders=[],this._cullingRendersLength=0,this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new On(.7,.7,.7),this.ambientColor=new On(.212,.227,.259),P.shaderHighPrecision&&this.addShaderDefine(ri.SHADERDEFINE_HIGHPRECISION),this.on("display",this,this._display),this.on("undisplay",this,this._unDisplay),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[]}r(t,"laya.d3.core.scene.Scene",e);var i=t.prototype;return n.imps(i,{"laya.webgl.submit.ISubmit":!0,"laya.resource.ICreateResource":!0}),i._setUrl=function(e){this._url=e},i._getGroup=function(){return this._group},i._setGroup=function(e){this._group=e},i._display=function(){n.stage._scenes.push(this),n.stage._scenes.sort(t._sortScenes);for(var e=0,i=this._childs.length;i>e;e++){var r=this._childs[e];r.active&&r._activeHierarchy()}},i._unDisplay=function(){var e=n.stage._scenes;e.splice(e.indexOf(this),1);for(var t=0,i=this._childs.length;i>t;t++){var r=this._childs[t];r.active&&r._inActiveHierarchy()}},i._addChild3D=function(e){e.transform._onWorldTransform(),e._setBelongScene(this),this.displayedInStage&&e.active&&e._activeHierarchy()},i._removeChild3D=function(e){e.transform.parent=null,this.displayedInStage&&e.active&&e._inActiveHierarchy(),e._setUnBelongScene()},i.initOctree=function(e,t,n,i,r){void 0===r&&(r=6),this.treeSize=new On(e,t,n),this.treeLevel=r,this.treeRoot=new dt(this,0),this.treeRoot.init(i,this.treeSize)},i._prepareUpdateToRenderState=function(e,t){t.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,t.scene=this},i._prepareSceneToRender=function(e){var t=this._lights.length;if(t>0)for(var n=0,i=0;t>i&&!(this._lights[i]._prepareToScene(e)&&(n++,n>=this._enableLightCount));i++);},i._updateChilds=function(e){for(var t=0,n=this._childs.length;n>t;++t)this._childs[t]._update(e)},i._preRenderScene=function(e,t,n){var i=t._viewMatrix,r=t._projectionMatrix,a=t._projectionViewMatrix,o=0,s=0,l=t.camera;for(l.useOcclusionCulling?this.treeRoot?Tt.renderObjectCullingOctree(n,this,l,i,r,a):Tt.renderObjectCulling(n,this,l,i,r,a):Tt.renderObjectCullingNoBoundFrustum(this,l,i,r,a),o=0,s=this._quenes.length;s>o;o++)this._quenes[o]&&this._quenes[o]._preRender(t)},i._clear=function(e,t){var n=t._viewport,i=t.camera,r=n.x,a=i.renderTargetSize.height-n.y-n.height,o=n.width,s=n.height;e.viewport(r,a,o,s);var l=256,u=i.renderTarget;switch(i.clearFlag){case 0:var c=i.clearColor;if(c){e.enable(3089),e.scissor(r,a,o,s);var h=c.elements;e.clearColor(h[0],h[1],h[2],h[3]),l|=16384}if(u)switch(c||(l=16384),u.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}e.clear(l),c&&e.disable(3089);break;case 1:case 2:if(u)switch(l=16384,u.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}e.clear(l);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},i._renderScene=function(e,t){var n,i=t.camera,r=0,a=0;for(r=0;2>r;r++)n=this._quenes[r],n&&(i.renderTarget?n._render(t,!0):n._render(t,!1));if(1===i.clearFlag){var o=i.sky;o&&(w.setCullFace(e,!1),w.setDepthFunc(e,515),w.setDepthMask(e,!1),o._render(t),w.setDepthFunc(e,513),w.setDepthMask(e,!0))}for(r=2,a=this._quenes.length;a>r;r++)n=this._quenes[r],n&&(n._sortAlpha(t.camera.transform.position),i.renderTarget?n._render(t,!0):n._render(t,!1))},i._set3DRenderConfig=function(e){e.disable(3042),w._blend=!1,e.blendFunc(770,771),w._sFactor=770,w._dFactor=771,e.disable(2929),w._depthTest=!1,e.enable(2884),w._cullFace=!0,e.depthMask(1),w._depthMask=!0,e.frontFace(2304),w._frontFace=2304},i._set2DRenderConfig=function(e){w.setBlend(e,!0),w.setBlendFunc(e,1,771),w.setDepthTest(e,!1),w.setCullFace(e,!1),w.setDepthMask(e,!0),w.setFrontFace(e,2305),e.viewport(0,0,M.width,M.height)},i._parseCustomProps=function(e,t,n,i){var r=i.customProps.lightmaps,a=r.length,o=this._lightmaps;
o.length=a;for(var s=0;a>s;s++)o[s]=g.getRes(t[r[s].replace(".exr",".png")]);this.setlightmaps(o);var l=i.customProps.ambientColor;l&&(this.ambientColor=new On(l[0],l[1],l[2]));var u=i.customProps.fogColor;u&&(this.fogColor=new On(u[0],u[1],u[2]))},i._addLight=function(e){this._lights.indexOf(e)<0&&this._lights.push(e)},i._removeLight=function(e){var t=this._lights.indexOf(e);t>=0&&this._lights.splice(t,1)},i._updateScene=function(){var e=this._renderState;this._prepareUpdateToRenderState(P.mainContext,e),this._updateComponents(e),this._updateChilds(e),this._lateUpdateComponents(e),this._time+=e.elapsedTime/1e3,this._shaderValues.setValue(22,this._time)},i._updateSceneConch=function(){var e=this._renderState;this._prepareUpdateToRenderState(P.mainContext,e),this._updateComponents(e),this._lateUpdateComponents(e),this._prepareSceneToRender(e);for(var t=0,n=this._cameraPool.length;n>t;t++){var i=this._cameraPool[t];e.camera=i,i._prepareCameraToRender()}},i._preRenderShadow=function(e,t,n,i,r){this.treeRoot?Tt.renderShadowObjectCullingOctree(this,t,n,i,r):Tt.renderShadowObjectCulling(this,t,n,i,r);for(var a=0,o=n.length;o>a;a++)n[a]&&n[a]._preRender(e)},i._renderShadowMap=function(e,t,n){var i=this.parallelSplitShadowMaps[0];i._calcAllLightCameraInfo(n);var r=i.PSSMNum;this._preRenderShadow(t,i._lightCulling,i._shadowQuenes,i._lightVPMatrix[0],r),this.addShaderDefine(Bn.SHADERDEFINE_CAST_SHADOW);var a,o,s;if(r>1)for(var l=0;r>l;l++)a=i.getRenderTarget(l+1),i.beginRenderTarget(l+1),e.clearColor(1,1,1,1),e.clear(16640),e.viewport(0,0,a.width,a.height),t.camera=s=i.getLightCamera(l),s._prepareCameraToRender(),s._prepareCameraViewProject(s.viewMatrix,s.projectionMatrix),t._projectionViewMatrix=i._lightVPMatrix[l+1],o=i._shadowQuenes[l],o._preRender(t),o._renderShadow(t,!1),i.endRenderTarget(l+1);else a=i.getRenderTarget(1),i.beginRenderTarget(1),e.clearColor(1,1,1,1),e.clear(16640),e.viewport(0,0,a.width,a.height),t.camera=s=i.getLightCamera(0),s._prepareCameraToRender(),s._prepareCameraViewProject(s.viewMatrix,s.projectionMatrix),t._projectionViewMatrix=i._lightVPMatrix[0],o=i._shadowQuenes[0],o._preRender(t),o._renderShadow(t,!0),i.endRenderTarget(1);this.removeShaderDefine(Bn.SHADERDEFINE_CAST_SHADOW)},i.addTreeNode=function(e){this.treeRoot.addTreeNode(e)},i.removeTreeNode=function(e){this.treeSize&&e._treeNode&&e._treeNode.removeObject(e)},i.setlightmaps=function(e){this._lightmaps=e;for(var t=0,n=this._renderableSprite3Ds.length;n>t;t++)this._renderableSprite3Ds[t]._render._applyLightMapParams()},i.getlightmaps=function(){return this._lightmaps},i.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),t>=0&&t<=this._childs.length){if(e._parent===this){var n=this.getChildIndex(e);this._childs.splice(n,1),this._childs.splice(t,0,e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,t)),this._childChanged()}else e.parent&&e.parent.removeChild(e),this._childs===D.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(t,0,e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,t),e.parent=this,this._addChild3D(e);return e}throw new Error("appendChildAt:The index is out of bounds")},i.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),e._parent===this){var t=this.getChildIndex(e);t!==this._childs.length-1&&(this._childs.splice(t,1),this._childs.push(e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,this._childs.length-1)),this._childChanged())}else e.parent&&e.parent.removeChild(e),this._childs===D.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,this._childs.length-1),e.parent=this,this._childChanged(),this._addChild3D(e);return e},i.removeChildAt=function(e){var t=this.getChildAt(e);return t&&(this._removeChild3D(t),this._childs.splice(e,1),this.conchModel&&this.conchModel.removeChild(t.conchModel),t.parent=null),t},i.removeChildren=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=2147483647),this._childs&&this._childs.length>0){var n=this._childs;if(0===e&&t>=a){var i=n;this._childs=D.ARRAY_EMPTY}else i=n.splice(e,t-e);for(var r=0,a=i.length;a>r;r++)this._removeChild3D(i[r]),i[r].parent=null,this.conchModel&&this.conchModel.removeChild(i[r].conchModel)}return this},i.addFrustumCullingObject=function(e){this.treeRoot?this.addTreeNode(e):(this._cullingRendersLength===this._cullingRenders.length?this._cullingRenders.push(e):this._cullingRenders[this._cullingRendersLength]=e,e._indexInSceneFrustumCullingObjects=this._cullingRendersLength++)},i.removeFrustumCullingObject=function(e){if(this.treeRoot)this.removeTreeNode(e);else{this._cullingRendersLength--;var t=e._indexInSceneFrustumCullingObjects;if(t!==this._cullingRendersLength){var n=this._cullingRenders[this._cullingRendersLength];this._cullingRenders[t]=n,n._indexInSceneFrustumCullingObjects=t,e._indexInSceneFrustumCullingObjects=-1}}},i.getRenderQueue=function(e){return 3e3>e?this._quenes[1]||(this._quenes[1]=new ct(this)):this._quenes[2]||(this._quenes[2]=new ct(this))},i.addRenderQuene=function(){this._quenes[this._customRenderQueneIndex++]=new ct(this)},i.addShaderDefine=function(e){this._shaderDefineValue|=e},i.removeShaderDefine=function(e){this._shaderDefineValue&=~e},i.addScript=function(e){return this._addComponent(e)},i.getScriptByType=function(e,t){return void 0===t&&(t=0),this._getComponentByType(e,t)},i.getScriptsByType=function(e,t){this._getComponentsByType(e,t)},i.getScriptByIndex=function(e){return this._getComponentByIndex(e)},i.removeScriptByType=function(e,t){void 0===t&&(t=0),this._removeComponentByType(e,t)},i.removeScriptsByType=function(e){this._removeComponentByType(e)},i.removeAllScript=function(){this._removeAllComponent()},i.render=function(e){x._context.ctx._renderKey=0,this._childs.length>0&&e.addRenderObject(this)},i.renderSubmit=function(){var e=P.mainContext,t=this._renderState;this._set3DRenderConfig(e),this._prepareSceneToRender(this._renderState);var n,i=0,r=0;if(Xn.debugMode||dt.debugMode)for(i=0,r=this._cameraPool.length;r>i;i++)n=this._cameraPool[i],Xn._debugPhasorSprite.begin(1,n),n.activeInHierarchy&&n._renderCamera(e,t,this),Xn._debugPhasorSprite.end();else for(i=0,r=this._cameraPool.length;r>i;i++)n=this._cameraPool[i],n.activeInHierarchy&&n._renderCamera(e,t,this);return this._set2DRenderConfig(e),1},i.onAsynLoaded=function(e,t){var n=t[0];if("Scene"!==n.type)throw new Error("Scene: the .lh file root type must be Scene,please use other function to  load  this file.");var i=t[1];kn._createNodeByJson(this,n,this,i),this.event("hierarchyloaded",[this]),this.__loaded=!0},i.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._renderState=null,this._lights=null,this._lightmaps=null,this._renderTargetTexture=null,this._shaderValues=null,this._cullingRenders=null,this._dynamicBatchManager=null,this._quenes=null,this._cameraPool=null,this._renderableSprite3Ds=null,this.treeRoot=null,this.treeSize=null,this.parallelSplitShadowMaps=null,this._typeComponentsIndices=null,this._components=null,g.clearRes(this.url),this.loaded||Xn._cancelLoadByUrl(this.url))},i.getRenderType=function(){return 0},i.releaseRender=function(){},i._addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=m.getInstance(e);t.push(this._components.length),this._components.push(i);var r=this;return i._initialize(r),i},i._removeComponent=function(e,t){var n=this._typeComponentsIndices[e],i=n[t],r=this._components[i];this._components.splice(i,1),n.splice(t,1),0===n.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1));for(var a=0,o=this._componentsMap.length;o>a;a++){n=this._typeComponentsIndices[a];for(var s=n.length-1;s>=0;s--){var l=n[s];if(!(l>i))break;n[s]=--l}}r._destroy()},i._getComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);return-1===n?null:this._components[this._typeComponentsIndices[n][t]]},i._getComponentsByType=function(e,t){var n=this._componentsMap.indexOf(e);if(-1===n)return t.length=0,void 0;var i=this._typeComponentsIndices[n],r=i.length;t.length=r;for(var a=0;r>a;a++)t[a]=this._components[i[a]]},i._getComponentByIndex=function(e){return this._components[e]},i._removeComponentByType=function(e,t){void 0===t&&(t=0);var n=this._componentsMap.indexOf(e);-1!==n&&this._removeComponent(n,t)},i._removeComponentsByType=function(e){var t=this._componentsMap.indexOf(e);if(-1!==t)for(var n=this._typeComponentsIndices[t],i=0,r=n.length;r>i;n.length<r?r--:i++)this._removeComponent(t,i)},i._removeAllComponent=function(){for(var e=0,t=this._componentsMap.length;t>e;this._componentsMap.length<t?t--:e++)this._removeComponentsByType(this._componentsMap[e])},i._updateComponents=function(e){for(var t=0,n=this._components.length;n>t;t++){var i=this._components[t];!i.started&&(i._start(e),i.started=!0),i.enable&&i._update(e)}},i._lateUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._lateUpdate(e)}},i._preRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},i._postRenderUpdateComponents=function(e){for(var t=0;t<this._components.length;t++){var n=this._components[t];!n.started&&(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}},a(0,i,"_loaded",null,function(e){this.__loaded=e}),a(0,i,"fogColor",function(){return this._fogColor},function(e){this._fogColor=e,this._shaderValues.setValue(0,e.elements)}),a(0,i,"enableFog",function(){return this._enableFog},function(e){this._enableFog!==e&&(this._enableFog=e,e?(this.addShaderDefine(ri.SHADERDEFINE_FOG),this.removeShaderDefine(ri.SAHDERDEFINE_DEPTHFOG)):this.removeShaderDefine(ri.SHADERDEFINE_FOG))}),a(0,i,"url",function(){return this._url}),a(0,i,"loaded",function(){return this.__loaded}),a(0,i,"enableDepthFog",function(){return this._enableDepthFog},function(e){this._enableDepthFog!=e&&(this._enableDepthFog=e,e?(this.addShaderDefine(ri.SAHDERDEFINE_DEPTHFOG),this.removeShaderDefine(ri.SHADERDEFINE_FOG)):this.removeShaderDefine(ri.SAHDERDEFINE_DEPTHFOG))}),a(0,i,"fogStart",function(){return this._fogStart},function(e){this._fogStart=e,this._shaderValues.setValue(1,e)}),a(0,i,"fogRange",function(){return this._fogRange},function(e){this._fogRange=e,this._shaderValues.setValue(2,e)}),a(0,i,"ambientColor",function(){return this._ambientColor},function(e){this._ambientColor=e,this._shaderValues.setValue(21,e.elements)}),a(0,i,"scene",function(){return this}),a(0,i,"renderableSprite3Ds",function(){return this._renderableSprite3Ds.slice()}),t._sortScenes=function(e,i){if(e.parent===n.stage&&i.parent===n.stage){var r=n.stage._childs;return r.indexOf(e)-r.indexOf(i)}return e.parent!==n.stage&&i.parent!==n.stage?t._sortScenes(e.parent,i.parent):e.parent===n.stage?-1:1},t.load=function(e){return n.loader.create(e,null,null,t)},t.FOGCOLOR=0,t.FOGSTART=1,t.FOGRANGE=2,t.LIGHTDIRECTION=3,t.LIGHTDIRCOLOR=4,t.POINTLIGHTPOS=5,t.POINTLIGHTRANGE=6,t.POINTLIGHTATTENUATION=7,t.POINTLIGHTCOLOR=8,t.SPOTLIGHTPOS=9,t.SPOTLIGHTDIRECTION=10,t.SPOTLIGHTSPOT=11,t.SPOTLIGHTRANGE=12,t.SPOTLIGHTATTENUATION=13,t.SPOTLIGHTCOLOR=14,t.SHADOWDISTANCE=15,t.SHADOWLIGHTVIEWPROJECT=16,t.SHADOWMAPPCFOFFSET=17,t.SHADOWMAPTEXTURE1=18,t.SHADOWMAPTEXTURE2=19,t.SHADOWMAPTEXTURE3=20,t.AMBIENTCOLOR=21,t.TIME=22,t}(y)),Ai=function(e){function t(e){t.__super.call(this),this.__loaded=!0,this._projectionViewWorldUpdateLoopCount=-1,this._activeInHierarchy=!1,this._projectionViewWorldMatrix=new xn,this._shaderValues=new bn,this._colliders=[],this._id=++t._uniqueIDCounter,this._transform=new qn(this),this.name=e?e:"Sprite3D-"+t._nameNumberCounter++,this.layer=z.currentCreationLayer,this.active=!0}r(t,"laya.d3.core.Sprite3D",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IUpdate":!0,"laya.resource.ICreateResource":!0,"laya.d3.core.IClone":!0}),i._setUrl=function(e){this._url=e},i._getGroup=function(){return this._group},i._setGroup=function(e){this._group=e},i._addChild3D=function(e){e.transform.parent=this.transform,this._hierarchyAnimator&&(!e._hierarchyAnimator&&e._setHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(e,!0,[e.name])),this._scene&&(e._setBelongScene(this._scene),this._activeInHierarchy&&e._active&&e._activeHierarchy())},i._removeChild3D=function(e){e.transform.parent=null,this._scene&&(this._activeInHierarchy&&e._active&&e._inActiveHierarchy(),e._setUnBelongScene()),this._hierarchyAnimator&&(e._hierarchyAnimator==this._hierarchyAnimator&&e._clearHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(e,!1,[e.name]))},i._parseBaseCustomProps=function(e){var t=this.transform.localPosition;t.fromArray(e.translate),this.transform.localPosition=t;var n=this.transform.localRotation;n.fromArray(e.rotation),this.transform.localRotation=n;var i=this.transform.localScale;i.fromArray(e.scale),this.transform.localScale=i;var r=e.layer;null!=r&&(this.layer=z.getLayerByNumber(r))},i._parseCustomComponent=function(e,t,n){for(var i in n){var r=n[i];switch(i){case"Animator":var a=this.addComponent(pi);if(r.avatarPath)a.avatar=g.getRes(t[r.avatarPath]);else{var o=r.avatar;if(o){a.avatar=g.getRes(t[o.path]);var s=o.linkSprites;s&&e.once("hierarchyloaded",this,this._onRootNodeHierarchyLoaded,[a,s])}}for(var l=r.clipPaths,u=l.length,c=0;u>c;c++)a.addClip(g.getRes(t[l[c]]));a.clip=g.getRes(t[l[0]]);var h=r.playOnWake;void 0!==h&&(a.playOnWake=h);break;case"Rigidbody":{this.addComponent(vi)}break;case"SphereCollider":var d=this.addComponent(Xi);d.isTrigger=r.isTrigger;var _=d.center;_.fromArray(r.center),d.center=_,d.radius=r.radius;break;case"BoxCollider":var f=this.addComponent(Wi);f.isTrigger=r.isTrigger,f.center.fromArray(r.center);var m=f.size;m.fromArray(r.size),f.size=m;break;case"MeshCollider":{this.addComponent(ki)}}}},i._onRootNodeHierarchyLoaded=function(e,t){for(var n in t){for(var i=this,r=t[n],a=0,o=r.length;o>a;a++){var s=r[a];if(""===s)break;if(i=i.getChildByName(s),!i)break}i&&e.linkSprite3DToAvatarNode(n,i)}},i._setHierarchyAnimator=function(e,t){this._changeHierarchyAnimator(e);for(var n=0,i=this._childs.length;i>n;n++){var r=this._childs[n];r._hierarchyAnimator==t&&r._setHierarchyAnimator(e,t)}},i._clearHierarchyAnimator=function(e,t){this._changeHierarchyAnimator(t);for(var n=0,i=this._childs.length;i>n;n++){var r=this._childs[n];r._hierarchyAnimator==e&&r._clearHierarchyAnimator(e,t)}},i._getAnimatorToLinkSprite3D=function(e,t,n){var i=this.getComponentByType(pi);if(i&&(i.avatar?i.avatar._version||e._setAnimatorToLinkAvatar(i,t):e._setAnimatorToLinkSprite3DNoAvatar(i,t,n)),this._parent&&this._parent instanceof laya.d3.core.Sprite3D){n.unshift(this._parent.name);var r=this._parent;r._hierarchyAnimator&&r._getAnimatorToLinkSprite3D(e,t,n)}},i._setAnimatorToLinkSprite3DNoAvatar=function(e,t,n){var i=0,r=0;for(i=0,r=e.getClipCount();r>i;i++)e._handleSpriteOwnersBySprite(i,t,n,this);for(i=0,r=this._childs.length;r>i;i++){var a=this._childs[i],o=n.length;n.push(a.name),a._setAnimatorToLinkSprite3DNoAvatar(e,t,n),n.splice(o,1)}},i._changeHierarchyAnimator=function(e){this._hierarchyAnimator=e},i._isLinkSpriteToAnimationNode=function(e,t,n){var i=e._avatarNodes.indexOf(t),r=e._cacheSpriteToNodesMap;if(n)this._transform.dummy=t.transform,e._cacheNodesToSpriteMap[i]=r.length,r.push(i);else{this._transform.dummy=null;var a=e._cacheNodesToSpriteMap[i];e._cacheNodesToSpriteMap[i]=null,r.splice(a,1)}},i._setBelongScene=function(e){this._scene=e;for(var t=0,n=this._childs.length;n>t;t++)this._childs[t]._setBelongScene(e)},i._setUnBelongScene=function(){this._scene=null;for(var e=0,t=this._childs.length;t>e;e++)this._childs[e]._setUnBelongScene()},i._activeHierarchy=function(){var e=0,t=0;for(this._activeInHierarchy=!0,this._addSelfRenderObjects(),e=0,t=this._colliders.length;t>e;e++)this._layer._addCollider(this._colliders[e]);for(this.event("activeinhierarchychanged",!0),e=0,t=this._childs.length;t>e;e++){var n=this._childs[e];n._active&&n._activeHierarchy()}},i._inActiveHierarchy=function(){var e=0,t=0;for(this._activeInHierarchy=!1,this._clearSelfRenderObjects(),e=0,t=this._colliders.length;t>e;e++){var n=this._colliders[e];n._clearCollsionMap(),this._layer._removeCollider(n)}for(this.event("activeinhierarchychanged",!1),e=0,t=this._childs.length;t>e;e++){var i=this._childs[e];i._active&&i._inActiveHierarchy()}},i.addComponent=function(e){var t,n=this._componentsMap.indexOf(e);if(-1===n)t=[],this._componentsMap.push(e),this._typeComponentsIndices.push(t);else if(t=this._typeComponentsIndices[n],this._components[t[0]].isSingleton)throw new Error("无法单实例创建"+e+"组件，"+e+"组件已存在！");var i=m.getInstance(e);if(t.push(this._components.length),this._components.push(i),i instanceof laya.d3.component.physics.Collider){var r=this.getComponentByType(vi);r&&(i._isRigidbody=!0),this._activeInHierarchy&&this._layer._addCollider(i),this._colliders.push(i)}else if(i instanceof laya.d3.component.Animator){var a=i;this._setHierarchyAnimator(a,this._parent?this._parent._hierarchyAnimator:null),this._setAnimatorToLinkSprite3DNoAvatar(a,!0,[])}else if(i instanceof laya.d3.component.Rigidbody)for(var o=0,s=this._colliders.length;s>o;o++)this._colliders[o]._setIsRigidbody(!0);return i instanceof laya.d3.component.Script&&this._scripts.push(i),i._initialize(this),i},i._removeComponent=function(e,t){var n=0,i=0,r=this._typeComponentsIndices[e],a=r[t],o=this._components[a];if(o instanceof laya.d3.component.physics.Collider){var s=o;this._activeInHierarchy&&this._layer._removeCollider(s),this._colliders.splice(this._colliders.indexOf(s),1)}else if(o instanceof laya.d3.component.Animator){var l=o;this._clearHierarchyAnimator(l,this._parent?this._parent._hierarchyAnimator:null)}else if(o instanceof laya.d3.component.Rigidbody)for(n=0,i=this._colliders.length;i>n;n++){var u=this._colliders[n];u._setIsRigidbody(!1);var c=u._runtimeCollisonMap,h=u._runtimeCollisonTestMap;for(var d in c)delete h[d]}for(this._components.splice(a,1),o instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(o),1),r.splice(t,1),0===r.length&&(this._typeComponentsIndices.splice(e,1),this._componentsMap.splice(e,1)),n=0,i=this._componentsMap.length;i>n;n++){r=this._typeComponentsIndices[n];for(var _=r.length-1;_>=0;_--){var f=r[_];if(!(f>a))break;r[_]=--f}}o._destroy()},i._clearSelfRenderObjects=function(){},i._addSelfRenderObjects=function(){},i._parseCustomProps=function(){},i._updateChilds=function(e){var t=this._childs.length;if(0!==t)for(var n=0;t>n;++n)this._childs[n]._update(e)},i._getSortID=function(e,t){return 1e3*t.id+e._getVertexBuffer().vertexDeclaration.id},i._update=function(e){e.owner=this,this._activeInHierarchy&&(this._updateComponents(e),this._lateUpdateComponents(e),C.spriteCount++,this._childs.length&&this._updateChilds(e))},i.getProjectionViewWorldMatrix=function(e){return xn.multiply(e,this.transform.worldMatrix,this._projectionViewWorldMatrix),this._projectionViewWorldMatrix},i.loadHierarchy=function(e){this.addChild(laya.d3.core.Sprite3D.load(e))},i.addChildAt=function(e,t){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),t>=0&&t<=this._childs.length){if(e._parent===this){var n=this.getChildIndex(e);this._childs.splice(n,1),this._childs.splice(t,0,e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,t)),this._childChanged()}else e.parent&&e.parent.removeChild(e),this._childs===D.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(t,0,e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,t),e.parent=this,this._addChild3D(e);return e}throw new Error("appendChildAt:The index is out of bounds")},i.addChild=function(e){if(!(e instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!e||this.destroyed||e===this)return e;if(e.zOrder&&this._set$P("hasZorder",!0),e._parent===this){var t=this.getChildIndex(e);t!==this._childs.length-1&&(this._childs.splice(t,1),this._childs.push(e),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(e.conchModel,this._childs.length-1)),this._childChanged())}else e.parent&&e.parent.removeChild(e),this._childs===D.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(e),this.conchModel&&this.conchModel.addChildAt(e.conchModel,this._childs.length-1),e.parent=this,this._childChanged(),this._addChild3D(e);return e},i.removeChildAt=function(e){var t=this.getChildAt(e);return t&&(this._removeChild3D(t),this._childs.splice(e,1),this.conchModel&&this.conchModel.removeChild(t.conchModel),t.parent=null),t},i.removeChildren=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=2147483647),this._childs&&this._childs.length>0){var n=this._childs;if(0===e&&t>=a){var i=n;this._childs=D.ARRAY_EMPTY}else i=n.splice(e,t-e);for(var r=0,a=i.length;a>r;r++)this._removeChild3D(i[r]),i[r].parent=null,this.conchModel&&this.conchModel.removeChild(i[r].conchModel)}return this},i.onAsynLoaded=function(e,t){var n=t[0];if("Sprite3D"!==n.type)throw new Error("Sprite3D: The .lh file root type must be Sprite3D,please use other function to  load  this file.");var i=t[1];kn._createNodeByJson(this,n,this,i),this.event("hierarchyloaded",[this]),this.__loaded=!0},i.cloneTo=function(e){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var t=e;t.name=this.name,t._destroyed=this._destroyed,t.timer=this.timer,t._$P=this._$P,t.active=this._active;var n=t.transform.localPosition;this.transform.localPosition.cloneTo(n),t.transform.localPosition=n;var i=t.transform.localRotation;this.transform.localRotation.cloneTo(i),t.transform.localRotation=i;var r=t.transform.localScale;this.transform.localScale.cloneTo(r),t.transform.localScale=r,t.isStatic=this.isStatic;var a=0,o=0;for(a=0,o=this._componentsMap.length;o>a;a++){var s=t.addComponent(this._componentsMap[a]);this._components[a]._cloneTo(s)}for(a=0,o=this._childs.length;o>a;a++)t.addChild(this._childs[a].clone());var l=t.getComponentByType(pi);if(l){var u=l._linkSpritesData;if(u)for(var c in u){for(var h=u[c],d=t,_=0,f=h.length;f>_&&(d=d.getChildByName(h[_]),d);_++);if(d){var m=l._avatarNodeMap[c];d._isLinkSpriteToAnimationNode(l,m,!0)}}}},i.clone=function(){var e=new this.constructor;return this.cloneTo(e),e},i.destroy=function(e){if(void 0===e&&(e=!0),!this.destroyed){laya.display.Node.prototype.destroy.call(this,e);var t=0,n=0;for(t=0,n=this._components.length;n>t;t++)this._components[t]._destroy();this._components=null,this._componentsMap=null,this._typeComponentsIndices=null,this._transform=null,this._colliders=null,g.clearRes(this.url),this.loaded||Xn._cancelLoadByUrl(this.url)}},i._handleSpriteToAvatar=function(e,t){var n=(e._avatarNodes,e._avatarNodeMap[this.name]);n&&n.name===this.name&&!this._transform.dummy&&this._isLinkSpriteToAnimationNode(e,n,t)},i._setAnimatorToLinkAvatar=function(e,t){this._handleSpriteToAvatar(e,t);for(var n=0,i=this._childs.length;i>n;n++){var r=this._childs[n];r._setAnimatorToLinkAvatar(e,t)}},a(0,i,"activeInHierarchy",function(){return this._activeInHierarchy}),a(0,i,"_loaded",null,function(e){this.__loaded=e}),a(0,i,"active",function(){return this._active},function(e){this._active!==e&&(this._active=e,this._parent&&(this._parent===this._scene&&this._parent.displayedInStage||this._parent._activeInHierarchy)&&(e?this._activeHierarchy():this._inActiveHierarchy()))}),a(0,i,"componentsCount",function(){return this._components.length}),a(0,i,"loaded",function(){return this.__loaded}),a(0,i,"id",function(){return this._id}),a(0,i,"url",function(){return this._url}),a(0,i,"layer",function(){return this._layer},function(e){if(this._layer!==e){if(!e)throw new Error("Layer value can be null.");if(this._activeInHierarchy){var t=0,n=this._colliders.length;if(this._layer)for(t=0;n>t;t++)this._layer._removeCollider(this._colliders[t]);for(t=0;n>t;t++)e._addCollider(this._colliders[t])}this._layer=e,this.event("layerchanged",e)}}),a(0,i,"scene",function(){return this._scene}),a(0,i,"transform",function(){return this._transform}),t.instantiate=function(e,t,n,i,r){void 0===n&&(n=!0);var a=e.clone();t&&t.addChild(a);var o=a.transform;if(n){var s=o.worldMatrix;e.transform.worldMatrix.cloneTo(s),o.worldMatrix=s}else i&&(o.position=i),r&&(o.rotation=r);return a},t.load=function(e){return n.loader.create(e,null,null,t)},t.WORLDMATRIX=0,t.MVPMATRIX=1,t._uniqueIDCounter=0,t._nameNumberCounter=0,t}(si),Ii=function(e){function t(){t.__super.call(this),this.setShaderName("BLINNPHONG"),this._albedoIntensity=1,this._albedoColor=new Vn(1,1,1,1),this._setColor(6,new Vn(1,1,1,1)),this._setColor(8,new On(1,1,1)),this._setNumber(9,.078125),this._setColor(10,new On(1,1,1)),this._setNumber(0,.5),this._setColor(11,new Vn(1,1,0,0)),this._enableLighting=!0,this.renderMode=0}r(t,"laya.d3.core.material.BlinnPhongMaterial",e);var o=t.prototype;return o.disableLight=function(){this._addDisablePublicShaderDefine(ri.SHADERDEFINE_POINTLIGHT|ri.SHADERDEFINE_SPOTLIGHT|ri.SHADERDEFINE_DIRECTIONLIGHT)},o.disableFog=function(){this._addDisablePublicShaderDefine(ri.SHADERDEFINE_FOG)},o.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;n._enableLighting=this._enableLighting,n._albedoIntensity=this._albedoIntensity,this._albedoColor.cloneTo(n._albedoColor)},a(0,o,"renderMode",null,function(e){switch(e){case 0:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 1:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=2e3,this.alphaTest=!0,this.depthTest=513,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this.depthTest=513,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,o,"normalTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,e)}),a(0,o,"reflectColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),a(0,o,"tilingOffset",function(){return this._getColor(11)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(11,e)}),a(0,o,"specularColor",function(){return this._getColor(8)},function(e){this._setColor(8,e)}),a(0,o,"albedoColor",function(){return this._albedoColor},function(e){var t=this._getColor(6);Vn.scale(e,this._albedoIntensity,t),this._albedoColor=e}),a(0,o,"albedoIntensity",function(){return this._albedoIntensity},function(e){if(this._albedoIntensity!==e){var t=this._getColor(6);Vn.scale(this._albedoColor,e,t),this._albedoIntensity=e}}),a(0,o,"albedoTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),a(0,o,"shininess",function(){return this._getNumber(9)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(9,e)}),a(0,o,"specularTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,e)}),a(0,o,"reflectTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(5,e)}),a(0,o,"enableLighting",function(){return this._enableLighting},function(e){this._enableLighting!==e&&(e?this._removeDisablePublicShaderDefine(ri.SHADERDEFINE_POINTLIGHT|ri.SHADERDEFINE_SPOTLIGHT|ri.SHADERDEFINE_DIRECTIONLIGHT):this._addDisablePublicShaderDefine(ri.SHADERDEFINE_POINTLIGHT|ri.SHADERDEFINE_SPOTLIGHT|ri.SHADERDEFINE_DIRECTIONLIGHT),this._enableLighting=e)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSEMAP=t.shaderDefines.registerDefine("DIFFUSEMAP"),t.SHADERDEFINE_NORMALMAP=t.shaderDefines.registerDefine("NORMALMAP"),t.SHADERDEFINE_SPECULARMAP=t.shaderDefines.registerDefine("SPECULARMAP"),t.SHADERDEFINE_REFLECTMAP=t.shaderDefines.registerDefine("REFLECTMAP"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET"),t.SHADERDEFINE_ADDTIVEFOG=t.shaderDefines.registerDefine("ADDTIVEFOG")},t.load=function(e){return n.loader.create(e,null,null,t)},t.SPECULARSOURCE_DIFFUSEMAPALPHA=0,t.SPECULARSOURCE_SPECULARMAP=0,t.RENDERMODE_OPAQUE=0,t.RENDERMODE_CUTOUT=1,t.RENDERMODE_TRANSPARENT=2,t.RENDERMODE_ADDTIVE=3,t.SHADERDEFINE_DIFFUSEMAP=0,t.SHADERDEFINE_NORMALMAP=0,t.SHADERDEFINE_SPECULARMAP=0,t.SHADERDEFINE_REFLECTMAP=0,t.SHADERDEFINE_TILINGOFFSET=0,t.SHADERDEFINE_ADDTIVEFOG=0,t.ALBEDOTEXTURE=1,t.NORMALTEXTURE=2,t.SPECULARTEXTURE=3,t.EMISSIVETEXTURE=4,t.REFLECTTEXTURE=5,t.ALBEDOCOLOR=6,t.MATERIALSPECULAR=8,t.SHININESS=9,t.MATERIALREFLECT=10,t.TILINGOFFSET=11,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),yi=function(e){function t(){}r(t,"laya.d3.core.material.ExtendTerrainMaterial",e);var n=t.prototype;return n._setDetailNum=function(){},n.disableLight=function(){},a(0,n,"diffuseScaleOffset2",null,function(){}),a(0,n,"splatAlphaTexture",function(){}),a(0,n,"diffuseScaleOffset3",null,function(){}),a(0,n,"diffuseTexture1",null,function(){}),a(0,n,"renderMode",null,function(){}),a(0,n,"diffuseTexture2",function(){}),a(0,n,"diffuseScaleOffset1",null,function(){}),a(0,n,"diffuseTexture3",function(){}),a(0,n,"diffuseTexture4",function(){}),a(0,n,"diffuseTexture5",function(){}),a(0,n,"diffuseScaleOffset4",null,function(){}),a(0,n,"diffuseScaleOffset5",null,function(){}),a(0,n,"albedo",function(){}),a(0,n,"ambientColor",function(){}),a(0,n,"diffuseColor",function(){}),a(0,n,"specularColor",function(){}),t.__init__=function(){},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_TRANSPARENT=2,t.SPLATALPHATEXTURE=0,t.DIFFUSETEXTURE1=1,t.DIFFUSETEXTURE2=2,t.DIFFUSETEXTURE3=3,t.DIFFUSETEXTURE4=4,t.DIFFUSETEXTURE5=5,t.DIFFUSESCALEOFFSET1=6,t.DIFFUSESCALEOFFSET2=7,t.DIFFUSESCALEOFFSET3=8,t.DIFFUSESCALEOFFSET4=9,t.DIFFUSESCALEOFFSET5=10,t.MATERIALAMBIENT=11,t.MATERIALDIFFUSE=12,t.MATERIALSPECULAR=13,t.MATERIALALBEDO=14,t.SHADERDEFINE_DETAIL_NUM1=0,t.SHADERDEFINE_DETAIL_NUM2=0,t.SHADERDEFINE_DETAIL_NUM3=0,t.SHADERDEFINE_DETAIL_NUM4=0,t.SHADERDEFINE_DETAIL_NUM5=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)
}]),t}(ci),Ci=(function(e){function t(){}r(t,"laya.d3.core.material.GlitterMaterial",e);var n=t.prototype;return n.setShaderName=function(){},a(0,n,"renderMode",null,function(){}),a(0,n,"diffuseTexture",function(){}),a(0,n,"albedo",function(){}),a(0,n,"color",function(){}),t.load=function(){},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.DIFFUSETEXTURE=1,t.ALBEDO=2,t.UNICOLOR=3,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t}]),t}(ci),function(e){function t(e,n,i,r,a,o,s,l){if(this._curActTexIndex=0,this._program=null,this._attributeParams=null,this._uniformParams=null,this._attributeParamsMap=[],this._sceneUniformParamsMap=[],this._cameraUniformParamsMap=[],this._spriteUniformParamsMap=[],this._materialUniformParamsMap=[],this._renderElementUniformParamsMap=[],t.__super.call(this),!e||!n)throw"Shader Error";this._id=++t._count,this._vs=e,this._ps=n,this._attributeMap=i,this._sceneUniformMap=r,this._cameraUniformMap=a,this._spriteUniformMap=o,this._materialUniformMap=s,this._renderElementUniformMap=l,this.recreateResource()}r(t,"laya.d3.shader.Shader3D",e);var n=t.prototype;return n.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},n.disposeResource=function(){P.mainContext.deleteShader(this._vshader),P.mainContext.deleteShader(this._pshader),P.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._attributeParams=null,this._uniformParams=null,this.memorySize=0,this._curActTexIndex=0},n._compile=function(){if(this._vs&&this._ps&&!this._attributeParams&&!this._uniformParams){this._reCompile=!0,this._attributeParams=[],this._uniformParams=[];var e=[this._vs,this._ps],n=P.mainContext;if(this._program=n.createProgram(),this._vshader=t._createShader(n,e[0],35633),this._pshader=t._createShader(n,e[1],35632),n.attachShader(this._program,this._vshader),n.attachShader(this._program,this._pshader),n.linkProgram(this._program),!x.isConchApp&&ri.debugMode&&!n.getProgramParameter(this._program,35714))throw n.getProgramInfoLog(this._program);var i,r,a=0,o=0,s=0;for(s=x.isConchApp?n.getProgramParameterEx(this._vs,this._ps,"",35721):n.getProgramParameter(this._program,35721),a=0;s>a;a++){var l=null;l=x.isConchApp?n.getActiveAttribEx(this._vs,this._ps,"",a):n.getActiveAttrib(this._program,a),r=n.getAttribLocation(this._program,l.name),i={vartype:"attribute",ivartype:0,attrib:l,location:r,name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._attributeParams.push(i)}var u=0;for(u=x.isConchApp?n.getProgramParameterEx(this._vs,this._ps,"",35718):n.getProgramParameter(this._program,35718),a=0;u>a;a++){var c=null;c=x.isConchApp?n.getActiveUniformEx(this._vs,this._ps,"",a):n.getActiveUniform(this._program,a),r=n.getUniformLocation(this._program,c.name),i={vartype:"uniform",ivartype:1,attrib:l,location:r,name:c.name,type:c.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},i.name.indexOf("[0]")>0&&(i.name=i.name.substr(0,i.name.length-3),i.isArray=!0,i.location=n.getUniformLocation(this._program,i.name)),this._uniformParams.push(i)}for(a=0,o=this._attributeParams.length;o>a;a++)i=this._attributeParams[a],i.indexOfParams=a,i.index=1,i.value=[i.location,null],i.codename=i.name,i.name=null!=this._attributeMap[i.codename]?this._attributeMap[i.codename]:i.codename,this._attributeParamsMap.push(i.name),this._attributeParamsMap.push(i),i._this=this,i.uploadedValue=[],i.fun=this._attribute;for(a=0,o=this._uniformParams.length;o>a;a++)switch(i=this._uniformParams[a],i.indexOfParams=a,i.index=1,i.value=[i.location,null],i.codename=i.name,null!=this._sceneUniformMap[i.codename]?(i.name=this._sceneUniformMap[i.codename],this._sceneUniformParamsMap.push(i.name),this._sceneUniformParamsMap.push(i)):null!=this._cameraUniformMap[i.codename]?(i.name=this._cameraUniformMap[i.codename],this._cameraUniformParamsMap.push(i.name),this._cameraUniformParamsMap.push(i)):null!=this._spriteUniformMap[i.codename]?(i.name=this._spriteUniformMap[i.codename],this._spriteUniformParamsMap.push(i.name),this._spriteUniformParamsMap.push(i)):null!=this._materialUniformMap[i.codename]?(i.name=this._materialUniformMap[i.codename],this._materialUniformParamsMap.push(i.name),this._materialUniformParamsMap.push(i)):null!=this._renderElementUniformMap[i.codename]?(i.name=this._renderElementUniformMap[i.codename],this._renderElementUniformParamsMap.push(i.name),this._renderElementUniformParamsMap.push(i)):console.log("Shader:can't find uinform name:"+i.codename+" in shader file."),i._this=this,i.uploadedValue=[],i.type){case 5124:i.fun=i.isArray?this._uniform1iv:this._uniform1i;break;case 5126:i.fun=i.isArray?this._uniform1fv:this._uniform1f;break;case 35664:i.fun=i.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:i.fun=i.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:i.fun=i.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:i.fun=this._uniform_sampler2D;break;case 35680:i.fun=this._uniform_samplerCube;break;case 35676:i.fun=this._uniformMatrix4fv;break;case 35670:i.fun=this._uniform1i;break;case 35674:i.fun=this._uinformMatrix2fv;break;case 35675:i.fun=this._uinformMatrix3fv;break;default:throw new Error("compile shader err!")}}},n._attribute=function(e,t){var n=P.mainContext,i=_._enableAtributes,r=e.location;return i[r]||n.enableVertexAttribArray(r),n.vertexAttribPointer(r,t[0],t[1],t[2],t[3],t[4]),i[r]=_._bindVertexBuffer,1},n._uniform1f=function(e,t){var n=e.uploadedValue;return n[0]!==t?(P.mainContext.uniform1f(e.location,n[0]=t),1):0},n._uniform1fv=function(e,t){if(t.length<4){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(P.mainContext.uniform1fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0}return P.mainContext.uniform1fv(e.location,t),1},n._uniform_vec2=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]?(P.mainContext.uniform2f(e.location,n[0]=t[0],n[1]=t[1]),1):0},n._uniform_vec2v=function(e,t){if(t.length<2){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(P.mainContext.uniform2fv(e.location,t),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],1):0}return P.mainContext.uniform2fv(e.location,t),1},n._uniform_vec3=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]?(P.mainContext.uniform3f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},n._uniform_vec3v=function(e,t){return P.mainContext.uniform3fv(e.location,t),1},n._uniform_vec4=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(P.mainContext.uniform4f(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},n._uniform_vec4v=function(e,t){return P.mainContext.uniform4fv(e.location,t),1},n._uniformMatrix2fv=function(e,t){return P.mainContext.uniformMatrix2fv(e.location,!1,t),1},n._uniformMatrix3fv=function(e,t){return P.mainContext.uniformMatrix3fv(e.location,!1,t),1},n._uniformMatrix4fv=function(e,t){return P.mainContext.uniformMatrix4fv(e.location,!1,t),1},n._uinformMatrix2fv=function(e,t){return P.mainContext.uniformMatrix2fv(e.location,!1,t),1},n._uinformMatrix3fv=function(e,t){return P.mainContext.uniformMatrix3fv(e.location,!1,t),1},n._uniform1i=function(e,t){var n=e.uploadedValue;return n[0]!==t?(P.mainContext.uniform1i(e.location,n[0]=t),1):0},n._uniform1iv=function(e,t){return P.mainContext.uniform1iv(e.location,t),1},n._uniform_ivec2=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]?(P.mainContext.uniform2i(e.location,n[0]=t[0],n[1]=t[1]),1):0},n._uniform_ivec2v=function(e,t){return P.mainContext.uniform2iv(e.location,t),1},n._uniform_vec3i=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]?(P.mainContext.uniform3i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2]),1):0},n._uniform_vec3vi=function(e,t){return P.mainContext.uniform3iv(e.location,t),1},n._uniform_vec4i=function(e,t){var n=e.uploadedValue;return n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2]||n[3]!==t[3]?(P.mainContext.uniform4i(e.location,n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]),1):0},n._uniform_vec4vi=function(e,t){return P.mainContext.uniform4iv(e.location,t),1},n._uniform_sampler2D=function(e,n){var i=n.source||n.defaulteTexture.source,r=P.mainContext,a=e.uploadedValue;if(null==a[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return a[0]=this._curActTexIndex,r.uniform1i(e.location,this._curActTexIndex),r.activeTexture(t._TEXTURES[this._curActTexIndex]),i&&w.bindTexture(r,3553,i),this._curActTexIndex++,1}return r.activeTexture(t._TEXTURES[a[0]]),i&&w.bindTexture(r,3553,i),0},n._uniform_samplerCube=function(e,n){var i=n.source||n.defaulteTexture.source,r=P.mainContext,a=e.uploadedValue;if(null==a[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return a[0]=this._curActTexIndex,r.uniform1i(e.location,this._curActTexIndex),r.activeTexture(t._TEXTURES[this._curActTexIndex]),i?w.bindTexture(r,34067,i):w.bindTexture(r,34067,Qi.grayTexture.source),this._curActTexIndex++,1}return r.activeTexture(t._TEXTURES[a[0]]),i?w.bindTexture(r,34067,i):w.bindTexture(r,34067,Qi.grayTexture.source),0},n._noSetValue=function(e){console.log("no....:"+e.name)},n.bind=function(){return h.activeShader=this,h.bindShader=this,this.activeResource(),w.UseProgram(this._program)},n.uploadAttributes=function(e,t){for(var n,i,r=0,a=0,o=this._attributeParamsMap.length;o>a;a+=2)i=this._attributeParamsMap[a+1],n=e[this._attributeParamsMap[a]],null!=n&&(t&&t[i.name]&&t[i.name].bind(),r+=i.fun.call(this,i,n));C.shaderCall+=r},n.uploadAttributesX=function(e,t){for(var n,i,r=0,a=0,o=this._attributeParamsMap.length;o>a;a+=2)i=this._attributeParamsMap[a+1],n=e[this._attributeParamsMap[a]],null!=n&&(t._bind(),r+=i.fun.call(this,i,n));C.shaderCall+=r},n.uploadSceneUniforms=function(e){for(var t,n,i=0,r=0,a=this._sceneUniformParamsMap.length;a>r;r+=2)n=this._sceneUniformParamsMap[r+1],t=e[this._sceneUniformParamsMap[r]],null!=t&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n.uploadCameraUniforms=function(e){for(var t,n,i=0,r=0,a=this._cameraUniformParamsMap.length;a>r;r+=2)n=this._cameraUniformParamsMap[r+1],t=e[this._cameraUniformParamsMap[r]],null!=t&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n.uploadSpriteUniforms=function(e){for(var t,n,i=0,r=0,a=this._spriteUniformParamsMap.length;a>r;r+=2)n=this._spriteUniformParamsMap[r+1],t=e[this._spriteUniformParamsMap[r]],null!=t&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n.uploadMaterialUniforms=function(e){for(var t,n,i=0,r=0,a=this._materialUniformParamsMap.length;a>r;r+=2)n=this._materialUniformParamsMap[r+1],t=e[this._materialUniformParamsMap[r]],null!=t&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},n.uploadRenderElementUniforms=function(e){for(var t,n,i=0,r=0,a=this._renderElementUniformParamsMap.length;a>r;r+=2)n=this._renderElementUniformParamsMap[r+1],t=e[this._renderElementUniformParamsMap[r]],null!=t&&(i+=n.fun.call(this,n,t));C.shaderCall+=i},t.create=function(e,n,i,r,a,o,s,l){return new t(e,n,i,r,a,o,s,l)},t.addInclude=function(e,t){I.addInclude(e,t)},t._createShader=function(e,t,n){var i=e.createShader(n);if(e.shaderSource(i,t),e.compileShader(i),ri.debugMode&&!e.getShaderParameter(i,35713))throw e.getShaderInfoLog(i);return i},t.PERIOD_RENDERELEMENT=0,t.PERIOD_MATERIAL=1,t.PERIOD_SPRITE=2,t.PERIOD_CAMERA=3,t.PERIOD_SCENE=4,t._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,33991],t._count=0,i(t,["shaderParamsMap",function(){return this.shaderParamsMap={"float":5126,"int":5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new O}]),t}(h)),Oi=function(e){function t(){}r(t,"laya.d3.core.material.PBRMaterial",e);var n=t.prototype;return n.disableLight=function(){},n.disableFog=function(){},n.onAsynLoaded=function(){},n.radicalInverse_VdC=function(){},n.createHammersleyTex=function(){},a(0,n,"normalTexture",function(){}),a(0,n,"has_tangent",null,function(){}),a(0,n,"roughness",function(){}),a(0,n,"metaless",function(){}),a(0,n,"pbrlutTexture",function(){}),a(0,n,"use_groundtruth",null,function(){}),a(0,n,"transformUV",function(){}),a(0,n,"diffuseTexture",function(){}),a(0,n,"renderMode",null,function(){}),a(0,n,"pbrInfoTexture",function(){}),a(0,n,"testClipZ",null,function(){}),t.__init__=function(){},t.load=function(){},t.DIFFUSETEXTURE=1,t.NORMALTEXTURE=2,t.PBRINFOTEXTURE=3,t.PBRLUTTEXTURE=4,t.UVANIAGE=5,t.MATERIALROUGHNESS=6,t.MATERIALMETALESS=7,t.UVMATRIX=8,t.UVAGE=9,t.AOOBJPOS=14,t.HSNOISETEXTURE=15,t.SHADERDEFINE_FIX_ROUGHNESS=0,t.SHADERDEFINE_FIX_METALESS=0,t.SHADERDEFINE_HAS_TANGENT=0,t.SHADERDEFINE_TEST_CLIPZ=0,t.SHADERDEFINE_HAS_PBRINFO=0,t.SHADERDEFINE_USE_GROUNDTRUTH=0,t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,t.pbrlutTex=null,t.HammersleyNoiseTex=null,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),Vi=function(e){function t(){}r(t,"laya.d3.core.material.PBRSpecularMaterial",e);var n=t.prototype;return a(0,n,"albedoColor",function(){}),a(0,n,"specularTexture",function(){}),a(0,n,"albedoTexture",function(){}),a(0,n,"occlusionTexture",function(){}),a(0,n,"normalTexture",function(){}),a(0,n,"parallaxTexture",function(){}),a(0,n,"emissionColor",function(){}),a(0,n,"normalTextureScale",function(){}),a(0,n,"parallaxTextureScale",function(){}),a(0,n,"occlusionTextureStrength",function(){}),a(0,n,"specularColor",function(){}),a(0,n,"smoothness",function(){}),a(0,n,"smoothnessTextureScale",function(){}),a(0,n,"smoothnessSource",function(){}),a(0,n,"enableEmission",function(){}),a(0,n,"emissionTexture",function(){}),a(0,n,"tilingOffset",function(){}),t.__init__=function(){},t.SmoothnessSource_MetallicGlossTexture_Alpha=0,t.SmoothnessSource_DiffuseTexture_Alpha=1,t.SHADERDEFINE_DIFFUSETEXTURE=0,t.SHADERDEFINE_NORMALTEXTURE=0,t.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,t.SHADERDEFINE_SPECULARTEXTURE=0,t.SHADERDEFINE_OCCLUSIONTEXTURE=0,t.SHADERDEFINE_PARALLAXTEXTURE=0,t.SHADERDEFINE_EMISSION=0,t.SHADERDEFINE_EMISSIONTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,t.DIFFUSETEXTURE=1,t.SPECULARTEXTURE=2,t.NORMALTEXTURE=3,t.PARALLAXTEXTURE=4,t.OCCLUSIONTEXTURE=5,t.EMISSIONTEXTURE=6,t.DIFFUSECOLOR=7,t.SPECULARCOLOR=8,t.EMISSIONCOLOR=9,t.SMOOTHNESS=10,t.SMOOTHNESSSCALE=11,t.SMOOTHNESSSOURCE=12,t.OCCLUSIONSTRENGTH=13,t.NORMALSCALE=14,t.PARALLAXSCALE=15,t.ENABLEEMISSION=16,t.TILINGOFFSET=17,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),Li=function(e){function t(){}r(t,"laya.d3.core.material.PBRStandardMaterial",e);var n=t.prototype;return a(0,n,"albedoColor",function(){}),a(0,n,"albedoTexture",function(){}),a(0,n,"enableEmission",function(){}),a(0,n,"metallicGlossTexture",function(){}),a(0,n,"occlusionTexture",function(){}),a(0,n,"normalTexture",function(){}),a(0,n,"parallaxTexture",function(){}),a(0,n,"emissionColor",function(){}),a(0,n,"normalTextureScale",function(){}),a(0,n,"parallaxTextureScale",function(){}),a(0,n,"occlusionTextureStrength",function(){}),a(0,n,"metallic",function(){}),a(0,n,"smoothness",function(){}),a(0,n,"smoothnessTextureScale",function(){}),a(0,n,"smoothnessSource",function(){}),a(0,n,"emissionTexture",function(){}),a(0,n,"tilingOffset",function(){}),t.__init__=function(){},t.SmoothnessSource_MetallicGlossTexture_Alpha=0,t.SmoothnessSource_DiffuseTexture_Alpha=1,t.SHADERDEFINE_DIFFUSETEXTURE=0,t.SHADERDEFINE_NORMALTEXTURE=0,t.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,t.SHADERDEFINE_METALLICGLOSSTEXTURE=0,t.SHADERDEFINE_OCCLUSIONTEXTURE=0,t.SHADERDEFINE_PARALLAXTEXTURE=0,t.SHADERDEFINE_EMISSION=0,t.SHADERDEFINE_EMISSIONTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,t.DIFFUSETEXTURE=1,t.METALLICGLOSSTEXTURE=2,t.NORMALTEXTURE=3,t.PARALLAXTEXTURE=4,t.OCCLUSIONTEXTURE=5,t.EMISSIONTEXTURE=6,t.DIFFUSECOLOR=7,t.EMISSIONCOLOR=8,t.METALLIC=9,t.SMOOTHNESS=10,t.SMOOTHNESSSCALE=11,t.SMOOTHNESSSOURCE=12,t.OCCLUSIONSTRENGTH=13,t.NORMALSCALE=14,t.PARALLAXSCALE=15,t.ENABLEEMISSION=16,t.TILINGOFFSET=17,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),Pi=function(e){function t(){this._transformUV=null,t.__super.call(this),this.setShaderName("SIMPLE"),this._setColor(9,new On(.6,.6,.6)),this._setColor(10,new On(1,1,1)),this._setColor(11,new Vn(1,1,1,8)),this._setColor(12,new On(1,1,1)),this._setColor(7,new Vn(1,1,1,1)),this._setNumber(0,.5),this._setColor(15,new Vn(1,1,0,0)),this.renderMode=1}r(t,"laya.d3.core.material.StandardMaterial",e);var o=t.prototype;return o.disableLight=function(){this._addDisablePublicShaderDefine(ri.SHADERDEFINE_POINTLIGHT|ri.SHADERDEFINE_SPOTLIGHT|ri.SHADERDEFINE_DIRECTIONLIGHT)},o.disableFog=function(){this._addDisablePublicShaderDefine(ri.SHADERDEFINE_FOG)},o.onAsynLoaded=function(n,i,r){var a=i[0];if(a.version)e.prototype.onAsynLoaded.call(this,n,i,r);else{var o=i[1],s=a.props;for(var l in s)this[l]=s[l];t._parseStandardMaterial(o,this,a),this._endLoaded()}},o.cloneTo=function(t){e.prototype.cloneTo.call(this,t);var n=t;this._transformUV&&(n._transformUV=this._transformUV.clone())},a(0,o,"ambientColor",function(){return this._getColor(9)},function(e){this._setColor(9,e)}),a(0,o,"ambientTexture",function(){return this._getTexture(5)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP),this._setTexture(5,e)}),a(0,o,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=2e3,this.alphaTest=!0,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,o,"reflectColor",function(){return this._getColor(12)},function(e){this._setColor(12,e)}),a(0,o,"tilingOffset",function(){return this._getColor(15)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(15,e)}),a(0,o,"albedo",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),a(0,o,"diffuseColor",function(){return this._getColor(10)},function(e){this._setColor(10,e)}),a(0,o,"albedoColor",function(){return this._getColor(7)},function(e){this._setColor(7,e)}),a(0,o,"specularColor",function(){return this._getColor(11)},function(e){this._setColor(11,e)}),a(0,o,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),a(0,o,"normalTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,e)}),a(0,o,"specularTexture",function(){return this._getTexture(3)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,e)}),a(0,o,"emissiveTexture",function(){return this._getTexture(4)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP),this._setTexture(4,e)}),a(0,o,"reflectTexture",function(){return this._getTexture(6)},function(e){e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(6,e)}),a(0,o,"transformUV",function(){return this._transformUV},function(e){this._transformUV=e,this._setMatrix4x4(13,e.matrix),e?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM),this._conchMaterial&&this._conchMaterial.setShaderValue(13,e.matrix.elements,0)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSEMAP=t.shaderDefines.registerDefine("DIFFUSEMAP"),t.SHADERDEFINE_NORMALMAP=t.shaderDefines.registerDefine("NORMALMAP"),t.SHADERDEFINE_SPECULARMAP=t.shaderDefines.registerDefine("SPECULARMAP"),t.SHADERDEFINE_EMISSIVEMAP=t.shaderDefines.registerDefine("EMISSIVEMAP"),t.SHADERDEFINE_AMBIENTMAP=t.shaderDefines.registerDefine("AMBIENTMAP"),t.SHADERDEFINE_REFLECTMAP=t.shaderDefines.registerDefine("REFLECTMAP"),t.SHADERDEFINE_UVTRANSFORM=t.shaderDefines.registerDefine("UVTRANSFORM"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET"),t.SHADERDEFINE_ADDTIVEFOG=t.shaderDefines.registerDefine("ADDTIVEFOG")},t.load=function(e){return n.loader.create(e,null,null,t)},t._parseStandardMaterial=function(e,t,n){var i=n.customProps,r=i.ambientColor;t.ambientColor=new On(r[0],r[1],r[2]);var a=i.diffuseColor;t.diffuseColor=new On(a[0],a[1],a[2]);var o=i.specularColor;t.specularColor=new Vn(o[0],o[1],o[2],o[3]);var s=i.reflectColor;t.reflectColor=new On(s[0],s[1],s[2]);var l=i.albedoColor;l&&(t.albedo=new Vn(l[0],l[1],l[2],l[3]));var u=i.diffuseTexture.texture2D;u&&(t.diffuseTexture=g.getRes(e[u]));var c=i.normalTexture.texture2D;c&&(t.normalTexture=g.getRes(e[c]));var h=i.specularTexture.texture2D;h&&(t.specularTexture=g.getRes(e[h]));var d=i.emissiveTexture.texture2D;d&&(t.emissiveTexture=g.getRes(e[d]));var _=i.ambientTexture.texture2D;_&&(t.ambientTexture=g.getRes(e[_]));var f=i.reflectTexture.texture2D;f&&(t.reflectTexture=g.getRes(e[f]))},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.SHADERDEFINE_DIFFUSEMAP=0,t.SHADERDEFINE_NORMALMAP=0,t.SHADERDEFINE_SPECULARMAP=0,t.SHADERDEFINE_EMISSIVEMAP=0,t.SHADERDEFINE_AMBIENTMAP=0,t.SHADERDEFINE_REFLECTMAP=0,t.SHADERDEFINE_UVTRANSFORM=0,t.SHADERDEFINE_TILINGOFFSET=0,t.SHADERDEFINE_ADDTIVEFOG=0,t.DIFFUSETEXTURE=1,t.NORMALTEXTURE=2,t.SPECULARTEXTURE=3,t.EMISSIVETEXTURE=4,t.AMBIENTTEXTURE=5,t.REFLECTTEXTURE=6,t.ALBEDO=7,t.UVANIAGE=8,t.MATERIALAMBIENT=9,t.MATERIALDIFFUSE=10,t.MATERIALSPECULAR=11,t.MATERIALREFLECT=12,t.UVMATRIX=13,t.UVAGE=14,t.TILINGOFFSET=15,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),wi=function(e){function t(){}r(t,"laya.d3.core.material.TerrainMaterial",e);var n=t.prototype;return n.setDiffuseScale1=function(){},n.setDiffuseScale2=function(){},n.setDiffuseScale3=function(){},n.setDiffuseScale4=function(){},n.setDetailNum=function(){},n.disableLight=function(){},n.setShaderName=function(){},a(0,n,"renderMode",null,function(){}),a(0,n,"diffuseTexture2",function(){}),a(0,n,"ambientColor",function(){}),a(0,n,"diffuseTexture4",function(){}),a(0,n,"diffuseColor",function(){}),a(0,n,"diffuseTexture1",function(){}),a(0,n,"specularColor",function(){}),a(0,n,"diffuseTexture3",function(){}),a(0,n,"splatAlphaTexture",function(){}),a(0,n,"normalTexture",function(){}),t.__init__=function(){},t.load=function(){},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_TRANSPARENT=2,t.SPLATALPHATEXTURE=0,t.NORMALTEXTURE=1,t.DIFFUSETEXTURE1=2,t.DIFFUSETEXTURE2=3,t.DIFFUSETEXTURE3=4,t.DIFFUSETEXTURE4=5,t.DIFFUSESCALE1=6,t.DIFFUSESCALE2=7,t.DIFFUSESCALE3=8,t.DIFFUSESCALE4=9,t.MATERIALAMBIENT=10,t.MATERIALDIFFUSE=11,t.MATERIALSPECULAR=12,t.SHADERDEFINE_DETAIL_NUM1=0,t.SHADERDEFINE_DETAIL_NUM2=0,t.SHADERDEFINE_DETAIL_NUM3=0,t.SHADERDEFINE_DETAIL_NUM4=0,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),Ni=function(e){function t(){}r(t,"laya.d3.core.material.WaterMaterial",e);var o=t.prototype;return o.disableFog=function(){},o.onAsynLoaded=function(){},a(0,o,"diffuseTexture",function(){}),a(0,o,"normalTexture",function(){}),a(0,o,"underWaterTexture",function(){}),a(0,o,"deepColorTexture",function(){}),a(0,o,"useFoam",null,function(){}),a(0,o,"skyTexture",function(){}),a(0,o,"deepScale",function(){}),a(0,o,"detailTexture",function(){}),a(0,o,"foamTexture",function(){}),a(0,o,"waterInfoTexture",function(){}),a(0,o,"vertexDispTexture",function(){}),a(0,o,"currentTm",function(){}),a(0,o,"waveInfo",function(){}),a(0,o,"waveInfoD",function(){}),a(0,o,"waveMainDir",function(){}),a(0,o,"geoWaveUVScale",function(){}),a(0,o,"windSpeed",function(){}),a(0,o,"scrsize",null,function(){}),a(0,o,"seaColor",function(){}),a(0,o,"useVertexDeep",function(){}),a(0,o,"windDir",function(){}),a(0,o,"useRefractTexture",null,function(){}),a(0,o,"renderMode",null,function(){}),t.__init__=function(){t.SHADERDEFINE_CUBE_ENV=t.shaderDefines.registerDefine("CUBE_ENV"),t.SHADERDEFINE_HDR_ENV=t.shaderDefines.registerDefine("HDR_ENV"),t.SHADERDEFINE_SHOW_NORMAL=t.shaderDefines.registerDefine("SHOW_NORMAL"),t.SHADERDEFINE_USEVERTEXHEIGHT=t.shaderDefines.registerDefine("USE_VERTEX_DEEPINFO"),t.SHADERDEFINE_USE_FOAM=t.shaderDefines.registerDefine("USE_FOAM"),t.SHADERDEFINE_USE_REFRACT_TEX=t.shaderDefines.registerDefine("USE_REFR_TEX")},t.load=function(e){return n.loader.create(e,null,null,t)},t.DIFFUSETEXTURE=1,t.NORMALTEXTURE=2,t.UNDERWATERTEXTURE=3,t.VERTEXDISPTEXTURE=4,t.UVANIAGE=5,t.UVMATRIX=6,t.UVAGE=7,t.CURTM=8,t.DETAILTEXTURE=9,t.DEEPCOLORTEXTURE=10,t.SKYTEXTURE=11,t.WAVEINFO=12,t.WAVEINFOD=13,t.WAVEMAINDIR=14,t.SCRSIZE=15,t.WATERINFO=16,t.FOAMTEXTURE=17,t.GEOWAVE_UV_SCALE=18,t.SEA_COLOR=19,t.WAVEINFODEEPSCALE=20,t.SHADERDEFINE_SHOW_NORMAL=0,t.SHADERDEFINE_CUBE_ENV=0,t.SHADERDEFINE_HDR_ENV=0,t.SHADERDEFINE_USE_FOAM=0,t.SHADERDEFINE_USE_REFRACT_TEX=0,t.SHADERDEFINE_USEVERTEXHEIGHT=0,t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),Fi=function(e){function t(e,n,i,r){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===i&&(i=35044),void 0===r&&(r=!1),t.__super.call(this),this._indexType=e,this._indexCount=n,this._bufferUsage=i,this._bufferType=34963,this._canRead=r;var a=0;if("ushort"==e)this._indexTypeByteCount=2;else{if("ubyte"!=e)throw new Error("unidentification index type.");this._indexTypeByteCount=1}a=this._indexTypeByteCount*n,this._byteLength=a,this._bind(),_._gl.bufferData(this._bufferType,a,this._bufferUsage),r?("ushort"==e?this._buffer=new Uint16Array(n):"ubyte"==e&&(this._buffer=new Uint8Array(n)),this.memorySize=2*a):this.memorySize=a}r(t,"laya.d3.graphics.IndexBuffer3D",e);var n=t.prototype;return n.setData=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295);var r=0;if("ushort"==this._indexType?(r=2,(0!==n||4294967295!==i)&&(e=new Uint16Array(e.buffer,n*r,i))):"ubyte"==this._indexType&&(r=1,(0!==n||4294967295!==i)&&(e=new Uint8Array(e.buffer,n*r,i))),this._bind(),_._gl.bufferSubData(this._bufferType,t*r,e),this._canRead)if(0!==t||0!==n||4294967295!==i){var a=this._buffer.length-t;i>a&&(i=a);for(var o=0;i>o;o++)this._buffer[t+o]=e[o]}else this._buffer=e},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.disposeResource=function(){e.prototype.disposeResource.call(this),this._buffer=null,this.memorySize=0},a(0,n,"indexType",function(){return this._indexType}),a(0,n,"indexTypeByteCount",function(){return this._indexTypeByteCount}),a(0,n,"indexCount",function(){return this._indexCount}),a(0,n,"canRead",function(){return this._canRead}),t.INDEXTYPE_UBYTE="ubyte",t.INDEXTYPE_USHORT="ushort",t.create=function(e,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new t(e,n,i,r)},t}(_),bi=function(e){function t(){t.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this.renderMode=6
}r(t,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",e);var o=t.prototype;return o.onAsynLoaded=function(n,i,r){var a=i[0];if(a.version)e.prototype.onAsynLoaded.call(this,n,i,r);else{var o=i[1],s=a.props;for(var l in s)this[l]=s[l];t._parseShurikenParticleMaterial(o,this,a),this._endLoaded()}},a(0,o,"renderMode",null,function(e){switch(e){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=2e3,this.alphaTest=!0,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=2e3,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=3e3,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=3e3,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=3e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=3e3,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=3e3,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(t.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(e)}),a(0,o,"tintColor",function(){return this._getColor(2)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._setColor(2,e)}),a(0,o,"tilingOffset",function(){return this._getColor(3)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(3,e)}),a(0,o,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,e)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSEMAP=t.shaderDefines.registerDefine("DIFFUSEMAP"),t.SHADERDEFINE_TINTCOLOR=t.shaderDefines.registerDefine("TINTCOLOR"),t.SHADERDEFINE_ADDTIVEFOG=t.shaderDefines.registerDefine("ADDTIVEFOG"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET")},t.load=function(e){return n.loader.create(e,null,null,t)},t._parseShurikenParticleMaterial=function(e,t,n){var i=n.customProps,r=i.diffuseTexture.texture2D;r&&(t.diffuseTexture=g.getRes(e[r]));var a=i.tintColor;a&&(t.tintColor=new Vn(a[0],a[1],a[2],a[3]))},t.RENDERMODE_OPAQUE=1,t.RENDERMODE_OPAQUEDOUBLEFACE=2,t.RENDERMODE_CUTOUT=3,t.RENDERMODE_CUTOUTDOUBLEFACE=4,t.RENDERMODE_TRANSPARENT=13,t.RENDERMODE_TRANSPARENTDOUBLEFACE=14,t.RENDERMODE_ADDTIVE=15,t.RENDERMODE_ADDTIVEDOUBLEFACE=16,t.RENDERMODE_DEPTHREAD_TRANSPARENT=5,t.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,t.RENDERMODE_DEPTHREAD_ADDTIVE=7,t.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,t.RENDERMODE_NONDEPTH_TRANSPARENT=9,t.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,t.RENDERMODE_NONDEPTH_ADDTIVE=11,t.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,t.SHADERDEFINE_DIFFUSEMAP=0,t.SHADERDEFINE_TINTCOLOR=0,t.SHADERDEFINE_TILINGOFFSET=0,t.SHADERDEFINE_ADDTIVEFOG=0,t.DIFFUSETEXTURE=1,t.TINTCOLOR=2,t.TILINGOFFSET=3,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),Bi=function(e){function t(e,n,i,r){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===r&&(r=!1),t.__super.call(this),this._vertexDeclaration=e,this._vertexCount=n,this._bufferUsage=i,this._bufferType=34962,this._canRead=r,this.memorySize=this._byteLength=this._vertexDeclaration.vertexStride*n,this._bind(),_._gl.bufferData(this._bufferType,this._byteLength,this._bufferUsage),r&&(this._buffer=new Float32Array(this._byteLength/4))}r(t,"laya.d3.graphics.VertexBuffer3D",e);var n=t.prototype;return n.bindWithIndexBuffer=function(e){e&&e._bind(),this._bind()},n.setData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=4294967295),(0!==n||4294967295!==i)&&(e=new Float32Array(e.buffer,4*n,i)),this._bind(),_._gl.bufferSubData(this._bufferType,4*t,e),this._canRead)if(0!==t||0!==n||4294967295!==i){var r=this._buffer.length-t;i>r&&(i=r);for(var a=0;i>a;a++)this._buffer[t+a]=e[a]}else this._buffer=e},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.disposeResource=function(){for(var t=P.mainContext,n=this._vertexDeclaration.getVertexElements(),i=_._enableAtributes,r=0,a=n.length;a>r;r++)i[r]===this._glBuffer&&(t.disableVertexAttribArray(r),i[r]=null);e.prototype.disposeResource.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},a(0,n,"vertexDeclaration",function(){return this._vertexDeclaration}),a(0,n,"vertexCount",function(){return this._vertexCount}),a(0,n,"canRead",function(){return this._canRead}),t.create=function(e,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new t(e,n,i,r)},t}(_),Ui=function(e){function t(){}r(t,"laya.d3.core.trail.TrailMaterial",e);var o=t.prototype;return a(0,o,"tintColor",function(){}),a(0,o,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),a(0,o,"tilingOffset",function(){return this._getColor(3)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(3,e)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSETEXTURE=t.shaderDefines.registerDefine("DIFFUSETEXTURE"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET")},t.load=function(e){return n.loader.create(e,null,null,t)},t.SHADERDEFINE_DIFFUSETEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,t.DIFFUSETEXTURE=1,t.TINTCOLOR=2,t.TILINGOFFSET=3,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),Hi=(function(e){function t(){}r(t,"laya.d3.extension.cartoonRender.CartoonMaterial",e);var n=t.prototype;return a(0,n,"specularTexture",function(){}),a(0,n,"albedoTexture",function(){}),a(0,n,"shadowColor",function(){}),a(0,n,"shadowIntensity",function(){}),a(0,n,"shadowRange",function(){}),a(0,n,"tilingOffset",function(){}),a(0,n,"specularRange",function(){}),a(0,n,"specularIntensity",function(){}),t.__init__=function(){t.SHADERDEFINE_ALBEDOTEXTURE=t.shaderDefines.registerDefine("DIFFUSETEXTURE"),t.SHADERDEFINE_SPECULARTEXTURE=t.shaderDefines.registerDefine("SPECULARTEXTURE")},t.initShader=function(){var e={a_Position:0,a_Normal:3,a_Texcoord0:2},t={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlbedoTexture:[1,1],u_SpecularTexture:[2,1],u_ShadowColor:[5,1],u_ShadowRange:[6,1],u_ShadowIntensity:[7,1],u_SpecularRange:[8,1],u_SpecularIntensity:[9,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4]},n=Ci.nameKey.add("CartoonShader"),i="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_ViewDir;\n\nvoid main()\n{\n	gl_Position = u_MvpMatrix * a_Position;\n	\n	mat3 worldMat = mat3(u_WorldMat);\n	v_PositionWorld = (u_WorldMat * a_Position).xyz;\n	v_Normal = worldMat * a_Normal;\n	v_Texcoord0 = a_Texcoord0;\n	\n	v_ViewDir = u_CameraPos - v_PositionWorld;\n}",r="#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nstruct DirectionLight\n{\n	vec3 Color;\n	vec3 Direction;\n};\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_ViewDir;\n\n#ifdef ALBEDOTEXTURE\n	uniform sampler2D u_AlbedoTexture;\n#endif\n\n#ifdef SPECULARTEXTURE\n	uniform sampler2D u_SpecularTexture;\n#endif\n\nuniform vec4 u_ShadowColor;\nuniform float u_ShadowRange;\nuniform float u_ShadowIntensity;\nuniform float u_SpecularRange;\nuniform float u_SpecularIntensity;\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main()\n{\n	vec3 normal = normalize(v_Normal);\n	vec3 viewdir = normalize(v_ViewDir);\n	vec3 lightDir = normalize(u_DirectionLight.Direction);\n	\n	vec4 albedoTextureColor = vec4(1.0);\n	#ifdef ALBEDOTEXTURE\n		albedoTextureColor = texture2D(u_AlbedoTexture, v_Texcoord0);\n	#endif\n	\n	vec4 specularTextureColor = vec4(1.0); \n	#ifdef SPECULARTEXTURE\n		specularTextureColor = texture2D(u_SpecularTexture, v_Texcoord0);\n	#endif\n	\n	specularTextureColor = specularTextureColor;\n	\n	//specularTextureColor = vec4(1.0, 1.0, 1.0, 1.0);\n	\n	float specTexColorG = specularTextureColor.g;\n	\n	//Overlay BlendMode 叠加\n	vec3 albedoColor;\n	albedoColor.r = albedoTextureColor.r > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.r) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.r * specTexColorG;\n	albedoColor.g = albedoTextureColor.g > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.g) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.g * specTexColorG;\n	albedoColor.b = albedoTextureColor.b > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.b) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.b * specTexColorG;\n	\n	albedoColor = clamp(albedoColor, 0.0, 1.0);\n	\n	float nl = max(dot(normal, -lightDir), 0.0);\n	\n	float shadowValue = nl + specTexColorG - 0.5;\n	float shadow = step(shadowValue, u_ShadowRange);\n	if(u_ShadowRange > (shadowValue + 0.01))\n		shadow = 1.0;\n	else if(u_ShadowRange < (shadowValue - 0.01))\n		shadow = 0.0;\n	else\n		shadow = (u_ShadowRange - (shadowValue - 0.01)) / 0.02;\n		\n	shadow = clamp(shadow, 0.0, 1.0);\n	\n	//specularTextureColor.r 影响高光范围\n	float specular = step(u_SpecularRange, clamp(pow(nl, specularTextureColor.r), 0.0, 1.0));\n	//specularTextureColor.b 影响高光强度\n	specular = step(0.1, specular * specularTextureColor.b);\n	\n	vec3 albedoAreaColor = (1.0 - shadow) * albedoColor;\n	vec3 shadowAreaColor = shadow * albedoColor * u_ShadowColor.rgb * u_ShadowIntensity;\n	vec3 speculAreaColor = (1.0 - shadow) * albedoColor * u_SpecularIntensity * specular;\n	\n	vec3 finalColor = albedoAreaColor + speculAreaColor + shadowAreaColor;\n	\n	gl_FragColor = vec4(finalColor, 1.0);\n}\n",a=ri.add(n,i,r,e,t);laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE=a.registerMaterialDefine("ALBEDOTEXTURE"),laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE=a.registerMaterialDefine("SPECULARTEXTURE"),laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET")},t.ALBEDOTEXTURE=1,t.SPECULARTEXTURE=2,t.TILINGOFFSET=4,t.SHADOWCOLOR=5,t.SHADOWRANGE=6,t.SHADOWINTENSITY=7,t.SPECULARRANGE=8,t.SPECULARINTENSITY=9,t.SHADERDEFINE_ALBEDOTEXTURE=0,t.SHADERDEFINE_SPECULARTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),function(e){function t(){}r(t,"laya.d3.extension.cartoonRender.OutlineMaterial",e);var n=t.prototype;return a(0,n,"outlineTexture",function(){}),a(0,n,"outlineWidth",function(){}),a(0,n,"outlineLightness",function(){}),t.__init__=function(){t.SHADERDEFINE_OUTLINETEXTURE=t.shaderDefines.registerDefine("OUTLINETEXTURE")},t.initShader=function(){var e={a_Position:0,a_Normal:3,a_Texcoord0:2},t={u_MvpMatrix:[1,2],u_OutlineTexture:[1,1],u_OutlineWidth:[2,1],u_OutlineLightness:[3,1]},n=Ci.nameKey.add("OutlineShader"),i="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform float u_OutlineWidth;\n\nvarying vec2 v_Texcoord0;\n\nvoid main()\n{\n	v_Texcoord0 = a_Texcoord0;\n	\n	vec4 position = vec4(a_Position.xyz + a_Normal * u_OutlineWidth, 1.0);\n	gl_Position = u_MvpMatrix * position;\n}",r="#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nstruct DirectionLight\n{\n	vec3 Color;\n	vec3 Direction;\n};\n\nvarying vec2 v_Texcoord0;\n\n#ifdef OUTLINETEXTURE\n	uniform sampler2D u_OutlineTexture;\n#endif\nuniform float u_OutlineLightness;\n\nvoid main()\n{\n	vec4 outlineTextureColor = vec4(1.0);\n	#ifdef OUTLINETEXTURE\n		outlineTextureColor = texture2D(u_OutlineTexture, v_Texcoord0);\n	#endif\n	\n	vec3 finalColor = outlineTextureColor.rgb * u_OutlineLightness;\n	\n	gl_FragColor = vec4(finalColor,0.0);\n}\n",a=ri.add(n,i,r,e,t);laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE=a.registerMaterialDefine("OUTLINETEXTURE")},t.OUTLINETEXTURE=1,t.OUTLINEWIDTH=2,t.OUTLINELIGHTNESS=3,t.SHADERDEFINE_OUTLINETEXTURE=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),function(e){function t(){}return r(t,"laya.d3.extension.domino.DominoMaterial",e),t.__init__=function(){},t.initShader=function(){{var e={a_Position:0,a_Normal:3,a_Color:1},t={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4]},n=Ci.nameKey.add("DominoShader"),i="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\nattribute vec4 a_Color;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_Normal;\nvarying vec3 v_ViewDir;\n\nvoid main()\n{\n	v_Texcoord0 = a_Texcoord0;\n	v_Color = a_Color;\n	\n	gl_Position = u_MvpMatrix * a_Position;\n	\n	v_Normal = mat3(u_WorldMat) * a_Normal;\n	v_PositionWorld = (u_WorldMat * a_Position).xyz;\n	v_ViewDir = u_CameraPos - v_PositionWorld;\n}",r="#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nstruct DirectionLight\n{\n	vec3 Color;\n	vec3 Direction;\n};\nuniform DirectionLight u_DirectionLight;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\nvarying vec3 v_ViewDir; \nvarying vec3 v_Normal;\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 normal, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor)\n{\n	vec3 lightVec = normalize(light.Direction);\n	\n	//mediump vec3 h = normalize(viewDir-light.Direction);\n	//float nh = max (0.0, dot (h,normal));\n	\n    lowp float ln = max (0.0, dot (-lightVec,normal));\n	diffuseColor = light.Color * ln;\n}\n\nvoid main()\n{\n	vec3 diffuseColor;\n	vec3 normal = normalize(v_Normal);\n	vec3 viewDir = normalize(v_ViewDir);\n	LayaAirBlinnPhongDiectionLight(normal, viewDir, u_DirectionLight, diffuseColor);\n	\n	gl_FragColor.xyz = diffuseColor * v_Color.xyz * 2.0;\n}\n\n";ri.add(n,i,r,e,t)}},i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),function(e){function t(){t.__super.call(this),this.setShaderName("LineShader"),this._setColor(2,new Vn(1,1,1,1)),this.cull=0}r(t,"laya.d3.extension.lineRender.LineMaterial",e);var o=t.prototype;return a(0,o,"tintColor",function(){return this._getColor(2)},function(e){this._setColor(2,e)}),a(0,o,"diffuseTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,e)}),a(0,o,"tilingOffset",function(){return this._getColor(3)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(3,e)}),t.__init__=function(){t.SHADERDEFINE_DIFFUSETEXTURE=t.shaderDefines.registerDefine("DIFFUSETEXTURE"),t.SHADERDEFINE_TILINGOFFSET=t.shaderDefines.registerDefine("TILINGOFFSET")},t.load=function(e){return n.loader.create(e,null,null,t)},t.initShader=function(){var e={a_Position:0,a_OffsetVector:41,a_Texcoord0X:38,a_Texcoord0X1:39,a_Texcoord0Y:40},t={u_MvpMatrix:[1,2],u_VMatrix:[1,3],u_PMatrix:[2,3],u_TilingOffset:[3,1],u_MainTexture:[1,1],u_MainColor:[2,1],u_WidthCurve:[3,2],u_WidthCurveKeyLength:[4,2],u_GradientColorkey:[5,2],u_GradientAlphakey:[6,2]},n=Ci.nameKey.add("LineShader"),i="attribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0X1;\nattribute float a_Texcoord0Y;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_VMatrix;\nuniform mat4 u_PMatrix;\n\nuniform vec4 u_TilingOffset;\n\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nuniform vec4 u_GradientColorkey[10];\nuniform vec2 u_GradientAlphakey[10];\n\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n	float t2 = t * t;\n	float t3 = t2 * t;\n	float a = 2.0 * t3 - 3.0 * t2 + 1.0;\n	float b = t3 - 2.0 * t2 + t;\n	float c = t3 - t2;\n	float d = -2.0 * t3 + 3.0 * t2;\n	return a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n	if(normalizeTime == 0.0){\n		return u_WidthCurve[0].w;\n	}\n	else if(normalizeTime >= 1.0){\n		return u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n	}\n	else{\n		for(int i = 0; i < 10; i ++ )\n		{\n			if(normalizeTime == u_WidthCurve[i].x)\n			{\n				return u_WidthCurve[i].w;\n			}\n			\n			vec4 lastFrame = u_WidthCurve[i];\n			vec4 nextFrame = u_WidthCurve[i + 1];\n			if(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n			{\n				float duration = nextFrame.x - lastFrame.x;\n				float t = (normalizeTime - lastFrame.x) / duration;\n				float outTangent = lastFrame.z;\n				float inTangent = nextFrame.y;\n				float value1 = lastFrame.w;\n				float value2 = nextFrame.w;\n				return hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n			}\n		}	\n	}\n}	\n\nvec4 getColorFromGradientByBlend(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n	vec4 color;\n	for(int i = 1; i < 10; i++)\n	{\n		vec4 gradientColor = gradientColors[i];\n		float colorKey = gradientColor.w;\n		if(colorKey >= normalizeTime)\n		{\n			vec4 lastGradientColor = gradientColors[i-1];\n			float lastColorKey = lastGradientColor.w;\n			float age = (normalizeTime - lastColorKey) / (colorKey - lastColorKey);\n			color.rgb = mix(gradientColors[i-1].xyz, gradientColor.xyz, age);\n			break;\n		}\n	}\n	for(int i = 1; i < 10; i++)\n	{\n		vec2 gradientAlpha = gradientAlphas[i];\n		float alphaKey = gradientAlpha.y;\n		if(alphaKey >= normalizeTime)\n		{\n			vec2 lastGradientAlpha = gradientAlphas[i-1];\n			float lastAlphaKey = lastGradientAlpha.y;\n			float age = (normalizeTime - lastAlphaKey) / (alphaKey - lastAlphaKey);\n			color.a = mix(lastGradientAlpha.x, gradientAlpha.x, age);\n			break;\n		}\n	}\n	return color;\n}\n\nvec4 getColorFromGradientByFixed(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n	vec4 color;\n	for(int i = 0; i < 10; i++)\n	{\n		vec4 gradientColor = gradientColors[i];\n		if(gradientColor.w >= normalizeTime)\n		{\n			color.rgb = gradientColor.xyz;\n			break;\n		}\n	}\n	for(int i = 0; i < 10; i++)\n	{\n		vec2 gradientAlpha = gradientAlphas[i];\n		if(gradientAlpha.y >= normalizeTime)\n		{\n			color.a = gradientAlpha.x;\n			break;\n		}\n	}\n	return color;\n}\n\nvoid main()\n{\n	#ifdef TEXTUREMODE_STRETCH\n		v_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\n	#else\n		v_Texcoord0 = vec2(a_Texcoord0X1, a_Texcoord0Y);\n	#endif\n	\n	#ifdef TILINGOFFSET\n		v_Texcoord0 = v_Texcoord0 * u_TilingOffset.xy + u_TilingOffset.zw;\n	#endif\n	\n	#ifdef GRADIENTMODE_BLEND\n		v_Color = getColorFromGradientByBlend(u_GradientColorkey, u_GradientAlphakey, a_Texcoord0X);\n	#else\n		v_Color = getColorFromGradientByFixed(u_GradientColorkey, u_GradientAlphakey, a_Texcoord0X);\n	#endif\n	\n	#ifdef WORLDSPACE\n		gl_Position = u_PMatrix * u_VMatrix * vec4(a_Position + a_OffsetVector * getCurWidth(a_Texcoord0X),1.0);\n	#else\n		gl_Position = u_MvpMatrix * vec4(a_Position + a_OffsetVector * getCurWidth(a_Texcoord0X),1.0);\n	#endif\n}",r="#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\n	vec4 color = 2.0 * u_MainColor * v_Color;\n	#ifdef DIFFUSETEXTURE\n		vec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n		color *= mainTextureColor;\n	#endif\n	gl_FragColor = color;\n}\n\n",a=ri.add(n,i,r,e,t);laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_DIFFUSETEXTURE=a.registerMaterialDefine("DIFFUSETEXTURE"),laya.d3.extension.lineRender.LineMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),hr.SHADERDEFINE_GRADIENTMODE_BLEND=a.registerSpriteDefine("GRADIENTMODE_BLEND"),hr.SHADERDEFINE_TEXTUREMODE_STRETCH=a.registerSpriteDefine("TEXTUREMODE_STRETCH"),hr.SHADERDEFINE_WORLDSPACE=a.registerSpriteDefine("WORLDSPACE")},t.SHADERDEFINE_DIFFUSETEXTURE=0,t.SHADERDEFINE_TILINGOFFSET=0,t.DIFFUSETEXTURE=1,t.TINTCOLOR=2,t.TILINGOFFSET=3,i(t,["defaultMaterial",function(){return this.defaultMaterial=new t},"shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci)),Gi=(function(e){function t(){}r(t,"laya.d3.extension.lulingmen.DissolveMaterial",e);var n=t.prototype;return a(0,n,"albedoColor",function(){}),a(0,n,"mainTexture",function(){}),a(0,n,"dissolveSpeed",function(){}),a(0,n,"tilingOffset",function(){}),a(0,n,"dissolveTexture",function(){}),a(0,n,"maskTexture",function(){}),a(0,n,"dissolveTilingOffset",function(){}),a(0,n,"maskTilingOffset",function(){}),a(0,n,"dissolve",function(){}),t.__init__=function(){t.SHADERDEFINE_MAINTEXTURE=t.shaderDefines.registerDefine("MAINTEXTURE"),t.SHADERDEFINE_DISSOLVETEXTURE=t.shaderDefines.registerDefine("DISSOLVETEXTURE"),t.SHADERDEFINE_MASKTEXTURE=t.shaderDefines.registerDefine("MASKTEXTURE"),t.SHADERDEFINE_MAINTILINGOFFSET=t.shaderDefines.registerDefine("MAINTILINGOFFSET"),t.SHADERDEFINE_DISSOLVETILINGOFFSET=t.shaderDefines.registerDefine("DISSOLVETILINGOFFSET"),t.SHADERDEFINE_MASKTILINGOFFSET=t.shaderDefines.registerDefine("MASKTILINGOFFSET")},t.initShader=function(){var e={a_Position:0,a_Normal:3,a_Texcoord0:2},t={u_MvpMatrix:[1,2],u_MainTexture:[1,1],u_DissolveTexture:[2,1],u_MaskTexture:[3,1],u_BaseColor:[9,1],u_MainTilingOffset:[4,1],u_DissolveTilingOffset:[5,1],u_MaskTilingOffset:[6,1],u_Dissolve:[7,1],u_DissolveSpeed:[8,1]},n=Ci.nameKey.add("Dissolve"),i="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nuniform vec4 u_MainTilingOffset;\nuniform vec4 u_DissolveTilingOffset;\nuniform vec4 u_MaskTilingOffset;\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec2 v_Texcoord2;\n\nvoid main()\n{\n	v_Texcoord0 = a_Texcoord0;\n	#ifdef MAINTILINGOFFSET\n		v_Texcoord0 = (vec2(v_Texcoord0.x, v_Texcoord0.y - 1.0) * u_MainTilingOffset.xy) + u_MainTilingOffset.zw;\n		v_Texcoord0 = vec2(v_Texcoord0.x, 1.0 + v_Texcoord0.y);\n	#endif\n	\n	v_Texcoord1 = a_Texcoord0;\n	#ifdef DISSOLVETILINGOFFSET\n		v_Texcoord1 = (vec2(v_Texcoord1.x, v_Texcoord1.y - 1.0) * u_DissolveTilingOffset.xy) + u_DissolveTilingOffset.zw;\n		v_Texcoord1 = vec2(v_Texcoord1.x, 1.0 + v_Texcoord1.y);\n	#endif\n	\n	v_Texcoord2 = a_Texcoord0;\n	\n	gl_Position = u_MvpMatrix * a_Position;\n}",r="#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec2 v_Texcoord2;\n\n#ifdef MAINTEXTURE\n	uniform sampler2D u_MainTexture;\n#endif\n\n#ifdef DISSOLVETEXTURE\n	uniform sampler2D u_DissolveTexture;\n#endif\n\n#ifdef MASKTEXTURE\n	uniform sampler2D u_MaskTexture;\n#endif\n\nuniform vec4 u_BaseColor;\nuniform float u_Dissolve;\nuniform float u_DissolveSpeed;\n\nvoid main()\n{\n	vec4 mainColor = u_BaseColor;\n	mainColor.a = 1.0;\n	#ifdef MAINTEXTURE\n		mainColor *= texture2D(u_MainTexture, v_Texcoord0);\n	#endif\n	\n	vec4 dissolveColor = vec4(1.0);\n	#ifdef DISSOLVETEXTURE\n		dissolveColor = texture2D(u_DissolveTexture, v_Texcoord1);\n	#endif\n	\n	vec4 maskColor = vec4(1.0);\n	#ifdef MASKTEXTURE\n		maskColor = texture2D(u_MaskTexture, v_Texcoord2);\n	#endif\n	\n	vec4 outColor = mix(vec4(0.0), mainColor, maskColor);\n	if(dissolveColor.a <= u_Dissolve){\n		float alpha = clamp(outColor.a - u_Dissolve * 2.0 + dissolveColor.a, 0.0, 1.0);\n		alpha = pow(alpha, u_DissolveSpeed);\n		outColor.a = alpha;\n	}\n	\n	gl_FragColor = outColor;\n}\n",a=ri.add(n,i,r,e,t);laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MAINTEXTURE=a.registerMaterialDefine("MAINTEXTURE"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_DISSOLVETEXTURE=a.registerMaterialDefine("DISSOLVETEXTURE"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MASKTEXTURE=a.registerMaterialDefine("MASKTEXTURE"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MAINTILINGOFFSET=a.registerMaterialDefine("MAINTILINGOFFSET"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_DISSOLVETILINGOFFSET=a.registerMaterialDefine("DISSOLVETILINGOFFSET"),laya.d3.extension.lulingmen.DissolveMaterial.SHADERDEFINE_MASKTILINGOFFSET=a.registerMaterialDefine("MASKTILINGOFFSET")},t.MAINTEXTURE=1,t.DISSOLVETEXTURE=2,t.MASKTEXTURE=3,t.MAINTILINGOFFSET=4,t.DISSOLVETILINGOFFSET=5,t.MASKTILINGOFFSET=6,t.DISSOLVE=7,t.DISSOLVESPEED=8,t.BASECOLOR=9,t.SHADERDEFINE_MAINTEXTURE=0,t.SHADERDEFINE_DISSOLVETEXTURE=0,t.SHADERDEFINE_MASKTEXTURE=0,t.SHADERDEFINE_MAINTILINGOFFSET=0,t.SHADERDEFINE_DISSOLVETILINGOFFSET=0,t.SHADERDEFINE_MASKTILINGOFFSET=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),function(e){function t(){}r(t,"laya.d3.extension.lulingmen.MeshParticleMaterial",e);var n=t.prototype;return a(0,n,"alpha",function(){}),a(0,n,"mainTexture",function(){}),a(0,n,"maskTexture",function(){}),a(0,n,"albedoColor",function(){}),a(0,n,"intensity",function(){}),a(0,n,"alphaColor",function(){}),a(0,n,"tilingOffset",function(){}),a(0,n,"maskTilingOffset",function(){}),t.__init__=function(){t.SHADERDEFINE_MAINTEXTURE=t.shaderDefines.registerDefine("MAINTEXTURE"),t.SHADERDEFINE_MASKTEXTURE=t.shaderDefines.registerDefine("MASKTEXTURE"),t.SHADERDEFINE_TILINGOFFSET1=t.shaderDefines.registerDefine("TILINGOFFSET1"),t.SHADERDEFINE_TILINGOFFSET2=t.shaderDefines.registerDefine("TILINGOFFSET2")},t.initShader=function(){var e={a_Position:0,a_Normal:3,a_Color:1,a_Texcoord0:2},t={u_MvpMatrix:[1,2],u_MainTexture:[1,1],u_MaskTexture:[2,1],u_BaseColor:[3,1],u_AlphaColor:[4,1],u_Instensity:[5,1],u_Alpha:[6,1],u_TilingOffset1:[7,1],u_TilingOffset2:[8,1]},n=Ci.nameKey.add("MeshParticle"),i="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\nattribute vec4 a_Color;\n\nuniform mat4 u_MvpMatrix;\n\nuniform vec4 u_TilingOffset1;\nuniform vec4 u_TilingOffset2;\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec4 v_Color;\n\nvoid main()\n{\n	v_Texcoord0 = a_Texcoord0;\n	#ifdef TILINGOFFSET1\n		v_Texcoord0 = (vec2(v_Texcoord0.x, v_Texcoord0.y - 1.0) * u_TilingOffset1.xy) + u_TilingOffset1.zw;\n		v_Texcoord0 = vec2(v_Texcoord0.x, 1.0 + v_Texcoord0.y);\n	#endif\n	\n	v_Texcoord1 = a_Texcoord0;\n	#ifdef TILINGOFFSET2\n		v_Texcoord1 = (vec2(v_Texcoord1.x, v_Texcoord1.y - 1.0) * u_TilingOffset2.xy) + u_TilingOffset2.zw;\n		v_Texcoord1 = vec2(v_Texcoord1.x, 1.0 + v_Texcoord1.y);\n	#endif\n	\n	v_Color = vec4(1.0);\n	#ifdef COLOR\n		v_Color = a_Color;\n	#endif\n	\n	gl_Position = u_MvpMatrix * a_Position;\n}",r="#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec4 v_Color;\n\n#ifdef MAINTEXTURE\n	uniform sampler2D u_MainTexture;\n#endif\n\n#ifdef MASKTEXTURE\n	uniform sampler2D u_MaskTexture;\n#endif\n\nuniform vec4 u_BaseColor;\nuniform vec4 u_AlphaColor;\nuniform float u_Instensity;\nuniform float u_Alpha;\n\nvoid main()\n{\n	vec4 mainTextureColor = vec4(1.0);\n	#ifdef MAINTEXTURE\n		mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n	#endif\n	\n	vec4 maskTextureColor = vec4(1.0);\n	#ifdef MASKTEXTURE\n		maskTextureColor = texture2D(u_MaskTexture, v_Texcoord1);\n	#endif\n	\n	vec4 outColor = mix(vec4(0.0), mainTextureColor, maskTextureColor);\n	\n	gl_FragColor = 2.0 * outColor * u_BaseColor * u_AlphaColor * u_Instensity * v_Color;\n	gl_FragColor.a *= u_Alpha;\n}\n",a=ri.add(n,i,r,e,t);laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_MAINTEXTURE=a.registerMaterialDefine("MAINTEXTURE"),laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_MASKTEXTURE=a.registerMaterialDefine("MASKTEXTURE"),laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_TILINGOFFSET1=a.registerMaterialDefine("TILINGOFFSET1"),laya.d3.extension.lulingmen.MeshParticleMaterial.SHADERDEFINE_TILINGOFFSET2=a.registerMaterialDefine("TILINGOFFSET2")},t.MAINTEXTURE=1,t.MASKTEXTURE=2,t.BASECOLOR=3,t.ALPHACOLOR=4,t.INTENSITY=5,t.ALPHA=6,t.TILINGOFFSET1=7,t.TILINGOFFSET2=8,t.SHADERDEFINE_MAINTEXTURE=0,t.SHADERDEFINE_MASKTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET1=0,t.SHADERDEFINE_TILINGOFFSET2=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)
}]),t}(ci)),zi=(function(e){function t(){t.__super.call(this),this.setShaderName("Particle"),this._setColor(3,new Vn(1,1,1,1)),this._setColor(4,new Vn(1,1,1,1)),this._setNumber(5,1),this._setNumber(6,1)}r(t,"laya.d3.extension.lulingmen.ParticleMaterial",e);var n=t.prototype;return a(0,n,"alpha",function(){return this._getNumber(6)},function(e){e=Math.max(0,Math.min(1,e)),this._setNumber(6,e)}),a(0,n,"tintColor",function(){return this._getColor(3)},function(e){this._setColor(3,e)}),a(0,n,"mainTexture",function(){return this._getTexture(1)},function(e){e?this._addShaderDefine(Gi.SHADERDEFINE_MAINTEXTURE):this._removeShaderDefine(Gi.SHADERDEFINE_MAINTEXTURE),this._setTexture(1,e)}),a(0,n,"maskTexture",function(){return this._getTexture(2)},function(e){e?this._addShaderDefine(Gi.SHADERDEFINE_MASKTEXTURE):this._removeShaderDefine(Gi.SHADERDEFINE_MASKTEXTURE),this._setTexture(2,e)}),a(0,n,"intensity",function(){return this._getNumber(5)},function(e){this._setNumber(5,e)}),a(0,n,"alphaColor",function(){return this._getColor(4)},function(e){this._setColor(4,e)}),a(0,n,"tilingOffset",function(){return this._getColor(7)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(Gi.SHADERDEFINE_TILINGOFFSET1):this._removeShaderDefine(Gi.SHADERDEFINE_TILINGOFFSET1)}else this._removeShaderDefine(Gi.SHADERDEFINE_TILINGOFFSET1);this._setColor(7,e)}),a(0,n,"maskTilingOffset",function(){return this._getColor(8)},function(e){if(e){var t=e.elements;1!=t[0]||1!=t[1]||0!=t[2]||0!=t[3]?this._addShaderDefine(Gi.SHADERDEFINE_TILINGOFFSET2):this._removeShaderDefine(Gi.SHADERDEFINE_TILINGOFFSET2)}else this._removeShaderDefine(Gi.SHADERDEFINE_TILINGOFFSET2);this._setColor(8,e)}),t.__init__=function(){t.SHADERDEFINE_MAINTEXTURE=t.shaderDefines.registerDefine("MAINTEXTURE"),t.SHADERDEFINE_MASKTEXTURE=t.shaderDefines.registerDefine("MASKTEXTURE"),t.SHADERDEFINE_TILINGOFFSET1=t.shaderDefines.registerDefine("TILINGOFFSET1"),t.SHADERDEFINE_TILINGOFFSET2=t.shaderDefines.registerDefine("TILINGOFFSET2")},t.initShader=function(){var e={a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshColor:1,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},t={u_MainTexture:[1,1],u_MaskTexture:[2,1],u_BaseColor:[3,1],u_AlphaColor:[4,1],u_Instensity:[5,1],u_Alpha:[6,1],u_TilingOffset1:[7,1],u_TilingOffset2:[8,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]},n=Ci.nameKey.add("Particle"),i="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n	attribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n	attribute vec3 a_MeshPosition;\n	attribute vec4 a_MeshColor;\n	attribute vec2 a_MeshTextureCoordinate;\n	varying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef MAINTEXTURE\n	varying vec2 v_TextureCoordinate;\n	#ifdef TILINGOFFSET1\n		uniform vec4 u_TilingOffset1;\n	#endif\n#endif\n\n#ifdef MASKTEXTURE\n	#ifdef TILINGOFFSET2\n		uniform vec4 u_TilingOffset2;\n	#endif\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n	uniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n	uniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n	uniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n	varying vec3 v_PositionWorld;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n	float halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n	float halfYaw = rot.y * 0.5;\n\n	float sinRoll = sin(halfRoll);\n	float cosRoll = cos(halfRoll);\n	float sinPitch = sin(halfPitch);\n	float cosPitch = cos(halfPitch);\n	float sinYaw = sin(halfYaw);\n	float cosYaw = cos(halfYaw);\n\n	float quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n	float quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n	float quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n	float quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n	\n	//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n	//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n	//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n	\n	float x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n	float xx = quaX * x;\n    float xy = quaX * y;\n	float xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n	\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n	float halfAngle = angle * 0.5;\n	float sin = sin(halfAngle);\n	\n	float quaX = axis.x * sin;\n	float quaY = axis.y * sin;\n	float quaZ = axis.z * sin;\n	float quaW = cos(halfAngle);\n	\n	//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n	//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n	//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n	\n	float x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n	float xx = quaX * x;\n    float xy = quaX * y;\n	float xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n	\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n	return v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n	float curValue;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientNumber=gradientNumbers[i];\n		float key=gradientNumber.x;\n		if(key>=normalizedAge)\n		{\n			vec2 lastGradientNumber=gradientNumbers[i-1];\n			float lastKey=lastGradientNumber.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			curValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n			break;\n		}\n	}\n	return curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n	float totalValue=0.0;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientNumber=gradientNumbers[i];\n		float key=gradientNumber.x;\n		vec2 lastGradientNumber=gradientNumbers[i-1];\n		float lastValue=lastGradientNumber.y;\n		\n		if(key>=normalizedAge){\n			float lastKey=lastGradientNumber.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			totalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n			break;\n		}\n		else{\n			totalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n		}\n	}\n	return totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n	vec4 overTimeColor;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientAlpha=gradientAlphas[i];\n		float alphaKey=gradientAlpha.x;\n		if(alphaKey>=normalizedAge)\n		{\n			vec2 lastGradientAlpha=gradientAlphas[i-1];\n			float lastAlphaKey=lastGradientAlpha.x;\n			float age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n			overTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n			break;\n		}\n	}\n	\n	for(int i=1;i<4;i++)\n	{\n		vec4 gradientColor=gradientColors[i];\n		float colorKey=gradientColor.x;\n		if(colorKey>=normalizedAge)\n		{\n			vec4 lastGradientColor=gradientColors[i-1];\n			float lastColorKey=lastGradientColor.x;\n			float age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n			overTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n			break;\n		}\n	}\n	return overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n	float overTimeFrame;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientFrame=gradientFrames[i];\n		float key=gradientFrame.x;\n		if(key>=normalizedAge)\n		{\n			vec2 lastGradientFrame=gradientFrames[i-1];\n			float lastKey=lastGradientFrame.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			overTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n			break;\n		}\n	}\n	return floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n	 outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n	 outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n	                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n					 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n					\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n	#ifdef VELOCITYOVERLIFETIMECONSTANT\n		  startPosition=startVelocity*age;\n		  lifePosition=lifeVelocity*age;\n	#endif\n	#ifdef VELOCITYOVERLIFETIMECURVE\n		  startPosition=startVelocity*age;\n		  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n	#endif\n	#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n		  startPosition=startVelocity*age;\n		  lifePosition=lifeVelocity*age;\n	#endif\n	#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n		  startPosition=startVelocity*age;\n		  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n	      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n	      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n	#endif\n	\n	vec3 finalPosition;\n	if(u_VOLSpaceType==0){\n	  if(u_ScalingMode!=2)\n	   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n	  else\n	   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n	}\n	else{\n	  if(u_ScalingMode!=2)\n	    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n	  else\n	    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n	}\n  #else\n	 startPosition=startVelocity*age;\n	 vec3 finalPosition;\n	 if(u_ScalingMode!=2)\n	   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n	 else\n	   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n	#ifdef COLOROVERLIFETIME\n	  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n	#endif\n	\n	#ifdef RANDOMCOLOROVERLIFETIME\n	  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n	#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n	#ifdef SIZEOVERLIFETIMECURVE\n		size*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVES\n	    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n	#endif\n	#ifdef SIZEOVERLIFETIMECURVESEPERATE\n		size*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n	    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n	    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n	#endif\n	return size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n	#ifdef SIZEOVERLIFETIMECURVE\n		size*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVES\n	    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n	#endif\n	#ifdef SIZEOVERLIFETIMECURVESEPERATE\n		size*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n	    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n	    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n		,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n	#endif\n	return size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n	#ifdef ROTATIONOVERLIFETIME\n		#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConst*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n		#endif\n	#endif\n	#ifdef ROTATIONOVERLIFETIMESEPERATE\n		#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n		#endif\n	#endif\n	return rotation;\n}\n\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n	#ifdef ROTATIONOVERLIFETIME\n	#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConst*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n		#endif\n	#endif\n	#ifdef ROTATIONOVERLIFETIMESEPERATE\n	#ifdef ROTATIONOVERLIFETIMECONSTANT\n			vec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			vec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n	        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n	        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n		#endif\n	#endif\n	return rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n	#ifdef TEXTURESHEETANIMATIONCURVE\n		float cycleNormalizedAge=normalizedAge*u_TSACycles;\n		float frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n		float totalULength=frame*u_TSASubUVLength.x;\n		float floorTotalULength=floor(totalULength);\n	    uv.x+=totalULength-floorTotalULength;\n		uv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n	#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n		float cycleNormalizedAge=normalizedAge*u_TSACycles;\n		float uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n	    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n		float totalULength=frame*u_TSASubUVLength.x;\n		float floorTotalULength=floor(totalULength);\n	    uv.x+=totalULength-floorTotalULength;\n		uv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n	return uv;\n}\n\nvoid main()\n{\n	float age = u_CurrentTime - a_DirectionTime.w;\n	float normalizedAge = age/a_ShapePositionStartLifeTime.w;\n	vec3 lifeVelocity;\n	if(normalizedAge<1.0){ \n	vec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n	#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n		lifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n	#endif \n	vec3 gravityVelocity=u_Gravity*age;\n	\n	vec4 worldRotation;\n	if(u_SimulationSpace==0)\n		worldRotation=a_SimulationWorldRotation;\n	else\n		worldRotation=u_WorldRotation;\n	\n	vec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n	    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n		#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n			if(u_ThreeDStartRotation){\n				vec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n				center += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n			}\n			else{\n				float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n				float c = cos(rot);\n				float s = sin(rot);\n				mat2 rotation= mat2(c, -s, s, c);\n				corner=rotation*corner;\n				center += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n			}\n		#else\n			if(u_ThreeDStartRotation){\n				center += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n			}\n			else{\n				float c = cos(a_StartRotation0.x);\n				float s = sin(a_StartRotation0.x);\n				mat2 rotation= mat2(c, -s, s, c);\n				corner=rotation*corner;\n				center += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n			}\n		#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n	vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n	vec3 velocity;\n	#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n	    if(u_VOLSpaceType==0)\n		  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n	    else\n		  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n	    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif	\n		vec3 cameraUpVector = normalize(velocity);\n		vec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n		\n		sideVector=u_SizeScale.xzy*sideVector;\n		cameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n		\n	    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n		\n	    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n	    corner=rotaionZHalfPI*corner;\n	    corner.y=corner.y-abs(corner.y);\n		\n	    float speed=length(velocity);//TODO:\n	    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n	    const vec3 sideVector = vec3(-1.0,0.0,0.0);\n		\n		float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n	    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n		corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n		\n		float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n	    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n		corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n	    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n		#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n			if(u_ThreeDStartRotation){\n				vec3 rotation=vec3(a_StartRotation0.xy,-computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n				center+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n			}\n			else{\n				#ifdef ROTATIONOVERLIFETIME\n					float angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n					if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n						center+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n					}\n					else{\n						#ifdef SHAPE\n							center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n						#else\n							if(u_SimulationSpace==0)\n								center+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n							else if(u_SimulationSpace==1)\n								center+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n						#endif\n					}\n				#endif\n				#ifdef ROTATIONOVERLIFETIMESEPERATE\n					//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n					vec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,a_StartRotation0.z), age,normalizedAge);\n					center+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n				#endif	\n			}\n		#else\n			if(u_ThreeDStartRotation){\n				center+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n			}\n			else{\n				if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n					if(u_SimulationSpace==0)\n						center+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n					else if(u_SimulationSpace==1)\n						center+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n				}\n				else{\n					#ifdef SHAPE\n						if(u_SimulationSpace==0)\n							center+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n						else if(u_SimulationSpace==1)\n							center+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);	\n					#else\n						if(u_SimulationSpace==0)\n							center+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n						else if(u_SimulationSpace==1)\n							center+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n					#endif\n				}\n			}\n		#endif\n		v_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n	#ifdef MAINTEXTURE\n		#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n			v_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n		#endif\n		#ifdef RENDERMODE_MESH\n			v_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n		#endif\n		\n		v_Texcoord0 = v_TextureCoordinate;\n		#ifdef TILINGOFFSET1 \n			v_Texcoord0=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset1.xy+vec2(u_TilingOffset1.z,-u_TilingOffset1.w);//需要特殊处理\n			v_Texcoord0=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n		#endif\n		\n		v_Texcoord1 = v_TextureCoordinate;\n		#ifdef TILINGOFFSET2 \n			v_Texcoord1=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset2.xy+vec2(u_TilingOffset2.z,-u_TilingOffset2.w);//需要特殊处理\n			v_Texcoord1=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n		#endif\n		\n	#endif\n    v_Discard=0.0;\n	  \n	#ifdef FOG\n		v_PositionWorld=center;\n	#endif\n   }\n   else\n	{\n		v_Discard=1.0;\n	}\n}\n\n",r="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\nuniform vec4 u_BaseColor;\nuniform vec4 u_AlphaColor;\nuniform float u_Instensity;\nuniform float u_Alpha;\n\n#ifdef MAINTEXTURE\n	uniform sampler2D u_MainTexture;\n#endif\n\n#ifdef MASKTEXTURE\n	uniform sampler2D u_MaskTexture;\n#endif\n\n#ifdef RENDERMODE_MESH\n	varying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n	varying vec3 v_PositionWorld;\n	uniform vec3 u_CameraPosition;\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	#ifdef ADDTIVEFOG\n	#else\n		uniform vec3 u_FogColor;\n	#endif\n#endif\n\n\nvoid main()\n{	\n	#ifdef RENDERMODE_MESH\n		gl_FragColor=v_MeshColor;\n	#else\n		gl_FragColor=vec4(1.0);	\n	#endif\n		\n	vec4 mainTextureColor = vec4(1.0);\n	#ifdef MAINTEXTURE\n		mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n	#endif\n	\n	vec4 maskTextureColor = vec4(1.0);\n	#ifdef MASKTEXTURE\n		maskTextureColor = texture2D(u_MaskTexture, v_Texcoord1);\n	#endif\n	\n	vec4 outColor = mix(vec4(0.0), mainTextureColor, maskTextureColor);\n	\n	gl_FragColor *= 2.0 * outColor * u_BaseColor * u_AlphaColor * v_Color * u_Instensity;\n	gl_FragColor.a *= u_Alpha;\n	\n	#ifdef FOG\n		vec3 toEye=u_CameraPosition-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n		\n		float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n		#ifdef ADDTIVEFOG\n			gl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n		#else\n			gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n		#endif\n	#endif\n}",a=ri.add(n,i,r,e,t);
Gi.SHADERDEFINE_MAINTEXTURE=a.registerMaterialDefine("MAINTEXTURE"),Gi.SHADERDEFINE_MASKTEXTURE=a.registerMaterialDefine("MASKTEXTURE"),Gi.SHADERDEFINE_TILINGOFFSET1=a.registerMaterialDefine("TILINGOFFSET1"),Gi.SHADERDEFINE_TILINGOFFSET2=a.registerMaterialDefine("TILINGOFFSET2"),lr.SHADERDEFINE_RENDERMODE_BILLBOARD=a.registerSpriteDefine("SPHERHBILLBOARD"),lr.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=a.registerSpriteDefine("STRETCHEDBILLBOARD"),lr.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=a.registerSpriteDefine("HORIZONTALBILLBOARD"),lr.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=a.registerSpriteDefine("VERTICALBILLBOARD"),lr.SHADERDEFINE_COLOROVERLIFETIME=a.registerSpriteDefine("COLOROVERLIFETIME"),lr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=a.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),lr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),lr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),lr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),lr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),lr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),lr.SHADERDEFINE_ROTATIONOVERLIFETIME=a.registerSpriteDefine("ROTATIONOVERLIFETIME"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=a.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=a.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=a.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),lr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),lr.SHADERDEFINE_SIZEOVERLIFETIMECURVE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),lr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),lr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),lr.SHADERDEFINE_RENDERMODE_MESH=a.registerSpriteDefine("RENDERMODE_MESH"),lr.SHADERDEFINE_SHAPE=a.registerSpriteDefine("SHAPE")},t.MAINTEXTURE=1,t.MASKTEXTURE=2,t.BASECOLOR=3,t.ALPHACOLOR=4,t.INTENSITY=5,t.ALPHA=6,t.TILINGOFFSET1=7,t.TILINGOFFSET2=8,t.SHADERDEFINE_MAINTEXTURE=0,t.SHADERDEFINE_MASKTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET1=0,t.SHADERDEFINE_TILINGOFFSET2=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),function(e){function t(){}r(t,"laya.d3.extension.lulingmen.UVSineMaterial",e);var n=t.prototype;return a(0,n,"alpha",function(){}),a(0,n,"baseTexture",function(){}),a(0,n,"baseScrollSpeedX",function(){}),a(0,n,"secondTexture",function(){}),a(0,n,"mMultiplier",function(){}),a(0,n,"baseScrollSpeedY",function(){}),a(0,n,"albedoColor",function(){}),a(0,n,"secondScrollSpeedX",function(){}),a(0,n,"secondScrollSpeedY",function(){}),a(0,n,"tilingOffset",function(){}),a(0,n,"detailTilingOffset",function(){}),t.__init__=function(){t.SHADERDEFINE_BASETEXTURE=t.shaderDefines.registerDefine("BASETEXTURE"),t.SHADERDEFINE_SECONDTEXTURE=t.shaderDefines.registerDefine("SECONDTEXTURE"),t.SHADERDEFINE_TILINGOFFSET1=t.shaderDefines.registerDefine("TILINGOFFSET1"),t.SHADERDEFINE_TILINGOFFSET2=t.shaderDefines.registerDefine("TILINGOFFSET2")},t.initShader=function(){var e={a_Position:0,a_Normal:3,a_Color:1,a_Texcoord0:2},t={u_MvpMatrix:[1,2],u_Time:[22,4],u_BaseTexture:[1,1],u_SecondTexture:[2,1],u_BaseColor:[3,1],u_BaseScrollSpeedX:[4,1],u_BaseScrollSpeedY:[5,1],u_SecondScrollSpeedX:[6,1],u_SecondScrollSpeedY:[7,1],u_MMultiplier:[8,1],u_Alpha:[9,1],u_TilingOffset1:[10,1],u_TilingOffset2:[11,1]},n=Ci.nameKey.add("UVSine"),i="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\nattribute vec4 a_Color;\n\nuniform mat4 u_MvpMatrix;\nuniform float u_Time;\nuniform float u_BaseScrollSpeedX;\nuniform float u_BaseScrollSpeedY;\nuniform float u_SecondScrollSpeedX;\nuniform float u_SecondScrollSpeedY;\n\nuniform vec4 u_TilingOffset1;\nuniform vec4 u_TilingOffset2;\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec4 v_Color;\n\nvoid main()\n{\n	v_Texcoord0 = a_Texcoord0;\n	#ifdef TILINGOFFSET1\n		v_Texcoord0 = (vec2(v_Texcoord0.x, v_Texcoord0.y - 1.0) * u_TilingOffset1.xy) + u_TilingOffset1.zw;\n		v_Texcoord0 = vec2(v_Texcoord0.x, 1.0 + v_Texcoord0.y);\n	#endif\n	\n	v_Texcoord1 = a_Texcoord0;\n	#ifdef TILINGOFFSET2\n		v_Texcoord1 = (vec2(v_Texcoord1.x, v_Texcoord1.y - 1.0) * u_TilingOffset2.xy) + u_TilingOffset2.zw;\n		v_Texcoord1 = vec2(v_Texcoord1.x, 1.0 + v_Texcoord1.y);\n	#endif\n	\n	v_Texcoord0 = v_Texcoord0 + vec2(fract(u_BaseScrollSpeedX * u_Time / 20.0), fract(-u_BaseScrollSpeedY * u_Time));\n	v_Texcoord1 = v_Texcoord1 + vec2(fract(u_SecondScrollSpeedX * u_Time / 20.0), fract(-u_SecondScrollSpeedY * u_Time));\n	\n	v_Color = vec4(1.0);\n	#ifdef COLOR\n		v_Color = a_Color;\n	#endif\n	\n	gl_Position = u_MvpMatrix * a_Position;\n}",r="#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nvarying vec4 v_Color;\n\n#ifdef BASETEXTURE\n	uniform sampler2D u_BaseTexture;\n#endif\n\n#ifdef SECONDTEXTURE\n	uniform sampler2D u_SecondTexture;\n#endif\n\nuniform vec4 u_BaseColor;\nuniform float u_MMultiplier;\nuniform float u_Alpha;\n\nvoid main()\n{\n	vec4 baseTextureColor = vec4(1.0);\n	#ifdef BASETEXTURE\n		baseTextureColor = texture2D(u_BaseTexture, v_Texcoord0);\n	#endif\n	\n	vec4 secondTextureColor = vec4(1.0);\n	#ifdef SECONDTEXTURE\n		secondTextureColor = texture2D(u_SecondTexture, v_Texcoord1);\n	#endif\n	\n	gl_FragColor = baseTextureColor * secondTextureColor * u_BaseColor * u_MMultiplier * v_Color;\n	gl_FragColor.a *= u_Alpha;\n}\n",a=ri.add(n,i,r,e,t);laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_BASETEXTURE=a.registerMaterialDefine("BASETEXTURE"),laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_SECONDTEXTURE=a.registerMaterialDefine("SECONDTEXTURE"),laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_TILINGOFFSET1=a.registerMaterialDefine("TILINGOFFSET1"),laya.d3.extension.lulingmen.UVSineMaterial.SHADERDEFINE_TILINGOFFSET2=a.registerMaterialDefine("TILINGOFFSET2")},t.BASETEXTURE=1,t.SECONDTEXTURE=2,t.BASECOLOR=3,t.BASESCROLLSPEEDX=4,t.BASESCROLLSPEEDY=5,t.SECONDSCROLLSPEEDX=6,t.SECONDSCROLLSPEEDY=7,t.MMULTIPLIER=8,t.ALPHA=9,t.TILINGOFFSET1=10,t.TILINGOFFSET2=11,t.SHADERDEFINE_BASETEXTURE=0,t.SHADERDEFINE_SECONDTEXTURE=0,t.SHADERDEFINE_TILINGOFFSET1=0,t.SHADERDEFINE_TILINGOFFSET2=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(ci.shaderDefines)}]),t}(ci),function(e){function t(){}r(t,"laya.d3.water.WaterDetailMaterial",e);var n=t.prototype;return a(0,n,"currentTm",function(){}),a(0,n,"waveInfo",function(){}),a(0,n,"waveInfoD",function(){}),a(0,n,"texWaveUVScale",function(){}),t.init=function(){if(!laya.d3.water.WaterDetailMaterial._bInited){laya.d3.water.WaterDetailMaterial._bInited=!0;{var e={a_position:0,a_normal:3,uv:2},t={u_curTm:[1,1],u_WaveInfo:[12,1],u_WaveInfoD:[13,1],TEXWAVE_UV_SCALE:[15,1]},n=Ci.nameKey.add("WaterDetail"),i="\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\n\nvoid main() {\n	vec3 pos = a_position;\n	if(pos.z!=0.)pos.y=pos.z;\n	pos.z=0.5;\n	gl_Position = vec4(pos,1.);\n    vUv = uv;\n	//vWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n	//vWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n	//vWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n}\n",r='precision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\nuniform float u_curTm;\n\n#include "WaveFunction.glsl"\n\nvoid main() {\n	vec3 wave_N,wave_B,wave_T;\n	calcWave(u_curTm, vUv,wave_B,wave_T,wave_N);\n	gl_FragColor.rgb = normalize(wave_N)*0.5+vec3(0.5);// vec3(0.1,.4,0.1);\n    gl_FragColor.a = 1.0;\n}\n';ri.add(n,i,r,e,t)}}},t.CURTM=1,t.WAVEINFO=12,t.WAVEINFOD=13,t.WAVEMAINDIR=14,t.TEXWAVE_UV_SCALE=15,t._bInited=!1,t}(ci),function(e){function t(){}r(t,"laya.d3.component.animation.RigidAnimations",e);var n=t.prototype;return n._init=function(){},n._animtionPlay=function(){},n._animtionStop=function(){},n._effectAnimation=function(){},n._load=function(){},n._update=function(){},n._unload=function(){},a(0,n,"url",null,function(){}),a(0,n,"templet",e.prototype._$get_templet,function(){}),t}(mi),function(e){function t(){this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,this._boneIndexToMeshList=null,this._oldVersion=!1,t.__super.call(this),this._boneIndexToMeshList=[]}r(t,"laya.d3.component.animation.SkinAnimations",e);var i=t.prototype;return i._computeBoneIndexToMeshOnTemplet=function(){this._templet.loaded?this._computeBoneIndexToMeshOnMesh():this._templet.once("loaded",this,this._computeBoneIndexToMeshOnMesh)},i._computeBoneIndexToMeshOnMesh=function(){this._oldVersion="LAYAANIMATION:02"===this._templet._aniVersion?!1:!0;var e=this._owner.meshFilter.sharedMesh;e.loaded?this._computeBoneIndexToMesh(e):e.on("loaded",this,this._computeBoneIndexToMesh)},i._computeBoneIndexToMesh=function(e){var t=e._boneNames;if(t)for(var n=t.length,i=this._templet._anis,r=0,a=i.length;a>r;r++){var o=this._boneIndexToMeshList[r];o||(o=this._boneIndexToMeshList[r]=[]),o.length=n;for(var s=i[r],l=0;n>l;l++)o[l]=s.bone3DMap[t[l]]}},i._getAnimationDatasWithCache=function(e,t,n,i,r){var a=n[i];if(a){var o=a[e];if(o){var s=o[t.id];return s?s[r]:null}return null}return null},i._setAnimationDatasWithCache=function(e,t,n,i,r,a){var o=n[i]||(n[i]={}),s=o[e]||(o[e]={}),l=s[t.id]||(s[t.id]=[]);l[r]=a},i._onAnimationPlayMeshLoaded=function(){for(var e=this._ownerMesh.meshRender._renderElements,t=0,n=e.length;n>t;t++)e[t]._canDynamicBatch=!1},i._onAnimationPlay=function(){this._ownerMesh._render._addShaderDefine(ur.SHADERDEFINE_BONE);var e=this._ownerMesh.meshFilter.sharedMesh;e.loaded?this._onAnimationPlayMeshLoaded():e.once("loaded",this,this._onAnimationPlayMeshLoaded)},i._onAnimationStop=function(){this._lastFrameIndex=-1,this._player.returnToZeroStopped&&(this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh._render._removeShaderDefine(ur.SHADERDEFINE_BONE));for(var e=this._ownerMesh.meshRender._renderElements,t=0,n=e.length;n>t;t++)e[t]._canDynamicBatch=!0},i._load=function(t){e.prototype._load.call(this,t),this._ownerMesh=t,this._player.on("played",this,this._onAnimationPlay),this._player.on("stopped",this,this._onAnimationStop),this._owner.meshFilter.on("meshchanged",this,this._computeBoneIndexToMeshOnTemplet)},i._update=function(){var e=this._ownerMesh.meshFilter.sharedMesh;if(2===this._player.state&&this._templet&&this._templet.loaded&&e.loaded){var i=this._player.playbackRate*n.timer.scale,r=this._player.cachePlayRate,a=this._player.isCache&&i>=r,o=a?this.currentFrameIndex:-1;if(-1===o||this._lastFrameIndex!==o){var s=this.currentAnimationClipIndex,l=this._templet._animationDatasCache[0],u=this._templet._animationDatasCache[1];if(a){var c=this._getAnimationDatasWithCache(r,e,u,s,o);if(c)return this._curAnimationDatas=c,this._curBonesDatas=this._templet.getAnimationDataWithCache(r,l,s,o),this._lastFrameIndex=o,void 0}var h=!1;a&&(this._curBonesDatas=this._templet.getAnimationDataWithCache(r,l,s,o),h=this._curBonesDatas?!0:!1);var d=this._templet.getNodes(s),_=16*d.length,f=e.InverseAbsoluteBindPoses;this._oldVersion?this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(_)):this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(16*f.length));var m,p,E=0,v=0,g=0,T=e.getSubMeshCount();if(a){for(this._curAnimationDatas=[],this._curAnimationDatas.length=T,E=0;T>E;E++)for(m=this._curAnimationDatas[E]=[],p=e.getSubMesh(E),g=p._boneIndicesList.length,m.length=g,v=0;g>v;v++)m[v]=new Float32Array(16*p._boneIndicesList[v].length);h||(this._curBonesDatas=new Float32Array(_))}else{if(!this._tempCurAnimationData)for(this._tempCurAnimationData=[],this._tempCurAnimationData.length=T,E=0;T>E;E++)for(m=this._tempCurAnimationData[E]=[],p=e.getSubMesh(E),g=p._boneIndicesList.length,m.length=g,v=0;g>v;v++)m[v]=new Float32Array(16*p._boneIndicesList[v].length);this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(_)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData}if(this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(s))),a?this._templet.getOriginalData(s,this._curOriginalData,this._player._fullFrames[s],o,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(s,this._curOriginalData,this._player.currentPlayTime),this._oldVersion)a&&h?kn._computeAnimationDatasByArrayAndMatrixFastOld(f,this._curBonesDatas,this._curMeshAnimationData):kn._computeBoneAndAnimationDatasByBindPoseMatrxixOld(d,this._curOriginalData,f,this._curBonesDatas,this._curMeshAnimationData);else{var S=this._boneIndexToMeshList[s];a&&h?kn._computeAnimationDatasByArrayAndMatrixFast(f,this._curBonesDatas,this._curMeshAnimationData,S):kn._computeBoneAndAnimationDatasByBindPoseMatrxix(d,this._curOriginalData,f,this._curBonesDatas,this._curMeshAnimationData,S)}for(E=0;T>E;E++){var D=e.getSubMesh(E)._boneIndicesList;for(g=D.length,m=this._curAnimationDatas[E],v=0;g>v;v++)t._splitAnimationDatas(D[v],this._curMeshAnimationData,m[v])}a&&(this._setAnimationDatasWithCache(r,e,u,s,o,this._curAnimationDatas),h||this._templet.setAnimationDataWithCache(r,l,s,o,this._curBonesDatas)),this._lastFrameIndex=o}}},i._preRenderUpdate=function(e){var t=e.renderElement.renderObj;t._skinAnimationDatas=this._curAnimationDatas?this._curAnimationDatas[t._indexInMesh]:null},i._unload=function(t){2==this.player.state&&this._ownerMesh._render._removeShaderDefine(ur.SHADERDEFINE_BONE),this._templet&&!this._templet.loaded&&this._templet.off("loaded",this,this._computeBoneIndexToMeshOnMesh);var n=this._ownerMesh.meshFilter.sharedMesh;n.loaded||n.off("loaded",this,this._onAnimationPlayMeshLoaded),e.prototype._unload.call(this,t),this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null},a(0,i,"curBonesDatas",function(){return this._curBonesDatas}),a(0,i,"templet",e.prototype._$get_templet,function(e){this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._computeBoneIndexToMeshOnTemplet(),this._curOriginalData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]]),this.event("animationchanged",this))}),t._splitAnimationDatas=function(e,t,n){for(var i=0,r=e.length,a=0;r>i;i++)for(var o=0;16>o;o++,a++)n[a]=t[(e[i]<<4)+o]},t}(mi)),Wi=function(e){function t(){this._size=null,this._transformOrientedBoundBox=null,this.center=null,t.__super.call(this),this._needUpdate=!1}r(t,"laya.d3.component.physics.BoxCollider",e);var n=t.prototype;return n._updateCollider=function(){if(this._needUpdate){var e=this._owner.transform,n=e.worldMatrix;n.cloneTo(this._transformOrientedBoundBox.transformation),On.multiply(e.scale,this.center,t._deviationV3),On.transformQuat(t._deviationV3,e.rotation,t._deviationV3),this._transformOrientedBoundBox.getCenter(t._obbCenterV3),On.add(t._obbCenterV3,t._deviationV3,t._deviationV3),this._transformOrientedBoundBox.transformation.setTranslationVector(t._deviationV3),this._needUpdate=!1}},n._onWorldMatrixChanged=function(){this._needUpdate=!0;for(var e in this._runtimeCollisonMap)this._runtimeCollisonTestMap[e]=!0,this._runtimeCollisonMap[e]._runtimeCollisonTestMap[this.id]=!0},n._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),this._transformOrientedBoundBox=new Mn(new On,new xn),this._size=new On,this.center=new On,e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._getType=function(){return 1},n._collisonTo=function(e){switch(e._getType()){case 0:return 0!==this.boundBox.containsSphere(e.boundSphere);case 1:return 0!==this.boundBox.containsOrientedBoundBox(e.boundBox);case 2:var t=e;if(0!==this.boundBox.containsBoundBox(t._boundBox)){for(var n=e.mesh._positions,i=0,r=n.length;r>i;i++)if(1===this.boundBox.containsPoint(n[i]))return!0;return!1}return!1;default:throw new Error("BoxCollider:unknown collider type.")}},n._cloneTo=function(e){var t=e,n=t.size;this.size.cloneTo(n),t.size=n,this.center.cloneTo(t.center)},n.raycast=function(e,t,n){void 0===n&&(n=1.79e308),this._updateCollider();var i=this._transformOrientedBoundBox.intersectsRay(e,t.position);return-1!==i&&n>=i?(t.distance=i,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},n.setFromBoundBox=function(e){Mn.createByBoundBox(e,this._transformOrientedBoundBox);var t=this._transformOrientedBoundBox.extents;this._size=new On(2*t.x,2*t.y,2*t.z),this.center=new On,On.add(e.min,e.max,this.center),On.scale(this.center,.5,this.center),this._needUpdate=!0},a(0,n,"boundBox",function(){return this._updateCollider(),this._transformOrientedBoundBox}),a(0,n,"size",function(){return this._size},function(e){this._size=e,On.scale(e,.5,this._transformOrientedBoundBox.extents)}),i(t,["_deviationV3",function(){return this._deviationV3=new On},"_obbCenterV3",function(){return this._obbCenterV3=new On}]),t}(Ei),ki=function(e){function t(){this._transformBoundingBox=null,this._mesh=null,t.__super.call(this),this._transformBoundingBox=new En(new On,new On),this._needUpdate=!1}r(t,"laya.d3.component.physics.MeshCollider",e);var n=t.prototype;return n._updateBoundBoxCollider=function(){if(this._needUpdate){for(var e=this._owner.transform.worldMatrix,n=this._mesh.boundingBoxCorners,i=0;8>i;i++)On.transformCoordinate(n[i],e,t._tempBoundBoxCorners[i]);En.createfromPoints(t._tempBoundBoxCorners,this._transformBoundingBox),this._needUpdate=!1}},n._raycastMesh=function(e,n,i,r){void 0===r&&(r=1.79e308);var a=n.transform.worldMatrix,o=t._tempMatrix4x40;a.invert(o);var s=e.origin,l=e.direction,u=t._tempRay0;On.transformCoordinate(s,o,u.origin),On.TransformNormal(l,o,u.direction);for(var c=Number.MAX_VALUE,h=0,d=this._mesh.getRenderElementsCount();d>h;h++){var _=this._mesh.getRenderElement(h),f=_._getVertexBuffer(0),m=f.getData(),p=_._getIndexBuffer().getData(),E=t._tempRaycastHit,v=Gn.rayIntersectsPositionsAndIndices(u,m,f.vertexDeclaration,p,E);if(v){On.transformCoordinate(E.position,a,E.position);var g=t._tempVector30;On.subtract(s,E.position,g);var T=On.scalarLength(g);if(r>T&&c>T){E.distance=T,E.sprite3D=n;var S=E.trianglePositions;On.transformCoordinate(S[0],a,S[0]),On.transformCoordinate(S[1],a,S[1]),On.transformCoordinate(S[2],a,S[2]);var D=E.triangleNormals;return On.transformCoordinate(D[0],a,D[0]),On.transformCoordinate(D[1],a,D[1]),On.transformCoordinate(D[2],a,D[2]),c=T,E.cloneTo(i),!0}return!1}}return!1},n._onWorldMatrixChanged=function(){this._needUpdate=!0},n._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._getType=function(){return 2},n._collisonTo=function(e){var t=0,n=0,i=this.mesh._positions;switch(e._getType()){case 0:var r=e;if(0!==Tn.sphereContainsBox(r.boundSphere,this._boundBox)){for(t=0,n=i.length;n>t;t++)if(1===Tn.sphereContainsPoint(r.boundSphere,i[t]))return!0;return!1}return!1;case 1:var a=e;if(0!==a.boundBox.containsBoundBox(this._boundBox)){for(t=0,n=i.length;n>t;t++)if(1===a.boundBox.containsPoint(i[t]))return!0;return!1}return!1;case 2:var o=e;return 1!==Tn.intersectsBoxAndBox(o._boundBox,this._boundBox)?!0:!1;default:throw new Error("MeshCollider:unknown collider type.")}},n._cloneTo=function(e){var t=e;t.mesh=this._mesh},n.raycast=function(e,t,n){if(void 0===n&&(n=1.79e308),null==this._mesh||!this._mesh.loaded)return!1;var i=Tn.intersectsRayAndBoxRD(e,this._boundBox);return-1!==i&&n>=i&&this._raycastMesh(e,this._owner,t,n)?!0:(t.distance=-1,t.sprite3D=null,!1)},a(0,n,"_boundBox",function(){return this._updateBoundBoxCollider(),this._transformBoundingBox}),a(0,n,"mesh",function(){return this._mesh},function(e){this._mesh=e}),i(t,["_tempRay0",function(){return this._tempRay0=new yn(new On,new On)},"_tempVector30",function(){return this._tempVector30=new On},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new xn},"_tempRaycastHit",function(){return this._tempRaycastHit=new zn},"_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new On,new On,new On,new On,new On,new On,new On,new On]}]),t}(Ei),Xi=function(e){function t(){this._originalBoundSphere=null,this._transformBoundSphere=null,t.__super.call(this),this._needUpdate=!1}r(t,"laya.d3.component.physics.SphereCollider",e);var n=t.prototype;return n._updateCollider=function(){if(this._needUpdate){var e=0/0,t=this._owner.transform,n=t.scale;e=n.x>=n.y&&n.x>=n.z?n.x:n.y>=n.z?n.y:n.z,On.transformCoordinate(this._originalBoundSphere.center,t.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=this._originalBoundSphere.radius*e,this._needUpdate=!1}},n._onWorldMatrixChanged=function(){this._needUpdate=!0;for(var e in this._runtimeCollisonMap)this._runtimeCollisonTestMap[e]=!0,this._runtimeCollisonMap[e]._runtimeCollisonTestMap[this.id]=!0},n._initialize=function(e){laya.d3.component.Component3D.prototype._initialize.call(this,e),this._originalBoundSphere=new gn(new On(0,0,0),.5),this._transformBoundSphere=new gn(new On(0,0,0),.5),e.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._getType=function(){return 0},n._collisonTo=function(e){switch(e._getType()){case 0:return 0!==Tn.sphereContainsSphere(this.boundSphere,e.boundSphere);case 1:return 0!==e.boundBox.containsSphere(this.boundSphere);case 2:var t=e;if(0!==Tn.sphereContainsBox(this.boundSphere,t._boundBox)){for(var n=t.mesh._positions,i=0,r=n.length;r>i;i++)if(1===Tn.sphereContainsPoint(this.boundSphere,n[i]))return!0;return!1}return!1;default:throw new Error("SphereCollider:unknown collider type.")}},n._cloneTo=function(e){var t=e;t.radius=this.radius;var n=t.center;this.center.cloneTo(n),t.center=n},n.raycast=function(e,t,n){void 0===n&&(n=1.79e308),this._updateCollider();var i=this._transformBoundSphere.intersectsRayPoint(e,t.position);return-1!==i&&n>=i?(t.distance=i,t.sprite3D=this._owner,!0):(t.distance=-1,t.sprite3D=null,!1)},a(0,n,"center",function(){return this._originalBoundSphere.center},function(e){this._originalBoundSphere.center=e}),a(0,n,"radius",function(){return this._originalBoundSphere.radius},function(e){this._originalBoundSphere.radius=e}),a(0,n,"boundSphere",function(){return this._updateCollider(),this._transformBoundSphere}),t}(Ei),Yi=function(e){function t(){this.simLodInfo=null,this._src=null,this._buffer=null,this._mipmaps=null,this._recreateLock=!1,this._needReleaseAgain=!1,t.__super.call(this),this._type=3553}r(t,"laya.d3.resource.DataTexture2D",e);var o=t.prototype;return o.genDebugMipmaps=function(){var e=[];return e.push(new Uint8Array(new Uint32Array(131072).fill(4278190335).buffer)),e.push(new Uint8Array(new Uint32Array(32768).fill(4278223103).buffer)),e.push(new Uint8Array(new Uint32Array(8192).fill(4278255615).buffer)),e.push(new Uint8Array(new Uint32Array(2048).fill(4278255360).buffer)),e.push(new Uint8Array(new Uint32Array(512).fill(4286595072).buffer)),e.push(new Uint8Array(new Uint32Array(128).fill(4294901760).buffer)),e.push(new Uint8Array(new Uint32Array(32).fill(4294901888).buffer)),e.push(new Uint8Array(new Uint32Array(8).fill(0).buffer)),e.push(new Uint8Array(new Uint32Array(2).fill(4286611584).buffer)),e.push(new Uint8Array(new Uint32Array(1).fill(4294967295).buffer)),e},o._onTextureLoaded=function(){},o._createWebGlTexture=function(){if(!this._buffer&&!this._mipmaps)throw"create GLTextur err:no data";var e=P.mainContext;e.getExtension("EXT_shader_texture_lod");var n=this._source=e.createTexture(),i=this._width,r=this._height,a=w.curBindTexTarget,o=w.curBindTexValue;if(w.bindTexture(e,this._type,n),this._mipmaps){if(laya.d3.resource.DataTexture2D.lodasatlas){var s=0;e.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null);for(var l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=c*h*4)throw"mipmap size error  level:"+l;e.texSubImage2D(this._type,0,t.simLodRect[s++],t.simLodRect[s++],t.simLodRect[s++],t.simLodRect[s++],6408,5121,new Uint8Array(this._mipmaps[l]))}this.minFifter=9729,this.magFifter=9729}else{var c=this._width,h=this._height;for(s=0,e.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null),l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=c*h*4)throw"mipmap size error  level:"+l;e.texImage2D(this._type,l,6408,c,h,0,6408,5121,new Uint8Array(this._mipmaps[l])),c/=2,h/=2,1>c&&(c=1),1>h&&(h=1),this.minFifter=9987,this.magFifter=9729}}this.mipmap=!1}else e.texImage2D(this._type,0,6408,i,r,0,6408,5121,new Uint8Array(this._buffer));var d=this._minFifter,_=this._magFifter,f=this._repeat?10497:33071,m=u.isPOT(i,r);if(!m)throw"data texture must be POT";this._mipmap||this._mipmaps?-1!==d||(d=9987):-1!==d||(d=9729),-1!==_||(_=9729),e.texParameteri(this._type,10241,d),e.texParameteri(this._type,10240,_),e.texParameteri(this._type,10242,f),this._mipmaps?e.texParameteri(this._type,10243,33071):e.texParameteri(this._type,10243,f),this._mipmap&&e.generateMipmap(this._type),a&&o&&w.bindTexture(e,a,o),this.src&&this.src.length>0&&(this._buffer=null),this.memorySize=m?i*r*4*(1+1/3):i*r*4,this._recreateLock=!1},o.recreateResource=function(){if(this._buffer||null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._buffer||this._mipmaps){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0}},o.onAsynLoaded=function(e,t,n){var i;n&&(i=n[0].call(this,t)),i&&(this._width=i.width,this._height=i.height,this._buffer=i.data),this._src=e,this._size=new Wn(this._width,this._height),this._conchTexture?alert("怎么给runtime传递datatexture数据"):this.activeResource(),this._endLoaded()},o.getPixels=function(){return new Uint8Array(this._buffer)},o.disposeResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this._buffer=null,this.memorySize=0)},a(0,o,"src",function(){return this._src}),t.create=function(e,n,i,r,a,o){if(void 0===r&&(r=9729),void 0===a&&(a=9729),void 0===o&&(o=!0),!e||e.byteLength<n*i*4)throw"DataTexture2D create error";var s=new t;return s._buffer=e,s._width=n,s._height=i,s._mipmap=o,s._magFifter=r,s._minFifter=a,s._size=new Wn(s._width,s._height),s._conchTexture?alert("怎么给runtime传递datatexture数据"):s.activeResource(),s},t.load=function(e,i,r,a,o){void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=9729),void 0===o&&(o=9729);var s=L.getFileExtension(e);if("mipmaps"===s){var l=n.loader.create(e,null,null,t,[function(e){this._mipmaps=[];var t=new Uint32Array(e);this._width=t[0];var n=512;if(laya.d3.resource.DataTexture2D.lodasatlas&&(this._width*=2,n=1024),this._width!=n)throw console.error("现在只支持512x256的环境贴图。当前的是"+t[0]),"现在只支持512x256的环境贴图。当前的是"+t[0];this._height=t[1];for(var i=laya.d3.resource.DataTexture2D.lodasatlas?this._width/2:this._width,r=this._height,a=8;;){var o=i*r*4;if(a+o>e.byteLength)throw"load mipmaps data size error ";var s=new Uint8Array(e,a,o);if(this._mipmaps.push(s),a+=o,1==i&&1==r)break;i/=2,r/=2,1>i&&(i=1),1>r&&(r=1)}return null}]);if(laya.d3.resource.DataTexture2D.lodasatlas){l.simLodInfo=new Float32Array(40);for(var u=0;u<l.simLodInfo.length;)l.simLodInfo[u]=(t.simLodRect[u]+.5)/1024,u++,l.simLodInfo[u]=(t.simLodRect[u]+.5)/256,u++,l.simLodInfo[u]=Math.max(t.simLodRect[u]-1,.1)/1024,u++,l.simLodInfo[u]=Math.max(t.simLodRect[u]-1.5,.1)/256,u++}return l}if("number"==typeof i)return n.loader.create(e,null,null,t,[function(e){return this._width=i,this._height=r,this._buffer=e,null}]);if("function"==typeof i)return n.loader.create(e,null,null,t,[i]);throw new Error("unknown params.")},t.lodasatlas=!1,i(t,["simLodRect",function(){return this.simLodRect=new Uint32Array([0,0,512,256,512,0,256,128,768,0,128,64,896,0,64,32,960,0,32,16,992,0,16,8,1008,0,8,4,1016,0,4,2,1020,0,2,1,1022,0,1,1])}]),t}(hi),Zi=function(e){function t(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,t.__super.call(this)}r(t,"laya.d3.resource.models.PrimitiveMesh",e);var i=t.prototype;return n.imps(i,{"laya.d3.core.render.IRenderable":!0}),i._getVertexBuffer=function(e){return void 0===e&&(e=0),0===e?this._vertexBuffer:null},i._getVertexBuffers=function(){return null},i._getIndexBuffer=function(){return this._indexBuffer},i._getPositions=function(){var e,t=[],n=this._vertexBuffer.vertexDeclaration.getVertexElements(),i=0;for(i=0;i<n.length;i++){var r=n[i];if("vector3"===r.elementFormat&&0===r.elementUsage){e=r;break}}var a=this._vertexBuffer.getData();for(i=0;i<a.length;i+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var o=i+e.offset/4,s=new On(a[o+0],a[o+1],a[o+2]);t.push(s)}return t},i.getRenderElement=function(){return this},i.getRenderElementsCount=function(){return 1},i.disposeResource=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this.memorySize=0},i._beforeRender=function(){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},i._render=function(){P.mainContext.drawElements(4,this._numberIndices,5123,0),C.drawCall++,C.trianglesFaces+=this._numberIndices/3},a(0,i,"_vertexBufferCount",function(){return 1}),a(0,i,"triangleCount",function(){return this._indexBuffer.indexCount/3}),t}(di),Ki=function(e){function t(){this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,this._skinnedDatas=null,t.__super.call(this),this._subMeshes=[],this._materials=[],this._vertexBuffers=[]}r(t,"laya.d3.resource.models.Mesh",e);var i=t.prototype;return i._getPositions=function(){var e,t,n,i,r,a=[],o=0,s=0,l=0;if(0!==this._vertexBuffers.length){var u=this._vertexBuffers.length;for(o=0;u>o;o++){for(e=this._vertexBuffers[o],n=e.vertexDeclaration.getVertexElements(),s=0;s<n.length;s++)if(i=n[s],"vector3"===i.elementFormat&&0===i.elementUsage){t=i;break}for(r=e.getData(),s=0;s<r.length;s+=e.vertexDeclaration.vertexStride/4)l=s+t.offset/4,a.push(new On(r[l+0],r[l+1],r[l+2]))}}else{var c=this._subMeshes.length;for(o=0;c>o;o++){var h=this._subMeshes[o];for(e=h._getVertexBuffer(),n=e.vertexDeclaration.getVertexElements(),s=0;s<n.length;s++)if(i=n[s],"vector3"===i.elementFormat&&0===i.elementUsage){t=i;break}for(r=e.getData(),s=0;s<r.length;s+=e.vertexDeclaration.vertexStride/4)l=s+t.offset/4,a.push(new On(r[l+0],r[l+1],r[l+2]))}}return a},i._setSubMeshes=function(e){this._subMeshes=e,this._subMeshCount=e.length;for(var t=0;t<this._subMeshCount;t++)e[t]._indexInMesh=t;this._positions=this._getPositions(),this._generateBoundingObject()},i.onAsynLoaded=function(e,t){var n=t[0],i=t[1];pn.read(n,this,this._materials,this._subMeshes,i),this.completeCreate(),this._endLoaded()
},i.getSubMesh=function(e){return this._subMeshes[e]},i.getSubMeshCount=function(){return this._subMeshes.length},i.getRenderElementsCount=function(){return this._subMeshes.length},i.getRenderElement=function(e){return this._subMeshes[e]},i.disposeResource=function(){for(var e=0;e<this._subMeshes.length;e++)this._subMeshes[e].dispose();this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null},a(0,i,"materials",function(){return this._materials.slice()}),a(0,i,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),t.load=function(e){return n.loader.create(e,null,null,t)},t}(di),ji=function(e){function t(e,n,i,r,a,o,s,l,u){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===i&&(i=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===o&&(o=!1),void 0===s&&(s=!1),void 0===l&&(l=-1),void 0===u&&(u=-1),t.__super.call(this),this._type=3553,this._width=e,this._height=n,this._size=new Wn(e,n),this._surfaceFormat=i,this._surfaceType=r,this._depthStencilFormat=a,x.isConchWebGL&&34041===this._depthStencilFormat&&(this._depthStencilFormat=33189),this._mipmap=o,this._repeat=s,this._minFifter=l,this._magFifter=u,this.activeResource(),this._alreadyResolved=!0}r(t,"laya.d3.resource.RenderTexture",e);var i=t.prototype;return i.recreateResource=function(){var e=P.mainContext;this._frameBuffer=e.createFramebuffer(),this._source=e.createTexture();var t=w.curBindTexTarget,n=w.curBindTexValue;w.bindTexture(e,this._type,this._source),e.texImage2D(this._type,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null);var i=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071,o=u.isPOT(this._width,this._height);if(o?(this._mipmap?-1!==i||(i=9987):-1!==i||(i=9729),-1!==r||(r=9729),e.texParameteri(this._type,10241,i),e.texParameteri(this._type,10240,r),e.texParameteri(this._type,10242,a),e.texParameteri(this._type,10243,a),this._mipmap&&e.generateMipmap(this._type)):(-1!==i||(i=9729),-1!==r||(r=9729),e.texParameteri(this._type,10241,i),e.texParameteri(this._type,10240,r),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),e.bindFramebuffer(36160,this._frameBuffer),e.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,this._depthStencilBuffer),e.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:e.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:e.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:e.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}e.bindFramebuffer(36160,null),t&&n&&w.bindTexture(e,t,n),e.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},i.start=function(){P.mainContext.bindFramebuffer(36160,this.frameBuffer),t._currentRenderTarget=this,this._alreadyResolved=!1},i.end=function(){P.mainContext.bindFramebuffer(36160,null),t._currentRenderTarget=null,this._alreadyResolved=!0},i.getData=function(e,t,n,i){var r=P.mainContext;r.bindFramebuffer(36160,this._frameBuffer);var a=36053===r.checkFramebufferStatus(36160);if(!a)return r.bindFramebuffer(36160,null),null;var o=new Uint8Array(this._width*this._height*4);return r.readPixels(e,t,n,i,this._surfaceFormat,this._surfaceType,o),r.bindFramebuffer(36160,null),o},i.disposeResource=function(){if(this._frameBuffer){var e=P.mainContext;e.deleteTexture(this._source),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0}},a(0,i,"surfaceFormat",function(){return this._surfaceFormat}),a(0,i,"surfaceType",function(){return this._surfaceType}),a(0,i,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,i,"source",function(){return this._alreadyResolved?n.superGet(hi,this,"source"):null}),a(0,i,"depthStencilBuffer",function(){return this._depthStencilBuffer}),a(0,i,"frameBuffer",function(){return this._frameBuffer}),t._currentRenderTarget=null,t}(hi),qi=function(e){function t(e){this._color=null,this._pixels=null,t.__super.call(this),this._type=3553,this._width=1,this._height=1,this._size=new Wn(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}r(t,"laya.d3.resource.SolidColorTexture2D",e);var n=t.prototype;return n._createWebGlTexture=function(){var e=P.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=w.curBindTexTarget,a=w.curBindTexValue;w.bindTexture(e,this._type,t),e.texImage2D(this._type,0,6408,n,i,0,6408,5121,this._pixels);var o=this._minFifter,s=this._magFifter,l=this._repeat?10497:33071,c=u.isPOT(n,i);c?(this._mipmap?-1!==o||(o=9987):-1!==o||(o=9729),-1!==s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),this._mipmap&&e.generateMipmap(this._type)):(-1!==o||(o=9729),-1!==s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&w.bindTexture(e,r,a),this.memorySize=c?n*i*4*(1+1/3):n*i*4},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.disposeResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},i(t,["magentaTexture",function(){return this.magentaTexture=new t(new Vn(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new t(new Vn(.5,.5,.5,1))}]),t}(hi),Qi=function(e){function t(e){this._color=null,this._pixels=null,this._texCount=6,t.__super.call(this),this._type=34067,this._width=1,this._height=1,this._size=new Wn(this.width,this.height),this._color=e,this._pixels=new Uint8Array([255*e.x,255*e.y,255*e.z,255*e.w])}r(t,"laya.d3.resource.SolidColorTextureCube",e);var n=t.prototype;return n._createWebGlTexture=function(){var e=P.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=w.curBindTexTarget,a=w.curBindTexValue;w.bindTexture(e,this._type,t),e.texImage2D(34069,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34070,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34071,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34072,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34073,0,6408,n,i,0,6408,5121,this._pixels),e.texImage2D(34074,0,6408,n,i,0,6408,5121,this._pixels);var o=this.minFifter,s=this.magFifter,l=this._repeat?10497:33071,c=u.isPOT(n,i);c?(this.mipmap?-1!==o||(o=9987):-1!==o||(o=9729),-1!==s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),this.mipmap&&e.generateMipmap(this._type)):(-1!==o||(o=9729),-1!==s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&w.bindTexture(e,r,a),this.memorySize=c?n*i*4*(1+1/3)*this._texCount:n*i*4*this._texCount},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.disposeResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},i(t,["magentaTexture",function(){return this.magentaTexture=new t(new Vn(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new t(new Vn(.5,.5,.5,1))}]),t}(hi),$i=function(t){function i(e,t,n,r){this._canRead=!1,this._image=null,this._pixels=null,void 0===e&&(e=!1),void 0===t&&(t=!0),void 0===n&&(n=6408),void 0===r&&(r=!0),i.__super.call(this),this._type=3553,this._repeat=t,this._canRead=e,this._format=n,this._mipmap=r}r(i,"laya.d3.resource.Texture2D",t);var o=i.prototype;return o._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var e=P.mainContext,t=this._source=e.createTexture(),n=this._width,i=this._height,r=w.curBindTexTarget,a=w.curBindTexValue;switch(w.bindTexture(e,this._type,t),this._format){case 6407:case 6408:this._canRead?e.texImage2D(this._type,0,this._format,n,i,0,this._format,5121,this._pixels):e.texImage2D(this._type,0,this._format,this._format,5121,this._image);break;case P.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:e.compressedTexImage2D(this._type,0,this._format,this._width,this._height,0,this._image)}var o=this._minFifter,s=this._magFifter,l=this._repeat?10497:33071,c=0==this._wrapModeU?10497:33071,h=0==this._wrapModeV?10497:33071,d=u.isPOT(n,i);d?(this._mipmap?-1!==o||(o=9987):-1!==o||(o=9729),-1!==s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,l),e.texParameteri(this._type,10243,l),e.texParameteri(this._type,10242,c),e.texParameteri(this._type,10243,h),this._mipmap&&e.generateMipmap(this._type)):(-1!==o||(o=9729),-1!==s||(s=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,s),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),r&&a&&w.bindTexture(e,r,a),this._image.onload=null,this._image=null,this.memorySize=d?n*i*4*(1+1/3):n*i*4},o.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},o.onAsynLoaded=function(t,n,i){if(i){var r=i[0];void 0!==r&&(this._canRead=r);var a=i[1];void 0!==a&&(this._repeat=a);var o=i[2];void 0!==o&&(this._format=o);var s=i[3];void 0!==s&&(this._mipmap=s);var l=i.wrapModeU;void 0!==l&&(this._wrapModeU=l);var u=i.wrapModeV;void 0!==u&&(this._wrapModeV=u)}switch(this._format){case 6407:case 6408:this._image=n;var c=n.width,h=n.height;this._width=c,this._height=h,this._size=new Wn(c,h),this._canRead&&(x.isConchApp?n instanceof e.HTMLElement&&(this._pixels=new Uint8Array(n.getImageData(0,0,c,h))):(d.canvas.size(c,h),d.canvas.clear(),d.context.drawImage(n,0,0,c,h),this._pixels=new Uint8Array(d.context.getImageData(0,0,c,h).data.buffer)));break;case P.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:{var _=new f(n);_.readUTFBytes(4),_.readUTFBytes(2),_.getInt16()}_.endian="bigEndian",this._width=_.getInt16(),this._height=_.getInt16(),this._size=new Wn(this._width,this._height);{_.getInt16(),_.getInt16()}this._image=new Uint8Array(n,_.pos)}this.recreateResource(),this._endLoaded()},o.getPixels=function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")},o.disposeResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},a(0,o,"_src",function(){return this.url}),a(0,o,"src",function(){return this.url}),i.load=function(e){return n.loader.create(e,null,null,i)},i}(hi),Ji=function(e){function t(){t.__super.call(this),this._type=34067}r(t,"laya.d3.resource.TextureCube",e);var i=t.prototype;return i._onTextureLoaded=function(e){this._images=e;for(var t=2147483647,n=2147483647,i=0;6>i;i++){var r=e[i];t=Math.min(t,r?r.width:0),n=Math.min(n,r?r.height:0)}this._width=t,this._height=n,this._size=new Wn(t,n)},i._createWebGlTexture=function(){var e=6,t=0;for(t=0;e>t;t++)if(!this._images[t])throw"create GLTextur err:no data:"+this._images[t];var n=P.mainContext,i=this._source=n.createTexture(),r=this._width,a=this._height,o=w.curBindTexTarget,s=w.curBindTexValue;w.bindTexture(n,this._type,i),n.texImage2D(34069,0,6408,6408,5121,this._images[0]),n.texImage2D(34070,0,6408,6408,5121,this._images[1]),n.texImage2D(34071,0,6408,6408,5121,this._images[2]),n.texImage2D(34072,0,6408,6408,5121,this._images[3]),n.texImage2D(34073,0,6408,6408,5121,this._images[4]),n.texImage2D(34074,0,6408,6408,5121,this._images[5]);var l=this.minFifter,c=this.magFifter,h=this._repeat?10497:33071,d=u.isPOT(r,a);for(d?(this.mipmap?-1!==l||(l=9987):-1!==l||(l=9729),-1!==c||(c=9729),n.texParameteri(this._type,10241,l),n.texParameteri(this._type,10240,c),n.texParameteri(this._type,10242,h),n.texParameteri(this._type,10243,h),this.mipmap&&n.generateMipmap(this._type)):(-1!==l||(l=9729),-1!==c||(c=9729),n.texParameteri(this._type,10241,l),n.texParameteri(this._type,10240,c),n.texParameteri(this._type,10242,33071),n.texParameteri(this._type,10243,33071)),o&&s&&w.bindTexture(n,o,s),t=0;6>t;t++)this._images[t].onload=null,this._images[t]=null;this.memorySize=d?r*a*4*(1+1/3)*e:r*a*4*e},i.recreateResource=function(){null!=this._url&&(this._createWebGlTexture(),this.completeCreate())},i.onAsynLoaded=function(e,t){this._onTextureLoaded(t),this.activeResource(),this._endLoaded()},i.disposeResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,i,"defaulteTexture",function(){return Qi.grayTexture}),t.load=function(e){return n.loader.create(e,null,null,t)},t}(hi),er=function(e){function t(e){this._hasIndependentBound=!0,t.__super.call(this,e),this._owner.transform.off("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._cacheAnimationNodeIndex=[],this._cacheAnimationNode=[],this._localBoundingBoxCorners=o(8,null),this._owner.meshFilter.on("meshchanged",this,this._$3__onMeshChanged)}r(t,"laya.d3.core.SkinnedMeshRender",e);var n=t.prototype;return n._getCacheAnimationNodes=function(){var e=this._cacheMesh._boneNames,t=e.length;this._cacheAnimationNode.length=t,this._cacheAnimationNodeIndex.length=t;for(var n=this._cacheAnimator._avatarNodes,i=this._cacheAnimator._avatarNodeMap,r=0;t>r;r++){var a=i[e[r]];this._cacheAnimationNode[r]=a,this._cacheAnimationNodeIndex[r]=n.indexOf(a)}},n._offComputeBoneIndexToMeshEvent=function(e,t){e.loaded?t.loaded||t.off("loaded",this,this._getCacheAnimationNodes):e.off("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},n._computeBoneIndexToMeshWithAsyncAvatar=function(){this._cacheAvatar.loaded?this._computeBoneIndexToMeshWithAsyncMesh():this._cacheAvatar.once("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},n._computeBoneIndexToMeshWithAsyncMesh=function(){this._cacheMesh.loaded?this._getCacheAnimationNodes():this._cacheMesh.on("loaded",this,this._getCacheAnimationNodes)},n._$3__onMeshChanged=function(e,t,n){this._cacheMesh=n,t&&!t.loaded&&n.off("loaded",this,this._onMeshLoaded),n.loaded?this._onMeshLoaded(n):n.on("loaded",this,this._onMeshLoaded),this._cacheAvatar&&(t&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,t),n&&this._computeBoneIndexToMeshWithAsyncAvatar())},n._onMeshLoaded=function(e){var t=e.subMeshCount;this._subSkinnedDatas=[],this._subSkinnedDatas.length=t;for(var n=0;t>n;n++)for(var i=this._subSkinnedDatas[n]=[],r=e.getSubMesh(n)._boneIndicesList,a=0,o=r.length;o>a;a++)i[a]=new Float32Array(16*r[a].length)},n._setCacheAnimator=function(e){this._cacheAnimator=e,this._rootBone&&(this._rootIndex=e._avatarNodes.indexOf(e._avatarNodeMap[this._rootBone]))},n._setRootBone=function(e){this._rootBone=e,this._cacheAnimator&&(this._rootIndex=this._cacheAnimator._avatarNodes.indexOf(this._cacheAnimator._avatarNodeMap[e]))},n._setCacheAvatar=function(e){this._cacheAvatar!==e&&(this._cacheMesh?(this._cacheAvatar&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,this._cacheMesh),this._cacheAvatar=e,e&&(this._addShaderDefine(ur.SHADERDEFINE_BONE),this._computeBoneIndexToMeshWithAsyncAvatar())):this._cacheAvatar=e)},n._calculateBoundingBox=function(){if(this._hasIndependentBound){if(this._cacheAnimator){var t=this._owner.transform,n=t.worldMatrix;if(this._cacheAnimator._canCache){var i=this._cacheAnimator._curAvatarNodeDatas;kn.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,i[this._rootIndex],n)}else kn.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheAnimator._avatarNodeMap[this._rootBone].transform.getWorldMatrix(),n);t.worldMatrix=n;var r=this._cacheAnimator._avatarNodeMap[this._rootBone];null==r||null==this._localBoundBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(this._localBoundingBoxCorners)}}else e.prototype._calculateBoundingBox.call(this)},n._calculateBoundingSphere=function(){if(this._hasIndependentBound){if(this._cacheAnimator){var t=this._owner.transform,n=t.worldMatrix;if(this._cacheAnimator._canCache){var i=this._cacheAnimator._curAvatarNodeDatas;kn.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,i[this._rootIndex],n)}else kn.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheAnimator._avatarNodeMap[this._rootBone].transform.getWorldMatrix(),n);t.worldMatrix=n;var r=this._cacheAnimator._avatarNodeMap[this._rootBone];null==r||null==this.localBoundSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(this.localBoundSphere)}}else e.prototype._calculateBoundingSphere.call(this)},n._updateOctreeNode=function(){var e=this._treeNode;e&&e.updateObject(this)},n._renderUpdate=function(e){var n,i=this._cacheAnimator,r=this._cacheMesh.subMeshCount,a=this._owner.transform;if(i){var o=i._canCache,s=this._cacheAnimator._curAvatarNodeDatas,l=i.owner;if(this._setShaderValueMatrix4x4(0,l._transform.worldMatrix),n=l.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,n),this._cacheMesh&&this._cacheMesh.loaded&&this._cacheAvatar&&this._cacheAvatar.loaded){var u=0,c=0,h=this._cacheMesh._inverseBindPoses,d=this._cacheMesh._skinnedDatas;if(o)for(u=0,c=h.length;c>u;u++)kn._mulMatrixArray(s[this._cacheAnimationNodeIndex[u]],h[u],d,16*u);else for(u=0,c=h.length;c>u;u++)kn._mulMatrixArray(this._cacheAnimationNode[u].transform.getWorldMatrix(),h[u],d,16*u);for(u=0;r>u;u++){for(var _=this._cacheMesh.getSubMesh(u)._boneIndicesList,f=_.length,m=this._subSkinnedDatas[u],p=0;f>p;p++)t._splitAnimationDatas(_[p],d,m[p]);this._renderElements[u]._skinAnimationDatas=m}}}else this._setShaderValueMatrix4x4(0,a.worldMatrix),n=this._owner.getProjectionViewWorldMatrix(e),this._setShaderValueMatrix4x4(1,n);return Xn.debugMode&&this._renderRenderableBoundBox(),!0},a(0,n,"localBoundBox",function(){return this._localBoundBox},function(e){this._localBoundBox=e,e.getCorners(this._localBoundingBoxCorners)}),a(0,n,"boundingSphere",function(){return this._calculateBoundingSphere(),this._boundingSphere}),a(0,n,"boundingBox",function(){return this._calculateBoundingBox(),this._boundingBox}),a(0,n,"boundingBoxCenter",function(){var e=this.boundingBox;return On.add(e.min,e.max,this._boundingBoxCenter),On.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenter}),t._splitAnimationDatas=function(e,t,n){for(var i=0,r=e.length,a=0;r>i;i++)for(var o=e[i]<<4,s=0;16>s;s++,a++)n[a]=t[o+s]},t}(Ti),tr=function(e){function t(e,i){t.__super.call(this),void 0===e&&(e=.3),void 0===i&&(i=1e3),this._tempVector3=new On,this._position=new On,this._up=new On,this._forward=new On,this._right=new On,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=Wn.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=e,this._farPlane=i,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),n.stage.on("resize",this,this._onScreenSizeChanged)}r(t,"laya.d3.core.BaseCamera",e);var o=t.prototype;return o._sortCamerasByRenderingOrder=function(){if(this._displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,n=0;t>n;n++)if(e[n].renderingOrder>e[t].renderingOrder){var i=e[n];e[n]=e[t],e[t]=i}},o._calculateProjectionMatrix=function(){},o._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},o._prepareCameraToRender=function(){z._currentCameraCullingMask=this.cullingMask;var e=this._shaderValues;e.setValue(0,this.transform.position.elements),e.setValue(5,this.forward.elements),e.setValue(6,this.up.elements)},o._prepareCameraViewProject=function(e,t){var n=this._shaderValues;n.setValue(1,e.elements),n.setValue(2,t.elements)},o._renderCamera=function(){},o.addLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask|e.mask)},o.removeLayer=function(e){29!==e.number&&30!=e.number&&(this.cullingMask=this.cullingMask&~e.mask)},o.addAllLayers=function(){this.cullingMask=2147483647},o.removeAllLayers=function(){this.cullingMask=0|z.getLayerByNumber(29).mask|z.getLayerByNumber(30).mask},o.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},o.moveForward=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=e,this.transform.translate(this._tempVector3)},o.moveRight=function(e){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=e,this.transform.translate(this._tempVector3)},o.moveVertical=function(e){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=e,this.transform.translate(this._tempVector3,!1)},o._addSelfRenderObjects=function(){var e=this.scene._cameraPool,t=e.length;if(t>0){for(var n=t-1;n>=0;n--)if(this.renderingOrder<=e[n].renderingOrder){e.splice(n+1,0,this);break}}else e.push(this),this.scene.conchModel&&this.scene.conchModel.setCurrentCamera(this.conchModel)},o._clearSelfRenderObjects=function(){var e=this.scene._cameraPool;e.splice(e.indexOf(this),1)},o.destroy=function(t){void 0===t&&(t=!0),this._sky&&this._sky.destroy(),this.renderTarget=null,n.stage.off("resize",this,this._onScreenSizeChanged),e.prototype.destroy.call(this,t)},a(0,o,"sky",function(){return this._sky},function(e){this._sky=e,e._ownerCamera=this}),a(0,o,"forward",function(){var e=this.transform.worldMatrix.elements,t=this._forward.elements;return t[0]=-e[8],t[1]=-e[9],t[2]=-e[10],this._forward}),a(0,o,"position",function(){var e=this.transform.worldMatrix.elements,t=this._position.elements;return t[0]=e[12],t[1]=e[13],t[2]=e[14],this._position}),a(0,o,"renderTarget",function(){return this._renderTarget},function(e){this._renderTarget=e,null!=e&&(this._renderTargetSize=e.size)}),a(0,o,"up",function(){var e=this.transform.worldMatrix.elements,t=this._up.elements;return t[0]=e[4],t[1]=e[5],t[2]=e[6],this._up}),a(0,o,"right",function(){var e=this.transform.worldMatrix.elements,t=this._right.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],this._right}),a(0,o,"renderTargetSize",function(){return this._renderTargetSize},function(e){null!=this.renderTarget&&this._renderTargetSize!=e,this._renderTargetSize=e,this._calculateProjectionMatrix()}),a(0,o,"fieldOfView",function(){return this._fieldOfView},function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}),a(0,o,"nearPlane",function(){return this._nearPlane},function(e){this._nearPlane=e,this._calculateProjectionMatrix()}),a(0,o,"farPlane",function(){return this._farPlane},function(e){this._farPlane=e,this._calculateProjectionMatrix()}),a(0,o,"orthographic",function(){return this._orthographic},function(e){this._orthographic=e,this._calculateProjectionMatrix()}),a(0,o,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}),a(0,o,"renderingOrder",function(){return this._renderingOrder},function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}),t.CAMERAPOS=0,t.VIEWMATRIX=1,t.PROJECTMATRIX=2,t.VPMATRIX=3,t.VPMATRIX_NO_TRANSLATE=4,t.CAMERADIRECTION=5,t.CAMERAUP=6,t.ENVIRONMENTDIFFUSE=7,t.ENVIRONMENTSPECULAR=8,t.SIMLODINFO=9,t.DIFFUSEIRRADMATR=10,t.DIFFUSEIRRADMATG=11,t.DIFFUSEIRRADMATB=12,t.HDREXPOSURE=13,t.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",t.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",t.CLEARFLAG_SOLIDCOLOR=0,t.CLEARFLAG_SKY=1,t.CLEARFLAG_DEPTHONLY=2,t.CLEARFLAG_NONE=3,i(t,["_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new xn(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1)},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new xn},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new xn}]),t}(Ai),nr=function(e){function t(e){this._render=null,this._geometryFilter=null,t.__super.call(this,e)}r(t,"laya.d3.core.RenderableSprite3D",e);var n=t.prototype;return n._addToInitStaticBatchManager=function(){},n._setBelongScene=function(t){e.prototype._setBelongScene.call(this,t),t._renderableSprite3Ds.push(this),this._render._applyLightMapParams()},n._setUnBelongScene=function(){var t=this._scene._renderableSprite3Ds,n=t.indexOf(this);t.splice(n,1),this._render._removeShaderDefine(laya.d3.core.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),e.prototype._setUnBelongScene.call(this)},n._update=function(e){e.owner=this,this._activeInHierarchy&&(this._updateComponents(e),this._render._updateOctreeNode(),this._lateUpdateComponents(e),C.spriteCount++,this._childs.length&&this._updateChilds(e))},n.destroy=function(t){void 0===t&&(t=!0),e.prototype.destroy.call(this,t),this._render._destroy(),this._render=null},t.__init__=function(){t.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=t.shaderDefines.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),t.SAHDERDEFINE_LIGHTMAP=t.shaderDefines.registerDefine("LIGHTMAP")},t.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=2,t.SAHDERDEFINE_LIGHTMAP=4,t.LIGHTMAPSCALEOFFSET=2,t.LIGHTMAP=3,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn}]),t}(Ai),ir=function(e){function t(){this._intensityColor=null,this._intensity=0/0,this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this._lightmapBakedType=0,this.color=null,t.__super.call(this),this._intensity=1,this._intensityColor=new On,this.color=new On(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0,this._lightmapBakedType=t.LIGHTMAPBAKEDTYPE_REALTIME}r(t,"laya.d3.core.light.LightSprite",e);var n=t.prototype;return n._parseCustomProps=function(e,t,n){var i=n.color,r=this.color.elements;r[0]=i[0],r[1]=i[1],r[2]=i[2]},n._addSelfRenderObjects=function(){this.lightmapBakedType!==t.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._addLight(this)},n._clearSelfRenderObjects=function(){this.lightmapBakedType!==t.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._removeLight(this)},n._prepareToScene=function(){return!1},a(0,n,"lightmapBakedType",function(){return this._lightmapBakedType},function(e){this._lightmapBakedType!==e&&(this._lightmapBakedType=e,this._activeInHierarchy&&(e!==t.LIGHTMAPBAKEDTYPE_BAKED?this._scene._addLight(this):this._scene._removeLight(this)))}),a(0,n,"shadowPCFType",function(){return this._shadowMapPCFType},function(e){this._shadowMapPCFType=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(e)}),a(0,n,"intensity",function(){return this._intensity},function(e){this._intensity=e}),a(0,n,"shadow",function(){return this._shadow},function(){throw new Error("LightSprite: must override it.")}),a(0,n,"shadowDistance",function(){return this._shadowFarPlane},function(e){this._shadowFarPlane=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(e)}),a(0,n,"shadowPSSMCount",function(){return this._shadowMapCount},function(e){this._shadowMapCount=e,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.PSSMNum=e)}),a(0,n,"shadowResolution",function(){return this._shadowMapSize},function(e){this._shadowMapSize=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(e)}),a(0,n,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},function(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}),t.LIGHTMAPBAKEDTYPE_REALTIME=0,t.LIGHTMAPBAKEDTYPE_MIXED=1,t.LIGHTMAPBAKEDTYPE_BAKED=2,t}(Ai),rr=function(e){function t(){}r(t,"laya.d3.terrain.Terrain",e);var n=t.prototype;return n._parseCustomProps=function(){},n.setLightmapIndex=function(){},n.setLightmapScaleOffset=function(){},n.disableLight=function(){},n.buildTerrain=function(){},n.width=function(){},n.depth=function(){},n.getHeightXZ=function(){},a(0,n,"terrainRes",null,function(){}),t.load=function(){},t.RENDER_LINE_MODEL=!1,t.LOD_TOLERANCE_VALUE=4,t.LOD_DISTANCE_FACTOR=2,t.__VECTOR3__=null,t}(Ai),ar=(function(e){function t(){}r(t,"laya.d3.resource.models.BoxMesh",e);var n=t.prototype;return n.recreateResource=function(){},a(0,n,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),a(0,n,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),a(0,n,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),t}(Zi),function(e){function t(){}r(t,"laya.d3.resource.models.CapsuleMesh",e);var n=t.prototype;return n.recreateResource=function(){},a(0,n,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),a(0,n,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())}),t}(Zi),function(e){function t(){}r(t,"laya.d3.resource.models.CylinderMesh",e);var n=t.prototype;return n.recreateResource=function(){},a(0,n,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),a(0,n,"height",function(){return this._height},function(e){this._height!==e&&(this._height=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())}),t}(Zi),function(e){function t(){}r(t,"laya.d3.resource.models.PlaneMesh",e);var n=t.prototype;return n.recreateResource=function(){},a(0,n,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),a(0,n,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())}),t}(Zi),function(e){function t(){}r(t,"laya.d3.resource.models.QuadMesh",e);var n=t.prototype;return n.recreateResource=function(){},a(0,n,"long",function(){return this._long},function(e){this._long!==e&&(this._long=e,this.releaseResource(),this.activeResource())}),a(0,n,"width",function(){return this._width},function(e){this._width!==e&&(this._width=e,this.releaseResource(),this.activeResource())}),t}(Zi),function(e){function t(){}r(t,"laya.d3.resource.models.SphereMesh",e);var n=t.prototype;return n.recreateResource=function(){},a(0,n,"radius",function(){return this._radius},function(e){this._radius!==e&&(this._radius=e,this.releaseResource(),this.activeResource())}),a(0,n,"slices",function(){return this._slices},function(e){this._slices!==e&&(this._slices=e,this.releaseResource(),this.activeResource())}),a(0,n,"stacks",function(){return this._stacks},function(e){this._stacks!==e&&(this._stacks=e,this.releaseResource(),this.activeResource())}),t}(Zi),function(e){function t(e,n,i){void 0===e&&(e=0),void 0===n&&(n=.3),void 0===i&&(i=1e3),this._viewMatrix=new xn,this._projectionMatrix=new xn,this._projectionViewMatrix=new xn,this._viewport=new Ln(0,0,0,0),this._normalizedViewport=new Ln(0,0,1,1),this._aspectRatio=e,this._boundFrustumUpdate=!0,this._boundFrustum=new vn(xn.DEFAULT),t.__super.call(this,n,i),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)
}r(t,"laya.d3.core.Camera",e);var o=t.prototype;return o._onWorldMatrixChanged=function(){this._boundFrustumUpdate=!0},o._parseCustomProps=function(e,t,n){var i=n.clearColor;this.clearColor=new Vn(i[0],i[1],i[2],i[3]);var r=n.viewport;this.normalizedViewport=new Ln(r[0],r[1],r[2],r[3])},o._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=this.orthographicVerticalSize*this.aspectRatio*.5,t=.5*this.orthographicVerticalSize;xn.createOrthoOffCenterRH(-e,e,-t,t,this.nearPlane,this.farPlane,this._projectionMatrix)}else xn.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._boundFrustumUpdate=!0},o._update=function(e){this.conchModel&&(this.conchModel.setViewMatrix(this.viewMatrix.elements),this.conchModel.setProjectMatrix(this.projectionMatrix.elements)),laya.d3.core.Sprite3D.prototype._update.call(this,e)},o._renderCamera=function(e,t,n){n.parallelSplitShadowMaps[0]&&n._renderShadowMap(e,t,this),t.camera=this,this._prepareCameraToRender(),n._preRenderUpdateComponents(t);var i,r;i=t._viewMatrix=this.viewMatrix;var a=this._renderTarget;a?(a.start(),xn.multiply(tr._invertYScaleMatrix,this._projectionMatrix,tr._invertYProjectionMatrix),xn.multiply(tr._invertYScaleMatrix,this.projectionViewMatrix,tr._invertYProjectionViewMatrix),r=t._projectionMatrix=tr._invertYProjectionMatrix,t._projectionViewMatrix=tr._invertYProjectionViewMatrix):(r=t._projectionMatrix=this._projectionMatrix,t._projectionViewMatrix=this.projectionViewMatrix),this._prepareCameraViewProject(i,r),t._viewport=this.viewport,n._preRenderScene(e,t,this.boundFrustum),n._clear(e,t),n._renderScene(e,t),n._postRenderUpdateComponents(t),a&&a.end()},o.viewportPointToRay=function(e,t){Gn.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)},o.normalizedViewportPointToRay=function(e,n){var i=t._tempVector20,r=this.viewport,a=e.elements,o=i.elements;o[0]=a[0]*r.width,o[1]=a[1]*r.height,Gn.calculateCursorRay(i,this.viewport,this._projectionMatrix,this.viewMatrix,null,n)},o.worldToViewportPoint=function(e,t){xn.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,t);var i=t.elements;t.z<0||t.z>1?i[0]=i[1]=i[2]=0/0:(i[0]=i[0]/n.stage.clientScaleX,i[1]=i[1]/n.stage.clientScaleY)},o.worldToNormalizedViewportPoint=function(e,t){xn.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,t);var i=t.elements;t.z<0||t.z>1?i[0]=i[1]=i[2]=0/0:(i[0]=i[0]/n.stage.clientScaleX,i[1]=i[1]/n.stage.clientScaleY)},o.convertScreenCoordToOrthographicCoord=function(e,t){if(this._orthographic){var n=ht.clientWidth,i=ht.clientHeight,r=this.orthographicVerticalSize*this.aspectRatio/n,a=this.orthographicVerticalSize/i,o=e.elements,s=t.elements;return s[0]=(-n/2+o[0])*r,s[1]=(i/2-o[1])*a,s[2]=(this.nearPlane-this.farPlane)*(o[2]+1)/2-this.nearPlane,On.transformCoordinate(t,this.transform.worldMatrix,t),!0}return!1},a(0,o,"projectionViewMatrix",function(){return xn.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),a(0,o,"aspectRatio",function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},function(e){if(0>e)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}),a(0,o,"boundFrustum",function(){return this._boundFrustumUpdate&&(this._boundFrustum.matrix=this.projectionViewMatrix),this._boundFrustum}),a(0,o,"needViewport",function(){var e=this.normalizedViewport;return 0===e.x&&0===e.y&&1===e.width&&1===e.height}),a(0,o,"viewport",function(){if(this._viewportExpressedInClipSpace){var e=this._normalizedViewport,t=this.renderTargetSize,n=t.width,i=t.height;this._viewport.x=e.x*n,this._viewport.y=e.y*i,this._viewport.width=e.width*n,this._viewport.height=e.height*i}return this._viewport},function(e){if(null!=this.renderTarget&&(e.x<0||e.y<0||0==e.width||0==e.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=e,this._calculateProjectionMatrix()}),a(0,o,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var e=this._viewport,t=this.renderTargetSize,n=t.width,i=t.height;this._normalizedViewport.x=e.x/n,this._normalizedViewport.y=e.y/i,this._normalizedViewport.width=e.width/n,this._normalizedViewport.height=e.height/i}return this._normalizedViewport},function(e){e.x<0&&(e.x=0,console.warn("Camera: viewport.x must large than 0.0.")),e.y<0&&(e.y=0,console.warn("Camera: viewport.y must large than 0.0.")),e.x+e.width>1&&(e.width=1-e.x,console.warn("Camera: viewport.width + viewport.x must less than 1.0.")),e.y+e.height>1&&(e.height=1-e.y,console.warn("Camera: viewport.height + viewport.y must less than 1.0.")),this._viewportExpressedInClipSpace=!0,this._normalizedViewport=e,this._calculateProjectionMatrix()}),a(0,o,"projectionMatrix",function(){return this._projectionMatrix},function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}),a(0,o,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),i(t,["_tempVector20",function(){return this._tempVector20=new Cn}]),t}(tr)),or=(function(e){function t(){}r(t,"laya.d3.core.glitter.Glitter",e);var n=t.prototype;return n._changeRenderObject=function(){},n._onMaterialChanged=function(){},n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._update=function(){},n.addGlitterByPositions=function(){},n.addGlitterByPositionsVelocitys=function(){},n.cloneTo=function(){},n.destroy=function(){},a(0,n,"templet",function(){return this._geometryFilter}),a(0,n,"glitterRender",function(){return this._render}),t.CURRENTTIME=2,t.DURATION=3,t}(nr),function(e){function t(){this._direction=null,this._updateDirection=!1,t.__super.call(this),this._updateDirection=!1,this._direction=new On,this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}r(t,"laya.d3.core.light.DirectionLight",e);var n=t.prototype;return n._initShadow=function(){if(this._shadow)this._parallelSplitShadowMap=new Bn,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this.transform.worldMatrix.getForward(this._direction),On.normalize(this._direction,this._direction),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this._direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var e=this.scene.parallelSplitShadowMaps;e.splice(e.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,this.scene.removeShaderDefine(Bn.SHADERDEFINE_SHADOW_PSSM1),this.scene.removeShaderDefine(Bn.SHADERDEFINE_SHADOW_PSSM2),this.scene.removeShaderDefine(Bn.SHADERDEFINE_SHADOW_PSSM3)}},n._addSelfRenderObjects=function(){e.prototype._addSelfRenderObjects.call(this),this._shadow&&this._initShadow()},n._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(4,null),t.setValue(3,null),e.removeShaderDefine(ri.SHADERDEFINE_DIRECTIONLIGHT)},n._prepareToScene=function(e){var t=e.scene;if(t.enableLight&&this._activeInHierarchy){var n=t._shaderValues;return t.addShaderDefine(ri.SHADERDEFINE_DIRECTIONLIGHT),On.scale(this.color,this._intensity,this._intensityColor),n.setValue(4,this._intensityColor.elements),this.transform.worldMatrix.getForward(this._direction),On.normalize(this._direction,this._direction),n.setValue(3,this._direction.elements),!0}return t.removeShaderDefine(ri.SHADERDEFINE_DIRECTIONLIGHT),!1},n._onWorldMatrixChange=function(){this._updateDirection=!0},a(0,n,"shadow",e.prototype._$get_shadow,function(e){this._shadow!==e&&(this._shadow=e,this.scene&&this._initShadow())}),a(0,n,"direction",function(){return console.log("Warning: discard property,please use transform's property instead."),this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),On.normalize(this._direction,this._direction),this._updateDirection=!1),this._direction},function(e){console.log("Warning: discard property,please use transform's property instead.");var t=this.transform.worldMatrix;t.setForward(e),this.transform.worldMatrix=t,On.normalize(e,e),this._direction=e,this.shadow&&this._parallelSplitShadowMap&&this._parallelSplitShadowMap._setGlobalParallelLightDir(this._direction)}),t}(ir)),sr=(function(e){function t(){this._range=0/0,this._attenuation=null,t.__super.call(this),this._range=6,this._attenuation=new On(.6,.6,.6)}r(t,"laya.d3.core.light.PointLight",e);var n=t.prototype;return n._clearSelfRenderObjects=function(){var e=this.scene,t=e._shaderValues;t.setValue(8,null),t.setValue(5,null),t.setValue(6,null),t.setValue(7,null),e.removeShaderDefine(ri.SHADERDEFINE_POINTLIGHT)},n._prepareToScene=function(e){var t=e.scene;if(t.enableLight&&this._activeInHierarchy){var n=t._shaderValues;return t.addShaderDefine(ri.SHADERDEFINE_POINTLIGHT),On.scale(this.color,this._intensity,this._intensityColor),n.setValue(8,this._intensityColor.elements),n.setValue(5,this.transform.position.elements),n.setValue(6,this.range),n.setValue(7,this.attenuation.elements),!0}return t.removeShaderDefine(ri.SHADERDEFINE_POINTLIGHT),!1},a(0,n,"range",function(){return this._range},function(e){this._range=e}),a(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),t}(ir),function(e){function t(){}r(t,"laya.d3.core.light.SpotLight",e);var n=t.prototype;return n._onWorldMatrixChange=function(){this._updateDirection=!0},n._clearSelfRenderObjects=function(){},n._prepareToScene=function(){},a(0,n,"spot",function(){return this._spot},function(e){this._spot=e}),a(0,n,"direction",function(){},function(){}),a(0,n,"range",function(){return this._range},function(e){this._range=e}),a(0,n,"attenuation",function(){return this._attenuation},function(e){this._attenuation=e}),t}(ir),function(e){function t(e,n){t.__super.call(this,n),this._geometryFilter=new gi(this),this._render=new Ti(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),e&&(this._geometryFilter.sharedMesh=e,e instanceof laya.d3.resource.models.Mesh&&(e.loaded?this._render.sharedMaterials=e.materials:e.once("loaded",this,this._applyMeshMaterials)))}r(t,"laya.d3.core.MeshSprite3D",e);var o=t.prototype;return o._changeRenderObjectByMesh=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new ii),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=Pi.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,n},o._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements[e];t||(t=Pi.defaultMaterial);var i=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(i,t),n._sprite3D=this,n.renderObj=i,n._material=t,n},o._changeRenderObjectsByMesh=function(){var e=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=e;for(var t=0;e>t;t++)this._changeRenderObjectByMesh(t)},o._onMeshChanged=function(e){var t=e.sharedMesh;t.loaded?this._changeRenderObjectsByMesh():t.once("loaded",this,this._onMeshLoaded)},o._onMeshLoaded=function(e){e===this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},o._onMaterialChanged=function(e,t,n){var i=this._render._renderElements.length;i>t&&this._changeRenderObjectByMaterial(t,n)},o._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},o._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},o._parseCustomProps=function(e,t,n,i){var r=this.meshRender,a=n.lightmapIndex;null!=a&&(r.lightmapIndex=a);var o=n.lightmapScaleOffset;o&&(r.lightmapScaleOffset=new Vn(o[0],o[1],o[2],o[3]));var s,l;if(i.instanceParams)s=i.instanceParams.loadPath,s&&(l=g.getRes(t[s]),this.meshFilter.sharedMesh=l,l.loaded?r.sharedMaterials=l.materials:l.once("loaded",this,this._applyMeshMaterials));else{s=n.meshPath,s&&(l=g.getRes(t[s]),this.meshFilter.sharedMesh=l);var u=n.materials;if(u){var c=r.sharedMaterials,h=u.length;c.length=h;for(var d=0;h>d;d++)c[d]=g.getRes(t[u[d].path]);r.sharedMaterials=c}}},o._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;r>i;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},o._addToInitStaticBatchManager=function(){t._staticBatchManager._addInitBatchSprite(this)},o.cloneTo=function(e){var t=e;t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=t._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.lightmapIndex=n.lightmapIndex,i.receiveShadow=n.receiveShadow,i.sortingFudge=n.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},o.destroy=function(t){if(void 0===t&&(t=!0),!this.destroyed){var n=this.meshFilter.sharedMesh;n.loaded||n.off("loaded",this,this._applyMeshMaterials),e.prototype.destroy.call(this,t),this._geometryFilter._destroy()}},a(0,o,"meshFilter",function(){return this._geometryFilter}),a(0,o,"meshRender",function(){return this._render}),t.__init__=function(){St._staticBatchManagers.push(t._staticBatchManager)},t.load=function(e){return n.loader.create(e,null,null,t)},i(t,["_staticBatchManager",function(){return this._staticBatchManager=new ai}]),t}(nr)),lr=function(e){function t(e){t.__super.call(this),this._render=new Di(this),this._render.on("materialchanged",this,this._onMaterialChanged),this._geometryFilter=new Si(this),this._createRenderElement(0),e&&(this._render.sharedMaterial=e)}r(t,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",e);var o=t.prototype;return o._initParticleVelocity=function(e){for(var t=new Q,n=e.velocitys,i=0,r=n.length;r>i;i++){var a=n[i];t.add(a.key,a.value)}return t},o._initParticleColor=function(e){var t=new j,n=e.alphas,i=0,r=0;for(i=0,r=n.length;r>i;i++){var a=n[i];t.addAlpha(a.key,a.value)}var o=e.rgbs;for(i=0,r=o.length;r>i;i++){var s=o[i],l=s.value;t.addRGB(s.key,new On(l[0],l[1],l[2]))}return t},o._initParticleSize=function(e){for(var t=new Q,n=e.sizes,i=0,r=n.length;r>i;i++){var a=n[i];t.add(a.key,a.value)}return t},o._initParticleRotation=function(e){for(var t=new Q,n=e.angularVelocitys,i=0,r=n.length;r>i;i++){var a=n[i];t.add(a.key,a.value/180*Math.PI)}return t},o._initParticleFrame=function(e){for(var t=new q,n=e.frames,i=0,r=n.length;r>i;i++){var a=n[i];t.add(a.key,a.value)}return t},o._createRenderElement=function(e){var t=this._render._renderElements,n=t[e]=new ut;n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=bi.defaultMaterial);var r=this._geometryFilter;n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i},o._onMaterialChanged=function(e,t,n){var i=e._renderElements;if(t<i.length){var r=i[t];r._material=n||bi.defaultMaterial}},o._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},o._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},o._parseCustomProps=function(e,n,i){var r,a=Math.PI/180,o=0,s=0,l=this.particleRender,u=i.material;if(u)r=g.getRes(n[u.path]);else{var c=i.materialPath;c?r=g.getRes(n[c]):(r=new bi,r.diffuseTexture=n?g.getRes(n[i.texturePath]):$i.load(i.texturePath))}l.sharedMaterial=r;var h=i.meshPath;h&&(l.mesh=g.getRes(n[h])),l.renderMode=i.renderMode,l.stretchedBillboardCameraSpeedScale=i.stretchedBillboardCameraSpeedScale,l.stretchedBillboardSpeedScale=i.stretchedBillboardSpeedScale,l.stretchedBillboardLengthScale=i.stretchedBillboardLengthScale,l.sortingFudge=i.sortingFudge?i.sortingFudge:0;var d=this.particleSystem;d.isPerformanceMode=i.isPerformanceMode,d.duration=i.duration,d.looping=i.looping,d.prewarm=i.prewarm,d.startDelayType=i.startDelayType,d.startDelay=i.startDelay,d.startDelayMin=i.startDelayMin,d.startDelayMax=i.startDelayMax,d.startLifetimeType=i.startLifetimeType,d.startLifetimeConstant=i.startLifetimeConstant,d.startLifeTimeGradient=t._initStartLife(i.startLifetimeGradient),d.startLifetimeConstantMin=i.startLifetimeConstantMin,d.startLifetimeConstantMax=i.startLifetimeConstantMax,d.startLifeTimeGradientMin=t._initStartLife(i.startLifetimeGradientMin),d.startLifeTimeGradientMax=t._initStartLife(i.startLifetimeGradientMax),d.startSpeedType=i.startSpeedType,d.startSpeedConstant=i.startSpeedConstant,d.startSpeedConstantMin=i.startSpeedConstantMin,d.startSpeedConstantMax=i.startSpeedConstantMax,d.threeDStartSize=i.threeDStartSize,d.startSizeType=i.startSizeType,d.startSizeConstant=i.startSizeConstant;var _=i.startSizeConstantSeparate,f=d.startSizeConstantSeparate.elements;f[0]=_[0],f[1]=_[1],f[2]=_[2],d.startSizeConstantMin=i.startSizeConstantMin,d.startSizeConstantMax=i.startSizeConstantMax;var m=i.startSizeConstantMinSeparate,p=d.startSizeConstantMinSeparate.elements;p[0]=m[0],p[1]=m[1],p[2]=m[2];var E=i.startSizeConstantMaxSeparate,v=d.startSizeConstantMaxSeparate.elements;v[0]=E[0],v[1]=E[1],v[2]=E[2],d.threeDStartRotation=i.threeDStartRotation,d.startRotationType=i.startRotationType,d.startRotationConstant=i.startRotationConstant*a;var T=i.startRotationConstantSeparate,S=d.startRotationConstantSeparate.elements;S[0]=T[0]*a,S[1]=T[1]*a,S[2]=T[2]*a,d.startRotationConstantMin=i.startRotationConstantMin*a,d.startRotationConstantMax=i.startRotationConstantMax*a;var D=i.startRotationConstantMinSeparate,x=d.startRotationConstantMinSeparate.elements;x[0]=D[0]*a,x[1]=D[1]*a,x[2]=D[2]*a;var M=i.startRotationConstantMaxSeparate,R=d.startRotationConstantMaxSeparate.elements;R[0]=M[0]*a,R[1]=M[1]*a,R[2]=M[2]*a,d.randomizeRotationDirection=i.randomizeRotationDirection,d.startColorType=i.startColorType;var A=i.startColorConstant,I=d.startColorConstant.elements;I[0]=A[0],I[1]=A[1],I[2]=A[2],I[3]=A[3];var y=i.startColorConstantMin,C=d.startColorConstantMin.elements;C[0]=y[0],C[1]=y[1],C[2]=y[2],C[3]=y[3];var O=i.startColorConstantMax,V=d.startColorConstantMax.elements;V[0]=O[0],V[1]=O[1],V[2]=O[2],V[3]=O[3],d.gravityModifier=i.gravityModifier,d.simulationSpace=i.simulationSpace,d.scaleMode=i.scaleMode,d.playOnAwake=i.playOnAwake,d.maxParticles=i.maxParticles;var L=i.autoRandomSeed;null!=L&&(d.autoRandomSeed=L);var P=i.randomSeed;null!=P&&(d.randomSeed[0]=P);var w=i.emission,N=d.emission;if(w){N.emissionRate=w.emissionRate;var F=w.bursts;if(F)for(o=0,s=F.length;s>o;o++){var b=F[o];N.addBurst(new W(b.time,b.min,b.max))}N.enbale=w.enable}else N.enbale=!1;var B=i.shape;if(B){var U;switch(B.shapeType){case 0:var H;U=H=new ni,H.radius=B.sphereRadius,H.emitFromShell=B.sphereEmitFromShell,H.randomDirection=B.sphereRandomDirection;break;case 1:var G;U=G=new ti,G.radius=B.hemiSphereRadius,G.emitFromShell=B.hemiSphereEmitFromShell,G.randomDirection=B.hemiSphereRandomDirection;break;case 2:var z;U=z=new ei,z.angle=B.coneAngle*a,z.radius=B.coneRadius,z.length=B.coneLength,z.emitType=B.coneEmitType,z.randomDirection=B.coneRandomDirection;break;case 3:var X;U=X=new $n,X.x=B.boxX,X.y=B.boxY,X.z=B.boxZ,X.randomDirection=B.boxRandomDirection;break;case 7:var j;U=j=new Jn,j.radius=B.circleRadius,j.arc=B.circleArc*a,j.emitFromEdge=B.circleEmitFromEdge,j.randomDirection=B.circleRandomDirection;break;default:var q;U=q=new Jn,q.radius=B.circleRadius,q.arc=B.circleArc*a,q.emitFromEdge=B.circleEmitFromEdge,q.randomDirection=B.circleRandomDirection}U.enable=B.enable,d.shape=U}var Q=i.velocityOverLifetime;if(Q){var tt,nt=Q.velocity;switch(nt.type){case 0:var st=nt.constant;tt=J.createByConstant(new On(st[0],st[1],st[2]));break;case 1:tt=J.createByGradient(this._initParticleVelocity(nt.gradientX),this._initParticleVelocity(nt.gradientY),this._initParticleVelocity(nt.gradientZ));break;case 2:var lt=nt.constantMin,ut=nt.constantMax;tt=J.createByRandomTwoConstant(new On(lt[0],lt[1],lt[2]),new On(ut[0],ut[1],ut[2]));break;case 3:tt=J.createByRandomTwoGradient(this._initParticleVelocity(nt.gradientXMin),this._initParticleVelocity(nt.gradientXMax),this._initParticleVelocity(nt.gradientYMin),this._initParticleVelocity(nt.gradientYMax),this._initParticleVelocity(nt.gradientZMin),this._initParticleVelocity(nt.gradientZMax))}var ct=new ot(tt);ct.space=Q.space,ct.enbale=Q.enable,d.velocityOverLifetime=ct}var ht=i.colorOverLifetime;if(ht){var dt,_t=ht.color;switch(_t.type){case 0:var ft=_t.constant;dt=K.createByConstant(new Vn(ft[0],ft[1],ft[2],ft[3]));break;case 1:dt=K.createByGradient(this._initParticleColor(_t.gradient));break;case 2:var mt=_t.constantMin,pt=_t.constantMax;dt=K.createByRandomTwoConstant(new Vn(mt[0],mt[1],mt[2],mt[3]),new Vn(pt[0],pt[1],pt[2],pt[3]));break;case 3:dt=K.createByRandomTwoGradient(this._initParticleColor(_t.gradientMin),this._initParticleColor(_t.gradientMax))}var Et=new k(dt);Et.enbale=ht.enable,d.colorOverLifetime=Et}var vt=i.sizeOverLifetime;if(vt){var gt,Tt=vt.size;switch(Tt.type){case 0:gt=Tt.separateAxes?$.createByGradientSeparate(this._initParticleSize(Tt.gradientX),this._initParticleSize(Tt.gradientY),this._initParticleSize(Tt.gradientZ)):$.createByGradient(this._initParticleSize(Tt.gradient));break;case 1:if(Tt.separateAxes){var St=Tt.constantMinSeparate,Dt=Tt.constantMaxSeparate;gt=$.createByRandomTwoConstantSeparate(new On(St[0],St[1],St[2]),new On(Dt[0],Dt[1],Dt[2]))}else gt=$.createByRandomTwoConstant(Tt.constantMin,Tt.constantMax);break;case 2:gt=Tt.separateAxes?$.createByRandomTwoGradientSeparate(this._initParticleSize(Tt.gradientXMin),this._initParticleSize(Tt.gradientYMin),this._initParticleSize(Tt.gradientZMin),this._initParticleSize(Tt.gradientXMax),this._initParticleSize(Tt.gradientYMax),this._initParticleSize(Tt.gradientZMax)):$.createByRandomTwoGradient(this._initParticleSize(Tt.gradientMin),this._initParticleSize(Tt.gradientMax))}var xt=new it(gt);xt.enbale=vt.enable,d.sizeOverLifetime=xt}var Mt=i.rotationOverLifetime;if(Mt){var Rt,At=Mt.angularVelocity;switch(At.type){case 0:At.separateAxes||(Rt=Z.createByConstant(At.constant*a));break;case 1:At.separateAxes||(Rt=Z.createByGradient(this._initParticleRotation(At.gradient)));break;case 2:if(At.separateAxes){var It=At.constantMinSeparate,yt=At.constantMaxSeparate;Rt=Z.createByRandomTwoConstantSeparate(new On(It[0]*a,It[1]*a,It[2]*a),new On(yt[0]*a,yt[1]*a,yt[2]*a))}else Rt=Z.createByRandomTwoConstant(At.constantMin*a,At.constantMax*a);break;case 3:At.separateAxes||(Rt=Z.createByRandomTwoGradient(this._initParticleRotation(At.gradientMin),this._initParticleRotation(At.gradientMax)))}var Ct=new et(Rt);Ct.enbale=Mt.enable,d.rotationOverLifetime=Ct}var Ot=i.textureSheetAnimation;if(Ot){var Vt,Lt=Ot.frame;switch(Lt.type){case 0:Vt=Y.createByConstant(Lt.constant);break;case 1:Vt=Y.createByOverTime(this._initParticleFrame(Lt.overTime));break;case 2:Vt=Y.createByRandomTwoConstant(Lt.constantMin,Lt.constantMax);break;case 3:Vt=Y.createByRandomTwoOverTime(this._initParticleFrame(Lt.overTimeMin),this._initParticleFrame(Lt.overTimeMax))}var Pt,wt=Ot.startFrame;switch(wt.type){case 0:Pt=rt.createByConstant(wt.constant);break;case 1:Pt=rt.createByRandomTwoConstant(wt.constantMin,wt.constantMax)}var Nt=new at(Vt,Pt);Nt.enable=Ot.enable;var Ft=Ot.tiles;Nt.tiles=new Cn(Ft[0],Ft[1]),Nt.type=Ot.type,Nt.randomRow=Ot.randomRow;var bt=Ot.rowIndex;void 0!==bt&&(Nt.rowIndex=bt),Nt.cycles=Ot.cycles,d.textureSheetAnimation=Nt}},o._activeHierarchy=function(){laya.d3.core.Sprite3D.prototype._activeHierarchy.call(this),this.particleSystem.playOnAwake&&this.particleSystem.play()},o._inActiveHierarchy=function(){laya.d3.core.Sprite3D.prototype._inActiveHierarchy.call(this),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)},o.cloneTo=function(e){var t=e,n=t._geometryFilter;this._geometryFilter.cloneTo(n);var i=t._render,r=this._render;i.sharedMaterials=r.sharedMaterials,i.enable=r.enable,i.renderMode=r.renderMode,i.mesh=r.mesh,i.stretchedBillboardCameraSpeedScale=r.stretchedBillboardCameraSpeedScale,i.stretchedBillboardSpeedScale=r.stretchedBillboardSpeedScale,i.stretchedBillboardLengthScale=r.stretchedBillboardLengthScale,i.sortingFudge=r.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},o.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._geometryFilter._destroy(),this._geometryFilter=null)},a(0,o,"particleSystem",function(){return this._geometryFilter}),a(0,o,"particleRender",function(){return this._render}),t.__init__=function(){t.SHADERDEFINE_RENDERMODE_BILLBOARD=t.shaderDefines.registerDefine("SPHERHBILLBOARD"),t.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=t.shaderDefines.registerDefine("STRETCHEDBILLBOARD"),t.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=t.shaderDefines.registerDefine("HORIZONTALBILLBOARD"),t.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=t.shaderDefines.registerDefine("VERTICALBILLBOARD"),t.SHADERDEFINE_COLOROVERLIFETIME=t.shaderDefines.registerDefine("COLOROVERLIFETIME"),t.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=t.shaderDefines.registerDefine("RANDOMCOLOROVERLIFETIME"),t.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=t.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECONSTANT"),t.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=t.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECURVE"),t.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=t.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),t.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=t.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),t.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=t.shaderDefines.registerDefine("TEXTURESHEETANIMATIONCURVE"),t.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=t.shaderDefines.registerDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),t.SHADERDEFINE_ROTATIONOVERLIFETIME=t.shaderDefines.registerDefine("ROTATIONOVERLIFETIME"),t.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=t.shaderDefines.registerDefine("ROTATIONOVERLIFETIMESEPERATE"),t.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=t.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECONSTANT"),t.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=t.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECURVE"),t.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=t.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),t.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=t.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),t.SHADERDEFINE_SIZEOVERLIFETIMECURVE=t.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVE"),t.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=t.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVESEPERATE"),t.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=t.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVES"),t.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=t.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),t.SHADERDEFINE_RENDERMODE_MESH=t.shaderDefines.registerDefine("RENDERMODE_MESH"),t.SHADERDEFINE_SHAPE=t.shaderDefines.registerDefine("SHAPE")},t.load=function(e){return n.loader.create(e,null,null,t)},t._initStartLife=function(e){for(var t=new Q,n=e.startLifetimes,i=0,r=n.length;r>i;i++){var a=n[i];t.add(a.key,a.value)}return t},t.SHADERDEFINE_RENDERMODE_BILLBOARD=0,t.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,t.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,t.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,t.SHADERDEFINE_COLOROVERLIFETIME=0,t.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,t.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,t.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,t.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIME=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,t.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,t.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,t.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,t.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,t.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,t.SHADERDEFINE_RENDERMODE_MESH=0,t.SHADERDEFINE_SHAPE=0,t.WORLDPOSITION=0,t.WORLDROTATION=1,t.POSITIONSCALE=4,t.SIZESCALE=5,t.SCALINGMODE=6,t.GRAVITY=7,t.THREEDSTARTROTATION=8,t.STRETCHEDBILLBOARDLENGTHSCALE=9,t.STRETCHEDBILLBOARDSPEEDSCALE=10,t.SIMULATIONSPACE=11,t.CURRENTTIME=12,t.VOLVELOCITYCONST=13,t.VOLVELOCITYGRADIENTX=14,t.VOLVELOCITYGRADIENTY=15,t.VOLVELOCITYGRADIENTZ=16,t.VOLVELOCITYCONSTMAX=17,t.VOLVELOCITYGRADIENTXMAX=18,t.VOLVELOCITYGRADIENTYMAX=19,t.VOLVELOCITYGRADIENTZMAX=20,t.VOLSPACETYPE=21,t.COLOROVERLIFEGRADIENTALPHAS=22,t.COLOROVERLIFEGRADIENTCOLORS=23,t.MAXCOLOROVERLIFEGRADIENTALPHAS=24,t.MAXCOLOROVERLIFEGRADIENTCOLORS=25,t.SOLSIZEGRADIENT=26,t.SOLSIZEGRADIENTX=27,t.SOLSIZEGRADIENTY=28,t.SOLSizeGradientZ=29,t.SOLSizeGradientMax=30,t.SOLSIZEGRADIENTXMAX=31,t.SOLSIZEGRADIENTYMAX=32,t.SOLSizeGradientZMAX=33,t.ROLANGULARVELOCITYCONST=34,t.ROLANGULARVELOCITYCONSTSEPRARATE=35,t.ROLANGULARVELOCITYGRADIENT=36,t.ROLANGULARVELOCITYGRADIENTX=37,t.ROLANGULARVELOCITYGRADIENTY=38,t.ROLANGULARVELOCITYGRADIENTZ=39,t.ROLANGULARVELOCITYGRADIENTW=40,t.ROLANGULARVELOCITYCONSTMAX=41,t.ROLANGULARVELOCITYCONSTMAXSEPRARATE=42,t.ROLANGULARVELOCITYGRADIENTMAX=43,t.ROLANGULARVELOCITYGRADIENTXMAX=44,t.ROLANGULARVELOCITYGRADIENTYMAX=45,t.ROLANGULARVELOCITYGRADIENTZMAX=46,t.ROLANGULARVELOCITYGRADIENTWMAX=47,t.TEXTURESHEETANIMATIONCYCLES=48,t.TEXTURESHEETANIMATIONSUBUVLENGTH=49,t.TEXTURESHEETANIMATIONGRADIENTUVS=50,t.TEXTURESHEETANIMATIONGRADIENTMAXUVS=51,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(nr.shaderDefines)}]),t}(nr),ur=function(e){function t(e,n){this._subMeshOffset=null,t.__super.call(this,n),this._subMeshOffset=[],this._geometryFilter=new gi(this),this._render=new er(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),e&&(this._geometryFilter.sharedMesh=e)}r(t,"laya.d3.core.SkinnedMeshSprite3D",e);var o=t.prototype;return o._changeRenderObjectByMesh=function(e){var t=this._render._renderElements,n=t[e];n||(n=t[e]=new ii),n._render=this._render;var i=this._render.sharedMaterials[e];i||(i=Pi.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,n},o._changeRenderObjectByMaterial=function(e,t){var n=this._render._renderElements[e];t||(t=Pi.defaultMaterial);var i=this._geometryFilter.sharedMesh.getRenderElement(e);return n._mainSortID=this._getSortID(i,t),n._sprite3D=this,n.renderObj=i,n._material=t,n},o._changeRenderObjectsByMesh=function(){var e=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=e;for(var t=0;e>t;t++)this._changeRenderObjectByMesh(t)},o._onMeshChanged=function(e){var t=e.sharedMesh;t.loaded?this._changeRenderObjectsByMesh():t.once("loaded",this,this._changeRenderObjectsByMesh)},o._onMaterialChanged=function(e,t,n){var i=this._render._renderElements.length;i>t&&this._changeRenderObjectByMaterial(t,n)},o._parseCustomProps=function(e,t,n,i){var r=this.skinnedMeshRender,a=n.lightmapIndex;null!=a&&(r.lightmapIndex=a);var o=n.lightmapScaleOffset;o&&(r.lightmapScaleOffset=new Vn(o[0],o[1],o[2],o[3]));var s,l;if(i.instanceParams)s=i.instanceParams.loadPath,s&&(l=g.getRes(t[s]),this.meshFilter.sharedMesh=l,l.loaded?r.sharedMaterials=l.materials:l.once("loaded",this,this._applyMeshMaterials));else{s=n.meshPath,s&&(l=g.getRes(t[s]),this.meshFilter.sharedMesh=l);var u=n.materials;if(u){var c=r.sharedMaterials,h=u.length;c.length=h;for(var d=0;h>d;d++)c[d]=g.getRes(t[u[d].path]);r.sharedMaterials=c}var _=n.rootBone;_&&r._setRootBone(_);var f=n.boundBox;if(f){var m=f.min,p=f.max,E=new En(new On(m[0],m[1],m[2]),new On(p[0],p[1],p[2]));r.localBoundBox=E
}else r._hasIndependentBound=!1;var v=n.boundSphere;if(v){var T=v.center,S=new gn(new On(T[0],T[1],T[2]),v.radius);r.localBoundSphere=S}}},o._changeHierarchyAnimator=function(e){if(e){var t=this.skinnedMeshRender;t._setCacheAnimator(e);var n=e.avatar;n&&t._setCacheAvatar(n)}laya.d3.core.Sprite3D.prototype._changeHierarchyAnimator.call(this,e)},o._clearSelfRenderObjects=function(){this._scene.removeFrustumCullingObject(this._render)},o._addSelfRenderObjects=function(){this._scene.addFrustumCullingObject(this._render)},o._applyMeshMaterials=function(e){for(var t=this._render.sharedMaterials,n=e.materials,i=0,r=n.length;r>i;i++)t[i]||(t[i]=n[i]);this._render.sharedMaterials=t},o.cloneTo=function(e){var t=e;t._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=t._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.receiveShadow=n.receiveShadow,i.sortingFudge=n.sortingFudge,i._rootBone=n._rootBone;var a=n.localBoundSphere;a&&(i.localBoundSphere=a.clone());var o=n.localBoundBox;o&&(i.localBoundBox=o.clone()),i._hasIndependentBound=n._hasIndependentBound,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,e)},o.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._geometryFilter._destroy())},a(0,o,"meshFilter",function(){return this._geometryFilter}),a(0,o,"skinnedMeshRender",function(){return this._render}),t.__init__=function(){t.SHADERDEFINE_BONE=t.shaderDefines.registerDefine("BONE")},t.load=function(e){return n.loader.create(e,null,null,t)},t.SHADERDEFINE_BONE=8,t.BONES=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(nr.shaderDefines)}]),t}(nr),cr=(function(e){function t(){}r(t,"laya.d3.core.VRCamera",e);var n=t.prototype;return n._onWorldMatrixChanged=function(){},n._calculatePupilOffset=function(){},n._calculateLeftProjectionMatrix=function(){},n._calculateRightProjectionMatrix=function(){},n._calculateProjectionMatrix=function(){},n._renderCamera=function(){},a(0,n,"rightBoundFrustum",function(){}),a(0,n,"leftNormalizedViewport",function(){}),a(0,n,"rightViewport",function(){}),a(0,n,"viewport",null,function(){}),a(0,n,"leftAspectRatio",function(){}),a(0,n,"rightAspectRatio",function(){}),a(0,n,"aspectRatio",null,function(){}),a(0,n,"rightNormalizedViewport",function(){}),a(0,n,"normalizedViewport",null,function(){}),a(0,n,"leftViewport",function(){}),a(0,n,"needLeftViewport",function(){}),a(0,n,"needRightViewport",function(){}),a(0,n,"leftViewMatrix",function(){}),a(0,n,"rightViewMatrix",function(){}),a(0,n,"leftProjectionMatrix",function(){}),a(0,n,"leftProjectionViewMatrix",function(){}),a(0,n,"rightProjectionMatrix",function(){}),a(0,n,"rightProjectionViewMatrix",function(){}),a(0,n,"leftBoundFrustum",function(){}),t}(tr),function(e){function t(){t.__super.call(this)}r(t,"laya.d3.core.trail.TrailSprite3D",e);var n=t.prototype;return n._changeRenderObjectsByMaterial=function(){},n._changeRenderObjectByMaterial=function(){},n._changeRenderObjectsByRenderElement=function(){},n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._update=function(){},n._parseCustomProps=function(){},n.reset=function(){},n.cloneTo=function(){},n.destroy=function(){},a(0,n,"trailFilter",function(){return this._geometryFilter}),a(0,n,"trailRender",function(){return this._render}),t.__init__=function(){t.SHADERDEFINE_GRADIENTMODE_BLEND=t.shaderDefines.registerDefine("GRADIENTMODE_BLEND")},t.CURTIME=3,t.LIFETIME=4,t.WIDTHCURVE=5,t.WIDTHCURVEKEYLENGTH=6,t.GRADIENTCOLORKEY=7,t.GRADIENTALPHAKEY=8,t.SHADERDEFINE_GRADIENTMODE_BLEND=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(nr.shaderDefines)}]),t}(nr)),hr=(function(e){function t(){}r(t,"laya.d3.extension.domino.DominoSprite3D",e);var n=t.prototype;return n.addDomino=function(){},n.updateDomino=function(){},n.updateDominos=function(){},n._changeRenderObjects=function(){},n._changeRenderObject=function(){},n._changeRenderObjectsByRenderElement=function(){},n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._update=function(){},a(0,n,"dominoFilter",function(){return this._geometryFilter}),a(0,n,"dominoRender",function(){return this._render}),t}(nr),function(e){function t(){t.__super.call(this),this._position=new On,this._render=new Mi(this),this._geometryFilter=new xi(this),this._changeRenderObjects(this._render,0,Hi.defaultMaterial),this._render.on("materialchanged",this,this._changeRenderObjects)}r(t,"laya.d3.extension.lineRender.LineSprite3D",e);var n=t.prototype;return n.addPosition=function(e,t){this._geometryFilter.addPosition(e,t)},n._changeRenderObjects=function(e,t,n){var i=this._render._renderElements;n||(n=Hi.defaultMaterial);var r=i[t];r||(r=i[t]=new ut),r._sprite3D=this,r.renderObj=this._geometryFilter,r._render=this._render,r._material=n},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._update=function(t){e.prototype._update.call(this,t),this._geometryFilter._update(t)},n._parseCustomProps=function(e,t,n,i){var r=this._render,a=this._geometryFilter,o=0,s=0,l=n.materials;if(l){var u=r.sharedMaterials,c=l.length;for(u.length=c,o=0;c>o;o++)u[o]=g.getRes(t[l[o].path]);r.sharedMaterials=u}var h=i.props;a.widthMultiplier=h.widthMultiplier,a.textureMode=h.textureMode;var d=[],_=n.widthCurve;for(o=0,s=_.length;s>o;o++){var f=new Et;f.time=_[o].time,f.inTangent=_[o].inTangent,f.outTangent=_[o].outTangent,f.value=_[o].value,d.push(f)}a.widthCurve=d;var m=n.colorGradient,p=new ft;p.mode=m.mode;var E,v,T=[],S=m.colorKeys;for(o=0,s=S.length;s>o;o++)v=S[o],E=new pt(new _t(v.value[0],v.value[1],v.value[2],1),v.time),T.push(E);var D,x,M=[],R=m.alphaKeys;for(o=0,s=R.length;s>o;o++)x=R[o],D=new mt(x.value,x.time),M.push(D);p.setKeys(T,M),a.colorGradient=p;var A,I=n.positions,y=I.size,C=I.values;for(o=0;y>o;o++)A=C[o],this._position.x=A[0],this._position.y=A[1],this._position.z=A[2],this.addPosition(this._position)},n.destroy=function(t){void 0===t&&(t=!0),this.destroyed||(e.prototype.destroy.call(this,t),this._geometryFilter._destroy(),this._position=null)},a(0,n,"lineFilter",function(){return this._geometryFilter}),a(0,n,"lineRender",function(){return this._render}),t.__init__=function(){t.SHADERDEFINE_GRADIENTMODE_BLEND=t.shaderDefines.registerDefine("GRADIENTMODE_BLEND"),t.SHADERDEFINE_TEXTUREMODE_STRETCH=t.shaderDefines.registerDefine("TEXTUREMODE"),t.SHADERDEFINE_WORLDSPACE=t.shaderDefines.registerDefine("WORLDSPACE")},t.WIDTHCURVE=3,t.WIDTHCURVEKEYLENGTH=4,t.GRADIENTCOLORKEY=5,t.GRADIENTALPHAKEY=6,t.SHADERDEFINE_WORLDSPACE=0,t.SHADERDEFINE_GRADIENTMODE_BLEND=0,t.SHADERDEFINE_TEXTUREMODE_STRETCH=0,i(t,["shaderDefines",function(){return this.shaderDefines=new Nn(nr.shaderDefines)}]),t}(nr));!function(e){function t(){}r(t,"laya.d3.terrain.TerrainChunk",e);var n=t.prototype;return n.buildRenderElementAndMaterial=function(){},n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._applyMeshMaterials=function(){},n.cloneTo=function(){console.log("Terrain Chunk can't clone")},n.destroy=function(){},a(0,n,"terrainFilter",function(){return this._geometryFilter}),a(0,n,"terrainRender",function(){return this._render}),t.load=function(){},t}(nr),function(e){function t(){}r(t,"laya.d3.core.MeshTerrainSprite3D",e);var n=t.prototype;return n._disableRotation=function(){},n._getScaleX=function(){},n._getScaleZ=function(){},n._initCreateFromMesh=function(){},n._initCreateFromMeshHeightMap=function(){},n._computeCellSize=function(){},n._update=function(){},n.getHeight=function(){},a(0,n,"minX",function(){var e=this.transform.worldMatrix,t=e.elements;return this._minX*this._getScaleX()+t[12]}),a(0,n,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),a(0,n,"minZ",function(){var e=this.transform.worldMatrix,t=e.elements;return this._minZ*this._getScaleZ()+t[14]}),a(0,n,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),t.createFromMesh=function(){},t.createFromMeshAndHeightMap=function(){},i(t,["_tempVector3",function(){return this._tempVector3=new On},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new xn}]),t}(sr),function(e){function t(){}r(t,"laya.d3.water.WaterSprite",e);var n=t.prototype;return n._getWaveInfo=function(){},n.onDescLoaded=function(){},n.onMeshLoaded=function(){},n.stop=function(){},n.addRefractObj=function(){},n.onPreRender=function(){},n._update=function(e){laya.d3.core.RenderableSprite3D.prototype._update.call(this,e)},a(0,n,"src",null,function(e){var t=new g;t.on("complete",this,this.onDescLoaded),t.load(e)}),a(0,n,"syncObj",null,function(e){this._syncObj=e,this.renderDetailWav=!1}),t._waveInfoEleNum=4,t.detailTexWidth=256,t.detailTexHeight=256,i(t,["deg2rad",function(){return this.deg2rad=Math.PI/180},"_2pi",function(){return this._2pi=2*Math.PI}]),t}(sr)}}(window,document,Laya),"function"==typeof define&&define.amd&&define("laya.core",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});for(var n in Laya){var i=Laya[n];i&&i.__isclass&&(t[n]=i)}});